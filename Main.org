#+TITLE:    Informational Content of Geographical Indications
#+AUTHOR:   Jean-Sauveur Ay\\ INRA UMR CESAER \\
#+OPTIONS:  LaTeX:t tags:nil toc:nil H:5
#+STARTUP:  hideblocks
#+DRAWERS:  PROPERTIES BABEL BIND LATEX MACRO
:BABEL:
#+PROPERTY: header-args :session *R* :exports both :eval no :results output
:END:
:BIND:
#+BIND:         org-latex-image-default-width ""
#+BIND:         org-latex-tables-booktabs t
:END:
:LATEX:
#+LaTex_CLASS:  ManueStat
#+LaTeX_HEADER: \parindent 20pt \parskip 1ex  
#+COLUMNS:      %40ITEM %10BEAMER_env(Env) %9BEAMER_envargs(Env Args) %4BEAMER_col(Col) %10BEAMER_extra(Extra)
# LaTeX_HEADER: \usepackage[utf8]{inputenc} \usepackage[flushleft]{threeparttable}\renewcommand{\baselinestretch}{1.50} \newcommand\crule[3][black]{\textcolor{#1}{\rule{#2}{#3}}}
#+LaTeX_HEADER: \usepackage{tabularx, rotating, booktabs, lscape, tikz, dcolumn, amssymb, amsmath, amsthm, bbm, eurosym, threeparttable, pdflscape}
# LaTeX_HEADER: \usetikzlibrary{calc,trees,positioning,arrows,chains,shapes.geometric, decorations.pathreplacing,decorations.pathmorphing,shapes, matrix,shapes.symbols}
# LaTeX_HEADER: \newcolumntype{Y}{>{\raggedleft\arraybackslash}X} \usepackage{caption} \captionsetup{font={stretch=.7}, position=top} \newcommand{\indep}{\;\rotatebox[origin=c]{90}{$\models$}\;}
# LaTeX_HEADER: \newtheorem*{mydef*}{Definition} \newtheorem*{myrem*}{Remark}
# LaTeX_HEADER: \newtheorem{mydef}{Definition}[section]  \newcommand{\mydefautorefname}{Definition}
# LaTeX_HEADER: \newtheorem{myhyp}{Assumption}[section]  \newcommand{\myhypautorefname}{Assumption} 
# LaTeX_HEADER: \newtheorem{myprp}{Proposition}[section] \newcommand{\myintautorefname}{Proposition}
# LaTeX_HEADER: \newtheorem{mycor}{Corollary}[section]   \newcommand{\mycorautorefname}{Corollary}
# LaTeX_HEADER: \newtheorem{myrem}{Remark}[section]   \newcommand{\myremautorefname}{Remark}
:END:
:MACRO:
#+MACRO:         ffc @@latex: \superfullcite{$1}@@
#+MACRO:         flc @@latex: \alert{\ding{220}}@@
:END:

# La partie de vigne qu'il manque à Chambole c'est Gilly les citeaux,
# non retenu ; La partie de vigne qu'il manque à Chassagne c'est
# Remigny en Saone et Loire

# On a 30 GCRU au de 32 à cause de Charlemagne, sous ensemble de
# corton-charlemagne peu utilisé et Charmes-Chambertain sous-ensemble
# de Mazoyere Chambertin.

# 1930s leading growers chose not to petition for them, for a range of
# reasons, including a reluctance to pay the higher taxes levied on
# grand cru wines.  Read more at
# https://www.decanter.com/learn/burgundy-premier-cru-vs-grand-cru-vineyards-ask-decanter-410099/#KPSkYut5TSE3rcZ7.99

* README
  :PROPERTIES:
  :EXPORT_FILE_NAME: README
  :END:
*** Classification statistique des vignobles de Côte d'Or
*** English version

    Modeling statistically the link between natural attributes of
    vineyards and the hierarchical scheme of /appellations d'origine
    contrôlée/ (AOC) allows to correct /commune/ effects and to
    estimate a continuous quality score for each vineyard plot.

    This research is described in the [[file:WorkingPaper.pdf][AAWE Working Paper XX]] and the
    Reproducibility Material in [[file:ReproPaper.pdf][PDF]] or [[file:ReproPaper.md][Markdown]].  Raw data are on the
    [[https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN][INRA dataverse server]] and the results are accessible by a [[https://geoind.shinyapps.io/application/][Shiny
    application]] or only the [[https://geoind-wine.firebaseapp.com][map]].

*** Version Française

    La modélisation statistique des liens entre les attributs naturels
    des vignobles et la hiérarchie des appellations d'origine
    contrôlée permet d'estimer un score de qualité pour chaque
    parcelle et de corriger les effets communaux.

    Les détails de la construction des données et de l'estimation sont
    disponibles en versions [[file:DataPaper.pdf][PDF]] et [[file:DataPaper.md][Markdown]].  Les données sont
    accessibles sur [[https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN][le serveur data de l'INRA]] et les résultats sont
    consultables par une [[https://geoind.shinyapps.io/application/][application]] ou une [[https://geoind-wine.firebaseapp.com][carte]].

*** Credits

    Bug reports, comments and suggestions by opening an issue on
    [[https://github.com/jsay/geoInd][GitHub]] (preferred) or [[mailto:jsay@inra.fr][sending an email]].
    
    Made on =emacs= with =org-mode= to juggle with =R=, =LaTex= and
    =Markdown=.

    Special thanks to [[https://fr.linkedin.com/in/pauline-mialhe][Pauline Mialhe]], [[https://fr.linkedin.com/in/vincent-larmet-bba997144][Vincent Larmet]], and [[https://www2.dijon.inra.fr/cesaer/membres/guillaume-royer/][Guillaume
    Royer]] for their help with the application.

    Licence GNU GPL V3, copyright and licence notices must be
    preserved (see https://www.gnu.org/licenses/gpl-3.0.en.html)

* Data Papier
  :PROPERTIES:
  :EXPORT_FILE_NAME:    DataPaper
  :EXPORT_LATEX_CLASS:  ManueStat
  :EXPORT_TITLE:        @@latex: \vspace{-2cm} \huge\textbf{Données, modèles et application \emph{Shiny}\\ pour une classification statistique \\des vignobles de Côte-d'Or }@@
  :EXPORT_AUTHOR:       @@latex: \begin{tabular}{ccc} \textbf{Jean-Sauveur AY} && \textbf{Mohamed HILAL} \\ < \url{jean-sauveur.ay@inra.fr} > && < \url{mohamed.hilal@inra.fr} > \\[.5cm] \multicolumn{3}{c}{Unité Mixte de Recherche CESAER} \\ \multicolumn{3}{c}{AgroSup / INRA / Univ. Bourgogne Franche-Comté} \\ \multicolumn{3}{c}{26 boulevard du docteur Petitjean 21000 DIJON}\\[.25cm] \end{tabular} @@
  :EXPORT_DATE:         /Data paper/ version 1.0 du Vendredi 12 juillet 2019 \vspace*{-.5cm}
  :EXPORT_OPTIONS:      TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:3
  :EXPORT_LATEX_HEADER: \usepackage[T1]{fontenc} \usepackage{tabularx, rotating, booktabs, lscape, tikz, dcolumn, amssymb, amsmath, amsthm, bbm, eurosym, threeparttable, pdflscape, txfonts, rotfloat} \usepackage{tocloft} \renewcommand{\abstractname}{Résumé} \usepackage[toc]{multitoc}\renewcommand*{\multicolumntoc}{2}\setlength{\columnseprule}{.5pt}\setlength{\columnsep}{1cm} \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}} \renewcommand*\contentsname{Table des Matières}
  :END:
** Résumé                                    :noheading:
#+begin_export html
---
title:  Déterminants biophysiques des AOC viticoles, Construction des données et modélisation
author: |
  | Jean-Sauveur Ay et Mohamed Hilal
  | UMR CESAER, AgroSup, INRA, Université Bourgogne Franche-Comté
---

# Résumé
#+end_export
#+BEGIN_abstract
Cet article présente la construction d'une base de données au niveau
des parcelles cadastrales pour étudier les relations entre les
caractéristiques biophysiques (topographie, géologie, pédologie) et
les appellations d'origine contrôlée (AOC) viticoles.  Sur les 31
communes de la Côte-d'Or qui forment la côte de Beaune et la côte de
Nuits, nous proposons une modélisation statistique qui permet de
classifier l'ensemble des parcelles sur une échelle de qualité
continue exclusivement à partir de leurs caractéristiques
biophysiques.  Nous montrons en particulier la persistance d'effets
communaux significatifs issus d'éléments historiques non reliés aux
caractéristiques biophysiques des parcelles.  Les données, méthodes et
prédictions du modèle sont disponibles sous licence GNU GPL V3 sur
[[https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN][https://data.inra.fr/]] et sont consultables par le biais d'une
application /Shiny/ sur [[http://github.com/jsay/geoInd/][http://github.com/jsay/geoInd/]].\\

*Mots-clés*: Économie viti-vinicole ; signes de qualité ; recherche
reproductible ; système d'information géographique ; modélisation
économétrique.
#+END_abstract
#+Latex: \vspace{-.25cm}
#+TOC: headlines 3
** Introduction
*** Généralités sur les AOC                  :noheading:

    Les appellations d'origine contrôlée (AOC) viticoles en Bourgogne
    résultent de processus historiques complexes au cours desquels les
    parcelles ont été classifiées selon leurs caractéristiques
    biophysiques au grès des rapports économiques, politiques et
    sociaux en vigueur citep:Garc11,WJac11.  La classification
    actuelle est issue de plusieurs siècles de culture de la vigne, de
    production de vin et de négociation sur les dénominations.  Ces
    trois ensembles de pratiques forment les usages loyaux et
    constants selon la doctrine de l'institut national de l'origine et
    de la qualité (INAO) pour définir, reconnaître et gérer les AOC
    citep:Capu47,Humb11.  La complexité des informations contenues
    dans la référence au lieu de production et leurs évolutions dans
    le temps sont à la fois des forces et des faiblesses pour les AOC.
    Elles permettent de simplifier les nombreux déterminants
    biophysiques de la qualité des vins au risque d'une faible
    pertinence et d'une opacité croissante pour les acteurs du marché
    du vin.
    
*** Économie des AOC                         :noheading:

    La question de la transmission de l'information entre les
    producteurs et les consommateurs sur la qualité des biens échangés
    fait l'objet d'une littérature économique abondante citep:CMar04.
    L'asymétrie d'information y est typiquement décrite comme une
    défaillance de marché qui porte préjudice aux parties prenantes de
    la relation commerciale.  Par contre, le recours aux indications
    géographiques apparaît comme une solution partielle qui peut
    segmenter artificiellement la production et générer des rentes non
    justifiées pour les producteurs au détriment des consommateurs.
    Nous nous concentrons dans cet article sur la capacité des AOC à
    simplifier l'information sur les caractéristiques des lieux de
    production, en laissant de côté la question de la pertinence de
    cette information pour le marché.  Il s'agit de quantifier dans
    quelle mesure la hiérarchie des AOC bourguignonnes en 5
    catégories, Coteaux bourguignons < Bourgogne régional < Bourgogne
    village < Premier cru < Grand cru, permet de résumer les nombreux
    déterminants biophysiques de la qualité des vins (topographie,
    géologie, pédologie).  Cette analyse statistique permet de mettre
    en évidence des déterminants historiques de la hiérarchie des AOC
    non reliés aux caractéristiques individuelles des parcelles mais
    reliés à la commune à laquelle elles appartiennent.  Nous
    interprétons ce résultat comme la manifestation de pouvoir de
    négociation de certaines communes (selon l'influence de leurs
    résidents, leur notoriété, ou leur proximité aux lieux de
    décision) lors de la mise en place des AOC.

*** Sources de données                       :noheading:

    Le travail sur les données consiste à apparier les informations
    biophysiques des parcelles cadastrales aux AOC par l'utilisation
    d'un système d'information géographique.  La Section [[#Sec:1]]
    présente en détail la construction des données, avec en
    particulier les références aux fichiers sources et le dictionnaire
    des variables produites.  Ce premier travail aboutit à la
    construction d'une base de données spatialisée librement
    disponible sous licence GNU GPL V3 sur [[https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN][https://data.inra.fr/]].  La
    parcelle cadastrale est l'unité géographique de base qui permet
    l'appariement de variables altimétriques du RGE
    ALTI\textsuperscript{\textregistered} 5m (IGN),
    @@latex:\textcolor{green}{d'un modèle d'occupation du sol (Hilal
    et al., 2018)??}@@, de variables géologiques de Charm-50 (BRGM),
    de variables pédologiques du Référentiel Pédologique de Bourgogne
    (Gis Sol), de variables historiques sur les AOC en 1936 (MSH
    Dijon) et de variables sur les lieux dits issus du Plan Cadastral
    Informatisé (DGFiP).  Les données construites concernent
    actuellement les 31 communes qui constituent la côte de Beaune et
    la côte de Nuits, soient l'ensemble des vignobles du département
    de la Côte-d'Or à l'exception des hautes côtes et du Châtillonnais
    (voir \autoref{Fig:1}).  Cette base de données permet de relier
    finement les AOC aux caractéristiques des parcelles dont les vins
    sont issus, et peut ainsi être utilisée pour d'autres questions de
    recherche.  Par contre, les versions brutes des données compilées
    ne sont pas diffusables en l'état.  C'est ainsi que la Section
    [[#Sec:1]] présente les traitements effectués, avec les codes R
    reportés en Annexe, sans que les données qui servent à les
    alimenter soient disponibles.  La partie reproductible de
    l'article commence réellement dans la Section [[#Sec:2]] qui suit,
    avec la présentation des principales statistiques descriptives
    relatives aux données produites.

*** Modèle économétrique                     :noheading:
    
    La Section [[#Sec:3]] contient ensuite le détails de l'estimation du
    modèle statistique dont la spécification est décrite plus
    extensivement dans un article associé citep:Ay19.  Le principe de
    la modélisation est d'utiliser la structure hiérarchique qui
    existe entre les différents niveaux des AOC pour simplifier le
    rôle des caractéristiques biophysiques au travers d'une variable
    latente de qualité des vignes.  Cette variable continue représente
    un niveau ordinal de qualité des vignes tel que révélé par la
    hiérarchie des AOC actuelles.  Nous présentons l'estimation d'un
    modèle ordonné additivement semi-paramétrique (OGAM,
    citealp:WPSa16) qui permet de prédire correctement près de 90% des
    niveaux d'AOC par un lissage spatial fin.  Ce modèle permet
    d'estimer non-paramétriquement l'effet de chaque variable
    biophysique sur la hiérarchie des AOC.  Il permet également
    d'identifier des effets communaux indépendants des variables
    biophysiques, potentiellement issus de facteurs humains tels que
    la réputation de la commune, la proximité à la ville centre
    (Dijon) ou l'antériorité des syndicats de producteurs
    citep:Jacq09.  L'estimation d'effets communaux significatifs
    permet de hiérarchiser chaque commune de la zone en fonction de la
    probabilité qu'une de ses parcelles soit plus haute dans la
    hiérarchie qu'une parcelle similaire prise au hasard sur la zone
    citep:AKat17.  Cela nous permet également de corriger ces effets
    communaux dans la variable latente de qualité des vignes déduite
    des AOC, ces effets étant /a priori/ non reliés à la qualité des
    vins produits.

*** L'application                            :noheading:

    Les prédictions issues du modèle statistique sont reportées
    (corrigées et non corrigées des effets communaux) dans la base de
    donnée issue de cette recherche.  Ces données alimentent également
    une application /Shiny/ dont le code et le manuel d'utilisation
    sont présentés dans la Section [[#Sec:4]].  Cette application peut
    être utilisée localement (moyennant la présence du [[https://cran.r-project.org/][logiciel R]] sur
    l'ordinateur de l'utilisateur) ou consultable sur internet à
    l'[[https://geoind.shinyapps.io/application/][adresse dédiée]].  Par le biais de cette application,
    l'utilisateur peut saisir une référence de vin à partir
    d'informations typiquement disponibles sur l'étiquette de la
    bouteille afin d'identifier géographiquement le lieu de production
    du raisin et son niveau de qualité (avec ou sans correction) sur
    une échelle normalisée de 0 à 100.  Cette information permet une
    évaluation plus précise que la hiérarchie actuelle des AOC en 5
    niveaux, et permet en outre de situer ce vin par rapport aux
    autres vins du même niveau hiérarchique.  Elle permet ainsi
    d'augmenter l'information disponible au niveau du consommateur
    pour effecteur ses choix de vin.  Il est important de mentionner
    que la classification obtenue se base exclusivement sur les AOC
    actuelles et à ce titre ne contient aucune appréciation subjective
    sur l'importance des différents facteurs biophysiques ou olfactif
    censés influer sur la qualité d'un vin.  La classification obtenue
    est déduite de la hiérarchie actuelle des AOC qui, au regard de la
    hiérarchie de prix qu'elle produit, semble crédible pour les
    acteurs du marché.

*** Détails techniques                       :noheading:

    Une part de subjectivité persiste toutefois dans la classification
    proposée.  Elle est relative à la spécification du modèle
    statistique, et le fait d'avoir favorisé des variables
    biophysiques pour décrire la relation entre les lieux de
    production et la qualité des vins.  Le débat sur l'articulation
    des facteurs humains et des facteurs naturels de la qualité vin
    existe depuis plus d'un demi-siècle et produit des discussions
    toujours d'actualité citep:Dion52,DChe15.  C'est pour alimenter ce
    débat que les analyses présentées dans cet article sont totalement
    reproductibles à partir de la base de donnée produite.  Les codes
    pour l'estimation du modèle sont reportés dans l'article, afin de
    permettre l'estimation de modèles alternatifs.  L'appariement de
    données supplémentaires pour relier les AOC aux caractéristiques
    des lieux est également possible par la géolocalisation des
    parcelles cadastrales.  La transparence des analyses permet aux
    résultats d'être discutés et contestés afin de faire l'objet d'une
    appropriation par les chercheurs, les décideurs, les
    professionnels du secteur, ou les amateurs de vin.

** Construction des données
  :PROPERTIES:
  :CUSTOM_ID: Sec:1
  :END:
*** Travail préalable                        :noexport:
**** Bricole pour premiers crus

     Envoi Mohamed pour intégration dicopar: OK

#+begin_src R
Dat.Deno <- fread("./Data/VITI_JSA_MH/denomination.csv",
                  encoding = 'Latin-1')
dd <- grepl("premier cru", Dat.Deno$denomination, perl=TRUE)
library(stringr)
Dat.Deno$id_den_new <- ifelse(
    dd & !str_sub(Dat.Deno$denomination, start= -7)=="ier cru",
    Dat.Deno$id_den+ 3000, Dat.Deno$id_den)
write.csv(Dat.Deno, file= "Inter/denom_new.csv")
#+end_src

**** Vérifications INAO

     Il y a des Bourgognes, Mousseux, aligotés, hors coteaux
     bourguignons, dans notre travail nous les ajoutons.

#+begin_src R
library(rgdal) ; library(data.table)
Geo.Cada <- readOGR("./Data/VITI_JSA_MH", "dicopar", verbose= F)
Dat.Apel <- fread("./Data/VITI_JSA_MH/appellation.csv",
                  encoding = 'Latin-1')
Dat.Deno <- fread("./Data/VITI_JSA_MH/denomination.csv",
                  encoding = 'Latin-1')
Geo.Cada@data <- cbind(Geo.Cada@data[, c(1: 18, 39: 69)])
names(Geo.Cada)[ 20: 49] <-
    paste0(substr(names(Geo.Cada)[ 20: 49], 1, 4), c("", "_ap", "_de"))
Geo.Cada$CODECOM <- paste0(Geo.Cada$Code_dep, Geo.Cada$Code_com)
##
## RETOUR INAO
## 
table(Geo.Cada$BGOR, Geo.Cada$PAOC)
table(Geo.Cada$BGOR, Geo.Cada$CREM)
table(Geo.Cada$BGOR, Geo.Cada$BOUR)
table(Geo.Cada$BGOR, Geo.Cada$PCRU)

ff <- subset(Geo.Cada, BGOR== 0 & PCRU== 1)
ff
jj <- subset(Geo.Cada, BGOR== 0 & MOUS== 1)
table(jj$CODECOM)
kk <- subset(Geo.Cada, BGOR== 0 & BOUR== 1)
plot(kk)
table(kk$CODECOM)

## On ne retrouve pas le chapitre
table(Geo.Cada$BOUR, Geo.Cada$BOUR_id_d9)

#+end_src

**** Sur la couche parcellaire

#+begin_src R :wrap example
library(rgdal) ; library(data.table)
Geo.Cada <- readOGR("./Data/VITI_JSA_MH", "dicopar", verbose= F)

## On inclue en BGOR les aligotés and co et les Bourgognes, pour que
## ça colle avec PAOC, AOC== 1, AOCtp== "Apell", AOClb= "Coteaux blabla"
Geo.Cada$AOC <- ifelse(!is.na(Geo.Cada$PAOC), 1, 0)
Geo.Cada$AOCtp <- ifelse(Geo.Cada$AOC== 1, "Appel", NA)
Geo.Cada$AOCgg <- ifelse(Geo.Cada$AOC== 1, Geo.Cada$BGOR_id_a2, NA)
Geo.Cada$AOCgg[Geo.Cada$AOCgg== 0] <- "1027"
## On regarde les dénominations pour les bourgognes
Geo.Cada$AOC <- ifelse(!is.na(Geo.Cada$BOUR) &
                     Geo.Cada$BOUR== 1, 2, Geo.Cada$AOC)
Geo.Cada$AOCtp <- ifelse(Geo.Cada$AOC== 2, "Denom", Geo.Cada$AOCtp)
Geo.Cada$AOCgg <- ifelse(Geo.Cada$AOC== 2, Geo.Cada$BOUR_id_d9,
                         Geo.Cada$AOCgg)
## Interactions denom apel pour les communes
Geo.Cada$AOC <- ifelse((!is.na(Geo.Cada$VILL) | !is.na(Geo.Cada$COMM)) &
                     (Geo.Cada$VILL== 1|Geo.Cada$COMM== 1), 3,Geo.Cada$AOC)
Geo.Cada$AOCtp <- ifelse(Geo.Cada$AOC== 3, "Appel", Geo.Cada$AOCtp)
Geo.Cada$AOCgg <- ifelse(Geo.Cada$AOC== 3,
                  ifelse(Geo.Cada$COMM== 1, Geo.Cada$COMM_id_14,
                         Geo.Cada$VILL_id_12), Geo.Cada$AOCgg)
## Prend les denominations PCRU
Geo.Cada$AOC <- ifelse(!is.na(Geo.Cada$PCRU) &
                     Geo.Cada$PCRU== 1, 4, Geo.Cada$AOC)
Geo.Cada$AOCtp <- ifelse(Geo.Cada$AOC== 4, "Denom", Geo.Cada$AOCtp)
Geo.Cada$AOCgg <- ifelse(Geo.Cada$AOC== 4, Geo.Cada$PCRU_id_17,
                         Geo.Cada$AOCgg)
## On vérifie que tous les grands crus sont présents et des dénom
## premiers crus sans nom sont absentes.
Geo.Cada$AOC <- ifelse(!is.na(Geo.Cada$GCRU) &
                     Geo.Cada$GCRU== 1, 5, Geo.Cada$AOC)
Geo.Cada$AOCtp <- ifelse(Geo.Cada$AOC== 5, "Appel", Geo.Cada$AOCtp)
Geo.Cada$AOCgg <- ifelse(Geo.Cada$AOC== 5, Geo.Cada$GCRU_id_18,
                         Geo.Cada$AOCgg)

Geo.Cada$CODECOM <- paste0(Geo.Cada$Code_dep, Geo.Cada$Code_com)
CadaParc <- Geo.Cada[,c("IDU","CODECOM", "Area", "Perimeter", "Max_distan",
                        "Par2ras", "PAOC", "BGOR", "BOUR", "VILL", "COMM",
                        "PCRU", "GCRU", "AOC", "AOCtp")]


Dat.Apel <- fread("./Data/VITI_JSA_MH/appellation.csv",
                     encoding = 'Latin-1')
Dat.Deno <- fread("./Data/VITI_JSA_MH/denomination.csv",
                     encoding = 'Latin-1')
## On met les étiquettes
Geo.Cada$AOCff <- paste0(Geo.Cada$AOCtp, Geo.Cada$AOCgg)

tmmp <- subset(Geo.Cada, AOCtp== "Appel")
Dat.Apel$AOCff <- as.character(paste0("Appel", Dat.Apel$ID_APP)) 
R1 <- merge(tmmp, Dat.Apel, by= "AOCff", all.x= TRUE)

tmpp <- subset(Geo.Cada, AOCtp== "Denom")
Dat.Deno$AOCff <- as.character(paste0("Denom", Dat.Deno$id_den)) 
R2 <- merge(tmpp, Dat.Deno, by= "AOCff", all.x= TRUE)

RR <- merge(CadaParc, R1@data[, c(19, 76)], by= "IDU", all.x= TRUE)
Geo.Cad <- merge(RR, R2@data[, c(19, 76)], by= "IDU", all.x= TRUE)

Geo.Cad$AOClb <- ifelse(Geo.Cad$AOCtp== "Appel", Geo.Cad$appellation,
                 ifelse(Geo.Cad$AOCtp== "Denom", Geo.Cad$denomination, NA))
Geo.Cad@data[, 16: 17] <- NULL
names(Geo.Cad)[ 3: 6] <- c("AREA", "PERIM", "MAXDIST", "PAR2RAS")
writeOGR(Geo.Cad, "Carto/", "GeoCad", "ESRI Shapefile")
#+end_src

  NOTE : l'IDU est l'identifiant unique parcellaire, composé des
    champs :
 - CODCOM : code commune sur 5 caractères (ex 56355)
 - PREFIXE : préfixe de section sur 3 caractères (par défaut 000):
   suite à fusion de communes
 - SECTION : identifiant section cadastrale sur 2 caractères (ex AB)
 - NUMPARC : numéro de parcelle sur 4 caractères (ex : 0255) D'où un
   IDU sur 14 caractères (ex : 56355000AB0255)

**** Vérifications

#+begin_src R
yop <- aggregate(Geo.Cad@data$AREA/ 10000,
                 by= list(Geo.Cad$CODECOM, substr(Geo.Cad$AOClb, 1, 40)), sum)

yop[order(yop$Group.1),]
#+end_src

**** Sur le raster

#+begin_src R
library(data.table)
Dat.Dem <- fread("Data/VITI_JSA_MH/vitidem.csv")
Dat.dem <- cbind(Dat.Dem, model.matrix(~ 0+ factor(MOS), Dat.Dem))
rm(Dat.Dem) ; dim(Dat.dem)
names(Dat.dem)[ 23: 34] <-
    c("NOMOS", "FIELDS", "GRASS", "SHRUBS", "FOREST", "VINEYARD",
      "WATER", "INFRAS", "INDUSFAC", "AGRIFAC", "LOWBUILT", "HIGHBUILT")
Dat.dem$URBAN <- rowSums(Dat.dem[, 30: 34])
Dat.Rast <- Dat.dem[, c("SUB2IND", "XL93", "YL93", "PAR2RAS",
                        "NOMOS", "URBAN", "FOREST", "WATER",
                        "DEM", "SLOPE", "ASPECT", "SOLAR", "PERMEABILITY")]
names(Dat.Rast)[ 13] <- "PERMEA"
fwrite(Dat.Rast, "Data/DatRas.csv")
#+end_src

**** Sur la géologie
***** Nouveau

#+begin_src R
GEOL <- readOGR("./Data/BRGM", "GEO050K_HARM_021_S_FGEOL_CGH_2154")
Pts.Cad <- SpatialPoints(Geo.Ras, proj4string= CRS(proj4string(GEOL)))
ttp <- over(Pts.Cad, GEOL)
selcol1 <- sapply(ttp, function(x) sum(is.na(x))< 1000)
selcol2 <- names(ttp)[ selcol1][ c(2, 4, 5, 15: 19, 21: 26, 28, 29)]
GeolMap <- GEOL[, selcol2]
library(stringr)
names(GeolMap) <- str_replace(names(GeolMap), "_", "")
writeOGR(GeolMap, "./Carto/", "GeolMap", "ESRI Shapefile")
#+end_src

***** Ancien

#+begin_src R :wrap "export latex"
library(rgdal) ; library(xtable)
GEOL <- readOGR("./Data/GeolPedo", "GeolL93", verb= F)
GEOL2 <- readOGR("./Data/BRGM", "GEO050K_HARM_021_S_FGEOL_CGH_2154")
head(GEOL2@data)
names(GEOL2)
table(GEOL2$DESCR)

table(GEOL2$C_FOND)

GCDtmp2 <- SpatialPointsDataFrame(GCDtmp,
                 data= cbind(Geo.CDem@data, over(GCDtmp, GEOL)[, 4: 5]))
names(GCDtmp2)[ 69: 70] <- c("CODEg", "DESCRg") 
tab <- data.frame(GCDtmp2$CODEg[!duplicated(GCDtmp2$CODEg)],
                  substr(GCDtmp2$DESCRg[!duplicated(GCDtmp2$CODEg)],1, 80))
names(tab) <- c("CODE", "DESCRIPTION")
tmp <- aggregate(rep(1, nrow(GCDtmp2)), by= list(GCDtmp2$CODEg), sum)
names(tmp) <- c("CODE", "FREQ")
tabb <- merge(tab, tmp, by= "CODE", all.x= TRUE)
tabb[32, 3] <- nrow(GCDtmp2)- sum(tmp[, 2])
print(xtable(tabb, digits= 0, caption= "Classification géologique"),
      hline.after = NULL, include.rownames= FALSE,
      add.to.row = list(pos = list(-1, 0, nrow(tab)),
          command = c("\\hline\\hline\\toprule\n", "\\midrule\n",
              "\\bottomrule\\hline\n")), caption.placement= "top",
      tabular.environment= "tabularx", width="\\textwidth",
      sanitize.text.function= identity, floating= T, table.placement="!h")
#+end_src

**** Sur la pédologie

#+begin_src R
PEDO <- readOGR("./Data/GeolPedo", "UCSCote2", verb= FALSE)
DESCRpedo <- read.csv("Inter/DescrPedo.csv", sep= ";")
Pedo.Map <- merge(PEDO, DESCRpedo, by= "NOUC")
Pedo.map <- spTransform(Pedo.Map[, c(1, 4: 13, 15, 16)], proj4string(GEOL))
writeOGR(Pedo.map, "Carto/", "PedoMap", "ESRI Shapefile")
#+end_src

**** Sur les AOC historiques

     Le répertoire =/Data/ExportSHP_territoireAOC= contient les aires
     délimitées au moment de la création des AOC en 1936 avec les
     évolutions des 4 années qui ont suivies.  Ces données m'ont été
     transmises par Florian Humbert de l'IUVV via la MSH.  Il s'agit
     ici de faire une boucle sur ces fichiers shapefile et de créer
     autant d'indicatrices pour les parcelles dont le centroïde tombe
     à l'intérieur des ces aires historiques.  Pour que la fonction
     ci-dessous marche bien, j'ai dû renommer certains fichiers
     initiaux:
     - =AOC_Pernand1936= devient =AOC_Pernand_Vergelesses_1936=
     - =AOC_Meursault_Blagny_Blagny_Blagny_Cote_de_Beaune_1939= devient \\
       =AOC_Meursault_Blagny_Cote_de_Beaune_1939=
     - =AOC_Cote_de_Beaune_1939= devient
       =AOC_Beaune_Cote_de_Beaune_1939=

#+begin_src R :wrap example
library(rgdal)
Geo.Cada <- readOGR("./Data/VITI_JSA_MH", "dicopar", verbose= F)
Pts.Cada <- SpatialPointsDataFrame(Geo.Cada, match.ID= FALSE,
                                   proj4string=CRS(proj4string(Geo.Cada)), 
                                   data= data.frame(1: nrow(Geo.Cada)))
Pts.Cada$Com36 <- Pts.Cada$Com37 <- Pts.Cada$Com38 <-
    Pts.Cada$Com39 <- Pts.Cada$Cote39 <- Pts.Cada$Com40 <- "NONE"

rpt <- "Data/ExportSHP_territoireAOC/"
for (i in list.files(rpt, pattern = "\\.shp$")) {
    map <- readOGR(rpt, substr(i, 1, nchar(i)- 4), ver= F)
    proj4string(map)= CRS(proj4string(Geo.Cada))
    tmp <- over(Pts.Cada, map)
    yop <- substr(i, nchar(i)- 22, nchar(i)- 19)== "Cote"
    aoc= if (yop) substr(i, 5, nchar(i)- 24) else substr(i, 5, nchar(i)- 9)
    switch(substr(i, nchar(i)- 7, nchar(i)- 4), 
           "1936"={Pts.Cada$Com36[!is.na(tmp$Nom)]= aoc},
           "1937"={Pts.Cada$Com37[!is.na(tmp$Nom)]= aoc},
           "1938"={Pts.Cada$Com38[!is.na(tmp$Nom)]= aoc},
           "1940"={Pts.Cada$Com40[!is.na(tmp$Nom)]= aoc},
           "1939"={if (yop) {
                       Pts.Cada$Cote39[!is.na(tmp$Nom)]= aoc
                       } else Pts.Cada$Com39[!is.na(tmp$Nom)]= aoc},
       {print('erreur')})
}

aocavt <- c(levels(factor(Pts.Cada$Com39)),levels(factor(Pts.Cada$Cote39)),
            levels(factor(Pts.Cada$Com38)), levels(factor(Pts.Cada$Com37)),
            levels(factor(Pts.Cada$Com36)))

equiv <- c("Auxey_Duresses"= 3, "Batard_Montrachet"= 5,
           "Bienvenues_Batard_Montrachet"= 5, "Chassagne_Montrachet"= 3,
           "Chevalier_Montrachet"= 5, "Chorey_les_Beaune"= 3,
           "Clos_de_Tart"= 5, "Criots_Batard_Montrachet"= 5, "Ladoix"= 3,
           "Meursault"= 3, "Monthelie"= 3, "Morey_Saint_Denis"= 3,
           "NONE"= 0, "Pernand_Vergelesses"= 3, "Puligny_Montrachet"= 3,
           "Saint_Aubin"= 3, "Santenay"= 3, "Savigny"= 3, "Volnay"= 3,
           "Volnay_Santenots"= 3, ## ATTENTION
           "Beaune"= 3, "Chorey"= 3, "Meursault_Blagny"= 3,
           "Aloxe_Corton"= 3, "Vosne_Romanee"= 3, "Chambertin"= 5,
           "Chambertin_Clos_de_Beze"= 5, "Chapelle_Chambertin"= 5,
           "Charlemagne"= 5, "Charmes_Chambertin"= 5, "Clos_de_Vougeot"= 5,
           "Corton"= 5, "Corton_Charlemagne"= 5,                       
           "Cote_de_Beaune_ou_Cote_de_Beaune_Villages"= 3,
           "Echezeaux"= 5, "Gevrey_Chambertin"= 3, "Grands_Echezeaux"= 5,
           "Griotte_Chambertin"= 5, "Latricieres_Chambertin"= 5,
           "Mazis_Chambertin"= 5, "Mazoyeres_Chambertin"= 5,
           "Montrachet"= 5, "Ruchottes_Chambertin"= 5,
           "Vins_fins_de_la_Cote_de_Nuits"= 0, ## ATTENTION            
           "Vougeot_rouge"= 3, "Bonnes_Mares"= 5, "Chambolle_Musigny"= 3,
           "Clos_de_la_Roche"= 5, "Clos_Saint_Denis"= 5, "Fixin"= 3,
           "La_Tache"= 5, "Musigny"= 5, "Nuits"= 3, "Pommard"= 3,
           "Richebourg"= 5, "Romanee"= 5, "Romanee_Conti"= 5,
           "Romanee_Saint_Vivant"= 5, "Vougeot"= 3)

library(plyr)
Pts.Cada$AOC39 <- revalue(factor(Pts.Cada$Cote39), equiv)
Pts.Cada$aoc39 <- revalue(factor(Pts.Cada$Com39), equiv)
Pts.Cada$AOC38 <- revalue(factor(Pts.Cada$Com38), equiv)
Pts.Cada$AOC37 <- revalue(factor(Pts.Cada$Com37), equiv)
Pts.Cada$AOC36 <- revalue(factor(Pts.Cada$Com36), equiv)

Pts.Cada$AOCavt <- apply(Pts.Cada@data[, 8: 12], 1, max)
Pts.Cada$tmpp <- apply(Pts.Cada@data[, 8: 12], 1, which.max)
Pts.Cada$AOClab <-
    apply(Pts.Cada@data, 1, function(x) x[ 2+ as.numeric(x[ 14])])

Geo.Cada@data <- cbind(Geo.Cada@data, Pts.Cada@data)
library(rgeos)
spydf_states <- gBuffer(Geo.Cada, byid=TRUE, width=0)
library(maptools)
OLDGIS <- unionSpatialPolygons(spydf_states, as.character(Geo.Cada$AOClab))
OLDGIS$AOC36lab <- as.character(row.names(OLDGIS))
OLDGIS$AOC36lvl <- revalue(factor(OLDGIS$AOC36lab), equiv)
OLDGIS$AOC36lab[OLDGIS$AOC36lab== "Vougeot_rouge" ] <- "Vougeot"
writeOGR(OLDGIS, "Carto/", "Aoc1936", "ESRI Shapefile")
#+end_src

     On pourrait reporter les années de création mais pas dans le
     fichier géographique tel qu'il est utilisé ici.  Il faudrait voir
     avec Florian pourquoi les aires en Côte de Beaune sont moins
     étendues que les aires villages avec nom (vérifié pour
     Auxey-Duresses et Chassagne-Montrachet).  Dans le cas de
     Meursault, les Côtes de Beaune associés sont les parcelles
     périphériques, inclues toutefois dans l'aire de Meursault. Par
     contre l'aire =Meursault_Blagny= (renommée) en Côte de Beaune est
     disjointe. En 1937, on a un polygone Côte de Beaune ou Côte de
     Beaune Village qui est disjoint de toutes les couches de cette
     année donc on l’inclut comme une modalité. Un polygone "Côte de
     Beaune" en 1939 plus étendu est ajouté à la variable Cote39,
     modalité =Beaune=. Les "vins fins de la cote de nuits" délimités
     en 1937 entrent comme une modalité dans la variable =Com37= car
     ils sont disjoint avec l'ensemble des polygones de cette
     année. Il y a deux ensembles: le nord de Gevrey et le sud de
     Nuits. La variable =Com40= ne compte que des =NONE= car les
     couches de cette année sont uniquement en Saône et Loire.

     L'appellation Vins fins de la Côte de Nuits a été remplacée le
     20/08/1964 par l'appellation Côte de Nuits Villages. Mais, le nom
     de Vins fins de la Côte de Nuits peut toujours être utilisé.  ce
     terroir est quasi-exclusivement consacré à la production de vins
     rouges.

     *Remarques:* Éric Vincent (INAO) s'est dit intéressé pour
     vectoriser les données 1860 avec de nouvelles variables sur le
     prix des terres en particulier, il s'agira de voir si l'on peu les
     intégrer dans une version 2 de la base. Je n'ai ces données pour
     l'instant que pour 5 communes qui peuvent servir de pilote. Des
     analyses descriptives m'ont fait apparaître une corrélation forte
     entre la forme du parcellaire et les AOC anciennes (parcelles en
     ligne), il faudrait regarder dans quelle mesure cela colle avec
     les nouvelles AOCs.

     *Actualisation* <2019-02-01 ven.> Rien à
     Chenove/Marsannay/Couchey. Voir callage Griotte chambertin par
     exemple.

**** Sur les lieux dits

#+begin_src R
library(rgdal)
CCOM <- readOGR("Carto/", "COML93")
ClCom <- read.csv("Data/ClassCom.csv", sep= ";")
names(ClCom)[ 1] <- "INSEE_COM"
tmpCom <- merge(CCOM, ClCom[-18, c(1, 3)], by= "INSEE_COM")
MapCom <- subset(tmpCom, tmpCom$INSEE_COM %in% c("21231",Geo.Cada$CODECOM),
                 select= c(3, 4, 8, 9, 13, 19))
writeOGR(MapCom, "Carto/", "MapCom", "ESRI Shapefile")

DatCom <- subset(tmpCom, tmpCom$INSEE_COM %in% Geo.Cada$CODECOM,
                 select= c(1, 4, 6, 7, 10, 11, 12, 13, 19))
names(DatCom) <- c("CODECOM", "LIBCOM", "XCHF", "YCHF",
                   "ALTCOM", "SUPCOM", "POPCOM", "CODECANT", "REGION")
MapLieuDits <- readOGR("Data/LieuxDits/Abziz", "COTE_NB21", verb= F)
MapLieuDits <- spTransform(MapLieuDits, proj4string(Geo.Cada))
names(MapLieuDits)[ c(2, 4, 6)] <- c("CODECOM", "LIEUDIT", "CLDVIN")
LieuDit <- merge(MapLieuDits[, c(2, 4, 6)], DatCom, by= "CODECOM")
writeOGR(Lieu.Dit, "./Carto/", "LieuDit", "ESRI Shapefile")
#+end_src

*** Les AOC à la parcelle cadastrale

    L'unité géographique de base est la parcelle cadastrale dont la
    géométrie est issue de la BD parcellaire de l'IGN version 2014
    pour la Côte-d'Or téléchargée le XX/XX/2018.  Ces données sont
    disponibles gratuitement pour la recherche, elle ne peuvent pas
    faire l'objet d'une diffusion à l'état brut.  Trois traitements
    ont été effectués au préalable et ne sont pas reportés en détail
    ici.  Nous avons calculé avec un système d'information
    géographique les caractéristiques géométriques (surface,
    périmètre, et distance maximale entre deux sommets).  Nous avons
    ensuite créé un identifiant pour apparier les parcelles avec les
    données du modèle numérique de terrain présenté dans la
    sous-section suivante.  Nous avons enfin apparié les délimitations
    parcellaire des AOC Viticoles de l'INAO disponible à l'adresse
    \url{https://www.data.gouv.fr/fr/datasets/delimitation-parcellaire-des-aoc-viticoles-de-linao}
    sous licence ouverte.  Les codes R correspondants à ces opérations
    sont reportés en Annexe A.1.1.

#+begin_src R :exports results :results value :colnames yes :rownames no
(labs <- data.frame(NOM= paste0("=", c("IDU", "CODECOM", "AREA", "PERIM",
                                       "MAXDIST", "PAR2RAS","PAOC", "BGOR",
                                       "BOUR", "VILL", "COMM", "PCRU",
                                       "GCRU", "AOC","AOCtp", "AOClb"),
                                "="), "",
                    TYPE= c(rep("/Caractère/", 2), rep("/Numérique/", 4),
                            rep("/Indicatrice/", 7), "/Numérique/",
                            rep("/Caractère/", 2)), "",
                    DESCRIPTION=
                        c("Identifiant de la parcelle cadastrale (14 caractères)",
                          "Code INSEE de la commune d'appartenance (5 caractères)",
                          "Surface calculée de la parcelle cadastrale (en mètres carrés)",
                          "Périmètre calculé de la parcelle cadastrale (en mètres)",
                          "Distance maximale calculée entre deux sommets (en mètres)",
                          "Identifiant pour appariement avec le modèle numérique de terrain",
                          "1 si la parcelle est dans au moins une AOC",
                          "1 si la parcelle est dans le niveau Coteaux Bourguignon",
                          "1 si la parcelle est dans le niveau Bourgogne Régional",
                          "1 si la parcelle est dans le niveau Bourgogne Village",
                          "1 si la parcelle est dans le niveau Bourgogne Communal",
                          "1 si la parcelle est dans le niveau Premier Cru",
                          "1 si la parcelle est dans le niveau Grand Cru",
                          "Rang de la parcelle dans la hiérarchie des AOC (entre 0 et 5)",
                          "=Appel= si le libellé est une appellation, =Denom= pour dénomination",
                          "Libellé de l'appellation ou de la dénomination selon la variable =AOCtp=")))
#+end_src

#+ATTR_LATEX: :environment tabularx :width \textwidth :align llllX
#+CAPTION: *Nom, type et description des variables disponibles au niveau des parcelles cadastrales*
#+NAME: Tab:1
#+RESULTS:
| NOM       |   | TYPE          |   | DESCRIPTION                                                              |
|-----------+---+---------------+---+--------------------------------------------------------------------------|
| =IDU=     |   | /Caractère/   |   | Identifiant de la parcelle cadastrale (14 caractères)                    |
| =CODECOM= |   | /Caractère/   |   | Code INSEE de la commune d'appartenance (5 caractères)                   |
| =AREA=    |   | /Numérique/   |   | Surface calculée de la parcelle cadastrale (en mètres carrés)            |
| =PERIM=   |   | /Numérique/   |   | Périmètre calculé de la parcelle cadastrale (en mètres)                  |
| =MAXDIST= |   | /Numérique/   |   | Distance maximale calculée entre deux sommets (en mètres)                |
| =PAR2RAS= |   | /Numérique/   |   | Identifiant pour appariement avec le modèle numérique de terrain         |
| =PAOC=    |   | /Indicatrice/ |   | 1 si la parcelle est dans au moins une AOC                               |
| =BGOR=    |   | /Indicatrice/ |   | 1 si la parcelle est dans le niveau Coteaux Bourguignon                  |
| =BOUR=    |   | /Indicatrice/ |   | 1 si la parcelle est dans le niveau Bourgogne Régional                   |
| =VILL=    |   | /Indicatrice/ |   | 1 si la parcelle est dans le niveau Bourgogne Village                    |
| =COMM=    |   | /Indicatrice/ |   | 1 si la parcelle est dans le niveau Bourgogne Communal                   |
| =PCRU=    |   | /Indicatrice/ |   | 1 si la parcelle est dans le niveau Premier Cru                          |
| =GCRU=    |   | /Indicatrice/ |   | 1 si la parcelle est dans le niveau Grand Cru                            |
| =AOC=     |   | /Numérique/   |   | Rang de la parcelle dans la hiérarchie des AOC (entre 0 et 5)            |
| =AOCtp=   |   | /Caractère/   |   | =Appel= si le libellé est une appellation, =Denom= pour dénomination     |
| =AOClb=   |   | /Caractère/   |   | Libellé de l'appellation ou de la dénomination selon la variable =AOCtp= |

    L'objet =Geo.Cad=, de la classe =SpatialPolygonsDataFrame=
    associée au package =sp=, contient $110\,350$ parcelles et 16
    variables que la Table [[Tab:1]] suivante présente plus en détails.
    L'information issue de la superposition avec la couche INAO sur
    les AOC est présente dans les variables =PAOC= à =GCRU=.  Les
    $49\,718$ valeurs manquantes qui apparaissent correspondent aux
    parcelles hors périmètres AOC.  Nous avons retravaillé
    l'information brute des données INAO dans les trois variables
    =AOC=, =AOCtp= et =AOClb= qui sont plus opérationnelles pour
    l'analyse statistique.  Selon le principe des replis de la
    doctrine de l'INAO, les parcelles d'un niveau hiérarchique
    supérieur peuvent toujours être revendiquées dans un niveau
    inférieur.  La superposition des couches de l'INAO conduit à la
    présence de plusieurs AOC sur une même parcelle, ce qui entre en
    contradiction avec une autre partie de la doctrine de l'INAO, à
    savoir qu'il est interdit de revendiquer des AOC différentes pour
    un même produit.  Dans les faits, les producteurs revendiquent
    très souvent l'AOC maximale à laquelle ils peuvent prétendre.  La
    variable =AOC= représente cette valeur pour chacune des parcelles,
    elle est codée =0= pour les parcelles hors AOC, =1= pour les
    Coteaux bourguignons, =2= pour les Bourgognes régionaux, jusqu'à
    =5= pour les Grands crus.  Par contre, les informations présentes
    sur l'étiquette des vins peuvent être des appellations ou des
    dénominations au sein du système des AOC (même si cette
    distinction n'est pas toujours claires pour les consommateurs,
    nous utilisons AOC comme le terme générique qui englobe les deux
    dimensions en précisant lorsque c'est nécessaire).  Le libellé
    =AOClb= contient donc généralement le nom de l'appellation
    maximale de la parcelle, sauf pour les Bourgognes régionaux (ou la
    dénomination Bourgogne côte d'or est plus haute dans la hiérarchie
    mais peu utilisée du fait de sa faible antériorité, l'appellation
    a été crée en 2015) et les Premiers Crus (dont l'appellation ne
    fait référence qu'au village alors que les dénominations
    permettent d'identifier les parcelles).

*** Enrichissement de la topographie

    Les données sur l'altimétrie sont issues du modèle numérique de
    terrain RGE ALTI\textsuperscript{\textregistered} 5m (IGN), sous
    licence XX.  Un premier traitement non reporté a été l'attribution
    de l'identifiant =PAR2RAS= aux cellules du raster par
    superposition avec le fond vectoriel présenté précédemment.
    @@latex:\textcolor{green}{Nous avons ensuite enrichi les données
    raster d'un mode d'occupation des sol (Hilal et al., 2018)}@@.
    Nous avons enfin calculé les variables que sont l'altitude, la
    pente, l'exposition et les radiations solaires
    @@latex:\textcolor{green}{ plus détails sur les calculs }@@.  À
    partir des plus de 14 millions de cellules pour 13 variables, le
    code en Annexe permet l'agrégation des variables raster au niveau
    des parcelles.  Pour le passage des variables altimétriques
    initialement disponibles au format raster vers les parcelles au
    format vectoriel, nous calculons des moyennes à l'échelle des
    parcelles, sachant que d'autres méthodes d'agrégation ont été
    utilisées sans différences notables sur les résultats.

#+begin_src R :exports results :results value :colnames yes :rownames no
(labt <- data.frame(
     NOM= paste0("=", c("XL93", "YL93", "NOMOS", "URBAN",
                        "FOREST", "WATER", "DEM", "SLOPE",
                        "ASPECT", "SOLAR"), "="),
     "", TYPE= rep("/Numérique/", 10), "",
     DESCRIPTION=
         c("Latitude du centroïde de la parcelle (système Lambert 93)",
           "Longitude du centroïde de la parcelle (système Lambert 93)",
           "Part de la parcelle hors du mode d'occupation des sol (entre 0 et 1)",
           "Part de la parcelle en usage urbain selon le MOS (entre 0 et 1)",
           "Part de la parcelle en usage forestier selon le MOS (entre 0 et 1)",
           "Part de la parcelle en eau selon le MOS (entre 0 et 1)",
           "Altitude moyenne de la parcelle selon le MNT (en mètres)",
           "Pente moyenne de la parcelle selon le MNT (en degrés)",
           "Exposition moyenne de la parcelle selon le MNT (en degrés)",
           "Radiation solaire moyenne sur la parcelle (en Joules)")))
#+end_src

#+ATTR_LATEX: :environment tabularx :width \textwidth :align llllX
#+CAPTION: *Nom, type et description des variables topographiques à la parcelle*
#+NAME: Tab:2
#+RESULTS:
| NOM      |   | TYPE        |   | DESCRIPTION                                                          |
|----------+---+-------------+---+----------------------------------------------------------------------|
| =XL93=   |   | /Numérique/ |   | Latitude du centroïde de la parcelle (système Lambert 93)            |
| =YL93=   |   | /Numérique/ |   | Longitude du centroïde de la parcelle (système Lambert 93)           |
| =NOMOS=  |   | /Numérique/ |   | Part de la parcelle hors du mode d'occupation des sol (entre 0 et 1) |
| =URBAN=  |   | /Numérique/ |   | Part de la parcelle en usage urbain selon le MOS (entre 0 et 1)      |
| =FOREST= |   | /Numérique/ |   | Part de la parcelle en usage forestier selon le MOS (entre 0 et 1)   |
| =WATER=  |   | /Numérique/ |   | Part de la parcelle en eau selon le MOS (entre 0 et 1)               |
| =DEM=    |   | /Numérique/ |   | Altitude moyenne de la parcelle selon le MNT (en mètres)             |
| =SLOPE=  |   | /Numérique/ |   | Pente moyenne de la parcelle selon le MNT (en degrés)                |
| =ASPECT= |   | /Numérique/ |   | Exposition moyenne de la parcelle selon le MNT (en degrés)           |
| =SOLAR=  |   | /Numérique/ |   | Radiation solaire moyenne sur la parcelle (en Joules)                |

    Les codes qui permettent l'appariement sont reportés en Annexe
    A.1.2, le dictionnaire des variables topographiques est reporté
    dans la Table [[Tab:2]].  Nous obtenons $2\,096$ valeurs manquantes
    pour lesquelles le code =PAR2RAS= des parcelles ne s'apparie à
    aucune cellule raster (résultat reporté en Annexe A.1.2).  Ces
    parcelles qui présentent des valeurs manquantes sont conservées
    dans la base, bien que ce soient de très petites parcelles avec
    des géométrie particulières et font penser à des "erreurs" du
    cadastre.  Nous les enlèverons au moment de l'analyse statistique
    sachant que cela revient à enlever 2.7 ha, moins de 0.01 % de la
    surface totale de la zone.  Nous n'utilisons qu'un sous ensemble
    du MOS lié aux modes d'occupation non agricoles, principalement
    afin de pouvoir les exclure si nécessaire.

*** Enrichissement de la géologie

    Les données géologiques sont issues de la Bd Charm-50 du BRGM à
    l'échelle $1/50\,000$ disponible sur le site
    http://infoterre.brgm.fr sous licence Ouverte.  Nous utilisons ici
    une extraction du fichier =GEO050K_HARM_021_S_FGEOL_CGH_2154=
    effectuée en avril 2019 pour le département de la Côte-d'Or.  Le
    seul travail non reporté sur ces données est une sélection des
    variables qui contiennent moins de 5% de valeurs manquantes et qui
    présentent des variations (c'est-à-dire une variance non nulle)
    sur la zone considérée.  L'appariement des polygones géologiques
    avec le parcellaire cadastral est effectué par les centroïdes des
    parcelles (voir code en Annexe A.1.3), la faible taille moyenne
    des parcelles sous AOC (moins de 0.2 ha de moyenne) permet de
    s'assurer de la validité de cette procédure.

#+begin_src R :exports results :results value :colnames yes :rownames no
(labu <-
     data.frame(NOM= paste0("=", c("CODE", "NOTATION", "DESCR", "TYPEGEOL",
                                   "APLOCALE", "TYPEAP", "GEOLNAT",
                                   "ISOPIQUE", "AGEDEB", "ERADEB",
                                   "SYSDEB", "LITHOLOGIE", "DURETE",
                                   "ENVIRONMT","GEOCHIMIE", "LITHOCOM"),
                            "="), "",
                TYPE= rep("/Caractère/", 16), "",
                DESCRIPTION=
                    c("Code de la géologie (31 modalités)",
                      "Notation géologie (31 modalités)",
                      "Description géologie (31 modalités)",
                      "Type superficiel (4 modalités)",
                      "Colluvions, Eboulis, etc. (28 modalités)",
                      "Type de formation (7 modalités)",
                      "Nature Géologique (3 modalités)",
                      "Faciès des couches (4 modalités)",
                      "Age de la couche (24 modalités)",
                      "Céno ou Méso (2 modalités)",
                      "Age autre (5 modalités)",
                      "Litho (16 modalités)", "Dureté (3 modalités)",
                      "Environnement (9 modalités)",
                      "Géochimie (5 modalités)",
                      "Litho détaillée (30 modalités)")))
#+end_src

#+ATTR_LATEX: :environment tabularx :width \textwidth :align llllX
#+CAPTION: *Nom, type et description des variables issues des données géologiques*
#+NAME: Tab:3
#+RESULTS:
| NOM          |   | TYPE        |   | DESCRIPTION                              |
|--------------+---+-------------+---+------------------------------------------|
| =CODE=       |   | /Caractère/ |   | Code de la géologie (31 modalités)       |
| =NOTATION=   |   | /Caractère/ |   | Notation géologie (31 modalités)         |
| =DESCR=      |   | /Caractère/ |   | Description géologie (31 modalités)      |
| =TYPEGEOL=   |   | /Caractère/ |   | Type superficiel (4 modalités)           |
| =APLOCALE=   |   | /Caractère/ |   | Colluvions, Eboulis, etc. (28 modalités) |
| =TYPEAP=     |   | /Caractère/ |   | Type de formation (7 modalités)          |
| =GEOLNAT=    |   | /Caractère/ |   | Nature Géologique (3 modalités)          |
| =ISOPIQUE=   |   | /Caractère/ |   | Faciès des couches (4 modalités)         |
| =AGEDEB=     |   | /Caractère/ |   | Age de la couche (24 modalités)          |
| =ERADEB=     |   | /Caractère/ |   | Céno ou Méso (2 modalités)               |
| =SYSDEB=     |   | /Caractère/ |   | Age autre (5 modalités)                  |
| =LITHOLOGIE= |   | /Caractère/ |   | Litho (16 modalités)                     |
| =DURETE=     |   | /Caractère/ |   | Dureté (3 modalités)                     |
| =ENVIRONMT=  |   | /Caractère/ |   | Environnement (9 modalités)              |
| =GEOCHIMIE=  |   | /Caractère/ |   | Géochimie (5 modalités)                  |
| =LITHOCOM=   |   | /Caractère/ |   | Litho détaillée (30 modalités)           |
    
    Le détail des 16 variables géologiques issues de la procédure est
    disponible dans la Table [[Tab:3]].  La description des variables
    manque de précision car les données géologiques ne possèdent pas
    encore, à notre connaissance, de dictionnaire exploitable.  Ce
    manque de précision n'est pas décisif pour l'analyse statistique
    que nous effectuons (il peut l'être pour d'autres usages) car les
    variables géologiques sont utilisées par le biais d'effets fixes
    (c'est-à-dire de variables indicatrices) qui permettent de
    s'affranchir de la nécessité de spécifier les relations entre les
    variables géologiques et les AOC.  Cette méthode est par ailleurs
    la plus générale pour contrôler l'hétérogénéité associée à la
    géologie, car elle permet de s'affranchir d'hypothèses sur la
    spécification des effets.  Comme nous le voyons an Annexe A.1.3,
    les parcelles non appariées qui produisent des valeurs manquantes
    sont peut nombreuses (entre 31 et 862 selon les variables) et
    seront négligées au moment de l'analyse statistique sans
    conséquences.  

*** Enrichissement de la pédologie

    Les données pédologiques sont extraites du Référentiel Pédologique
    de Bourgogne : Régions naturelles, pédopaysage et sols de
    Côte-d'Or (étude 25021, Gis Sol) à l'échelle $1/250\,000$,
    compatible avec la base de données nationale DoneSol, sous licence
    XX (Chrétien, 1998).  La localisation des types de sol et
    l'appariement avec le cadastre s'opèrent par les 194 Unités
    Cartographiques de Sols de la zone, qui sont des polygones plutôt
    homogènes en termes de pédo-paysages, bien qu'ils contiennent
    différents types de sols.  Ces derniers, regroupés en unités
    typologiques, ne peuvent pas être localisés plus précisément, ce
    qui est un limite importante pour leur usage à l'échelle
    parcellaire citep:Ay11.  En l'absence de données plus fines
    spatialement, les données parcellaires seront enrichies du code
    des unités cartographiques et des valeurs de l'unité typologique
    dominante, c'est-à-dire celle qui est la plus étendue au sein de
    chaque unité cartographique.  Comme pour la géologie, les données
    pédologiques seront utilisées par des effets fixes au niveau des
    unités cartographiques, ce qui fait que cette procédure de
    traitement de l'information n'est pas limitante (elle peut
    cependant l'être pour d'autres usages).  Les libellés des unités
    cartographiques reportés dans la variable =DESCRp= sont obtenus
    par un travail manuel à partir du site
    https://bourgogne.websol.fr/carto, les codes utilisés pour
    l'appariement des données pédologiques à partir des centroïdes des
    parcelles sont présentés en Annexe A.1.4.

#+begin_src R :exports results :results value :colnames yes :rownames no
(labv <- data.frame(
     NOM= paste0("=", c("NOUC", "SURFUC", "TARG", "TSAB", "TLIM",
                       "TEXTAG", "EPAIS", "TEG", "TMO", "RUE",
                       "RUD", "OCCUP", "DESCRp"), "="), "",
     TYPE= c("/Caractère/", rep("/Numérique/", 4), "/Caractère/",
             rep("/Numérique/", 6), "/Caractère/"), "",     
     DESCRIPTION=
         c("Numéro de l'unité cartographique (2 caractères)",
           "Surface de l'unité cartographique (en hectares)",
           "Taux d'argile de l'unité typologique dominante (pourcentage)",
           "Taux de sable de l'unité typologique dominante (pourcentage)",
           "Taux de limons de l'unité typologique dominante (pourcentage)",
           "Classes de textures agrégées en 9 modalités (voir Ay, 2011)",
           "Épaisseur des sols de l'unité typologique dominante (centimètre)",
           "Taux d'éléments grossiers de l'unité typologique dominante (pour mille)",
           "Taux de Matière organique de l'unité typologique dominante (pourcentage)",
           "Réserve Utile par excès de l'unité typologique dominante (millimètre)",
           "Réserve Utile par défaut de l'unité typologique dominante (millimètre)",
           "Part de l'unité typologique dominante dans l'unité carto (entre 0 et 1)",
           "Libellé de la classe pédologique en 33 modalités")))
#+end_src

#+ATTR_LATEX: :environment tabularx :width \textwidth :align llllX
#+CAPTION: *Nom, type et description des variables issues des données pédologiques*
#+NAME: Tab:4
#+RESULTS:
| NOM      |   | TYPE        |   | DESCRIPTION                                                              |
|----------+---+-------------+---+--------------------------------------------------------------------------|
| =NOUC=   |   | /Caractère/ |   | Numéro de l'unité cartographique (2 caractères)                          |
| =SURFUC= |   | /Numérique/ |   | Surface de l'unité cartographique (en hectares)                          |
| =TARG=   |   | /Numérique/ |   | Taux d'argile de l'unité typologique dominante (pourcentage)             |
| =TSAB=   |   | /Numérique/ |   | Taux de sable de l'unité typologique dominante (pourcentage)             |
| =TLIM=   |   | /Numérique/ |   | Taux de limons de l'unité typologique dominante (pourcentage)            |
| =TEXTAG= |   | /Caractère/ |   | Classes de textures agrégées en 9 modalités (voir Ay, 2011)              |
| =EPAIS=  |   | /Numérique/ |   | Épaisseur des sols de l'unité typologique dominante (centimètre)         |
| =TEG=    |   | /Numérique/ |   | Taux d'éléments grossiers de l'unité typologique dominante (pour mille)  |
| =TMO=    |   | /Numérique/ |   | Taux de Matière organique de l'unité typologique dominante (pourcentage) |
| =RUE=    |   | /Numérique/ |   | Réserve Utile par excès de l'unité typologique dominante (millimètre)    |
| =RUD=    |   | /Numérique/ |   | Réserve Utile par défaut de l'unité typologique dominante (millimètre)   |
| =OCCUP=  |   | /Numérique/ |   | Part de l'unité typologique dominante dans l'unité carto (entre 0 et 1)  |
| =DESCRp= |   | /Caractère/ |   | Libellé de la classe pédologique en 33 modalités                         |

    Le détails des 13 variables pédologiques issues de la procédure
    sont disponibles dans la Table [[Tab:4]].  Les valeurs manquantes
    associées aux parcelles non couvertes par la pédologie sont assez
    importantes : $14\,645$ parcelles cadastrales, soient environ
    4.25% des surfaces de la zone.  Ces parcelles non couvertes sont
    en revanche peu désignées en AOC (moins de 1% des AOC ont des
    variables pédologiques manquantes), il s'agit donc très peu de
    vignes.  Une explication intuitive de ces valeur manquantes est
    l'absence de données pédologiques sur les sols artificialisés,
    cette interprétation étant corroborée par la cartographie de ces
    zones.  Par contre, ce résultat ne se retrouve pas réellement à
    partir des usages urbains du MOS.  La question de l'échelle des
    données est ainsi déterminante car les unités cartographiques pour
    lesquelles les variables pédologiques manques peuvent regrouper
    des modes d'occupation du sol très différents.

*** Enrichissement des AOC historiques

    Les AOC en vigueur à la création de l'INAO en 1936 nous ont été
    transmises par la Maison des Sciences de l'Homme de Dijon avec
    l'aide de Florian Humbert.  Un travail préalable a été effectué
    pour obtenir les AOC que nous référons à 1936 alors qu'il s'agit
    d'une compilation des différentes années de 1936 à 1940.  La
    localisation est toujours effectuée par le centroïde des parcelles
    cadastrales car la géométrie des polygones ne correspond pas
    parfaitement (à la fois par la numérisation des cartes historiques
    et parce que le cadastre a changé).  Encore une fois, la faible
    taille des parcelle permet d'avoir confiance en cette procédure
    d'appariement qui a été confirmée visuellement dans le détails.
    Le code pour cette procédure d'appariement est reporté en Annexe
    A.1.5.

#+begin_src R :exports results :results value :colnames yes :rownames no
(laba <- data.frame(
     NOM= paste0("=", c("AOC36lab", "AOC36lvl"), "="), "",
     TYPE= rep("/Caractère/", 2), "",     
     DESCRIPTION=
         c("Libellé de l'appellation en 1936 (56 modalités)",
           "Rang de la parcelle dans la hiérarchie des AOC (0, 3 ou 5)")))
#+end_src

#+ATTR_LATEX: :environment tabularx :width \textwidth :align llllX
#+CAPTION: *Nom, type et description des variables issues des AOC historiques*
#+NAME: Tab:5
#+RESULTS:
| NOM        |   | TYPE        |   | DESCRIPTION                                                |
|------------+---+-------------+---+------------------------------------------------------------|
| =AOC36lab= |   | /Caractère/ |   | Libellé de l'appellation en 1936 (56 modalités)            |
| =AOC36lvl= |   | /Caractère/ |   | Rang de la parcelle dans la hiérarchie des AOC (0, 3 ou 5) |
    
    Nous obtenons des aires sous AOC sensiblement plus réduites que
    pour les AOC actuelles, elles représentent 27% au lieu de 55% des
    parcelles.  Hormis un creux en 1938, entre 10 et 15% des parcelles
    sont classées chaque années, sachant toutefois qu'il y a du double
    compte avec des parcelles qui changent d'AOC.  Les dénominations
    géographiques complémentaires, les Premiers crus en particulier,
    n'apparaissent pas dans ce données car ils n'existaient tout
    simplement pas.  Le décret instaurant les Premiers crus fut adopté
    en 1943.  Notons que ces AOC historiques sont issus de deux
    classements préalables (bien que non officiels): celui de Jules
    Lavalle de 1855 et le Classement du Comité d’Agriculture et de
    Viticulture de l'Arrondissement de Beaune de 1860.  Ces données
    sur les AOC de 1936 ne sont pas spécifiquement utilisées dans la
    suite du présent article, mais le sont dans cite:Ay19, et
    pourraient l'être dans toute utilisation alternative des données
    issues de cette recherche.

*** Enrichissement des lieux dits

    Un dernier enrichissement de la base des parcelles cadastrales
    provient de l'information cadastrale d'une source alternative
    disponible sur =data.gouv.fr=.  Nous utilisons en effet le Plan
    Cadastral Informatisé Vecteur
    https://cadastre.data.gouv.fr/datasets/plan-cadastral-informatise
    téléchargé pour la Côte-d'Or (21) en janvier 2019.  C'est données
    sont en License ouverte Etalab, elles nous permettent d'obtenir
    les lieux dits pour les parcelles qui sont en niveau Village,
    Bourgogne, et Coteaux bourguignons.  Une difficulté avec les lieux
    dit est que leur intitulés doivent être croisés avec ceux des
    communes car un même nom de lieu dit peut être présent sur
    plusieurs communes.  Comme la géométrie des lieux dits et des
    parcelles colle parfaitement, nous pouvons enrichir les données
    parcellaires directement par le centroïde.  Nous profitons de la
    procédure pour inclure des données communales, en particulier, les
    coordonnées des chefs-lieux pour calculer une distance à vol
    d'oiseaux, la population et la distinction côte de Beaune / côte
    de Nuits qui peut se révéler pertinente.  Nous enregistrons
    également un shapefile =MapCom= qui permet de cartographier les
    contours communaux dans les figures de l'article.  Le détails des
    codes est reporté en Annexe A.1.6.

#+begin_src R :exports results :results value :colnames yes :rownames no
(labd <- data.frame(
     NOM= paste0("=", c("LIEUDIT", "CLDVIN", "LIBCOM", "XCHF", "YCHF",
                        "ALTCOM", "SUPCOM", "POPCOM", "CODECANT",
                        "REGION"), "="), "",
     TYPE= c(rep("/Caractère/", 3), rep("/Numérique/", 3),
             "/Caractère/", "/Numérique/", "/Caractère/", "/Caractère/"),
     "",     
     DESCRIPTION=
         c("Libellé du lieu dit de la parcelle (2691 modalités)",
           "Identifiant du lieu dit de la parcelle (2691 modalités)",
           "Libellé de la commune de la parcelle (31 modalités)",
           "Latitude du chef-lieu de la commune (système Lambert 93)",
           "Longitude du chef-lieu de la commune (système Lambert 93)",
           "Altitude du point culminant de la commune (mètre)",
           "Superficie de la commune de la parcelle (hectare)",
           "Population de la commune de la parcelle en 2015 (millier d'hab)",
           "Identifiant du canton d'appartenance (2 caractères)",
           "Region viticole (=CDB= pour côte de Beaune, =CDN= pour côte de Nuits)")))
#+end_src

#+ATTR_LATEX: :environment tabularx :width \textwidth :align llllX
#+CAPTION: *Nom, type et description des variables issues des lieux dits*
#+NAME: Tab:6
#+RESULTS:
| NOM        |   | TYPE        |   | DESCRIPTION                                                           |
|------------+---+-------------+---+-----------------------------------------------------------------------|
| =LIEUDIT=  |   | /Caractère/ |   | Libellé du lieu dit de la parcelle (2691 modalités)                   |
| =CLDVIN=   |   | /Caractère/ |   | Identifiant du lieu dit de la parcelle (2691 modalités)               |
| =LIBCOM=   |   | /Caractère/ |   | Libellé de la commune de la parcelle (31 modalités)                   |
| =XCHF=     |   | /Numérique/ |   | Latitude du chef-lieu de la commune (système Lambert 93)              |
| =YCHF=     |   | /Numérique/ |   | Longitude du chef-lieu de la commune (système Lambert 93)             |
| =ALTCOM=   |   | /Numérique/ |   | Altitude du point culminant de la commune (mètre)                     |
| =SUPCOM=   |   | /Caractère/ |   | Superficie de la commune de la parcelle (hectare)                     |
| =POPCOM=   |   | /Numérique/ |   | Population de la commune de la parcelle en 2015 (millier d'hab)       |
| =CODECANT= |   | /Caractère/ |   | Identifiant du canton d'appartenance (2 caractères)                   |
| =REGION=   |   | /Caractère/ |   | Region viticole (=CDB= pour côte de Beaune, =CDN= pour côte de Nuits) |

    Nous observons en Annexe qu'aucun lieu dit n'a été apparié 4% des
    parcelles.  Ces parcelles se concentrent sur les communes de
    Chenôve, Marsannay-la-Côte et Beaune (Corgoloin dans une moindre
    mesure).  Ces valeurs manquantes apparaissent déjà dans le fichier
    source et ne sont donc pas un résultat de l'appariement.  Ils
    semblent être des espaces bâtis visuellement, mais ce n'est
    toujours pas confirmé par le MOS à cause de la question de
    l'échelle.  @@latex:\textcolor{green}{Il peut sembler que ce sont
    les parcelles qui ont été modifiées (à confirmer dans PPL) ou il
    faut attendre la nouvelle actualisation du PCI}@@.  Dasn tous les
    cas, ces valeurs manquantes ne sont pas décisives pour l'analyse
    statistique présentée dans cet article.

*** Enregistrement de la base

    Ces différentes opérations aboutissent à la constitution d'une
    base de données géographiques disponibles sur le serveur de
    données de l'INRA [[https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN][https://data.inra.fr/]].  Ces données sont
    illustrées dans les deux cartes de la \autoref{Fig:1}, qui
    présentent l'altimétrie à une échelle fine et les AOC, dans leur
    dimension verticale (niveau hiérarchique) et leur dimension
    horizontale (commune d'appartenance).  Le téléchargement de ces
    données permet au lecteur d'exécuter les codes R reportés dans la
    suite de l'article, afin de reproduire nos résultats et de faire
    tourner l'application /Shiny/ localement.

#+begin_export latex
\vspace{.5cm}
\begin{figure}[!h]
  \caption{\textbf{Vignobles de la \emph{Côte d'Or}, topographie
      et appellations d'origine contrôlées}}\label{Fig:1}
  \centering\hspace{-2cm}
\begin{minipage}{.5\textwidth}
  \centering
 \includegraphics[scale= .4]{./Figures/MapCom1}
\end{minipage}%
\begin{minipage}{.5\textwidth}
  \centering
 \includegraphics[scale= .4]{./Figures/MapCom2}
\end{minipage}
\end{figure}\clearpage
#+end_export

*** Vérif 1 : anciens AOC INAO               :noexport:

    Il s'agit ici de vérifier la cohérence interne des nouveaux
    fichiers INAO et s'ils correspondent aux anciens. Nous joignons
    les deux couches en utilisant le centroïde des parcelles
    cadastrales (afin de déterminer dans quel polygone AOC ils
    tombent). Les anciens fichiers INAO contiennent une information
    simplifiée en 6 classes exclusives et cumulatives, que nous
    croisons avec les nouvelles données dans le code suivant. 

#+begin_src R :wrap example
BGOR <- readOGR(rpt <- "./Data/INAOlocal", "BGOR", verbose= F)
BOUR <- readOGR(rpt, "BOUR", ver= F) ; VILL <- readOGR(rpt, "VILL", ver= F)
PCRU <- readOGR(rpt, "PCRU", ver= F) ; GCRU <- readOGR(rpt, "GCRU", ver= F)
GCDtmp <- Geo.Cada@data ; coordinates(GCDtmp) <- coordinates(Geo.Cada)
proj4string(GCDtmp) <- proj4string(Geo.Cada)
Geo.Cada$AOC <- factor(ifelse(!is.na(over(GCDtmp, GCRU)[, 9]), "GCRU",
                       ifelse(!is.na(over(GCDtmp, PCRU)[, 9]), "PCRU",
                       ifelse(!is.na(over(GCDtmp, VILL)[, 9]), "VILL",
                       ifelse(!is.na(over(GCDtmp, BOUR)[, 9]), "BOUR",
                       ifelse(!is.na(over(GCDtmp, BGOR)[, 9]), "BGOR", "NONE"))))),
                       levels= c("NONE", "BGOR", "BOUR", "VILL", "PCRU", "GCRU"))
addmargins(apply(Geo.Cada@data[, c(19: 21, 24, 28, 27, 29, 26)],
                 2, function(x) table(x== 1, Geo.Cada$AOC)[2, ]))
#+end_src

#+RESULTS:
#+begin_example
      PAOC  BPTG  BGOR  BOUR  COMM  VILL  PCRU GCRU    Sum
NONE   369   201   201   349   136    23    20    3   1302
BGOR  9829  9829  9160     5     0     0     0    0  28823
BOUR 13494 13482 13482 13490     5     4     2    0  53959
VILL 26167 26111 26111 26166 23366 11524    10    0 139455
PCRU  8827  8812  8812  8826  7835  5389  8668    1  57170
GCRU  1946  1944  1944  1946  1944   173  1944 1943  13784
Sum  60632 60379 59710 50782 33286 17113 10644 1947 294493
 #+end_example

    Il y a $60\,632$ ($54.9\%$) parcelles de la zone qui ont une AOC
    viticole. La structure hiérarchique des AOC ferait que
    théoriquement sur l'ensemble de ces parcelles les AOC les moins
    prestigieuses peuvent être produites (Passe-Tout-Grain dans les
    tableau mais aussi Aligoté, Crémants et Mousseux, dont les aires
    sont identiques, résultats non reportés pour ces derniers). Nous
    obtenons une différence de 253 parcelles éparpillées sur toute la
    zone. 252 de ces parcelles sont classées en Bourgogne régional et 2
    sont classées en Premier cru (ce qui indique qu'une est classée à
    la fois Bourgogne régional et Premier cru). À part pour ces
    parcelles, la hiérarchie par rapport aux niveaux inférieurs est
    bien respectée. La hiérarchie se tient pour les Côteaux
    Bourguignons et les Bourgognes régionaux (hormis pour les 2
    parcelles de premiers crus mentionnées ci-avant). Il y a ensuite
    une certaine horizontalité entre =VILL= et =COMM=, on ne peut pas
    tester la consistance de la hiérarchie mais je dirais que le niveau
    Village final doit être la somme des deux. Tout se règle par
    l'échelle de la commune. Il y a $33\,286$ parcelles en appellation
    communale avec environ la moitié ($17\,877$) dans des communes sans
    appellation village et l'autre moitié ($15\,409$) dans des communes
    avec appellation village. Seule la commune de Beaune contient des
    parcelles avec =VILL= égal à 1 avec =COMM= égal à 0 ($N= 1\,704$),
    il faut les ajouter aux parcelles en appellation
    communale. (Retravailler le texte dans le papier.) La hiérarchie
    avec les premiers crus n'est pas vérifiée pour 94 parcelles (dont
    92 à Fixin et 2 à Brochon) à voir d'où vient l'erreur. Pour les
    Grands Crus c'est presque bon, ils peuvent tous peuvent se replier
    dans l'ensemble des autres appellations, sauf pour $1,774$
    parcelles grand cru localisées dans les communes de
    Chassagne-Montrachet et Puligny-Montrachet, où les Grands crus ne
    peuvent pas se replier en Village. Cela renforce le choix de sommer
    =VILL= et =COMM=, nous retrouverons la cohérence de la hiérarchie.

    Pour la comparaison avec les anciennes AOC, le triangle supérieur
    de la matrice monte une assez bonne cohérence (si on néglige la
    première ligne sur les parcelles hors AOC). Seulement 27 parcelles
    se retrouvent dans une AOC différente, leurs identifiants sont
    reportés en annexe 1. Pour les 369 parcelles qui étaient hors AOC
    dans les anciennes données (=AOC= = =NONE=) qui se retrouve avec
    des AOC dans les nouvelles, il pourrait s'agir de modifications
    parcellaires, les IDU sont reportées dans le fichier
    =./Inter/HorsAOC.csv= (script ci-dessous). Globalement, moyennant
    le traitement sur les communes et les villages, les nouvelles
    données sont cohérentes et correspondent aux anciens, donc nou ne
    retenons que ces nouveaux fichiers.

 #+begin_src R :results raw :file "Inter/HorsAOC.csv" :colnames yes
Geo.Cada@data[Geo.Cada$AOC== "NONE" &
              rowSums(Geo.Cada@data[, 19: 29])> 1, 18: 30]
 #+end_src

 #+RESULTS:
 [[file:Inter/HorsAOC.csv]]

*** Vérif 2: vignes dans le MOS              :noexport:

    Vérifications à l'échelle communale avec le Casier Viticole
    Informatisé 2015 sur lequel je travaille avec l'INAO. Les surfaces
    communales de vigne en 2015 sont disponibles dans le fichier
    =/Inter/CP2015.csv=. J'utilise également les surfaces produites par
    FranceAgriMer en 2016 (issues du projet avec Estelle).

#+begin_src R :results graphics :file "Figures/Verif2.pdf"
load("Inter/AocRank.Rda")
names(AocRank)
yop <- aggregate(AocRank@data[, 51: 62]* AocRank$Area/ 10000,
          by= list(AocRank$AOC), sum, na.rm= T)
row.names(yop) <- yop[, 1]
addmargins(round(as.matrix(yop[, -1], nrow= 6), 1))
yop

AocRank$SUPVIGNE <- AocRank$VINEYARD* AocRank$Area/ 10000
tmp <- aggregate(AocRank$SUPVIGNE, by=list(AocRank$CODECOM), sum, na.rm= T)
names(tmp)[ 1] <- "CODGEO"
FAM16 <- read.csv("~/bioEstelle/Data/NewData2016.csv", sep= ";")
tmp1 <- subset(FAM16, FAM16$CODECOM %in% levels(factor(tmp$CODGEO)))
names(tmp1)[ 5] <- "CODGEO"
CVI15 <- read.csv("Inter/CP2015.csv", sep= ";")
tmp2 <- subset(CVI15, CVI15$CODGEO %in%  levels(factor(tmp$CODGEO)))

tmp3 <- merge(tmp1, tmp2, by= "CODGEO")
plot(tmp3$SUPVIGNE, tmp3$TOTha)
tmp4 <- merge(tmp, tmp3, by= "CODGEO")
plot(tmp4$x, tmp4$TOTha,
     xlab= "Surfaces en vignes selon le MOS (ha)",
     ylab= "Surfaces en vignes selon le CVI (ha)")
abline(a= 0, b= 1)
names(tmp4)
tmp4[tmp4$x== 0 & tmp4$TOTha> 200, c("CODGEO", "NOMCOM", "TOTha")]
#+end_src

#+ATTR_LaTeX: :options scale= .35
#+Caption: *Relation entre les surfaces MOS et CVI pour les communes de la zone*
#+RESULTS:
[[file:Figures/Verif2.pdf]]

*** Lieux dits: actualisation PLUS TARD      :noexport:

    Pour les lieux dit la version cadastre retravaillée Etalab
    (https://www.data.gouv.fr/fr/datasets/cadastre/) serait suffisante
    mais le PCI contient plus de variables. Les sources sont dans le
    répertoire =/Data/PCI/dpt21/=, j'utilise alors l'extension
    =cadastre= de QGis pour générer des SpatiaLite par commune qui
    contiennent l'ensemble des informations disponibles dans le PCI. Il
    faut pour cela créer une base Spatialite pour chaque commune, que
    je localise dans le répertoire =/Data/PCI/SpatiaLite/= en utilisant
    le nom simplifié de chaque commune. Il faut ensuite localiser le
    répertoire des fichiers EDIGEO mettre la projection Lambert 93 en
    source et en cible mettre le code commune en lot et lancer
    l'export. Au redémarrage de QGis les fichiers exportés apparaissent
    dans l'explorateur, au niveau SpatiaLite.

#+begin_src R
rpt <- "Data/PCI/LieuxDits/"
map <- readOGR(rpt, "21166")
plot(map, border= "blue", add= T)
plot(Geo.CDem, add= T)
proj4string(map) <- proj4string(Geo.CDem)
yop <- over(Geo.CDem, map)
table(yop$tex)
#+end_src

** Statistiques descriptives
  :PROPERTIES:
  :CUSTOM_ID: Sec:2
  :END:
*** Sélection des données

    Nous commençons l'analyse par le chargement du fichier
    =GeoRas.Rda= issue du serveur data de l'INRA que l'utilisateur
    doit télécharger puis placer dans un répertoire =Inter/= à la
    racine utilisée par =R= (soit le répertoire renvoyé par la
    commande =getwd()=).  Les données peuvent également être
    consultées à partir des fichiers shapefile sur le serveur qui sont
    utilisables dans un système d'information géographique.  La
    première procédure à exécuter est présentée ci-dessous, elle
    consiste à :
    - Recoder les codes communaux selon le gradient Nord-Sud
    - Calculer la distance de chaque parcelle au chef lieu de sa commune
    - Centrer et réduire la variable sur les rayonnements solaires
    - Recoder la variable exposition en 8 catégories
    - Re-projeter les coordonnées dans le système WGS84
    - Enlever les valeurs manquantes de la base de données 

#+begin_src R :wrap example
library(sp) ; load("Inter/GeoRas.Rda")
tmp <- unique(Geo.Ras$LIBCOM[order(Geo.Ras$YCHF, decreasing= TRUE)])
Geo.Ras$LIBCOM <- factor(Geo.Ras$LIBCOM, levels= tmp)
Geo.Ras$DISTCHF <- sqrt((Geo.Ras$XL93- Geo.Ras$XCHF* 100)^2
                        + (Geo.Ras$YL93- Geo.Ras$YCHF* 100)^2)
Geo.Ras$RAYAT <- (Geo.Ras$SOLAR- mean(Geo.Ras$SOLAR, na.rm= TRUE))/
    sd(Geo.Ras$SOLAR, na.rm= TRUE)
Geo.Ras$EXPO <- cut(Geo.Ras$ASPECT,
                    breaks= c(-2, 45, 90, 135, 180, 225, 270, 315, 360))
GR84 <- spTransform(Geo.Ras, CRS("+proj=longlat +ellps=WGS84"))
dd <- coordinates(GR84) ; Geo.Ras$X= dd[, 1] ; Geo.Ras$Y= dd[, 2]
dim(Reg.Ras <- subset(Geo.Ras, !is.na(AOClb) & !is.na(DEM) & !is.na(DESCR)
                      & !is.na(RUD) & !is.na(AOC36lab) & !is.na(REGION)))
#+end_src

#+RESULTS:
#+begin_example

[1] 59113    72
#+end_example

     Nous obtenons une base de données qui contient $59\,113$
     observations utilisables pour estimer le modèle statistique.  Le
     principal critère de sélection des parcelles provient de la
     limitation aux parcelles ayant au moins une AOC.  Sur la zone,
     nous avons $60\,632$ ($=110\,350-49\,718$) parcelles dans ce cas,
     ce qui signifie que le retrait des valeurs manquantes cause la
     perte de seulement $1\,519$ parcelles ($=60\,632-59\,113$).

*** Distribution des AOC

    Nous pouvons désormais présenter plus en détails la distribution
    des AOC sur les parcelles, en particulier à partir des 2
    informations typiquement reportées sur les étiquettes des
    bouteilles de vins.  Une première information est de type
    verticale, elle consiste à mentionner le niveau de l'AOC dans la
    hiérarchie.  Cette information est contenue dans la variable
    =AOC=.  La deuxième information est de type horizontale, avec la
    mention de la commune d'appartenance de la parcelle, sans qu'il
    n'y ai de hiérarchie entre les communes.  Cette information est
    contenue dans la variable =LIBCOM=.  Le code ci-dessous permet de
    reproduire la Figure A.1 de cite:Ay19 avec les pourcentages de
    chaque niveau d'AOC au sein de chaque commune.

#+begin_src R :results graphics :height 9 :width 13 :file "./Figures/InterGIs.pdf"
library(lattice) ; library(RColorBrewer)
fig.dat <- aggregate(model.matrix(~0+ factor(Reg.Ras$AOC))*
                     Reg.Ras$AREA/ 1000, by= list(Reg.Ras$LIBCOM), sum)
names(fig.dat) <- c("LIBCOM", "BGOR", "BOUR", "VILL", "PCRU", "GCRU")
fig.dat$LIBCOM <- factor(fig.dat$LIBCOM, lev= rev(levels(fig.dat$LIBCOM)))
fig.crd <- t(apply(fig.dat[, -1], 1, function(t) cumsum(t)- t/2))
fig.lab <- round(t(apply(fig.dat[, -1], 1, function(t) t/ sum(t)))* 100)
my.pal  <- brewer.pal(n= 9, name = "BuPu")[ 2: 8]
barchart(LIBCOM~ BGOR+ BOUR+ VILL+ PCRU+ GCRU, xlim= c(-100, 10200),
         xlab="Surfaces sous appellation d'origine contrôlée (hectare)",
         data= fig.dat, horiz= T, stack= T, col= my.pal, border= "black",
         par.settings= list(superpose.polygon= list(col= my.pal)),
         auto.key= list(space= "top", points= F, rectangles= T, columns= 5,
                        text=c("Coteaux b.", "Bourgogne",
                               "Village", "Premier cru", "Grand cru")),
         panel=function(x, y, ...) {
             panel.grid(h= 0, v = -11, col= "grey60")
             panel.barchart(x, y, ...)
             ltext(fig.crd, y, lab= ifelse(fig.lab> 0, fig.lab, ""))})
#+end_src

#+CAPTION: *Distribution des niveaux des AOC entre les communes*
#+ATTR_LATEX: :options scale= .5
#+RESULTS:
[[file:./Figures/InterGIs.pdf]]

*** La pyramide des AOC

    Les AOC en Bourgogne sont souvent représentées sous forme
    pyramidale (voir par exemple
    https://www.vins-bourgogne.fr/plan-de-site/classification-des-appellations,2314,12208.html)
    selon le principe qu'en montant dans la hiérarchie les surfaces de
    vigne concernées deviennent moins importantes.  Cette structure
    pyramidale souvent présentée à l'échelle régionale (à l'échelle de
    la Bourgogne administrative) ne s'observe pas à l'échelle
    départementale.  Étant donné que nous travaillons sur un
    sous-échantillon des vignes de Bourgogne, limité au département de
    la Côte-d'Or, nous n'obtenons pas cette structure pyramidale comme
    en atteste la Figure ci-dessous.  Il apparaît que les AOC
    inférieures (Bourgogne régional, Coteaux bourguignons) sont
    sous-représentées, à la fois dans la côte de Beaune et la côte de
    Nuits.

#+begin_src R :results graphics :height 9 :width 13 :file "./Figures/PyramGIs.pdf"
ddd <- aggregate(Reg.Ras$AREA/ 10000,
                 by= list(Reg.Ras$AOC, Reg.Ras$REGION), sum, na.rm= TRUE)
names(ddd) <- c("AOC", "REGION", "SURFACES")
ddd$SURFACES[ddd$REGION== "CDB"] <- -ddd$SURFACES[ddd$REGION== "CDB"]
library(ggplot2)
ggplot(ddd, aes(x= AOC, y= SURFACES, fill= REGION))+ 
    geom_bar(data= subset(ddd, REGION== "CDB"), stat= "sum")+
    geom_bar(data= subset(ddd, REGION== "CDN"), stat= "sum")+
    coord_flip()+ theme_bw()+ ylab("Surfaces en hectares")+
    xlab("Niveau d'Indication Géographique")
#+end_src

#+Caption: *Surfaces des différents niveaux d'AOC au sein de la Côte d'Or*
#+ATTR_LATEX: :options scale= .4
#+RESULTS:
[[file:./Figures/PyramGIs.pdf]]

    Nous observons des distributions presque symétriques au sein des
    deux sous-régions viticoles avec un niveau village plus
    représenté, qui est même majoritaire pour la côte de Nuits.
    Notons également que la côte de Nuits apparaît comme relativement
    privilégiée par rapport à la côte de Beaune en termes de grands
    crus, mais compte moins de surfaces totales sous AOC.

#+Latex: \clearpage

*** Tableau des variables utilisées

    La distribution des variables utilisées dans l'analyse statistique
    est détaillé dans le \autoref{Tab:1}.  Nous observons des surfaces
    parcellaires faibles (moyenne de 0.2 ha), des altitudes comprises
    entre 200 et 500 m (moyenne à 286), des pentes entre 0 et 37
    (moyenne à 5.75) et des radiations solaires entre $581\,000$ et
    1.2 millions de Joules.  Les vignobles sous AOC sont globalement
    orientés à l'Est.

#+begin_src R :wrap "export latex"
Stat.Ras <- data.frame(Reg.Ras@data, model.matrix(~0+ factor(Reg.Ras$AOC)),
                       model.matrix(~ 0+ factor(Reg.Ras$EXPO)))
names(Stat.Ras)[73: 77] <- paste0("AOC", 1: 5)
names(Stat.Ras)[78: 85] <- paste0("EXPO", 1: 8)
Stat.Ras$AREA  <- Reg.Ras$AREA/ 1000
Stat.Ras$DEM   <- Reg.Ras$DEM/ 1000
Stat.Ras$SOLAR <- Reg.Ras$SOLAR/ 1000000
lab <- c(AREA= "Surface [1000 m$^2$]", DEM= "Altitude [1000 m]",
         SLOPE= "Pente [degrés]", SOLAR=  "Radiation solaire [millions J]",
         X= "Longitude [degrés]", Y= "Latitude [degrés]",
         AOC1= "Niveau AOC Coteaux", AOC2= "Niveau AOC Régional",
         AOC3= "Niveau AOC Village", AOC4= "Niveau AOC Premier Cru",
         AOC5= "Niveau AOC Grand Cru",
         EXPO1= "Exposition [$0-45$]"   , EXPO2= "Exposition [$45-90$]",
         EXPO3= "Exposition [$90-135$]" , EXPO4= "Exposition [$135-180$]",
         EXPO5= "Exposition [$180-225$]", EXPO6= "Exposition [$225-270$]",
         EXPO7= "Exposition [$270-315$]", EXPO8= "Exposition [$315-360$]") 
library(stargazer)          
stargazer(Stat.Ras[, names(lab)], covariate.labels=lab, font.size= "small",
          column.sep.width= "0pt", float= T, digit.separate= c(0, 3),
          title= "\\textbf{Statistiques descriptives des variables utilisées}")
#+end_src

#+RESULTS:
#+begin_export latex
% Table created by stargazer v.5.2.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: jeu., juin 27, 2019 - 09:53:09
\begin{table}[!htbp] \centering 
  \caption{\textbf{Statistiques descriptives des variables utilisées}} 
  \label{Tab:1} 
\small 
\begin{tabular}{@{\extracolsep{0pt}}lccccccc} 
                                                                                                                                                                                                                                   \\[-1.8ex]\hline 
\hline                                                                                                                                                                                                                             \\[-1.8ex] 
Statistic                      & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{Mean} & \multicolumn{1}{c}{St. Dev.} & \multicolumn{1}{c}{Min} & \multicolumn{1}{c}{Pctl(25)} & \multicolumn{1}{c}{Pctl(75)} & \multicolumn{1}{c}{Max} \\ 
\hline                                                                                                                                                                                                                             \\[-1.8ex] 
Surface [1000 m$^2$]           & 59113                 & 1.908                    & 3.399                        & 0.000                   & 0.517                        & 2.178                        & 177.200                 \\ 
Altitude [1000 m]              & 59113                 & 0.286                    & 0.056                        & 0.210                   & 0.241                        & 0.319                        & 0.505                   \\ 
Pente [degrés]                 & 59113                 & 5.772                    & 5.478                        & 0.000                   & 1.556                        & 8.747                        & 36.970                  \\ 
Radiation solaire [millions J] & 59113                 & 1.060                    & 0.049                        & 0.581                   & 1.048                        & 1.076                        & 1.230                   \\ 
Longitude [degrés]             & 59113                 & 4.837                    & 0.104                        & 4.665                   & 4.740                        & 4.955                        & 5.003                   \\ 
Latitude [degrés]              & 59113                 & 47.060                   & 0.110                        & 46.900                  & 46.980                       & 47.170                       & 47.300                  \\ 
Niveau AOC Coteaux             & 59113                 & 0.164                    & 0.370                        & 0                       & 0                            & 0                            & 1                       \\ 
Niveau AOC Régional            & 59113                 & 0.229                    & 0.420                        & 0                       & 0                            & 0                            & 1                       \\ 
Niveau AOC Village             & 59113                 & 0.428                    & 0.495                        & 0                       & 0                            & 1                            & 1                       \\ 
Niveau AOC Premier Cru         & 59113                 & 0.147                    & 0.354                        & 0                       & 0                            & 0                            & 1                       \\ 
Niveau AOC Grand Cru           & 59113                 & 0.032                    & 0.177                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$0-45$]            & 59113                 & 0.046                    & 0.210                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$45-90$]           & 59113                 & 0.186                    & 0.389                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$90-135$]          & 59113                 & 0.362                    & 0.481                        & 0                       & 0                            & 1                            & 1                       \\ 
Exposition [$135-180$]         & 59113                 & 0.212                    & 0.409                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$180-225$]         & 59113                 & 0.100                    & 0.300                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$225-270$]         & 59113                 & 0.044                    & 0.206                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$270-315$]         & 59113                 & 0.030                    & 0.170                        & 0                       & 0                            & 0                            & 1                       \\ 
Exposition [$315-360$]         & 59113                 & 0.021                    & 0.142                        & 0                       & 0                            & 0                            & 1                       \\ 
\hline                                                                                                                                                                                                                             \\[-1.8ex] 
\end{tabular} 
\end{table}
#+end_export

#+Latex: \clearpage

** Modèle statistique
  :PROPERTIES:
  :CUSTOM_ID: Sec:3
  :END:
*** Estimation du modèle

    Nous abordons désormais l'estimation du modèle statistique, dont
    le processus de spécification est présenté plus extensivement dans
    cite:Ay19.  Il s'agit d'estimer un modèle ordonné additivement
    semi-paramétrique (OGAM) qui prend en compte la structure
    hiérarchique des AOC de la zone, notée $y \in \{1, 2, 3, 4, 5\}$
    par ordre croissant.  Nous supposons que les désignations des AOC
    suivent une règle de décision basée sur une variable latente de
    qualité des vignes qui franchit des seuils différentiés selon la
    commune d'appartenance des parcelles.  Ainsi, en notant $X_i$ les
    variables biophysiques d'une vigne $i$ donnée $i= 1, \dots, N$, et
    $C_i$ le vecteur ligne de dimension 31, avec pour élément
    générique $c_{ih}$ égal à 1 si la vigne $i$ se situe dans la
    /commune/ $h$ et 0 sinon.  L'hypothèse d'une distribution
    logistique de la partie aléatoire des désignations AOC permet de
    déboucher sur un modèle de logit ordonné classique :
#+begin_export latex
\begin{equation}
\mbox{Prob}(y_{i}> j\mid X_i, C_i)= \Lambda\big[ B(X_i)^\top\beta+ C_i^\top\mu- \alpha_{j}\big],\label{Eq:Mod}
\end{equation}
#+end_export
    où $\Lambda$ est la fonction cumulative de la loi logistique.  Les
    déterminants humain qui impactent la classification AOC à partir
    des seuils de désignation sont pris en compte par des effets fixes
    communaux notés $\mu$.  En l'absence d'/a priori/ théoriques sur
    les effets des variables biophysiques $X_i$, nous les spécifions
    au travers d'une série de transformations /B-splines/ que nous
    notons $B(\cdot)$ avec $\beta$ leurs coefficients associés.  Le
    modèle est estimé avec la fonction =gam= du package =mgcv= comme
    décrit récemment par cite:WPSa16.  Le manuel d'utilisation de
    l'auteur du package cite:Wood17 contient de nombreux détails
    méthodologiques.

    Notons qu'en préalable à l'estimation, nous opérons un
    regroupement des unités géologiques et pédologiques afin de
    pouvoir les inclure comme des variables binaires dans le modèle.
    En effet, un nombre trop faible d'observation au sein d'une unité
    géologique ou pédologique diminue sensiblement la précision de
    l'estimation et peut poser des problèmes de convergence de
    l'algorithme de régression pénalisée.  Nous choisissons de ne
    retenir que les unités qui contiennent plus de $1\,000$ parcelles,
    d'autres valeurs ont été testées sans que cela change les
    résultats.  Notons également que le modèle que nous estimons opère
    un lissage spatial fin (avec un nombre maximal de degré de liberté
    effectifs de 900 sur les termes spatiaux) ce qui implique une
    procédure estimation assez longue (environ 9 heures avec un
    processeur Intel Core i7-7820HQ CPU 2.90 GHz x8 et 64 Go of RAM).
    D'autres modèles plus parcimonieux sont également présents dans
    l'objet =gamod.Rda= téléchargeable sur le [[https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN][serveur data de l'INRA]].
    Nous conseillons au lecteur de télécharger =gamod.Rda= plutôt que
    d'effectuer l'estimation en local du modèle, bien que les deux
    procédures peuvent être effectuées avec le code ci-dessous.
 
#+begin_src R :wrap example
Reg.Ras$NOTATION <- factor(Reg.Ras$NOTATION)
tmp <- table(Reg.Ras$NOTATION)< 1000
Reg.Ras$GEOL <- factor(
    ifelse(Reg.Ras$NOTATION %in% names(tmp[ tmp]), "0AREF",
           as.character(Reg.Ras$NOTATION)))
Reg.Ras$NOUC <- factor(Reg.Ras$NOUC)
tmp <- table(Reg.Ras$NOUC)< 1000
Reg.Ras$PEDO <- factor(
    ifelse(Reg.Ras$NOUC %in% names(tmp[tmp]), "0AREF",
           as.character(Reg.Ras$NOUC)))
library(mgcv) ; load("Inter/gamod.Rda")
## system.time(
##     gam900 <- gam(AOC~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO 
##                   + s(DEM)+ s(SLOPE)+ s(RAYAT)+ s(X, Y, k= 900)
##                 , data= Reg.Ras, family= ocat(R= 5))
## )
## utilisateur     système      écoulé 
##    32271.43       93.78    32366.00 
## save(gam900, file= "Inter/gam900.Rda")
anova(gamod$gam900)
#+end_src

#+RESULTS:
#+begin_example
Family: Ordered Categorical(-1,5.34,14.01,20.99) 
Link function: identity 

Formula:
AOC ~ 0 + LIBCOM + EXPO + GEOL + PEDO + s(DEM) + s(SLOPE) + s(RAYAT) + 
    s(X, Y, k = 900)

Parametric Terms:
       df Chi.sq p-value
LIBCOM 31   1363  <2e-16
EXPO    7    131  <2e-16
GEOL   14    441  <2e-16
PEDO   13    388  <2e-16

Approximate significance of smooth terms:
            edf Ref.df Chi.sq p-value
s(DEM)     8.81   8.98    867  <2e-16
s(SLOPE)   7.72   8.61    190  <2e-16
s(RAYAT)   7.33   8.38    531  <2e-16
s(X,Y)   841.42 870.01  86597  <2e-16
#+end_example

    Nous observons en sortie la significativité statistique des
    différentes variables au regard des statistiques de $\chi^2$.  Les
    coordonnées géographiques sont les variables explicatives les plus
    importantes, suivies des indicatrices communales, de l'altitude,
    du rayonnement solaire, de la géologie, de la pédologie, de la
    pente et enfin de l'exposition.  Ce modèle produit près de 90% de
    bonnes prédictions pour un pseudo R$^2$ (au sens de Mc Fadden)
    égal à 0.76.  Les mêmes statistiques peuvent être obtenues pour
    les autres modèles présents dans l'objet =gamod=, moins lissés
    spatialement, mais ne sont pas reportées ici.

#+begin_src R :wrap example
sum(diag(table(cut(gamod$gam900$line,
                   c(-Inf, gamod$gam900$family$getTheta(TRUE), Inf)),
                   gamod$gam900$model[, 1])))/ nrow(gamod$gam900$model)*100
1- (logLik(gamod$gam900)/ logLik(update(gamod$gam900, . ~ + 1)))
#+end_src

#+RESULTS:
#+begin_example
[1] 89.48
'log Lik.' 0.7565 (df=964)
#+end_example

*** Variables biophysiques

    Nous pouvons alors représenter les effets marginaux des variables
    biophysiques sur la variable latente de qualité continue des
    parcelles de vigne.  La fonction =plot= par défaut du package
    =mgcv= permet de représenter graphiquement ces effets en fixant
    toutes les autres variables explicatives du modèle à leurs
    moyennes.  Notons également dans le graphique ci-dessous que les
    effets ont une moyenne normalisée à 0 car le niveau des effets
    n'est pas identifiable semi-paramétriquement.

#+begin_src R :results graphics :file "./Figures/GamPlot.pdf"
plot(gamod$gam700, page= 1, scale= 0)
#+end_src

#+CAPTION: *Effets semi-paramétriques de la topographie et de la localisation*
#+ATTR_LATEX: :options scale= .65
#+RESULTS:
[[file:./Figures/GamPlot.pdf]]

    Des Figures plus détaillées, qui contiennent en particulier les
    effets associés aux autres modèles moins lissés, sont reportées
    dans l'article associé citep:Ay19.  La structure des effets reste
    cependant robuste à la spécification, elle reste proche de ce qui
    est observé dans la Figure A.3 du papier.  L'altitude et la pente
    ont des effets en U inversé, le rayonnement solaire a un effet
    linéaire à proximité de sa moyenne égale à 0 (la présence de
    valeurs extrêmes entraîne de forte non linéarité qui concernent
    que très peu d'observations).  Enfin, les effets spatiaux en bas à
    droite semblent se structurer dans une relation de centre/
    périphérie.

*** Effets communaux

    Les coefficients associés aux effets fixes communaux sont d'un
    intérêt particulier car ils correspondent à la partie historique
    des désignations AOC, ils représentent la partie de la variable
    latente de qualité qui n'est pas expliquée par les
    caractéristiques biophysiques des vignes.  Comme présenté dans
    cite:Ay19, la finesse du lissage spatial permet de contrôler les
    effets de /terroir/ potentiellement non captés par les variables
    topographiques, géologiques et pédologiques.  Cette interprétation
    des effets fixes communaux fait écho à certains travaux
    historiques pour lesquels nos résultats offre une sorte de
    confirmation statistique.  En effet, Christophe Lucand dans
    cite:WJac11 évoque l'existence d'une hiérarchie implicite des
    communes "qui ne détermine cependant en rien la réalité des zones
    d'approvisionnement concernées. Il s'agit plutôt d'identifications
    commerciales communes, investies d'un plus ou moins grand capital
    symbolique hérité. Ce capital symbolique hérité attribut un
    prestige plus ou moins grand à certaines communes ou propriétaires
    particulier."  Les effets fixes que nous estimons peuvent alors
    être vus comme des mesures de ce capital symbolique.  De manière
    complémentaire, cite:Jacq09 étudie la structuration des syndicats
    de viticulteurs qui s'opère quasi-exclusivement à l'échelle
    communale et mentionne le fait que (p.193) "plus l'appellation
    requise se calque sur le syndicat qui la défend, plus elle a de
    chance d'émerger et d'être délimitée strictement".  Les effets
    fixes communaux peuvent donc également mesurer l'action des
    syndicats, qui apparaît ainsi avoir une forte inertie historique
    puisqu'ils se retrouvent dans les AOC actuelles.

#+begin_src R :results graphics :height 7 :width 11 :file "./Figures/ComGam.pdf"
library(latticeExtra) ; yop <- summary(gamod$gam900)
plogi <- function(x) exp(x/ sqrt(2))/ (1+ exp(x/ sqrt(2)))
cf <- yop$p.coeff[ 4: 31]- mean(yop$p.coeff[ 4: 31]) ; se <- yop$se[ 4: 31]
zz <- data.frame(LIBCOM= substr(names(gamod$gam900$coef[ 4: 31]), 7, 30),
                 REGION= c(rep("tomato", 12), rep("chartreuse", 16)),
                 OS= 2* plogi(cf)- 1,
                 OSi= 2* plogi(cf- 1.5* se)- 1,
                 OSa= 2* plogi(cf+ 1.5* se)- 1)
foo_key <- list(x = .35, y = .95, corner = c(1, 1),
            text = list(c("Côte de Beaune", "Côte de Nuits")),
            rectangle = list(col = c("chartreuse", "tomato")))
segplot(reorder(factor(LIBCOM), OS)~ OSi+ OSa,
        length= 5, draw.bands= T,
        key= foo_key,
        data= zz[order(zz$OS), ], center= OS, type= "o",
        col= as.character(zz$REGION[order(zz$OS)]),
        unit = "mm", axis = axis.grid, col.symbol= "black", cex= 1, 
        xlab= "Mesure de supériorité ordinale et intervalles à 10 %")
#+end_src

#+CAPTION: *Effets communaux sur la classification AOC des parcelles*
#+ATTR_LATEX: :options scale= .55 
#+NAME: Fig:2
#+RESULTS:
[[file:./Figures/ComGam.pdf]]

    Nous traduisons les coefficients estimés en mesures de supériorité
    ordinale comme cela est présenté dans cite:AKat17.  Les valeurs
    obtenues pour les effets fixes communaux s'interprètent alors plus
    intuitivement. Les valeurs en abscisses correspondent aux
    probabilités qu'une parcelle de la commune reportée en ordonnées
    soit mieux classée qu'une parcelle aux caractéristiques
    biophysiques identiques mais localisée dans une commune au hasard.
    Le communes relativement favorisées par les AOC apparaissent en
    haut de la Figure et les communes relativement défavorisées en
    bas.  Les intervalles de confiance qui encadrent les valeurs
    moyennes sont différents de ceux reportés dans cite:Ay19.  Au lieu
    de représenter l'incertitude quand à la spécification des effets
    spatiaux, ils représentent ici l'incertitude associée à
    l'estimation des effets fixes par la procédure statistique.
    L'ordre de grandeur pour l'incertitude associée à ces estimations
    reste toutefois similaire.

*** Prédiction continue
**** Calculs                                 :noheading:

     Nous pouvons désormais utiliser ce modèle de désignation pour
     prédire les valeurs de la variable latente de qualité des vignes
     pour chacune des parcelles de la base de données.  Nous obtenons
     ainsi un score continue pour chaque parcelle selon ses
     caractéristiques biophysiques, avec les effets communaux
     potentiellement corrigés.  Notons que cette classification
     continue des parcelles est directement issue des AOC qui existent
     aujourd'hui et ne se base donc pas sur des appréciations
     subjectives sur ce qui fait la qualité d'une vigne ou d'un vin.
     Nous discutons ici deux sorties principales du modèle
     statistique : la valeur latente de la qualité avec les effets
     fixes communaux (ce qui signifie que les prédictions ne sont pas
     corrigées) et la valeur latente de la qualité sans les effets
     fixes communaux (car prendre la moyenne permet de corriger les
     prédictions de ces effets).  Le code suivant présente le calcul
     des prédictions et leur normalisation pour qu'ils soient
     distribués entre 0 et 100.  Nous les appellerons alors des
     scores, respectivement bruts ou corrigés.  Attention la ligne sur
     les prédictions est longue (5 minutes) à tourner.

#+begin_src R 
Prd.Ras <- subset(Geo.Ras, !is.na(AOClb))
Prd.Ras$GEOL <- ifelse(Prd.Ras$NOTATION %in% levels(Reg.Ras$GEOL),
                       as.character(Prd.Ras$NOTATION), "0AREF")
Prd.Ras$PEDO <- ifelse(Prd.Ras$NOUC %in% levels(Reg.Ras$PEDO),
                       as.character(Prd.Ras$NOUC), "0AREF")
## prd <- predict(gamod$gam900, newdata= Prd.Ras@data, type= "terms")
Prd.Ras$LTraw <- rowSums(prd, na.rm= TRUE)
Prd.Ras$LTcor <- mean(prd[, 1], na.rm= T)+ rowSums(prd[, -1], na.rm= T)
unini <- function(x) (x- min(x))/ (max(x)- min(x))
Prd.Ras$UFraw <- round(unini(Prd.Ras$LTraw)* 100, 2)
Prd.Ras$UFcor <- round(unini(Prd.Ras$LTcor)* 100, 2)
#+end_src

**** Figure                                  :noexport:

    Pour le graphique, on a besoin des codes en annexe qui sont
    également disponibles dans le fichiers =myFcts.R= disponible sur
    le dataverse de l'INRA.  Annexe 4.

    balbla clearpage

    balbla clearpage

    balbla clearpage

    balbla clearpage

#+begin_src R :results graphics :height 5 :width 7 :file "./Figures/PrdLt.pdf"
library(ggplot2) ; library(plyr) ; source("./myFcts.R")
NVA <- c("Coteaux b.", "Bourgogne", "Village", "Premier cru", "Grand cru")
names(NVA) <- 1: 5
cc <- rbind(
    data.frame(AOC= revalue(factor(Prd.Ras$AOC), NVA),
               Score= Prd.Ras$UFraw,
               Pr= "Non corrigé : maintient des effets communaux"),
    data.frame(AOC= revalue(factor(Prd.Ras$AOC), NVA),
               Score= Prd.Ras$UFcor,
               Pr= "Corrigé : suppression des effets communaux"))
ggplot(cc, aes(factor(AOC), Score, fill= Pr))+
    geom_split_violin()+
    ylab("Score de qualité des vignes (échelle de 0 à 100)")+
    ylim(40, 100)+ theme_minimal()+ xlab("")+
    geom_split_violin(draw_quantiles = c(0.25, 0.5, 0.75))+
    theme(legend.justification=c(0, 1), legend.position=c(0, 1),
          legend.title = element_blank())
#+end_src

#+CAPTION: *Distribution des qualités prédites avec et sans correction*
#+ATTR_LATEX: :options scale= .75
#+RESULTS:
[[file:./Figures/PrdLt.pdf]]

     Un premier élément du graphique précédent est que les
     caractéristiques biophysiques permettent de bien discriminer les
     différents niveaux d'AOC car les distributions se chevauchent
     peu.  Un deuxième élément tient de la correction qui ne produit
     pas les même conséquences selon le niveau d'AOC.  Pour les
     Coteaux bourguignons, les Villages et les Grands Crus, la
     correction maintien globalement les scores médians, et leur
     variance hormis pour le niveau Village où elle augmentent
     sensiblement.  À l'inverse, pour les Bourgogne régionaux et les
     Premiers crus, les scores médians sont revus à la hausse, ce qui
     indique la présence de parcelles dans ces niveaux qui sont
     sous-estimées du fait de leur communes d'appartenance.  Cet effet
     est particulièrement important pour les Premier cru comme on peut
     le voir dans le déplacement du mode de la distribution.

*** Agrégation par lieux dits
**** Recodage des dénominations              :noheading:

     Pour faciliter la consultation des résultats de la modélisation
     dans l'application, nous agrégeons les scores prédits sur la base
     d'un recodage des dénominations et la référence aux lieux dits.
     Nous utilisons pour cela les lieux dits qui permettent en outre
     de localiser plus précisément les parcelles en niveaux Coteaux
     bourguignons, Bourgogne régional et Village pour lesquels la
     mention de la parcelle n'est pas reporté sur l'étiquette.  Il
     s'agit également ici de renommer les premiers crus pour qu'ils
     soient plus lisibles dans l'application.

#+begin_src R :wrap example
Prd.Ras$NIVEAU <- as.character(revalue(factor(Prd.Ras$AOC), NVA))
Prd.Ras$NAME <- ifelse(Prd.Ras$AOC== 5, as.character(Prd.Ras$AOClb),
                ifelse(Prd.Ras$AOC< 4, as.character(Prd.Ras$LIEUDIT), NA))
for (i in 1: nrow(Prd.Ras)){
    if (is.na(Prd.Ras$NAME[ i])){
        Prd.Ras$NAME[ i] <- substr(Prd.Ras$AOClb[ i],
                                   regexpr(" cru+", Prd.Ras$AOClb[ i],
                                           perl= T)+ 5,
                                   nchar(as.character(Prd.Ras$AOClb[ i])))
    } else {(Prd.Ras$NAME[ i])}
}
Prd.Ras$Concat <- paste0(Prd.Ras$AOC, Prd.Ras$LIBCOM, Prd.Ras$NAME)
length(unique(Prd.Ras$Concat))
#+end_src

#+RESULTS:
#+begin_example
[1] 2391
#+end_example

     Ainsi, des quelques $60\,000$ parcelles cadastrales utilisées
     dans la modélisation, nous obtenons environ $2\,400$ localités,
     qui correspondent aux lieux dits pour les niveaux Coteaux
     Bourguignons, Bourgogne régional, et Village; ils correspondent
     aux dénominations retravaillées pour les Premiers crus; et aux
     appellations pour les Grands Crus.

**** Agrégation cartographique               :noheading:

     Nous allons désormais regrouper la géographie des parcelles selon
     la variable =Contat= tout juste créée.  Les scores sont reportés
     au niveau des nouvelles localités par moyenne pondérée par la
     surface de chaque parcelle qui la compose.  Nous calculons
     également la position de chaque localité dans la hiérarchie
     continue issue de la modélisation, ce qui permet de présenter en
     sortie du code ci-dessous les 10 localités les mieux notées sur
     la base des scores corrigés.

#+begin_src R :wrap example
library(data.table) ; Prd.Dtb <- data.table(Prd.Ras@data)
summary(Prd.Dtb$AREA)
Dat.Ldt <- Prd.Dtb[, .(LIBCOM= LIBCOM[ 1], NOM= NAME[ 1],
                       NIVEAU= NIVEAU[ 1],
                       SURFACE_ha= round(sum(AREA)/ 1e4, 2),
                       SCORE_brut= round(weighted.mean(UFraw, AREA), 2),
                       SCORE_corrigé=round(weighted.mean(UFcor, AREA), 2)), by= Concat]
library(rgdal) ; library(rgeos) ; library(maptools)
tmp_geo <- gBuffer(Prd.Ras, byid= TRUE, width= 0)    
Poly.ldt <- unionSpatialPolygons(tmp_geo, Prd.Ras$Concat)
Poly.ldt$Concat <- as.character(row.names(Poly.ldt))
Poly.Ras <- merge(Poly.ldt, Dat.Ldt, by= "Concat")
Poly.Ras$RANG_brut<- round(rank(Poly.Ras$SCORE_brut)/ nrow(Poly.Ras)*100,2)
Poly.Ras$RANG_corrigé <- round(rank(Poly.Ras$SCORE_corrigé)/
                               nrow(Poly.Ras)*100,2)
head(Poly.Ras@data[order(Poly.Ras$RANG_corrigé, decreasing= T), c(3, 4, 6, 7)], n= 10)
Poly.Ras$NIVEAU <- factor(Poly.Ras$NIVEAU, levels= NVA)
#+end_src

#+RESULTS:
#+begin_example
                        NOM      NIVEAU SCORE_brut SCORE_corrigé
2364             Chambertin   Grand cru      94.22         94.11
2363       Grands-Echezeaux   Grand cru      87.73         90.76
2384             Montrachet   Grand cru      88.72         90.69
2381      Bâtard-Montrachet   Grand cru      87.73         89.68
2361             Montrachet   Grand cru      87.05         89.58
2362              Echezeaux   Grand cru      86.13         89.12
2369 Latricières-Chambertin   Grand cru      88.73         88.53
2371   Mazoyères-Chambertin   Grand cru      88.71         88.50
2359      Bâtard-Montrachet   Grand cru      85.80         88.30
2010      La Combe d'Orveau Premier cru      91.01         87.83
#+end_example

      Sans trop de surprise, les Grands Crus arrivent en haut de la
      hiérarchie autant issus de la côte de Nuits (Chambertin,
      Grands-Echezeaux) que de la côte de Beaune (Montrachet,
      Bâtard-Montrachet).  Notons tout de même qu'un Premier cru
      arrive en dixième position, ce qu'il veut dire qu'il dépasse les
      2/3 des Grands crus.  Ce Premier cru "La Combe d'Orveau" se
      trouve sur la commune de Chambolle Musigny qui n'apparaît pas
      pourtant si désavantagée selon la Figure 2.  Cela indique que la
      haute classification de ce Premier cru (en particulier au-dessus
      du Grand cru "Musigny" situé sur la même commune) provient des
      caractéristiques biophysiques et non de la correction communale.
      Plus étonnant, la Romanée-conti qui apparaît souvent parmi les
      vins les plus chers du monde
      (https://www.wine-searcher.com/most-expensive-wines) n'apparaît
      qu'en 26ième position (elle est tout de même dans les 2 %
      meilleurs).  On peut penser que la situation de monopole peut
      expliquer la fort prix indépendamment des caractéristiques
      biophysiques.

**** Sauvegarde pour l'appli                 :noheading:

     Nous enregistrons ensuite les résultats dans une base
     de données géographique de type =sf= qui pourra directement être
     utilisée dans l'application /Shiny/.  Ces résultats sont
     accessibles sur le serveur data de l'INRA à l'adresse XX.
     
#+begin_src R
library(sf)
Poly.Ras <- st_as_sf(Poly.Ras)
Poly.Ras <- st_transform(Poly.Ras,crs= 4326)
save(Poly.Ras, file= "Inter/PolyRas.Rda")
#+end_src

    Sauvegarde disponible sur le serveur de l'INRA.

#+Latex: \clearpage

** Application /Shiny/
  :PROPERTIES:
  :CUSTOM_ID: Sec:4
  :END:

  Les résultats issus de la modélisation statistiques des AOC de
  Côte-d'Or sont consultables par le biais d'une application /Shiny/
  dédiée.  Il y a deux manière de faire tourner l'application, par le
  biais d'un explorateur internet à l'adresse
  https://cesaer-datas.inra.fr/geoind/ ou en local sur la base d'une
  version récente de =R= et des packages spécifiés ci-dessous.

*** Cartographie dynamique
**** Codes                                   :noheading:

     Pour faire tourner l'application en local, il est nécessaire de
     télécharger le fichier =PolyRas.Rda= sur le serveur data de
     l'INRA pour le placer dans le dossier =Inter/= à la racine de =R=
     (obtenue avec =getwd()=).  Les codes ci-dessous permettent de
     créer la cartographie dynamique de type =Leaflet= qui sera
     intégrée ensuite à l'application.  Elle permet de naviguer entre
     les différentes parcelles viticoles de la zone, pour faire
     apparaître le score ou le score corrigé suite à un simple clic.
     La position de la parcelle sélectionnée dans la hiérarchie
     générale de la région apparaît également par les variables
     =rang_brut= et =rang_cor= crées précédemment.

#+begin_src R :tangle ./Application2/global.R
library(RColorBrewer) ; library(mapview) ; library(sf)
load("Inter/PolyRas.Rda")

AocPal <- brewer.pal(5, "BuPu")
mapviewOptions(basemaps= c("Esri.WorldImagery", "OpenStreetMap",
                           "OpenTopoMap", "CartoDB.Positron"),
               raster.palette= colorRampPalette(brewer.pal(9, "Greys")),
               vector.palette= colorRampPalette(brewer.pal(9, "YlGnBu")),
               na.color= "magenta", layers.control.pos = "topleft")
map <- mapview(Poly.Ras, zcol= "NIVEAU", label= Poly.Ras$NOM,
               layerId= Poly.Ras$Concat, alpha.regions= .5,
               col.regions = AocPal, color= "white", legend.opacity= .5,
               popup = popupTable(Poly.Ras, feature.id= FALSE,
                                  zcol= names(Poly.Ras)[ -1]))
## mapshot(addLogo(map, "http://www7.inra.fr/fournisseurs/images/logo.jpg",
##                 width = 200, height = 100),
##         url = paste0(getwd(), "/Application/CotePrd.html"),
##         file = paste0(getwd(), "/Application/CotePrd.png"),
##         remove_controls = c("homeButton", "layersControl"))
#+end_src

**** Détails techniques                      :noexport:

   On utilise mapview, https://r-spatial.github.io/mapview/
   - sudo apt install libgdal-dev
   - sudo ln -s /usr/lib/rstudio/bin/pandoc/pandoc /usr/local/bin
   - webshot::install_phantomjs()

   On pourrait également utiliser:
   - http://symbolixau.github.io/googleway/articles/googleway-vignette.html
   - https://www.osgeo.org/projects/mapguide-open-source/
   - http://geoserver.org/
   - https://rstudio.github.io/leaflet/shiny.html
   - https://github.com/mtennekes/tmap

   Extension: On peut mettre des graphiques quand on clique sur un
   polygone:
   https://r-spatial.github.io/mapview/articles/articles/mapview_04-popups.html

   also show info on the epsg code and the proj4string press and hold
   Ctrl and move the mouse. addMouseCoordinates also allows us to copy
   the info about the current mouse position to the clipboard by
   holding the Ctrl and left-clicking on the map.

**** Deploiement                             :noexport:
***** Mise à niveau

     https://firebase.google.com/

     wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh | bash
     https://websiteforstudents.com/install-the-latest-node-js-and-nmp-packages-on-ubuntu-16-04-18-04-lts/
     nvm install 10.15.3

 #+begin_src sh
from https://github.com/creationix/nvm:
You can list available versions using ls-remote:
nvm ls-remote
And then in any new shell just use the installed version:
nvm use node
Or you can just run it:
nvm run node --version
Or, you can run any arbitrary command in a subshell with the desired version of node:
nvm exec 10.15.3 node --version
nvm install 10.15.3
 #+end_src

***** Déploiement effectif

      Toujours être sûr d'être up-to-date.
      
      npm install -g firebase-tools
     To update to the latest version of the Firebase CLI, re-run the
     same npm install command.
     firebase login
     firebase list
     se mettre dans le répertoire DynMap
     firebase init, choisir hosting
     mettre le fichier, l'appeler index.html
     firebase deploy

 #+begin_src sh
firebase login
    firebase list
    se mettre dans le répertoire DynMap
    firebase init hosting
    mettre le fichier dans le répertoire public, l'appeler index.html
    firebase deploy

 #+end_src

*** Tests shiny                              :noexport:
**** TEST 1

 #+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shiny)
library(shinyjs)

Pts.Crd <- spTransform(Poly.Lxd, CRS("+proj=longlat +ellps=WGS84"))

r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()

ui <- dashboardPage(
  dashboardHeader(
    titleWidth = 500, 
    title = "Informational Content of Geographical Indications"),
  dashboardSidebar(
    width = 75,
    sidebarMenu(
      id = "tabs",
      menuItem("T1", tabName = "T1", icon = icon("angle-right ")),
      menuItem("T2", tabName = "T2", icon = icon("angle-right "))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "T1",
        fluidRow(
            box(width = 4, # taille de la box
                column(
                    width = 12,
                    checkboxGroupInput("aoc", "Sélectionner une AOC",
                                       choices= 1: 5,
                                       selected= 1: 5, inline= TRUE),
                    selectInput("aocld", 
                                label = "Sélectionner un lieux dit",
                                choices = unique(Poly.Lxd$AOCLD), 
                                selected = 1),
                    plotOutput("miplot", width='100%'))
          ),
          box(width = 8, 
              column(
                  width = 12, 
                  leafletOutput("mymap", height = 700)
              )
              )
        )
      ),
      tabItem(
          tabName = "T2",
        fluidRow(
          box(width = 5, 
              column(
                width = 12, 
                plotOutput("myplot2",width='100%')
              )
          )          
        )
      )
    )
  )
)

server <- function(input, output, session) {
    observe({
        x <- input$aoc
        if (is.null(x)) x <- 1: 5 
        updateSelectInput(session, "aocld",
                          label= paste("Select input label", length(x)),
                          choices= unique(Poly.Lxd$AOCLD[ Poly.Lxd$AOC %in% x])
    )
    getData  <- reactive({
        Poly.Lxd$PrdCor[Poly.Lxd$AOC%in% x ]
    }) 
    getCrd <- reactive({
        coordinates(Pts.Crd[Pts.Crd$AOCLD == input$aocld, ])
    })
    getPts <- reactive({
        SpatialPoints(Pts.Crd[Pts.Crd$AOCLD == input$aocld, ])
    })
    output$mymap <- renderLeaflet({
        tst@map %>%
            setView(getCrd()[ 1], getCrd()[ 2], zoom= 17) %>%
            addCircleMarkers(data = getPts()) })
    output$miplot <- renderPlot({
        plot(density(getData()),
             main= paste0("AOC numero ", paste(x, collapse= ", ")))
        abline(v= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == input$aocld] )})
    })
}

shinyApp(ui, server)
 #+end_src

**** TEST 2

 #+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shiny)
library(shinyjs)
library(ggplot2)
library(plyr)

Pts.Crd <- spTransform(Poly.Lxd, CRS("+proj=longlat +ellps=WGS84"))
r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()

ui <- dashboardPage(
  dashboardHeader(
    titleWidth = 500, 
    title = "Informational Content of Geographical Indications"),
  dashboardSidebar(
    width = 75,
    sidebarMenu(
      id = "tabs",
      menuItem("T1", tabName = "T1", icon = icon("angle-right ")),
      menuItem("T2", tabName = "T2", icon = icon("angle-right "))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "T1",
        fluidRow(
            box(width = 4, # taille de la box
                column(
                    width = 12,
                    checkboxGroupInput("aoc", "Sélectionner une AOC",
                                       choices= 1: 5,
                                       selected= 1: 5, inline= TRUE),
                    selectInput("aocld", 
                                label = "Sélectionner un lieux dit",
                                choices = unique(Poly.Lxd$AOCLD), 
                                selected = 1),
                    plotOutput("miplot", width='100%'))
          ),
          box(width = 8, 
              column(
                  width = 12, 
                  leafletOutput("mymap", height = 700),
                  fluidRow(verbatimTextOutput("mymap_shape_click"))
              )
              )
        )
      ),
      tabItem(
          tabName = "T2",
        fluidRow(
          box(width = 5, 
              column(
                width = 12, 
                plotOutput("myplot2",width='100%')
              )
          )          
        )
      )
    )
  )
)

## click, mouseover, and mouseout, null before the first click
server <- function(input, output, session) {
    observe({
    x <- input$aoc
    if (is.null(x)) x <- 1: 5
    updateSelectInput(session, "aocld",
      label = paste("Select input label", length(x)),
      choices = unique(Poly.Lxd$AOCLD[ Poly.Lxd$AOC %in% x])
    )
    getData  <- reactive({## LA DENSITE
        Poly.Lxd$PrdCor[Poly.Lxd$AOC%in% x ]
    }) 
    getCrd <- reactive({## LE ZOOM
        coordinates(Pts.Crd[Pts.Crd$AOCLD == input$aocld, ])
    })
    getPts <- reactive({## LE POINT
        Pts.Crd[Pts.Crd$AOCLD == input$aocld, ]
    })
    getClk <- reactive({## LE CLICK
        input$mymap_shape_click$id
    })
    output$mymap <- renderLeaflet({
        tst@map %>%
            setView(getCrd()[ 1], getCrd()[ 2], zoom= 17) %>%
            addCircleMarkers(data= SpatialPoints(getPts()))})
    output$miplot <- renderPlot({
        plot(density(getData()),
             main= paste0("AOC numero ", paste(x, collapse= ", ")))
        abline(v=  Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == input$aocld])
        abline(v=  Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == getClk()])})
    })
}
)

shinyApp(ui, server)
 #+end_src

**** TEST 3

 #+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shiny)
library(shinyjs)
library(ggplot2)
library(plyr)

Pts.Crd <- spTransform(Poly.Lxd, CRS("+proj=longlat +ellps=WGS84"))
yop <- c("Coteaux b.", "Bourgogne", "Village", "Premier cru", "Grand cru")
names(yop) <- 1: 5

r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()

ui <- dashboardPage(
  dashboardHeader(
    titleWidth = 500, 
    title = "Informational Content of Geographical Indications"),
  dashboardSidebar(
    width = 75,
    sidebarMenu(
      id = "tabs",
      menuItem("T1", tabName = "T1", icon = icon("angle-right ")),
      menuItem("T2", tabName = "T2", icon = icon("angle-right "))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "T1",
        fluidRow(
            box(width = 4, # taille de la box
                column(
                    width = 12,
                    checkboxGroupInput("aoc", "Sélectionner une AOC",
                                       choices= 1: 5,
                                       selected= 1: 5, inline= TRUE),
                    selectInput("aocld", 
                                label = "Sélectionner un lieux dit",
                                choices = unique(Poly.Lxd$AOCLD), 
                                selected = 1),
                    plotOutput("miplot", width='100%'))
          ),
          box(width = 8, 
              column(
                  width = 12, 
                  leafletOutput("mymap", height = 700),
                  fluidRow(verbatimTextOutput("mymap_shape_click"))
              )
              )
        )
      ),
      tabItem(
          tabName = "T2",
        fluidRow(
          box(width = 5, 
              column(
                width = 12, 
                plotOutput("myplot2",width='100%')
              )
          )          
        )
      )
    )
  )
)

## click, mouseover, and mouseout, null before the first click
server <- function(input, output, session) {
    observe({
    x <- input$aoc
    if (is.null(x)) x <- 1: 5
    updateSelectInput(session, "aocld",
      label = paste("Select input label", length(x)),
      choices = unique(Poly.Lxd$AOCLD[ Poly.Lxd$AOC %in% x])
    )
    getData  <- reactive({## LA DENSITE
        Poly.Lxd@data[Poly.Lxd$AOC%in% x ,]
    }) 
    getCrd <- reactive({## LE ZOOM
        coordinates(Pts.Crd[Pts.Crd$AOCLD == input$aocld, ])
    })
    getPts <- reactive({## LE POINT
        Pts.Crd[Pts.Crd$AOCLD == input$aocld, ]
    })
    getClk <- reactive({## LE CLICK
        input$mymap_shape_click$id
    })
    output$mymap <- renderLeaflet({
        tst@map %>%
            setView(getCrd()[ 1], getCrd()[ 2], zoom= 17) %>%
            addCircleMarkers(data= SpatialPoints(getPts()))})
    output$miplot <- renderPlot({
        ggplot(getData(), aes(x= revalue(factor(AOC), yop),
                              y= PrdCor, fill= factor(AOC)))+
            geom_violin(trim=FALSE)+ theme_minimal()+ ylim(40, 100)+
            geom_boxplot(width=0.1, fill="white")+
            labs(title= paste("Reference: ", input$aocld,
                              " ; Current: ", getClk()),
                 x= "", y = "100-Point Vineyard Quality Score")+    
            scale_fill_manual(values= pal(5))+ 
            theme(legend.position= "none")+
            scale_x_discrete(expand= expand_scale(mult= 0, add= 1),drop=T)+
            geom_hline(yintercept= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == input$aocld],
                       lty= 3, col= "red")+
            geom_hline(yintercept= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == getClk()], lty= 2, col= "blue")+
            annotate("text", x= 0.4,
                     y= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == input$aocld]+ 2,
                     label = "Reference", col= "red")+
            annotate("text", x= length(x)+ .6,
                     y= ifelse(is.null(input$mymap_shape_click), -100,
                               Poly.Lxd$PrdCor[Poly.Lxd$AOCLD==getClk()])+
                         2, label = "Current", col= "blue")
    })
    })
})

shinyApp(ui, server)
 #+end_src

**** TEST 4

 #+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shiny)
library(shinyjs)
library(ggplot2)
library(plyr)

Pts.Crd <- spTransform(Poly.Lxd, CRS("+proj=longlat +ellps=WGS84"))
yop <- c("Coteaux b.", "Bourgogne", "Village", "Premier cru", "Grand cru")
names(yop) <- 1: 5

r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()

ui <- dashboardPage(
  dashboardHeader(
    titleWidth = 500, 
    title = "Informational Content of Geographical Indications"),
  dashboardSidebar(
    width = 75,
    sidebarMenu(
      id = "tabs",
      menuItem("T1", tabName = "T1", icon = icon("angle-right ")),
      menuItem("T2", tabName = "T2", icon = icon("angle-right "))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "T1",
        fluidRow(
            box(width = 5, 
                column(
                    width = 12,
                    checkboxGroupInput("aoc", "Sélectionner une AOC",
                                       choices= 1: 5,
                                       selected= 1: 5, inline= TRUE),
                    selectInput("aocld", 
                                label = "Sélectionner un lieux dit",
                                choices = unique(Poly.Lxd$AOCLD), 
                                selected = 1),
                    plotOutput("miplot", width='100%'),
                    tableOutput('table'))
          ),
          box(width = 7, 
              column(
                  width = 12, 
                  leafletOutput("mymap", height = 700),
                  fluidRow(verbatimTextOutput("mymap_shape_click"))
              )
              )
        )
      ),
      tabItem(
          tabName = "T2",
        fluidRow(
          box(width = 5, 
              column(
                width = 12, 
                plotOutput("myplot2",width='100%')
              )
          )          
        )
      )
    )
  )
)

## click, mouseover, and mouseout, null before the first click
server <- function(input, output, session) {
    observe({
    x <- input$aoc
    if (is.null(x)) x <- 1: 5
    updateSelectInput(session, "aocld",
      label = paste("Select input label", length(x)),
      choices = unique(Poly.Lxd$AOCLD[ Poly.Lxd$AOC %in% x])
    )
    getData  <- reactive({## LA DENSITE
        Poly.Lxd@data[Poly.Lxd$AOC%in% x ,]
    }) 
    getCrd <- reactive({## LE ZOOM
        coordinates(Pts.Crd[Pts.Crd$AOCLD == input$aocld, ])
    })
    getPts <- reactive({## LE POINT
        Pts.Crd[Pts.Crd$AOCLD == input$aocld, ]
    })
    getClk <- reactive({## LE CLICK
        input$mymap_shape_click$id
    })
    output$mymap <- renderLeaflet({
        tst@map %>%
            setView(getCrd()[ 1], getCrd()[ 2], zoom= 17) %>%
            addCircleMarkers(data= SpatialPoints(getPts()))})
    output$table <- renderTable(
        data.frame("Vineyard"= c("Reference", "Current"),
                   "Coteaux b."= c(100, NA),
                   "Bourgogne"= c(100, NA),
                   "Village"= c(100, NA),
                   "Premier Cru"= c(100, NA),
                   "Grand Cru"= c(100, NA)))
    output$miplot <- renderPlot({
        ggplot(getData(), aes(x= revalue(factor(AOC), yop),
                              y= PrdCor, fill= factor(AOC)))+
            geom_violin(trim=FALSE)+ theme_minimal()+ ylim(40, 100)+
            geom_boxplot(width=0.1, fill="white")+
            labs(title= paste("Reference: ", input$aocld,
                              " ; Current: ", getClk()),
                 x= "", y = "100-Point Vineyard Quality Score")+    
            scale_fill_manual(values= pal(5))+ 
            theme(legend.position= "none")+
            scale_x_discrete(expand= expand_scale(mult= 0, add= 1),drop=T)+
            geom_hline(yintercept= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == input$aocld],
                       lty= 3, col= "red")+
            geom_hline(yintercept= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == getClk()], lty= 2, col= "blue")+
            annotate("text", x= 0.4,
                     y= Poly.Lxd$PrdCor[Poly.Lxd$AOCLD == input$aocld]+ 2,
                     label = "Reference", col= "red")+
            annotate("text", x= length(x)+ .6,
                     y= ifelse(is.null(input$mymap_shape_click), -100,
                               Poly.Lxd$PrdCor[Poly.Lxd$AOCLD==getClk()])+
                         2, label = "Current", col= "blue")
    })
    })
})

shinyApp(ui, server)
 #+end_src

**** TEST 5

 #+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shinyjs)
library(ggplot2)
library(plyr)

Pts.Crd <- spTransform(Poly.tst, CRS("+proj=longlat +ellps=WGS84"))

ui <- dashboardPage(
  dashboardHeader(
    titleWidth = 500, 
    title = "Informational Content of Geographical Indications"),
  dashboardSidebar(
    width = 75,
    sidebarMenu(
      id = "tabs",
      menuItem("T1", tabName = "T1", icon = icon("angle-right ")),
      menuItem("T2", tabName = "T2", icon = icon("angle-right "))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "T1",
        fluidRow(
            box(width = 5, 
                column(
                    width = 12,
                    selectInput("niveau", 
                                label= "Sélectionner un niveau",
                                choices= unique(Poly.tst$NIVEAU), 
                                selected = 1),
                    selectInput("commune", 
                                label = "Sélectionner une commune",
                                choices = unique(Poly.tst$LIBCOM), 
                                selected = 1),
                    selectInput("name", 
                                label = "Sélectionner un lieu dit",
                                choices = unique(Poly.tst$NAME), 
                                selected = 1),
                    plotOutput("miplot", width='100%'),
                    tableOutput('table'))
          ),
          box(width = 7, 
              column(
                  width = 12, 
                  leafletOutput("mymap", height = 700),
                  fluidRow(verbatimTextOutput("mymap_shape_click"))
              )
              )
        )
      ),
      tabItem(
          tabName = "T2",
        fluidRow(
          box(width = 5, 
              column(
                width = 12, 
                plotOutput("myplot2",width='100%')
              )
          )          
        )
      )
    )
  )
)

## click, mouseover, and mouseout, null before the first click
server <- function(input, output, session) {
    observe({
    updateSelectInput(session, "commune",
      choices = unique(Poly.tst$LIBCOM[ Poly.tst$NIVEAU %in% input$niveau])
      )
    updateSelectInput(session, "name",
      choices = unique(Poly.tst$NAME[ Poly.tst$NIVEAU %in% input$niveau &
                                      Poly.tst$LIBCOM %in% input$commune ])
    )
    getCrd <- reactive({## LE ZOOM
        coordinates(Pts.Crd[Pts.Crd$NIVEAU == input$niveau &
                            Pts.Crd$LIBCOM == input$commune &
                            Pts.Crd$NAME   == input$name , ])
    })
    getPts <- reactive({## LE POINT
        Pts.Crd[Pts.Crd$NIVEAU == input$niveau &
                            Pts.Crd$LIBCOM == input$commune &
                            Pts.Crd$NAME   == input$name , ]
    })
    getClk <- reactive({## LE CLICK
        input$mymap_shape_click$id
    })
    output$mymap <- renderLeaflet({
        tst@map %>%
            setView(getCrd()[ 1], getCrd()[ 2], zoom= 17) %>%
            addCircleMarkers(data= SpatialPoints(getPts()))})
    output$table <- renderTable(
        data.frame("Vineyard"= c("Reference", "Current"),
                   "Coteaux b."= c(100, NA),
                   "Bourgogne"= c(100, NA),
                   "Village"= c(100, NA),
                   "Premier Cru"= c(100, NA),
                   "Grand Cru"= c(100, NA)))
    output$miplot <- renderPlot({
        ggplot(Poly.tst@data, aes(x= factor(NIVEAU),
                                 y= PrdCor, fill= factor(NIVEAU)))+
            geom_violin(trim=FALSE)+ theme_minimal()+ ylim(40, 100)+
            geom_boxplot(width=0.1, fill="white")+
            labs(title= paste("Reference: ", input$name,
                              " ; Current: ", getClk()),
                 x= "", y = "100-Point Vineyard Quality Score")+    
            scale_fill_manual(values= AocPal)+ 
            theme(legend.position= "none")+
            scale_x_discrete(expand= expand_scale(mult= 0, add= 1),drop=T)+
            geom_hline(yintercept=
                 Poly.tst$PrdCor[Poly.tst$NIVEAU %in% input$niveau &
                                 Poly.tst$LIBCOM %in% input$commune&
                                 Poly.tst$NAME   %in% input$name ],
                       lty= 3, col= "red")+
            geom_hline(yintercept= Poly.tst$PrdCor[Poly.tst$xx== getClk()],
                       lty= 2, col= "blue")+
            annotate("text", x= 0.4,
                     y= Poly.tst$PrdCor[Poly.tst$NIVEAU %in% input$niveau &
                                        Poly.tst$LIBCOM %in% input$commune&
                                        Poly.tst$NAME   %in% input$name ]+
                         2, label = "Reference", col= "red")+
            annotate("text", x= 5.6,
                     y= ifelse(is.null(input$mymap_shape_click), -100,
                               Poly.tst$PrdCor[Poly.tst$xx== getClk()])+
                         2, label = "Current", col= "blue")
    })
    })
})

shinyApp(ui, server)
 #+end_src

**** TEST 6

 #+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shinyjs)
library(ggplot2)
library(plyr)

Pts.Crd <- spTransform(Poly.tst, CRS("+proj=longlat +ellps=WGS84"))

ui <- dashboardPage(
  dashboardHeader(
    titleWidth = 700, 
    title = "Essai de classification continue des vignobles de la Côte d'Or"),
  dashboardSidebar(
    width = 75,
    sidebarMenu(
      id = "tabs",
      menuItem("T1", tabName = "T1", icon = icon("angle-right ")),
      menuItem("T2", tabName = "T2", icon = icon("angle-right "))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "T1",
        fluidRow(
            box(width = 5, 
                column(
                    width = 12,
                    selectInput("niveau", 
                                label=
                                    "Niveau de l'appellation de référence",
                                choices= unique(Poly.tst$NIVEAU), 
                                selected= 1),
                    selectInput("commune", 
                                label=
                                    "Commune de la parcelle de référence",
                                choices= unique(Poly.tst$LIBCOM), 
                                selected= 1),
                    selectInput("name", 
                                label=
                                    "Lieu dit de la parcelle de référence",
                                choices= unique(Poly.tst$NAME), 
                                selected = 1),
                    plotOutput("miplot", width='100%'),
                    tableOutput('table'))
          ),
          box(width = 7, 
              column(
                  width = 12, 
                  leafletOutput("mymap", height = 700),
                  fluidRow(verbatimTextOutput("mymap_shape_click"))
              )
              )
        )
      ),
      tabItem(
          tabName = "T2",
        fluidRow(
          box(width = 5, 
              column(
                width = 12, 
                plotOutput("myplot2",width='100%')
              )
          )          
        )
      )
    )
  )
)

## click, mouseover, and mouseout, null before the first click
server <- function(input, output, session) {
    observe({
    updateSelectInput(session, "commune",
      choices = unique(Poly.tst$LIBCOM[ Poly.tst$NIVEAU %in% input$niveau])
      )})
    observe({
    updateSelectInput(session, "name",
      choices = unique(Poly.tst$NAME[ Poly.tst$NIVEAU %in% input$niveau &
                                      Poly.tst$LIBCOM %in% input$commune ])
      )})
    observe({
        yop <- Poly.tst$PrdCor[Poly.tst$NIVEAU %in% input$niveau &
                               Poly.tst$LIBCOM %in% input$commune&
                               Poly.tst$NAME   %in%   input$name ]
    getCrd <- reactive({## LE ZOOM
        coordinates(Pts.Crd[Pts.Crd$NIVEAU == input$niveau &
                            Pts.Crd$LIBCOM == input$commune &
                            Pts.Crd$NAME   == input$name , ])
    })
    getPts <- reactive({## LE POINT
        Pts.Crd[Pts.Crd$NIVEAU == input$niveau &
                            Pts.Crd$LIBCOM == input$commune &
                            Pts.Crd$NAME   == input$name , ]
    })
    getClk <- reactive({## LE CLICK
        input$mymap_shape_click$id
    })
    yap <- Poly.tst$PrdCor[Poly.tst$xx== getClk()]
    output$mymap <- renderLeaflet({
        tst@map %>%
            setView(getCrd()[ 1], getCrd()[ 2], zoom= 17) %>%
            addCircleMarkers(data= SpatialPoints(getPts()))})
    output$table <- renderTable(
        data.frame("Meilleur que x pc des"= c("Reference", "Current"),
                   "Coteaux b."= round(c(mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Coteaux b."]< yop)* 100, mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Coteaux b."]< yap)* 100), 2),
                   "Bourgogne"= round(c(mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Bourgogne"]< yop)* 100, mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Bourgogne"]< yap)* 100), 2),
                   "Village"= round(c(mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Village"]< yop)* 100, mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Village"]< yap)* 100), 2),
                   "Premier cru"= round(c(mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Premier cru"]< yop)* 100, mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Premier cru"]< yap)* 100), 2),
                   "Grand cru"= round(c(mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Grand cru"]< yop)* 100, mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Grand cru"]< yap)* 100), 2)))
    output$miplot <- renderPlot({
        ggplot(Poly.tst@data, aes(x= factor(NIVEAU),
                                 y= PrdCor, fill= factor(NIVEAU)))+
            geom_violin(trim=FALSE)+ theme_minimal()+ ylim(40, 100)+
            geom_boxplot(width=0.1, fill="white")+
            labs(title= paste("Référence: ", input$name,
                              " ; Current: ",
                              Poly.tst$NAME[Poly.tst$xx== getClk()]),
                 x= "", y = "100-Point Vineyard Quality Score")+    
            scale_fill_manual(values= AocPal)+ 
            theme(legend.position= "none")+
            scale_x_discrete(expand= expand_scale(mult= 0, add= 1),drop=T)+
            geom_hline(yintercept= yop, lty= 3, col= "red")+
            geom_hline(yintercept= yap, lty= 2, col= "blue")+
            annotate("text", x= 0.4,
                     y= yop+ 2, label = "Référence", col= "red")+
            annotate("text", x= 5.6,
                     y= ifelse(is.null(input$mymap_shape_click),
                               -100, yap)+ 2, label="Current", col= "blue")
    })
    })
})

shinyApp(ui, server)
 #+end_src

**** TEST 7

#+begin_src R
library(shiny)
library(leaflet)
library(shinydashboard)
library(shinyjs)
library(ggplot2)
library(plyr)

Pts.Crd <- spTransform(Poly.tst, CRS("+proj=longlat +ellps=WGS84"))

shina <- list(Pts.Crd= Pts.Crd, Poly.tst= Poly.tst)
save(shina, file= "Inter/shina.Rda")

header <- dashboardHeader(
    titleWidth = 500, 
    title = "Classification continue des vignobles de la Côte d'Or")

body <- dashboardBody(
    fluidRow(
        box(width= 5, 
            column(
                width= 12,
                selectInput("niveau", 
                            label=
                                "Niveau de l'appellation",
                            choices= c(
                                as.character(unique(Poly.tst$NIVEAU)),
                                "TOUS"), 
                            selected= 1),
                selectInput("commune", 
                            label=
                                "Commune de la parcelle",
                            choices= c(
                                as.character(unique(Poly.tst$LIBCOM)),
                                "TOUTES"), 
                            selected= 1),
                selectInput("name", 
                            label=
                                "Lieu dit de la parcelle",
                            choices= c(
                                as.character(unique(Poly.tst$NAME)),
                                "TOUS"), 
                            selected = 1),
                plotOutput("miplot", width='100%'),
                tableOutput('table'))
            ),
        box(width = 7, 
            column(
                width = 12, 
                leafletOutput("mymap", height = 700),
                fluidRow(verbatimTextOutput("mymap_shape_click"))
            )
            )
    )
)

ui <- dashboardPage(
    header,
    dashboardSidebar(disable = TRUE),
    body)

if (input$communes== "TOUTES")
    input$communes <- unique(Poly.tst$LIBCOM)
if (input$name== "TOUS") input$name <- unique(Poly.tst$NAME)
if (){
    input$niveau <- as.character(unique(Poly.tst$NIVEAU))
}

gg <- ifelse(input$niveau== "TOUS",
                         as.character(unique(Poly.tst$NIVEAU)),
                         input$niveau)

## click, mouseover, and mouseout, null before the first click
server <- function(input, output, session) {
    observe({
        updateSelectInput(
            session, "commune",
            choices= c(
                as.character(unique(Poly.tst$LIBCOM[Poly.tst$NIVEAU
                                                    %in%
                                                    input$niveau])),
                     "TOUTES"))})
    observe({updateSelectInput(
                 session, "name",
                 choices= c(
                     as.character(unique(Poly.tst$NAME[Poly.tst$NIVEAU %in%
                                                       input$niveau &
                                                       Poly.tst$LIBCOM %in%
                                                       input$commune ])),
                     "TOUS"))})
    observe({
        yop <- Poly.tst$PrdCor[Poly.tst$NIVEAU %in% input$niveau  &
                               Poly.tst$LIBCOM %in% input$commune &
                               Poly.tst$NAME   %in% input$name ]
        getCrd <- reactive({## LE ZOOM
            coordinates(Pts.Crd[Pts.Crd$NIVEAU == input$niveau &
                                Pts.Crd$LIBCOM == input$commune &
                                Pts.Crd$NAME   == input$name , ])
        })
        getPts <- reactive({## LE POINT
            Pts.Crd[Pts.Crd$NIVEAU %in% input$niveau &
                    Pts.Crd$LIBCOM %in% input$commune &
                    Pts.Crd$NAME   %in% input$name , ]
        })
        getClk <- reactive({## LE CLICK
            input$mymap_shape_click$id
        })
        yap <- Poly.tst$PrdCor[Poly.tst$xx== getClk()]
        output$mymap <- renderLeaflet({
        tst@map %>%
            setView(mean(coordinates(getPts())[, 1]),
                    mean(coordinates(getPts())[, 2]), zoom= 17) %>%
            addCircleMarkers(data= SpatialPoints(getPts()))
        })
        output$table <- renderTable(
            data.frame("Meilleur que x pc des"= c("Reference", "Current"),
                       "Coteaux b."= round(c(mean(
                           Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                           "Coteaux b."]< yop)* 100, mean(
                                                                         Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                                                                         "Coteaux b."]< yap)* 100), 2),
                       "Bourgogne"= round(c(mean(
                           Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                           "Bourgogne"]< yop)* 100, mean(
                                                                        Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                                                                        "Bourgogne"]< yap)* 100), 2),
                       "Village"= round(c(mean(
                           Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                           "Village"]< yop)* 100, mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Village"]< yap)* 100), 2),
                       "Premier cru"= round(c(mean(
                           Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                           "Premier cru"]< yop)* 100, mean(
                                                                          Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                                                                          "Premier cru"]< yap)* 100), 2),
                       "Grand cru"= round(c(mean(
                       Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                       "Grand cru"]< yop)* 100, mean(
                                                                    Poly.tst$PrdCor[Poly.tst$NIVEAU==
                                                                                    "Grand cru"]< yap)* 100), 2)))
        output$miplot <- renderPlot({
            ggplot(Poly.tst@data, aes(x= factor(NIVEAU),
                                      y= PrdCor, fill= factor(NIVEAU)))+
                geom_violin(trim=FALSE)+ theme_minimal()+ ylim(40, 100)+
                geom_boxplot(width=0.1, fill="white")+
		labs(title= paste("Référence: ", input$name,
                                  " ; Current: ",
                                  Poly.tst$NAME[Poly.tst$xx== getClk()]),
                     x= "", y = "Niveau sur une échelle de 1 à 100")+    
                scale_fill_manual(values= AocPal)+ 
                theme(legend.position= "none")+
                scale_x_discrete(expand= expand_scale(mult= 0, add= 1),drop=T)+
                geom_hline(yintercept= yop, lty= 3, col= "red")+
            geom_hline(yintercept= yap, lty= 2, col= "blue")+
                annotate("text", x= 0.4,
                         y= yop+ 2, label = "Référence", col= "red")+
                annotate("text", x= 5.6,
                         y= ifelse(is.null(input$mymap_shape_click),
                                   -100, yap)+ 2, label="Current", col= "blue")
        })
    })
})

shinyApp(ui, server)
 #+end_src

**** TEST 8

#+begin_src R
library(shiny) ; library(shinydashboard) ; library(shinyjs)
library(leaflet) ; library(maptools) ; library(ggplot2)
Pts.Crd <- spTransform(Poly.Ras, CRS("+proj=longlat +ellps=WGS84"))

source("./ui.R")
source("./server.R")
shinyApp(ui, server)

ui <- dashboardPage(
    dashboardHeader(
        titleWidth= 550, 
        title= "Classification statistique des vignobles de la Côte d'Or"),
    dashboardSidebar(disable = TRUE),
    dashboardBody(
        fluidRow(
            box(width= 3,
                column(width= 12,
                       selectInput(
                           "niveau", label= "Niveau de l'appellation",
                           choices=
                               c(as.character(unique(Poly.Ras$NIVEAU)),
                                 "TOUS"),
                           selected= 1),
                       selectInput(
                           "commune", 
                           label= "Commune de la parcelle",
                           choices= c(
                               as.character(unique(Poly.Ras$LIBCOM)),
                               "TOUTES"), selected= 1),
                       selectInput(
                           "nom",
                           label= "Lieu dit de la parcelle",
                           choices= c(
                               as.character(unique(Poly.Ras$NOM)),
                               "TOUS"), selected = 1),
                       plotOutput("miplot", width='100%'),
                       tableOutput('table'))),
            box(width= 9, 
                column(width = 12, 
                       leafletOutput("mymap", height= 645),
                       fluidRow(verbatimTextOutput("mymap_shape_click"))
                       )
                )
        )
    )
)

server <- function(input, output, session) {
    observe({
        updateSelectInput(
            session, "commune",
            choices= c(
                as.character(unique(Poly.Ras$LIBCOM[Poly.Ras$NIVEAU
                                                    %in% input$niveau])),
                "TOUTES"))})
    observe({
        updateSelectInput(
            session, "nom",
            choices= c(
                as.character(unique(Poly.Ras$NOM[Poly.Ras$NIVEAU %in%
                                                 input$niveau &
                                                 Poly.Ras$LIBCOM %in%
                                                 input$commune ])),
                "TOUS"))})
    observe({
        getPts <- reactive({
            Pts.Crd[Pts.Crd$NIVEAU %in% input$niveau &
                    Pts.Crd$LIBCOM %in% input$commune &
                    Pts.Crd$NOM    %in% input$nom, ]})
        output$mymap <- renderLeaflet({
            map@map %>%
                setView(mean(coordinates(getPts())[, 1]),
                        mean(coordinates(getPts())[, 2]), zoom= 17) %>%
                addCircleMarkers(data= SpatialPoints(getPts()))
        })
        output$miplot <- renderPlot({
            yop <- getPts()$PRDcor
            top <- round(100-
                         aggregate(I(Poly.Ras$PRDcor< yop)* 100,
                                   by= list(Poly.Ras$NIVEAU), mean)[, 2])
            ggplot(Poly.Ras@data, aes(x= factor(NIVEAU),
                                      y= PRDcor, fill= factor(NIVEAU)))+
                geom_violin(trim= FALSE)+ theme_minimal()+ ylim(40, 100)+
                geom_boxplot(width=0.1, fill="white")+
                annotate("text", x= 1: 5, y= 100,
                         label= paste("Top", top, "%"), col= "red")+
                labs(title= "Comparaison avec les autres parcelles",
                     x= "", y = "Niveau sur une échelle de 1 à 100")+    
                scale_fill_manual(values= AocPal)+ 
                theme(legend.position= "none")+
                scale_x_discrete(expand= expand_scale(mult= 0, add= 1),
                                 drop= T)+
                geom_hline(yintercept= yop, lty= 3, col= "red")+
                annotate("text", x= 0.35, y= yop+ 2,
                         label= round(yop, 2), col= "red")

        })
    })
}

#+end_src

*** Lancer l'application localement

    Une fois la cartographie dynamique effectuée, l'application
    /Shiny/ peut être déployée localement, suite au chargement des
    packages associés.  L'intégralité du code de l'application est
    reporté en Annexe 4 et 5, qui produises les fichiers =ui.R= et
    =server.R= qui sont également disponibles sur [[https://github.com/jsay/geoInd/tree/master/Application][github]].  

#+begin_src R :tangle ./Application2/global.R
library(shiny) ; library(shinydashboard) ; library(shinyjs)
library(leaflet) ; library(maptools) ; library(ggplot2)
library(markdown)
Pts.Crd <- st_centroid(Poly.Ras)

source("ui.R") ; source("server.R")
## source("Application/ui.R") ; source("Application/server.R")
## source("Application2/ui.R") ; source("Application2/server.R")

enableBookmarking(store = "url")
shinyApp(ui,server)
#+end_src

#+RESULTS:

*** Manuel d'utilisation

    L'application est structurée en 3 parties, avec en haut à gauche
    des zones de saisie pour renseigner directement une localité (à
    partir des informations disponibles sur les étiquettes d'un vin ou
    à partir de ses connaissances personnelles); en bas à gauche un
    graphique qui positionne la qualité de la localité sélectionnée
    dans la distribution générale des qualité (où les niveaux
    d'appellation sont différentiés); et à droite la cartographie
    dynamique qui permet de faire apparaître la localité sélectionnée,
    amis permet aussi de se déplacer librement sur la zone d'étude.
    Les fonctions de la cartographie dynamique sont maintenues, ainsi
    un clic sur une zone permet de faire apparaître ses
    caractéristiques, et les prévisions du modèle en particulier.

    Prenons l'exemple d'un vin d'un niveau Premier cru, sur la commune
    de Flagey-Echezeaux, qui a pour lieu dit (dénomination en
    l'occurrence) Les Rouges.  Suite à la saisie de ces
    caractéristiques dans les zones dédiées, le score corrigé prédit
    pour ce vin égal à 83.82 apparaît dans le graphique en bas à
    gauche de l'application, et nous observons que ce score est
    supérieur à l'ensemble des Coteaux bourguignons, des Bourgognes
    régionaux et des villages de la zone.  Ce Premier cru est parmi
    les 10% de Premiers crus qui ont les plus hauts scores et il
    dépasse même 30% des Grands crus de la zone.  La partie à droite
    de l'application a zoomé sur cette zone, un clic sur le lieu dit
    en question permet de faire apparaître la différence entre les
    prédictions brutes et corrigées.  Ainsi, le score non corrigé de
    la localité est sensiblement plus bas (80.92), ce qui implique que
    suite à la correction des effets communaux, le vin passe du top 7%
    au top 3% sur l'ensemble de la zone étudiée.  Ce résultat est
    consistant avec les effets communaux reportés dans la Figure 5, où
    la commune de Flagey-Echezeaux apparaît comme relativement
    défavorisée dans la hiérarchie.  Nous pouvons également que ce
    Premier est mitoyen du Grand cru Echezeaux qui se trouve tout
    juste à l'Est.

*** Développements à venir                   :noexport:

    - Corriger les surfaces

    - Régler le LIBCOM = NA sur la commune de Marsannay (pres des
      echzeaux), il y a SAVIGNY-LES-BEAUNE 1ER CRU "Aux Guettes" qui
      fait planté l'appli

    - Diminuer la taille du graphique pour fitter le smart phone

    - Faire un onglet pour des croisements exhaustifs, réfléchir à
    l'interaction avec la carte et le graphique

    - Pour le rank, mettre la position plutôt que la part, corriger
      les valeurs qui sont reporter dans les box.

    - Réfléchir à l'emplacement d'enregistrement de la base

    - faire des url qui pointent sur les parcelles

*** Déploiement                              :noexport:
**** Sur Rstudio server

    https://www.shinyapps.io/admin/#/dashboard
    http://shiny.rstudio.com/articles/shinyapps.html


# https://rtask.thinkr.fr/blog/a-tale-of-two-shiny-apps-google-auth-shinyproxy/
# http://code.markedmondson.me/
# https://code.markedmondson.me/r-on-kubernetes-serverless-shiny-r-apis-and-scheduled-scripts/

#+begin_src R
library(rsconnect)
rsconnect::setAccountInfo(name='geoind',
			  token='82F46B13B55046680E20FD09364E805A',
			  secret='XXQkLNx5bGEOAIiAsuBcv9Sz5dYjoj1o/KIiag1G')
rsconnect::deployApp('./Application')

rsconnect::deployApp('./Application2')
#+end_src

**** Sur serveur cesaer

#+begin_src sh
sudo mount.davfs https://cesaer-datas.inra.fr/remote.php/webdav ./cesaer
sudo cp -r ./geoind_app ./cesaer/
#+end_src

** Conclusion
  :PROPERTIES:
  :CUSTOM_ID: Sec:5
  :END:

   Le chiffres d’affaire des signes de qualité c’est 32 milliards
   d’euros et le budget de l’INAO 32 millions d’euros, c’est un
   millième du chiffre d’affaires.  

   Information pour les consommateurs, l'appli peut permettre de
   passer d'une information discrète à continue, ce qui permet
   d'accroître la qualité de 80 à 95 (cf WP). 

   Développements à venir.

*** Remerciements

   Nous tenons à remercier Pauline, Vincent, Guillaume.


#+begin_src R :wrap example
sessionInfo()
#+end_src

#+RESULTS:
#+begin_example
R version 3.6.0 (2019-04-26)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 18.04.2 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.7.1
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.7.1

locale:
 [1] LC_CTYPE=fr_FR.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=fr_FR.UTF-8        LC_COLLATE=fr_FR.UTF-8    
 [5] LC_MONETARY=fr_FR.UTF-8    LC_MESSAGES=fr_FR.UTF-8   
 [7] LC_PAPER=fr_FR.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=fr_FR.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods  
[7] base     

other attached packages:
[1] latticeExtra_0.6-28 lattice_0.20-38     mgcv_1.8-28        
[4] nlme_3.1-140        rgdal_1.3-6         sf_0.7-2           
[7] mapview_2.6.3       RColorBrewer_1.1-2  sp_1.3-1           

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.0        compiler_3.6.0    later_0.7.5      
 [4] base64enc_0.1-3   class_7.3-15      tools_3.6.0      
 [7] digest_0.6.18     satellite_1.0.1   viridisLite_0.3.0
[10] png_0.1-7         Matrix_1.2-17     shiny_1.2.0      
[13] DBI_1.0.0         crosstalk_1.0.0   e1071_1.7-0      
[16] raster_2.8-4      htmlwidgets_1.3   stats4_3.6.0     
[19] classInt_0.3-1    leaflet_2.0.2     grid_3.6.0       
[22] webshot_0.5.1     R6_2.4.0          magrittr_1.5     
[25] scales_1.0.0      codetools_0.2-16  promises_1.0.1   
[28] htmltools_0.3.6   units_0.6-2       splines_3.6.0    
[31] mime_0.6          xtable_1.8-3      colorspace_1.3-2 
[34] httpuv_1.4.5      munsell_0.5.0
#+end_example

#+Latex: \clearpage

** Bibliographie
  :PROPERTIES:
  :CUSTOM_ID: Sec:6
  :END:

   bibliographystyle:../Softwares/latex/erae
   bibliography:Biblio.bib

#+LATEX: \clearpage\appendix

** Annexes
  :PROPERTIES:
  :CUSTOM_ID: Sec:A
  :END:
*** Annexe 1 : Construction des données      :noheading:

    *Annexe 1 : Construction des données*

    Cette annexe reporte les codes =R= utilisés pour constituer la
    base de données principale associée à l'article.  Les références
    des données sources sont mentionnées dans le corps de l'article.

***** /Données parcellaires/

    Le résultat de ces traitements se trouve dans le fichier
    =/Carto/GeoCad.shp= (disponible auprès des auteurs sur demande)
    utilisé dans le code suivant :

#+begin_src R :wrap example
library(sp) ; library(rgdal)
Geo.Cad <- readOGR("./Carto", "GeoCad")
sapply(Geo.Cad@data, function(x) sum(is.na(x)))
#+end_src

#+RESULTS:
#+begin_example
OGR data source with driver: ESRI Shapefile 
Source: "/home/jsay/geoInd/Carto", layer: "GeoCad"
with 110350 features
It has 16 fields
    IDU CODECOM    AREA   PERIM MAXDIST PAR2RAS    PAOC    BGOR 
      0       0       0       0       0       0   49718   49718 
   BOUR    VILL    COMM    PCRU    GCRU     AOC   AOCtp   AOClb 
  49718   49718   49718   49718   49718       0   49718   49718
#+end_example

***** /Données raster/

    Le fichier =Data/DatRas= appariés aux données du cadastre peut
    être obtenu auprès des auteurs.

#+begin_src R :wrap example
library(data.table)
dim(Dat.Ras <- fread("./Data/DatRas.csv"))
Cad.Ras <- Dat.Ras[, lapply(.SD, mean), 
                   by= list(PAR2RAS),.SDcols= names(Dat.Ras)[-c(1, 4, 13)]]
Geo.Ras <- merge(Geo.Cad, Cad.Ras, by= "PAR2RAS")
sapply(Geo.Ras@data[, 17: 26], function(x) sum(is.na(x))); rm(Dat.Ras)
#+end_src

#+RESULTS:
#+begin_example
[1] 14253070       13
  XL93   YL93  NOMOS  URBAN FOREST  WATER    DEM  SLOPE ASPECT  SOLAR 
  2096   2096   2096   2096   2096   2096   2096   2096   2096   2096
#+end_example

***** /Données géologiques (polygone)/

    Nous apparions les $13\,960$ polygones géologiques présent dans
    =/Carto/GeolMap= (disponible sur demande) sur la base du centroïde
    des parcelles cadastrales, comme présenté dans le code suivant.

#+begin_src R :wrap example
Geol.Map <- readOGR("./Carto/", "GeolMap")
Pts.Cad <- SpatialPoints(Geo.Ras, proj4string= CRS(proj4string(Geol.Map)))
Geo.Ras@data <- cbind(Geo.Ras@data, over(Pts.Cad, Geol.Map))
sapply(Geo.Ras@data[, 27: 42], function(x) sum(is.na(x)))
#+end_src

#+RESULTS:
#+begin_example
OGR data source with driver: ESRI Shapefile 
Source: "/home/jsay/geoInd/Carto", layer: "GeolMap"
with 13960 features
It has 16 fields
      CODE   NOTATION      DESCR   TYPEGEOL   APLOCALE     TYPEAP 
        31         31         31         31        862        862 
   GEOLNAT   ISOPIQUE     AGEDEB     ERADEB     SYSDEB LITHOLOGIE 
        31         31         31         31         31         31 
    DURETE  ENVIRONMT  GEOCHIMIE   LITHOCOM 
        69         31         31         69
#+end_example

***** /Données pédologiques (polygone)/

#+begin_src R :wrap example
Pedo.Map <- readOGR("./Carto", "PedoMap")
Geo.Ras@data <- cbind(Geo.Ras@data, over(Pts.Cad, Pedo.Map))
Geo.Ras@data[, c(44: 47, 49: 54)] <-
    apply(Geo.Ras@data[, c(44: 47, 49: 54)], 2, as.numeric)
sapply(Geo.Ras@data[, 43: 55], function(x) sum(is.na(x)))
#+end_src

#+RESULTS:
#+begin_example
OGR data source with driver: ESRI Shapefile 
Source: "/home/jsay/geoInd/Carto", layer: "PedoMap"
with 194 features
It has 13 fields

  NOUC SURFUC   TARG   TSAB   TLIM TEXTAG  EPAIS    TEG    TMO    RUE 
 14645  14645  14645  14645  14645  14645  14645  14645  14645  14645 
   RUD  OCCUP DESCRp 
 14645  14645  14645
#+end_example

***** /Données AOC historiques (polygones)/ 

#+begin_src R :wrap example
Hist.Aoc <- readOGR("Carto/", "Aoc1936")
Geo.Ras@data <- cbind(Geo.Ras@data, over(Pts.Cad, Hist.Aoc))
sapply(Geo.Ras@data[, 56: 57], function(x) sum(is.na(x)))
#+end_src

#+RESULTS:
#+begin_example
OGR data source with driver: ESRI Shapefile 
Source: "/home/jsay/geoInd/Carto", layer: "Aoc1936"
with 56 features
It has 2 fields
AOC36lab AOC36lvl 
      70       70
#+end_example

***** /Données Lieux dits (polygones)/

#+begin_src R :wrap example
Lieu.Dit <- readOGR("./Carto/", "LieuDit")
Geo.Ras@data <- cbind(Geo.Ras@data, over(Pts.Cad, Lieu.Dit[, -1]))
sapply(Geo.Ras@data[, 58: 67], function(x) sum(is.na(x)))
#+end_src

#+RESULTS:
#+begin_example
OGR data source with driver: ESRI Shapefile 
Source: "/home/jsay/geoInd/Carto", layer: "LieuDit"
with 3285 features
It has 11 fields
 LIEUDIT   CLDVIN   LIBCOM     XCHF     YCHF   ALTCOM   SUPCOM 
    4494     4494     4494     4494     4494     4494     4494 
  POPCOM CODECANT   REGION 
    4494     4494     4494
#+end_example

***** /Enregistrement de la base/

#+begin_src R :wrap example
dim(Geo.Ras)
save(Geo.Ras, file= "Inter/GeoRas.Rda")
writeOGR(Geo.Ras, "Carto/", "GeoRas", driver= "ESRI Shapefile")
#+end_src

#+RESULTS:
#+begin_example
[1] 110350     67
#+end_example

#+Latex: \clearpage

*** Annexe 2 : Intitulés géologiques         :noheading:

    *Annexe 2 : Intitulés géologiques*

#+begin_src R :tangle ./myFcts.R
trans_geol <- data.frame(
    GEOL= Reg.Ras$GEOL[!duplicated(Reg.Ras$GEOL)],
    GEOf= c(
        "Calcaires massifs de \"Comblanchien\" (Bathonien sup.)",
        "Marnes et calcaires divers (Callovien inférieur)",
        "Marnes et calcaires argileux (Oxfordien moyen)",
        "Eboulis ordonnés cryoclastiques et colluvions diverses",
        "Oolithe ferrugineuse (Oxfordien moyen-sup)",
        "Calcaires hydrauliques de Molesmes et Noiron (Oxfordien sup.)",
        "Colluvions diverses",
        "Dépôts argilo-limoneux, sables et graviers du Villafranchien",
        "Calcaires de Tonnerre, Oisellemont et calcaires à Astartes",
        "Eboulis et glissements de terrains",
        "Calcaires grenus bicolores (Bathonien terminal)",
        "Terrasse argilo-limoneuse de Saint-Usage",
        "Formation de Saint-Cosme (marnes fluvio-lacustres varvées)",
        "Alluvions anciennes indifférenciées, argilo-limoneuses",
        "Calcaires bioclastiques, graveleux, à oolithes (Bathonien inf.)"
    ),
    GEOe= c(
        "Massive limestones from \"Comblanchien\" (upper Bathonian)",
        "Various marls and limestones (lower Callovian)",
        "Marls and argillaceous limestones (middle Oxfordian)",
        "Ordered cryoclastic scree and various colluviums",
        "Ferruginous Oolite (middle-upper Oxfordian)",
        "Hydraulic limestones of Molesmes and Noiron (upper Oxfordian)",
        "Various colluviums",
        "Clay-silt deposits, sand and gravel from Villafranchien",
        "Limestones of Thunder, Oisellemont and limestones in Astartes",
        "Screes and landslides",
        "Two-tone gray limestones (terminal Bathonian)",
        "Clay-silty terrace of Saint-Usage",
        "Formation of Saint-Cosme (varnished fluvio-lacustrine marls)",
        "Undifferentiated ancient alluvium, clay-silty",
        "Bioclastic limestones, gravelly, with oolites (lower Bathonian)")
)
#+end_src

#+LATEX: \clearpage

*** Annexe 3 : Intitulés pédologiques        :noheading:

    *Annexe 3 : Intitulés pédologiques*

#+begin_src R  :tangle ./myFcts.R
trans_pedo <- data.frame(
    PEDO= Reg.Ras$PEDO[!duplicated(Reg.Ras$PEDO)],
    PEDf= c(
        "Vignoble de la Côte de de Beaune",
        "Cônes de déjection du pied de Côte",
        "Côteaux viticoles des Hautes Côtes de Nuits",
        "Courtes pentes marneuses des plateaux plio-pléistocène",
        "Piedmont de la côte viticole",
        "Versants pentus des Hautes Côtes de Beaune",
        "Sommets des collines des Hautes Côtes de Beaune",
        "Alluvions récentes calcaires des vallées (Ouche, Tille, Meuzin)",
        "Pentes liasiques du Haut-Auxois",
        "Basses terrasses gravelo-caillouteuses des plaines alluviales",
        "Basses terrasses argileuses des plaines alluviales",
        "Terrasse argilo-limoneuse de Saint-Usage",
        "Vignoble de la Côte de Nuits",
        "Rebord oriental des plateaux calcaires dominant la Côte viticole"
    ),
    PEDe= c(
        "Vineyard of the Côte de Beaune",
        "Coot footing cones",
        "Wine hills of Hautes Côtes de Nuits",
        "Oxfordian limestone-marly trays of the Hautes Côtes",
        "Short marly slopes of Plio-Pleistocene plateaus",
        "Piedmont of the vineyard of the Côte",
        "Sloping slopes of the Hautes Côtes de Beaune",
        "Summits of the hills of the Hautes Côtes de Beaune",
        "Recent alluvial limestone valleys (Ouche, Tille, Meuzin)",
        "Liastic slopes of Haut-Auxois",
        "Gravelo-stony low terraces of alluvial plains",
        "Low clay terraces of alluvial plains",
        "Vineyard of the Côte de Nuits",
        "Eastern edge of the limestone plateaus overlooking the Côte"
    )
)
#+end_src

#+LATEX: \clearpage

*** Annexe 4 : Interface utilisateur         :noheading:

    *Annexe 5 : Interface utilisateur de l'application*

#+begin_src R :tangle ./Application/ui.R
ui <- dashboardPage(
  dashboardHeader(
    titleWidth= 400, 
    title= "Classification des vignobles de la Côte d'Or"),
  dashboardSidebar(disable = TRUE),
  dashboardBody(
    fluidRow(
      box(width= 2, height= 375,
          selectInput("niveau", label= "Niveau de l'appellation",
                      choices=
                          c(as.character(unique(Poly.Ras$NIVEAU))),
                      selected= 1),
          selectInput("commune", label= "Commune de la parcelle",
                      choices= c(
                          as.character(unique(Poly.Ras$LIBCOM)),
                          "TOUTES"), selected= 1),
          selectInput("nom", label= "Lieu dit de la parcelle",
                      choices= c(
                          as.character(unique(Poly.Ras$NOM)),
                          "TOUS"), selected = 1)),
      box(width= 3, height= 645, plotOutput("miplot")),
      box(width= 3, 
          column(width = 12, 
                 leafletOutput("mymap", height= 645),
                 fluidRow(verbatimTextOutput("mymap_shape_click"))
          )
      )
    )
  )
)
#+end_src

#+RESULTS:

#+begin_src R :tangle ./Application2/ui.R
ui <- function(request){
    fluidPage(sidebarLayout(
        sidebarPanel(
            width= 2,
            selectInput("niveau",label= "Niveau de l'appellation",
                        choices=
                            c(as.character(unique(Poly.Ras$NIVEAU))),
                        selected= 1),
            selectInput("commune", label= "Commune de la parcelle",
                        choices= c(
                            as.character(unique(Poly.Ras$LIBCOM)),
                            "TOUTES"), selected= 1),
            selectInput("nom", label= "Lieu dit de la parcelle",
                        choices= c(
                            as.character(unique(Poly.Ras$NOM)),
                            "TOUS"), selected = 1),
            bookmarkButton()
        ),
        mainPanel(
            width= 3,
            tabsetPanel(id = "inTabset",
                        tabPanel(title = "Carte",
                                 leafletOutput("mymap", height= 645)),
                        tabPanel(title = "Figure", plotOutput("miplot")),
                        tabPanel(title = "Détails",
                                 includeMarkdown("README.md"))
                        )
        )
    ))}
#+end_src

#+RESULTS:

#+Latex: \clearpage

*** Annexe 5 : Partie serveur                :noheading:

    *Annexe 6 : Partie serveur de l'application*

#+begin_src R :tangle ./Application/server.R
server <- function(input, output, session) {
    ## Reactive values 
    values <- reactiveValues(niveau= NULL, commune= NULL, nom= NULL)  
    ## Initialisation reactive values
    observe({
        if (is.null(values$niveau))  values$niveau  <- input$niveau
        if (is.null(values$commune)) values$commune <- input$commune
        if (is.null(values$nom))     values$nom     <- input$nom
    })
    ## MAJ des reactive values apres un click sur un polygone
    observeEvent(input$mymap_shape_click,{
        values$niveau  <- Pts.Crd$NIVEAU[Pts.Crd$Concat==
                                         input$mymap_shape_click$id]
        values$nom     <- Pts.Crd$NOM[Pts.Crd$Concat==
                                      input$mymap_shape_click$id]
        values$commune <-Pts.Crd$LIBCOM[Pts.Crd$Concat==
                                        input$mymap_shape_click$id]
    })
    ## MAJ des reactive values apres un choix dans menus deroulants
    observeEvent(c(input$commune, input$niveau, input$nom),{
        if (values$niveau  != input$niveau) {
            values$niveau  <- input$niveau
            values$commune <- Pts.Crd$LIBCOM[Pts.Crd$NIVEAU==
                                             values$niveau][ 1]
            values$nom     <- Pts.Crd$NOM[Pts.Crd$LIBCOM==
                                          values$commune][ 1]
        }
        else if (values$commune != input$commune) {
            values$commune <- input$commune
            values$nom <- Pts.Crd$NOM[Pts.Crd$LIBCOM== values$commune][ 1]
        }           
        else if (values$nom!=input$nom){
            values$nom<-input$nom
        }})
    ## MAJ menus deroulants
    observeEvent(c(values$commune, values$niveau, values$nom),{
        updateSelectInput(session, "niveau",
                          choices= c(as.character(
                              unique(Poly.Ras$NIVEAU))),
                          selected=values$niveau)
        updateSelectInput(session, "commune",
                          choices= c(as.character(
                              unique(Poly.Ras$LIBCOM[Poly.Ras$NIVEAU %in%
                                                     values$niveau]))),
                          selected=values$commune)
        updateSelectInput(session, "nom",
                          choices= c(as.character(
                              unique(Poly.Ras$NOM[Poly.Ras$LIBCOM %in%
                                                  values$commune &
                                                  Poly.Ras$NIVEAU %in%
                                                  values$niveau]))),
                          selected=values$nom)
    })
    ## Subset donnees
    getPts <- reactive({
        Pts.Crd[Pts.Crd$NIVEAU %in% values$niveau &
                Pts.Crd$LIBCOM %in% values$commune &
                Pts.Crd$NOM    %in% values$nom, ]})
    ## Carte de base
    output$mymap <- renderLeaflet({
        map@map
    })
    ## Rafraichissement carte
    observe({
        gg <- getPts()
        if (nrow(gg)== 0) return(NULL)
        else {
            bound_box <- as.numeric(st_bbox(Poly.Ras[Poly.Ras$Concat %in%
                                                     gg$Concat,]))
            leafletProxy("mymap") %>%
                clearMarkers() %>%
                fitBounds(lng1= bound_box[ 3], lng2= bound_box[ 1],
                          lat1= bound_box[ 4], lat2= bound_box[ 2]) %>%
                addCircleMarkers(data= (getPts()))}
    })
    ## Violon Plot de base
    output$miplot <- renderPlot({
        yop <- getPts()$SCORE_corrigé
        if (length(yop)==0) return(NULL)
        top <- round(100-
                     aggregate(I(Poly.Ras$SCORE_corrigé< yop)* 100,
                               by= list(Poly.Ras$NIVEAU), mean)[, 2])
        ggplot(Poly.Ras, aes(x= factor(NIVEAU),
                             y= SCORE_corrigé, fill= factor(NIVEAU)))+
            geom_violin(trim= FALSE)+ theme_minimal()+ ylim(40, 100)+
            geom_boxplot(width=0.1, fill= "white")+
            annotate("text", x= 1: 5, y= 100,
                     label= paste("Top", top, "%"), col= "red", size= 7)+
            labs(title= "Comparaison avec les autres parcelles",
                 x= "\n source: jean-sauveur ay @ inra cesaer, voir https://github.com/jsay/geoInd/",
                 y = "Niveau sur une échelle de 1 à 100")+ 
            scale_fill_manual(values= AocPal)+ 
            theme(legend.position= "none",
                  plot.title = element_text(hjust = 0, size = 16),
                  axis.text.x = element_text(size= 14),
                  axis.title.x = element_text(hjust= 0, size= 14),
                  axis.title.y = element_text(size= 14))+
            scale_x_discrete(expand= expand_scale(mult= 0, add= 1),
                             drop= T)+
            geom_hline(yintercept= yop, lty= 2, col= "red")+
            annotate("text", x= 0.35, y= yop+ 2,
                     label= round(yop, 2), col= "red", size= 8)
    }, height = 575, width = 400)}
#+end_src

#+RESULTS:

#+begin_src R :tangle ./Application2/server.R

server <- function(input, output, session) {
    ## Reactive values 
    values <- reactiveValues(niveau= NULL, commune= NULL, nom= NULL)  
    ## Initialisation reactive values
    observe({
        if (is.null(values$niveau))  values$niveau  <- input$niveau
        if (is.null(values$commune)) values$commune <- input$commune
        if (is.null(values$nom))     values$nom     <- input$nom
    })
    ## MAJ des reactive values apres un click sur un polygone
    observeEvent(input$mymap_shape_click,{
        values$niveau  <- Pts.Crd$NIVEAU[Pts.Crd$Concat==
                                         input$mymap_shape_click$id]
        values$nom     <- Pts.Crd$NOM[Pts.Crd$Concat==
                                      input$mymap_shape_click$id]
        values$commune <-Pts.Crd$LIBCOM[Pts.Crd$Concat==
                                        input$mymap_shape_click$id]
    })
    ## MAJ des reactive values apres un choix dans menus deroulants
    observeEvent(c(input$commune, input$niveau, input$nom),{
        if (values$niveau  != input$niveau) {
            values$niveau  <- input$niveau
            values$commune <- Pts.Crd$LIBCOM[Pts.Crd$NIVEAU==
                                             values$niveau][ 1]
            values$nom     <- Pts.Crd$NOM[Pts.Crd$LIBCOM==
                                          values$commune][ 1]
        }
        else if (values$commune != input$commune) {
            values$commune <- input$commune
            values$nom <- Pts.Crd$NOM[Pts.Crd$LIBCOM== values$commune][ 1]
        }           
        else if (values$nom!=input$nom){
            values$nom<-input$nom
        }})
    ## MAJ menus deroulants
    observeEvent(c(values$commune, values$niveau, values$nom),{
        updateSelectInput(session, "niveau",
                          choices= c(as.character(
                              unique(Poly.Ras$NIVEAU))),
                          selected=values$niveau)
        updateSelectInput(session, "commune",
                          choices= c(as.character(
                              unique(Poly.Ras$LIBCOM[Poly.Ras$NIVEAU %in%
                                                     values$niveau]))),
                          selected=values$commune)
        updateSelectInput(session, "nom",
                          choices= c(as.character(
                              unique(Poly.Ras$NOM[Poly.Ras$LIBCOM %in%
                                                  values$commune &
                                                  Poly.Ras$NIVEAU %in%
                                                  values$niveau]))),
                          selected=values$nom)
    })
    ## Subset donnees
    getPts <- reactive({
        Pts.Crd[Pts.Crd$NIVEAU %in% values$niveau &
                Pts.Crd$LIBCOM %in% values$commune &
                Pts.Crd$NOM    %in% values$nom, ]})
    ## Carte de base
    output$mymap <- renderLeaflet({
        map@map
    })
    ## Rafraichissement carte
    observe({
        gg <- getPts()
        if (nrow(gg)== 0) return(NULL)
        else {
            bound_box <- as.numeric(st_bbox(Poly.Ras[Poly.Ras$Concat %in%
                                                     gg$Concat,]))
            leafletProxy("mymap") %>%
                clearMarkers() %>%
                fitBounds(lng1= bound_box[ 3], lng2= bound_box[ 1],
                          lat1= bound_box[ 4], lat2= bound_box[ 2]) %>%
                addCircleMarkers(data= (getPts()))}
    })
    ## Violon Plot de base
    output$miplot <- renderPlot({
        yop <- getPts()$SCORE_corrigé
        if (length(yop)==0) return(NULL)
        top <- round(100-
                     aggregate(I(Poly.Ras$SCORE_corrigé< yop)* 100,
                               by= list(Poly.Ras$NIVEAU), mean)[, 2])
        ggplot(Poly.Ras, aes(x= factor(NIVEAU),
                             y= SCORE_corrigé, fill= factor(NIVEAU)))+
            geom_violin(trim= FALSE)+ theme_minimal()+ ylim(40, 100)+
            geom_boxplot(width=0.1, fill= "white")+
            annotate("text", x= 1: 5, y= 100,
                     label= paste("", top, "%"), col= "red", size= 5)+
            labs(title= "Comparaison avec les autres parcelles",
                 x= "",
                 y = "Niveau sur une échelle de 1 à 100")+ 
            scale_fill_manual(values= AocPal)+ 
            theme(legend.position= "none",
                  plot.title = element_text(hjust = 0, size = 16),
                  axis.text.x = element_text(size= 12),
                  axis.title.x = element_text(hjust= 0, size= 14),
                  axis.title.y = element_text(size= 14))+
            scale_x_discrete(expand= expand_scale(mult= 0, add= 1),
                             drop= T)+
            geom_hline(yintercept= yop, lty= 2, col= "red")+
            annotate("text", x= 0.35, y= yop+ 2,
                     label= round(yop, 2), col= "red", size= 5)
    }, height = 500, width = 400)}
#+end_src

#+RESULTS:

#+Latex: \clearpage

*** Annexe X : Code pour les violons         :noexport:

    *Annexe 4 : Code pour le graphique en violon*

#+begin_src R :tangle ./myFcts.R
GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin,
  draw_group = function(self, data, ..., draw_quantiles = NULL) {
    # Original function by Jan Gleixner (@jan-glx)
    # Adjustments by Wouter van der Bijl (@Axeman)
    data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
    grp <- data[1, "group"]
    newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
    newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
    newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])
    if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
      stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <= 1))
      quantiles <- create_quantile_segment_frame(data, draw_quantiles, split = TRUE, grp = grp)
      aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
      aesthetics$alpha <- rep(1, nrow(quantiles))
      both <- cbind(quantiles, aesthetics)
      quantile_grob <- GeomPath$draw_panel(both, ...)
      ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
    }
    else {
      ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
    }
  }
)

create_quantile_segment_frame <- function(data, draw_quantiles, split = FALSE, grp = NULL) {
  dens <- cumsum(data$density) / sum(data$density)
  ecdf <- stats::approxfun(dens, data$y)
  ys <- ecdf(draw_quantiles)
  violin.xminvs <- (stats::approxfun(data$y, data$xminv))(ys)
  violin.xmaxvs <- (stats::approxfun(data$y, data$xmaxv))(ys)
  violin.xs <- (stats::approxfun(data$y, data$x))(ys)
  if (grp %% 2 == 0) {
    data.frame(
      x = ggplot2:::interleave(violin.xs, violin.xmaxvs),
      y = rep(ys, each = 2), group = rep(ys, each = 2)
    )
  } else {
    data.frame(
      x = ggplot2:::interleave(violin.xminvs, violin.xs),
      y = rep(ys, each = 2), group = rep(ys, each = 2)
    )
  }
}

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, position = position, 
        show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}
#+end_src

#+Latex: \clearpage

*** Methods for GI codes                     :noexport:
    :PROPERTIES:
    :EXPORT_FILE_NAME: Codage
    :EXPORT_LATEX_CLASS: WorkinPap
    :EXPORT_OPTIONS: TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:3
    :EXPORT_TITLE: Détails sur le codage des AOCs
    :EXPORT_AUTHOR:
    :END:
**** Description

     A partir du fichier SIG multicouche
     =delimitation_parcellaire_aoc_viticoles_inao=, il faudrait
     construire les 11 variables suivantes dans le fichier =dicopar= (ou
     dans une autre base de données avec l'identifiant =PAR2RAS=):
  
    1. PAOC : vaut 1 si la parcelle est dans une AOC viticole, 0 sinon
       (i.e., si elle a une intersection non vide avec la couche inao).
    2. BPTG : vaut 1 si la parcelle est dans un polygone avec la
       variable =appellation= égale à "Bourgogne Passe-tout-Grain", 0
       sinon
    3. BGOR : vaut 1 si la parcelle est dans un polygone avec la
       variable =appellation= égale à "Coteaux Bourguignons ou Bourgogne
       grand ordinaire ou Bourgogne ordinaire", 0 sinon
    4. CREM : vaut 1 si la parcelle est dans un polygone avec la
       variable =appellation= égale à "Crémant de Bourgogne", 0 sinon
    5. ALIG : vaut 1 si la parcelle est dans un polygone avec la
       variable =appellation= égale à "Bourgogne aligoté", 0 sinon
    6. BOUR : vaut 1 si la parcelle est dans un polygone avec la
       variable =appellation= égale à "Bourgogne", 0 sinon
    7. MOUS : vaut 1 si la parcelle est dans un polygone avec la
       variable =appellation= égale à "Bourgogne mousseux", 0 sinon
    8. GCRU : vaut la valeur de la variable =appellation= si la parcelle
       est dans un polygone avec la valeur =appellation= dans la liste
       des grand crus ci-dessous, 0 sinon
    9. VILL : vaut la valeur de la variable =appellation= si la parcelle
       est dans un polygone avec la valeur =appellation= dans =c("Côte
       de Beaune", "Côte de Beaune-Villages", "Côte de
       Nuits-Villages")=, 0 sinon
    10. COMM : vaut la valeur de la variable =appellation= si la
	parcelle est dans un polygone avec la valeur =appellation= dans
	la liste des communes ci-dessous, 0 sinon
    11. PCRU : différente de 0 si le terme "premier cru" apparaît dans
	la variable =denomination= (recherche du type expression
	régulière). Cette variable prend la valeur du nom qui suit la
	mention du premier cru dans la variable =denomination=. (ex:
	elle vaut "La Coutière" si denomination= "Aloxe-Corton premier
	cru La Coutière"). Pour les valeurs avec "premier cru" seul,
	sans nom qui suit (ex: denomination= "Aloxe-Corton premier cru")
	la variable premier cru doit prendre la valeur "sans nom".

**** Codes

# Liste des Grands Crus
#+begin_src R :results output example
Liste_Grand_Crus <- c("Chambertin", "Chambertin-clos de Bèze",
                      "Charmes-Chambertin", "Mazoyères-Chambertin",
                      "Chapelle-Chambertin", "Griottes-Chambertin",
                      "Latricières-Chambertin", "Mazis-Chambertin",
                      "Ruchottes-Chambertin", "Bonnes Mares",
                      "Clos de la Roche", "Clos de Tart",
                      "Clos des Lambrays", "Clos St Denis",
                      "Bonnes Mares", "Musigny",
                      "Clos de Vougeot ou Clos Vougeot",
                      "Romanée-Conti", "La Romanée",
                      "La Tâche", "Richebourg",
                      "La Grande Rue", "Romanée-St-Vivant",
                      "Echezeaux", "Grands Echezeaux",  
                      "Corton", "Corton-Charlemagne",
                      "Charlemagne", "Montrachet",
                      "Chevalier-Montrachet",
                      "Bâtard-Monrachet", "Bienvenues-Bâtard-Montrachet",
                      "Montrachet", "Bâtard-Montrachet",
                      "Criots-Bâtard-Montrachet")
#+end_src

# Liste des Communes
#+begin_src R :results output example
Liste_Communes <- c("Aloxe-Corton", "Auxey-Duresses", "Beaune",
                    "Blagny", "Chambolle-Musigny",
                    "Chassagne-Montrachet", "Chorey-lès-Beaune",
                    "Fixin", "Gevrey-Chambertin", "Ladoix",
                    "Marsannay", "Meursault", "Monthélie",
                    "Morey-Saint-Denis", "Nuits-Saint-Georges",
                    "Pernand-Vergelesses", "Pommard",
                    "Puligny-Montrachet", "Saint-Aubin",
                    "Saint-Romain", "Santenay", "Savigny-lès-Beaune",
                    "Volnay", "Vosne-Romanée", "Vougeot")
#+end_src

# Liste des Grands Crus matchés aux communes
#+begin_src R :results output example
GrandCru <- data.frame("Gevrey-Chambertin", "Chambertin",
                       "Gevrey-Chambertin", "Chambertin-clos de Bèze",
                       "Gevrey-Chambertin", "Charmes-Chambertin",
                       "Gevrey-Chambertin", "Mazoyères-Chambertin",
                       "Gevrey-Chambertin", "Chapelle-Chambertin",
                       "Gevrey-Chambertin", "Griottes-Chambertin",
                       "Gevrey-Chambertin", "Latricières-Chambertin",
                       "Gevrey-Chambertin", "Mazis-Chambertin",
                       "Gevrey-Chambertin", "Ruchottes-Chambertin",
                       "Morey St Denis", "Bonnes Mares",
                       "Morey St Denis", "Clos de la Roche",
                       "Morey St Denis", "Clos de Tart",
                       "Morey St Denis", "Clos des Lambrays",
                       "Morey St Denis", "Clos St Denis",
                       "Chambolle-Musigny", "Bonnes Mares",
                       "Chambolle-Musigny", "Musigny",
                       "Vougeot", "Clos de Vougeot ou Clos Vougeot",
                       "Vosne-Romanée", "Romanée-Conti",
                       "Vosne-Romanée", "La Romanée",
                       "Vosne-Romanée", "La Tâche",
                       "Vosne-Romanée", "Richebourg",
                       "Vosne-Romanée", "La Grande Rue",
                       "Vosne-Romanée", "Romanée-St-Vivant",
                       "Flagey-Echezeaux", "Echezeaux",
                       "Flagey-Echezeaux", "Grands Echezeaux",  
                       "Ladoix-Serrigny", "Corton",
                       "Ladoix-Serrigny", "Corton-Charlemagne",
                       "Pernand-Vergelesses", "Corton",
                       "Pernand-Vergelesses", "Corton-Charlemagne",
                       "Pernand-Vergelesses", "Charlemagne",
                       "Puligny-Montrachet", "Montrachet",
                       "Puligny-Montrachet", "Chevalier-Montrachet",
                       "Puligny-Montrachet", "Bâtard-Monrachet",
                       "Puligny-Montrachet", "Bienvenues-Bâtard-Montrachet",
                       "Chassagne-Montrachet", "Montrachet",
                       "Chassagne-Montrachet", "Bâtard-Montrachet",
                       "Chassagne-Montrachet", "Criots-Bâtard-Montrachet")
#+end_src

* Reprod Paper
  :PROPERTIES:
  :EXPORT_FILE_NAME:    ReproPaper
  :EXPORT_LATEX_CLASS:  ManueStat
  :EXPORT_LANGUAGE:     en
  :EXPORT_OPTIONS:      TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:3
  :EXPORT_TITLE:        @@latex: \vspace{-1cm} The informational content of geographical indications@@
  :EXPORT_AUTHOR:       @@latex: Jean-Sauveur AY\footnote{\url{jsay@inra.fr}, UMR CESAER, AgroSup, INRA, Univ. Bourgogne Franche-Comté, 26 bd Dr Petitjean, 21000 Dijon (FR).} \\[.15cm] INRA UMR CESAER @@
  :EXPORT_DATE:         @@latex: Replication Material Version 1.1 : \today @@
  :EXPORT_LATEX_HEADER: \usepackage[T1]{fontenc}\usepackage{tabularx, rotating, booktabs, lscape, tikz, dcolumn, amssymb, amsmath, amsthm, bbm, eurosym, threeparttable, pdflscape, txfonts, rotfloat}  \usepackage{tocloft} \usepackage[toc]{multitoc}\renewcommand*{\multicolumntoc}{2}\setlength{\columnseprule}{.5pt}\setlength{\columnsep}{1cm}
  :END:
** Abstract                                  :noheading:
#+begin_export html
---
title:  The Informational Content of Geographical Indications
author: |
  | Jean-Sauveur Ay
  | UMR CESAER, AgroSup, INRA, Université Bourgogne Franche-Comté
---

# Abstract
#+end_export
#+BEGIN_abstract
This file contents the Replication Material (RM) associated to the
AAWE Working Paper No XXX entitled /The informational content of
geographical indications/.  Data, code and prediction materials are
under the copyright license GNU GPL V3, which means that license
notices must be preserved.  Raw data are available from the INRA
dataverse server [[https://doi.org/10.15454/ZZWQMN][https://data.inra.fr]].  Some R functions are reported
in the Appendix to preserve the readability of codes in the main text.
The most recent version of this document and a Shiny application about
the econometric classification of vineyards in the /Côte d'Or/
(Burgundy, France) are available from the remote repository
[[https://github.com/jsay/geoInd/blob/master/ReproPaper.pdf][https://github.com/jsay/geoInd]].
#+END_abstract
#+TOC: headlines 3
** Simulation                                :noexport:

   for Gaussian DGPs

*** Constant thresholds

#+begin_src R :results graphics :height 6 :width 11 :file "./Figures/Simu1.pdf"
x <- rnorm(10000, mean= 2, sd= 2)
xi <- rnorm(10000, sd= 1)
yi <- (.5* x)+ xi
y1 <- ifelse(yi< -1, 1, 0)
y2 <- ifelse(yi< 2 & yi> -1, 1, 0)
y3 <- ifelse(yi> 2, 1, 0)
y <- factor(ifelse(yi< -1, 1, ifelse(yi> 2, 3, 2)))
plot(yi[order(yi)], .5* x[order(yi)], type= "l",
     xlab= "Latent Variable (Signal+Noise) Increasingly Sorted",
     ylab= "Signal Part of Latent Variable")
abline(v= c(-1, 2), col= "orange", lty= 3, lwd= 2)
abline(a= 1/2, b= 1/ 2, col= "blue", lwd= 2)
lines(x= c(-10: -1, -1: 2, 2: 10),
      y= c(rep(mean(.5* x[ y1== 1]), 10),
           rep(mean(.5* x[ y2== 1]), 4), rep(mean(.5* x[ y3== 1]), 9)),
      col= "green", lty= 5, lwd= 2)
#+end_src

#+CAPTION: Gaussian Simulation of Information Signal from Geographical Indication (N= 10000)
#+ATTR_LATEX: :options scale= .55
#+RESULTS:
[[file:./Figures/Simu1.pdf]]

*** Variable thresholds

    The correlation between commune and quality has strong effects.

#+begin_src R
library(MASS) # for mvrnorm
xi <- rnorm(100000, sd= 1)
## If corr pos. inverse signal of ranking
Sig <- matrix(c(4, 0, 0, 1), 2, 2)
tmp <- mvrnorm(100000, c(2, 0), Sig)
x <- tmp[, 1] ; cx <- tmp[, 2]
cA <- ifelse(cx< -2/ 3 , 1, 0)
cB <- ifelse(cx> -2/ 3 & cx< -.05, 1, 0)
cC <- ifelse(cx> -.05  & cx< 1/3, 1, 0)
cD <- ifelse(cx> 1/3   , 1, 0)
ci <- factor(ifelse(cA== 1, "A",
             ifelse(cB== 1, "B",
             ifelse(cC== 1, "C", "D"))))
yi <- (.5* x)+ xi
gg <- model.matrix(~ 0+ ci)
s1 <- apply(gg, 1, function(z) -1+ sum(z* c(-3, -2, 1, 2)))
s2 <- apply(gg, 1, function(z)  2+ sum(z* c(-3, -2, 1, 2)))
table(yi< s1, yi> s2)
y1 <- ifelse(yi< s1, 1, 0)
y2 <- ifelse(yi< s2 & yi> s1, 1, 0)
y3 <- ifelse(yi> s2, 1, 0)
y <- factor(ifelse(yi< s1, 1, ifelse(yi> s2, 3, 2)))

plot(yi[order(yi)], .5* x[order(yi)], type= "l",
     xlab= "Latent Variable (Signal+Noise) Increasingly Sorted",
     ylab= "Signal Part of Latent Variable")
abline(v= c(-1, 2), col= "orange", lty= 3, lwd= 2)
abline(a= 1/2, b= 1/ 2, col= "blue", lwd= 2)
lines(x= c(-10: -1, -1: 2, 2: 10),
      y= c(rep(mean(.5* x[ y1== 1]), 10),
           rep(mean(.5* x[ y2== 1]), 4), rep(mean(.5* x[ y3== 1]), 9)),
      col= "green", lty= 5, lwd= 2)
#+end_src

*** Old codes                                :noexport:

#+begin_src R
## library(MASS)
## summary(polr(y~ x))
## plot(yi[order(x)], ylim= c(-5, 5))
## par(new= TRUE)
## plot(.5* x[order(x)], type= "l", col= "blue", ylim= c(-5, 5))
## abline(h= -1, col= "pink")
## abline(h= 2, col= "purple")
yop <- density(.5* x)
yap <- density(yi)
plot(yap, xlim= c(-6, 10), ylim= c(0, .42), col= "blue")
abline(v= c(-1, 2), lty= 3)
lines(x= -7: -1, y= rep(mean(yap$y[yap$x< -1]), 7), col= "pink")
lines(x= -1: 2, y= rep(mean(yap$y[yap$x> -1 & yap$x< 2]), 4), col= "pink")
lines(x= 2: 10, y= rep(mean(yap$y[yap$x< 2]), 9), col= "pink")
par(new= T)
plot(yop, xlim= c(-6, 10), ylim= c(0, .42), col= "red")
lines(x= -7: -1, y= rep(mean(yop$y[yap$x< -1]), 7), col= "red")
lines(x= -1: 2, y= rep(mean(yop$y[yap$x> -1 & yap$x< 2]), 4), col= "red")
lines(x= 2: 10, y= rep(mean(yop$y[yap$x< 2]), 9), col= "red")
#+end_src

** Descriptive Statistics
*** Data shaping

    The full detail of data construction is presented in a data paper
    available at [[https://github.com/jsay/geoInd/blob/master/DataPaper.pdf][https://github.com/jsay/geoInd/]].  The data paper also
    contains the dictionary of the variables used here.  The result of
    these preliminary treatments can be directly downloaded from the
    INRA dataverse server at [[https://doi.org/10.15454/ZZWQMN/][https://data.inra.fr]].
    
    The following R code allows to load the data once downloaded and
    located in the =/Inter/= folder at the root of the working
    directory of the R session.  It loads a =SpatialPolygonDataFrame=
    object from the =sp= package that contains the characteristics of
    the vineyard plots under consideration (session information used
    for this article is reported at Section 8).  It also reshapes some
    variables of particular interest:
    - It reorders the /commune/ levels along the North-South gradient
    - It standardizes the variable about solar radiation
    - It recodes the variable about exposition in 8 quadrants
    - It projects the geographical coordinates inside the WGS84 system
    - It selects the parcels with GIs and drop omitted values 

#+begin_src R :wrap example
library(sp) ; load("Inter/GeoRas.Rda")
Geo.Ras$LIBCOM <- factor(Geo.Ras$LIBCOM, levels=
              unique(Geo.Ras$LIBCOM[order(Geo.Ras$YCHF, decreasing= T)]))
Geo.Ras$RAYAT <- as.numeric(scale(Geo.Ras$SOLAR))
Geo.Ras$EXPO <- cut(Geo.Ras$ASPECT, breaks= c(-2, 1: 8* 45))
GR84 <- spTransform(Geo.Ras, CRS("+proj=longlat +ellps=WGS84"))
dd <- coordinates(GR84) ; Geo.Ras$X= dd[, 1] ; Geo.Ras$Y= dd[, 2]
dim(Reg.Ras <- subset(Geo.Ras, !is.na(AOClb) & !is.na(DEM) & !is.na(DESCR)
                      & !is.na(RUD) & !is.na(AOC36lab) & !is.na(REGION)))
#+end_src

#+RESULTS:
#+begin_example
[1] 59113    71
#+end_example

    The resulting object is a =SpatialPolygonDataFrame= that contains
    $59\,113$ observations of vineyard plots with $72$ variables
    without omitted values.

#+Latex: \clearpage

*** Geology and pedology

    Another pre-regression treatment is the transformation of the
    geological and pedological variables into dummy variables in order
    to control sub-soil and soil characteristics of vineyards with
    fixed effects.  A too small number of observation within a given
    fixed effect can be a problem for the precision and convergence of
    the estimation, hence we choose to include a fixed effects only
    for geological and pedological polygons with more than $1\,000$
    vineyard plots.  The details and robustness of this arbitrary
    choice are presented in the data paper mentioned above.

#+begin_src R :wrap example
Reg.Ras$NOTATION <- factor(Reg.Ras$NOTATION)
tmp <- table(Reg.Ras$NOTATION)< 1000
Reg.Ras$GEOL <- factor(
    ifelse(Reg.Ras$NOTATION %in% names(tmp[ tmp]), "0AREF",
           as.character(Reg.Ras$NOTATION)))
Reg.Ras$NOUC <- factor(Reg.Ras$NOUC)
tmp <- table(Reg.Ras$NOUC)< 1000
Reg.Ras$PEDO <- factor(
    ifelse(Reg.Ras$NOUC %in% names(tmp[tmp]), "0AREF",
           as.character(Reg.Ras$NOUC)))
apply(Reg.Ras@data[, c("GEOL", "PEDO")], 2, table)
#+end_src

#+RESULTS:
#+begin_example
$GEOL

0AREF     C     E    Fu    Fx    Fy    GP    j3   j3a   j3b   j4a 
 5208 19014  1997  1060  2142  1460  8372  1288  2570  2539  1531 
  j5a   j5b   j6a  p-IV 
 3526  3928  3087  1391 

$PEDO

0AREF    13    14    26    28    29    30    32    34    35    36 
 3310  1553 17475  3718  8687  6241  4563  1802  1700  5255  1116 
    5    69     8 
 1051  1484  1158
#+end_example

     The characteristics of sub-soils and soils are modeled with
     respectively 14 and 13 fixed effects.  In each case, the
     reference modality coded =0AREF= is equal to 1 for all vineyards
     plots inside geological and pedological polygons without
     sufficient observations.  Robustness checks have been made with
     other threshold values than $1\,000$ without this arbitrary
     choice changes the results.

#+Latex: \clearpage

*** Crossing GIs dimensions
**** Current GIs                             :noheading:

     The data are now ready for the econometric analysis.  The GIs on
     the area of interest contains both an horizontal (/commune/) and
     a vertical (/hierarchical level/) dimension as detailed in the
     Working Paper.  The balance of the two distributions can be
     assessed with the following Figure 3 (p.37) in the Working Paper.

#+begin_src R :results graphics :height 9 :width 13 :file "./Figures/CrossGIs.pdf"
library(lattice) ; library(RColorBrewer)
fig.dat <- aggregate(model.matrix(~0+ factor(Reg.Ras$AOC))*
                     Reg.Ras$AREA/ 1000, by= list(Reg.Ras$LIBCOM), sum)
names(fig.dat) <- c("LIBCOM", "BGOR", "BOUR", "VILL", "PCRU", "GCRU")
fig.dat$LIBCOM <- factor(fig.dat$LIBCOM, lev= rev(levels(fig.dat$LIBCOM)))
fig.crd <- t(apply(fig.dat[, -1], 1, function(t) cumsum(t)- t/2))
fig.lab <- round(t(apply(fig.dat[, -1], 1, function(t) t/ sum(t)))* 100)
my.pal  <- brewer.pal(n= 9, name = "BuPu")[ 2: 8]
barchart(LIBCOM~ BGOR+ BOUR+ VILL+ PCRU+ GCRU, xlim= c(-100, 10200),
         xlab="Vineyards delineated as Geographical Indications (hectare)",
         data= fig.dat, horiz= T, stack= T, col= my.pal, border= "black",
         par.settings= list(superpose.polygon= list(col= my.pal)),
         auto.key= list(space= "top", points= F, rectangles= T, columns= 5,
                        text=c("Coteaux b.", "Bourgogne",
                               "Village", "Premier cru", "Grand cru")),
         panel=function(x, y, ...) {
             panel.grid(h= 0, v = -11, col= "grey60")
             panel.barchart(x, y, ...)
             ltext(fig.crd, y, lab= ifelse(fig.lab> 0, fig.lab, ""))})
#+end_src

#+CAPTION: *Cross-distribution of current GI levels among communes*
#+ATTR_LATEX: :options scale= .45
#+RESULTS:
[[file:./Figures/CrossGIs.pdf]]

**** 1936 GIs                                :noheading:

     We also use historical GI designation scheme from 1936, the year
     of creation of the French national institute in charge of
     geographical indications (INAO).  At his time, the vertical
     dimension counted only three levels, whereas the horizontal
     dimension was identical.  The balance of the distribution can be
     assessed by the following Figure.

#+begin_src R :results graphics :height 9 :width 13 :file "./Figures/CrossOldGIs.pdf"
library(lattice) ; library(RColorBrewer)
fig.old <- aggregate(model.matrix(~0+ factor(Reg.Ras$AOC36lvl))*
                     Reg.Ras$AREA/ 1000, by= list(Reg.Ras$LIBCOM), sum)
names(fig.old) <- c("LIBCOM", "BOUR", "VILL", "GCRU")
fig.old$LIBCOM <- factor(fig.old$LIBCOM, lev= rev(levels(fig.old$LIBCOM)))
old.crd <- t(apply(fig.old[, -1], 1, function(t) cumsum(t)- t/2))
old.lab <- round(t(apply(fig.old[, -1], 1, function(t) t/ sum(t)))* 100)
old.pal  <- brewer.pal(n= 9, name = "BuPu")[ c(2, 5, 8)]
barchart(LIBCOM~ BOUR+ VILL+ GCRU, xlim= c(-100, 10200),
         xlab="Vineyards delineated as 1936 GI (hectare)",
         data= fig.old, horiz= T, stack= T, col= old.pal, border= "black",
         par.settings= list(superpose.polygon= list(col= old.pal)),
         auto.key= list(space= "top", points= F, rectangles= T, columns= 3,
                        text=c("Bourgogne", "Village", "Grand cru")),
         panel=function(x, y, ...) {
             panel.grid(h= 0, v = -11, col= "grey60")
             panel.barchart(x, y, ...)
             ltext(old.crd, y, lab= ifelse(old.lab> 0, old.lab, ""))})
#+end_src

#+CAPTION: *Cross-distribution of 1936 GI levels among communes*
#+ATTR_LATEX: :options scale= .45
#+RESULTS:
[[file:./Figures/CrossOldGIs.pdf]]

#+Latex: \clearpage

*** Ancien                                   :noexport:

#+begin_src R
load("Inter/AocRank.Rda")
RegRank <- subset(AocRank, AocRank$PAOC!= 0 &
                           !is.na(AocRank$DEM) & !is.na(AocRank$CODEg))
RegRank$AOCc <- ifelse(RegRank$GCRU== 1, 5,
                ifelse(RegRank$PCRU== 1, 4,
                ifelse(RegRank$VILL== 1 | RegRank$COMM== 1, 3,
                ifelse(RegRank$BOUR== 1, 2, 1))))
RegRank$RAYAT <- with(RegRank@data, (SOLAR- mean(SOLAR))/ sd(SOLAR))
RegRank$EXPO <- factor(ifelse(RegRank$ASPECT< 45, "0-45",
                       ifelse(RegRank$ASPECT< 90, "45-90",
                       ifelse(RegRank$ASPECT<135, "90-135",
                       ifelse(RegRank$ASPECT<180, "135-180",
                       ifelse(RegRank$ASPECT<225, "180-225",
                       ifelse(RegRank$ASPECT<270, "225-270",
                       ifelse(RegRank$ASPECT<315, "270-315", "315-360"))))))),
                       levels= c("0-45", "45-90", "90-135", "135-180",
                                 "180-225","225-270","270-315","315-360"))
RRank <- spTransform(RegRank, CRS("+proj=longlat +ellps=WGS84"))
SSank <- as(RRank, "data.frame")
RRank$X= SSank$coords.x1
RRank$Y= SSank$coords.x2
RRank$AOCo <- factor(ifelse(RRank$GCRU== 1, "GCRU",
                     ifelse(RRank$PCRU== 1, "PCRU",
                     ifelse(RRank$VILL== 1 | RRank$COMM== 1, "VILL",
                     ifelse(RRank$BOUR== 1, "BOUR", "BGOR")))),
                     c("BGOR", "BOUR",
                       "VILL", "PCRU", "GCRU"))

aocavt <- c(levels(factor(RRank$Com39)), levels(factor(RRank$Cote39)),
            levels(factor(RRank$Com38)), levels(factor(RRank$Com37)),
            levels(factor(RRank$Com36)))

equiv <- c("Auxey_Duresses"= 3,                   
           "Batard_Montrachet"= 5,                        
           "Bienvenues_Batard_Montrachet"= 5,             
           "Chassagne_Montrachet"= 3,                     
           "Chevalier_Montrachet"= 5,                     
           "Chorey_les_Beaune"= 3,                        
           "Clos_de_Tart"= 5,                             
           "Criots_Batard_Montrachet"= 5,                 
           "Ladoix"= 3,                                   
           "Meursault"= 3,                                
           "Monthelie"= 3,
           "Morey_Saint_Denis"= 3,                        
           "NONE"= 0,                                     
           "Pernand_Vergelesses"= 3,                      
           "Puligny_Montrachet"= 3,                       
           "Saint_Aubin"= 3,                              
           "Santenay"= 3,                                 
           "Savigny"= 3,                                  
           "Volnay"= 3,
           "Volnay_Santenots"= 3, ## ATTENTION
           "Beaune"= 3,
           "Chorey"= 3,
           "Meursault_Blagny"= 3,                         
           "Aloxe_Corton"= 3,
           "Vosne_Romanee"= 3,                            
           "Chambertin"= 5,                               
           "Chambertin_Clos_de_Beze"= 5,                  
           "Chapelle_Chambertin"= 5,                      
           "Charlemagne"= 5,                              
           "Charmes_Chambertin"= 5,                       
           "Clos_de_Vougeot"= 5,                          
           "Corton"= 5,                                   
           "Corton_Charlemagne"= 5,                       
           "Cote_de_Beaune_ou_Cote_de_Beaune_Villages"= 3,
           "Echezeaux"= 5,                                
           "Gevrey_Chambertin"= 3,                        
           "Grands_Echezeaux"= 5,                         
           "Griotte_Chambertin"= 5,
           "Latricieres_Chambertin"= 5,                   
           "Mazis_Chambertin"= 5,                         
           "Mazoyeres_Chambertin"= 5,                     
           "Montrachet"= 5,
           "Ruchottes_Chambertin"= 5,
           "Vins_fins_de_la_Cote_de_Nuits"= 0, ## ATTENTION            
           "Vougeot_rouge"= 3,
           "Bonnes_Mares"= 5,                             
           "Chambolle_Musigny"= 3,                        
           "Clos_de_la_Roche"= 5,
           "Clos_Saint_Denis"= 5,                         
           "Fixin"= 3,
           "La_Tache"= 5,                                 
           "Musigny"= 5,
           "Nuits"= 3,
           "Pommard"= 3,                                  
           "Richebourg"= 5,                               
           "Romanee"= 5,                            
           "Romanee_Conti"= 5,                            
           "Romanee_Saint_Vivant"= 5,                     
           "Vougeot"= 3)

library(plyr)
RRank$AOC39 <- revalue(factor(RRank$Com39), equiv)
RRank$aoc39 <- revalue(factor(RRank$Cote39), equiv)
RRank$AOC38 <- revalue(factor(RRank$Com38), equiv)
RRank$AOC37 <- revalue(factor(RRank$Com37), equiv)
RRank$AOC36 <- revalue(factor(RRank$Com36), equiv)

RRank$AOCavt <- apply(RRank@data[, 89: 93], 1, max)
RRank$AOCavt <- as.numeric(ifelse(RRank$AOCavt== "0", 1,
                           ifelse(RRank$AOCavt== "3", 2, 3)))

RRank$SELOLD <- ifelse(!RRank$LIBCOM %in%
                       c("CHENOVE", "MARSANNAY-LA-COTE", "COUCHEY",
                         "COMBLANCHIEN","CORGOLOIN", "SAINT-ROMAIN"), 1, 0)
SRank <- subset(RRank, SELOLD== 1)
SRank$LIBCOM <- factor(SRank$LIBCOM)
library(mgcv)
gamoldd200 <- gam(AOCavt~ 0+ LIBCOM+ EXPO+ s(DEM)+ s(SLOPE)+ s(RAYAT)
                    + s(X, Y, k= 250)
                , data= SRank, family= ocat(R= 3))
summary(gamoldd200)
#+end_src

#+RESULTS:
#+begin_example

Le chargement a nécessité le package : sp

The following `from` values were not present in `x`: Beaune, Chorey, Meursault_Blagny, Aloxe_Corton, Vosne_Romanee, Chambertin, Chambertin_Clos_de_Beze, Chapelle_Chambertin, Charlemagne, Charmes_Chambertin, Clos_de_Vougeot, Corton, Corton_Charlemagne, Cote_de_Beaune_ou_Cote_de_Beaune_Villages, Echezeaux, Gevrey_Chambertin, Grands_Echezeaux, Griotte_Chambertin, Latricieres_Chambertin, Mazis_Chambertin, Mazoyeres_Chambertin, Montrachet, Ruchottes_Chambertin, Vins_fins_de_la_Cote_de_Nuits, Vougeot_rouge, Bonnes_Mares, Chambolle_Musigny, Clos_de_la_Roche, Clos_Saint_Denis, Fixin, La_Tache, Musigny, Nuits, Pommard, Richebourg, Romanee, Romanee_Conti, Romanee_Saint_Vivant, Vougeot

The following `from` values were not present in `x`: Batard_Montrachet, Bienvenues_Batard_Montrachet, Chevalier_Montrachet, Chorey_les_Beaune, Clos_de_Tart, Criots_Batard_Montrachet, Morey_Saint_Denis, Volnay, Volnay_Santenots, Aloxe_Corton, Vosne_Romanee, Chambertin, Chambertin_Clos_de_Beze, Chapelle_Chambertin, Charlemagne, Charmes_Chambertin, Clos_de_Vougeot, Corton, Corton_Charlemagne, Cote_de_Beaune_ou_Cote_de_Beaune_Villages, Echezeaux, Gevrey_Chambertin, Grands_Echezeaux, Griotte_Chambertin, Latricieres_Chambertin, Mazis_Chambertin, Mazoyeres_Chambertin, Montrachet, Ruchottes_Chambertin, Vins_fins_de_la_Cote_de_Nuits, Vougeot_rouge, Bonnes_Mares, Chambolle_Musigny, Clos_de_la_Roche, Clos_Saint_Denis, Fixin, La_Tache, Musigny, Nuits, Pommard, Richebourg, Romanee, Romanee_Conti, Romanee_Saint_Vivant, Vougeot

The following `from` values were not present in `x`: Auxey_Duresses, Batard_Montrachet, Bienvenues_Batard_Montrachet, Chassagne_Montrachet, Chevalier_Montrachet, Chorey_les_Beaune, Clos_de_Tart, Criots_Batard_Montrachet, Ladoix, Meursault, Monthelie, Morey_Saint_Denis, Pernand_Vergelesses, Puligny_Montrachet, Saint_Aubin, Santenay, Savigny, Volnay, Volnay_Santenots, Beaune, Chorey, Meursault_Blagny, Chambertin, Chambertin_Clos_de_Beze, Chapelle_Chambertin, Charlemagne, Charmes_Chambertin, Clos_de_Vougeot, Corton, Corton_Charlemagne, Cote_de_Beaune_ou_Cote_de_Beaune_Villages, Echezeaux, Gevrey_Chambertin, Grands_Echezeaux, Griotte_Chambertin, Latricieres_Chambertin, Mazis_Chambertin, Mazoyeres_Chambertin, Montrachet, Ruchottes_Chambertin, Vins_fins_de_la_Cote_de_Nuits, Vougeot_rouge, Bonnes_Mares, Chambolle_Musigny, Clos_de_la_Roche, Clos_Saint_Denis, Fixin, La_Tache, Musigny, Nuits, Pommard, Richebourg, Romanee, Romanee_Conti, Romanee_Saint_Vivant, Vougeot

The following `from` values were not present in `x`: Auxey_Duresses, Bienvenues_Batard_Montrachet, Chassagne_Montrachet, Chorey_les_Beaune, Clos_de_Tart, Criots_Batard_Montrachet, Ladoix, Meursault, Monthelie, Morey_Saint_Denis, Puligny_Montrachet, Saint_Aubin, Santenay, Savigny, Volnay_Santenots, Beaune, Chorey, Meursault_Blagny, Aloxe_Corton, Vosne_Romanee, Bonnes_Mares, Chambolle_Musigny, Clos_de_la_Roche, Clos_Saint_Denis, Fixin, La_Tache, Musigny, Nuits, Pommard, Richebourg, Romanee, Romanee_Conti, Romanee_Saint_Vivant, Vougeot

The following `from` values were not present in `x`: Auxey_Duresses, Batard_Montrachet, Bienvenues_Batard_Montrachet, Chassagne_Montrachet, Chevalier_Montrachet, Chorey_les_Beaune, Clos_de_Tart, Criots_Batard_Montrachet, Ladoix, Meursault, Monthelie, Puligny_Montrachet, Saint_Aubin, Volnay, Volnay_Santenots, Chorey, Meursault_Blagny, Aloxe_Corton, Chambertin, Chambertin_Clos_de_Beze, Chapelle_Chambertin, Charlemagne, Charmes_Chambertin, Clos_de_Vougeot, Corton, Corton_Charlemagne, Cote_de_Beaune_ou_Cote_de_Beaune_Villages, Echezeaux, Grands_Echezeaux, Griotte_Chambertin, Latricieres_Chambertin, Mazis_Chambertin, Mazoyeres_Chambertin, Montrachet, Ruchottes_Chambertin, Vins_fins_de_la_Cote_de_Nuits, Vougeot_rouge
#+end_example

*** Encore plus ancien                       :noexport:

#+begin_src R
RegRank <- subset(AocRank@data, AocRank$PAOC!= 0 &
                  !is.na(AocRank$DEM) & !is.na(AocRank$CODEg))
RegRank$AOCc <- ifelse(RegRank$GCRU== 1, 5,
                ifelse(RegRank$PCRU== 1, 4,
                ifelse(RegRank$VILL== 1 | RegRank$COMM== 1, 3,
                ifelse(RegRank$BOUR== 1, 2, 1))))
RegRank$RAYAT <- with(RegRank, (SOLAR- mean(SOLAR))/ sd(SOLAR))
RegRank$XREG  <- with(RegRank, (XL93-  mean(XL93))/  sd(XL93))
RegRank$YREG  <- with(RegRank, (YL93-  mean(YL93))/  sd(YL93))
RegRank$EXPO <- factor(ifelse(RegRank$ASPECT< 45, "0-45",
                       ifelse(RegRank$ASPECT< 90, "45-90",
                       ifelse(RegRank$ASPECT<135, "90-135",
                       ifelse(RegRank$ASPECT<180, "135-180",
                       ifelse(RegRank$ASPECT<225, "180-225",
                       ifelse(RegRank$ASPECT<270, "225-270",
                       ifelse(RegRank$ASPECT<315, "270-315", "315-360"))))))),
                       levels= c("0-45", "45-90", "90-135", "135-180",
                                 "180-225","225-270","270-315","315-360"))
RegRank$PERM <- factor(ifelse(RegRank$PERMEABILITY<= 1, "0",
                       ifelse(RegRank$PERMEABILITY<= 2, "1",
                       ifelse(RegRank$PERMEABILITY<= 3, "2", "3"))))
tmp <- table(RegRank$CODEg)< 500
RegRank$Cg5 <- factor(
    ifelse(RegRank$CODEg%in% c("Hydro","j5b-c","l2","LP","t7-l1","Uy","X"),
           "ZZZ", ifelse(RegRank$CODEg %in% levels(RegRank$CODEg)[ tmp],
                         "0AREF", as.character(RegRank$CODEg))))
table(RegRank$Cg5)
tmp <- table(RegRank$CODEp)< 1000
RegRank$Cp10 <- factor(
    ifelse(RegRank$CODEp %in% c(1, 10, 17, 41), "ZZZ",
    ifelse(RegRank$CODEp %in% levels(RegRank$CODEp)[ tmp], "0AREF",
           as.character(RegRank$CODEp))))
table(RegRank$Cp10)

#+end_src

** Models of GI designation
*** Parametric ordered logit models

   We first estimate the benchmark parametric ordered logistic model
   =polm1= that corresponds to model ( 0 ) of Table 1 (p.22) in the
   Working Paper.  Model =polm1a= is the auxiliary regression without
   /commune/ fixed effects used to test the presence of omitted
   /terroir/ effect as detailed in the Working Paper.  Model =polm1b=
   is also an auxiliary regression without smoothing of spatial
   coordinates to compute the Fisher statistics associated to these
   terms in Table 1.  We use for this the standard =polr= function
   from =MASS= package.

#+begin_src R :wrap example
library(MASS)
polm1 <- polr(factor(AOC)~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO
              + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
              + poly(X, 3)* poly(Y, 3), data= Reg.Ras, Hess= TRUE)
polm1a <- polr(factor(AOC)~ 0+ EXPO+ GEOL+ PEDO
               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
               + poly(X, 3)* poly(Y, 3), data= Reg.Ras, Hess= TRUE)
polm1b <- polr(factor(AOC)~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO
               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
             , data= Reg.Ras, Hess= TRUE)
#+end_src

#+RESULTS:
#+begin_example
Warning messages:
1: In polr(factor(AOC) ~ 0 + LIBCOM + EXPO + GEOL + PEDO + poly(DEM,  :
  une coordonnée à l'origine est nécessaire et assumée
2: In polr(factor(AOC) ~ 0 + LIBCOM + EXPO + GEOL + PEDO + poly(DEM,  :
  le plan ne semble pas de rang plein, des coefs seront ignorés
#+end_example

   The warning messages come from the choice to drop the intercept in
   order to estimate a coefficient for each /commune/ from the
   variable =LIBCOM=.  This choice is made to compute more easily the
   ordinal superiority measures from fixed effects.  This does not
   have any effect on the other estimated coefficients.

#+Latex: \clearpage

*** Ordered generalized additive models

   We estimate the series of ordered generalized additive models
   (OGAMs) of GIs designations within a loop.  Models ( I ) to ( V )
   reported in Table 1 (p.22) of the Working Paper are only a subset
   of all models of the =gamod= object that can be downloaded directly
   from the INRA server, https://data.inra.fr/geoInd/gamod.Rda.
   Models with high complexities for the spatial effects (more than
   600 edf) are long to run. They require about 8 hours each, with the
   full loop requires about 2 days to run with Intel Core i7-7820HQ
   CPU 2.90 GHz x 8 and 64 Go of RAM.  We advise the reader to not run
   the full loop, but instead to select values of =listk= and estimate
   each model separately.
   
#+begin_src R :wrap example
library(mgcv)
listk <- c(50, 100, 200, 300, 400, 500, 600, 700, 800, 900)
gamod <- vector("list", length(listk))
system.time(
for (i in 1: length(listk)){
    gamod[[ i]] <- gam(AOC~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO
                       + s(DEM)+ s(SLOPE)+ s(RAYAT)+ s(X, Y, k= listk[ i])
                     , data= Reg.Ras, family= ocat(R= 5))
})
names(gamod) <- paste0("gam", listk)
save(gamod, file= "Inter/gamod.Rda")
#+end_src

#+RESULTS:
#+begin_example
utilisateur     système      écoulé 
     113038         384      109562 
#+end_example

   The second loop below produces the =gammod= object that contains
   the auxiliary regressions to test the omitted /terroir/ effects as
   presented in the Working Paper, Section 4.2.  The reader is not
   expected to run the loop entirely but pick some value of =k= in
   =listk= between 0 and $1\,000$ to estimate each model individually.

#+begin_src R :wrap example
gammod <- vector("list", length(listk))
system.time(
for (i in 1: length(listk)){
    gammod[[ i]] <- gam(AOC~ 0+ EXPO+ GEOL+ PEDO
                        + s(DEM)+ s(SLOPE)+ s(RAYAT)+ s(X, Y, k= listk[ i])
                      , data= Reg.Ras, family= ocat(R= 5))
})
names(gammod) <- paste0("gam", listk)
save(gammod, file= "Inter/gammod.Rda")
#+end_src

#+RESULTS:
#+begin_example
utilisateur     système      écoulé 
     103037         262      102775
#+end_example

#+Latex: \clearpage

** Diagnostics
*** Significance
**** POL                                     :noheading:

     We first reports the Chi-square statistics for the joint
     significance of the parametric ordered logit model =polm1= that
     corresponds to model ( 0 ) of Table 1 (p.22) in the Working
     Paper.

#+begin_src R :wrap example
library(car)
res1a <- anova(polm1, polm1b)
(res1 <- Anova(polm1))
#+end_src

#+RESULTS:
#+begin_example
Le chargement a nécessité le package : carData

Analysis of Deviance Table (Type II tests)

Response: factor(AOC)
                      LR Chisq Df Pr(>Chisq)    
LIBCOM                    9768 31     <2e-16 ***
EXPO                       743  7     <2e-16 ***
GEOL                      1716 14     <2e-16 ***
PEDO                      8811 13     <2e-16 ***
poly(DEM, 2)              4030  2     <2e-16 ***
poly(SLOPE, 2)             532  2     <2e-16 ***
poly(RAYAT, 2)            1885  2     <2e-16 ***
poly(X, 3)                1933  3     <2e-16 ***
poly(Y, 3)                 178  3     <2e-16 ***
poly(X, 3):poly(Y, 3)     5257  9     <2e-16 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
Warning messages:
1: glm.fit: fitted probabilities numerically 0 or 1 occurred 
2: glm.fit: fitted probabilities numerically 0 or 1 occurred 
3: glm.fit: fitted probabilities numerically 0 or 1 occurred 
4: glm.fit: fitted probabilities numerically 0 or 1 occurred 
5: glm.fit: fitted probabilities numerically 0 or 1 occurred
#+end_example

#+Latex: \clearpage

**** OGAM                                    :noheading:

     Then, we compute the same Chi-square statistics for all the OGAMs
     with the function =resume=.  They are also reported in Table 1
     (p.22) in the Working Paper.  Recall that the estimated models
     can be downloaded from https://data.inra.fr/geoInd/gamod.Rda.

#+begin_src R :wrap example
load("Inter/gamod.Rda")
resume <- function(mod){
    tmp <- anova(mod)
    res <- c(as.vector(rbind(tmp$s.table[, 3], tmp$s.table[, 1])),
             as.vector(rbind(tmp$pTerms.tab[, 2], tmp$pTerms.tab[, 1])))
    names(res) <- c(as.vector(rbind(rownames(tmp$s.table), rep("", 4))),
                    as.vector(rbind(rownames(tmp$pTerms.tab), rep("", 2))))
    round(res, 1)
}
sapply(gamod[ 1: 5* 2], resume)
#+end_src

#+RESULTS:
#+begin_example
          gam100  gam300  gam500  gam700  gam900
s(DEM)    4123.2  1793.1  1189.9  1014.1   867.0
             8.9     8.9     8.9     8.8     8.8
s(SLOPE)   922.5   343.6   168.5   155.5   190.1
             8.3     8.2     8.3     8.2     7.7
s(RAYAT)  2091.3   981.6   797.7   646.5   531.0
             8.1     8.1     8.3     8.0     7.3
s(X,Y)   32524.2 59293.9 74154.2 78445.3 86597.1
            98.6   295.0   483.2   666.6   841.4
LIBCOM    3007.9  2295.2  2353.7  1721.6  1363.5
            31.0    31.0    31.0    31.0    31.0
EXPO        61.0    81.3   171.5   159.0   130.5
             7.0     7.0     7.0     7.0     7.0
GEOL       977.4   557.4   500.5   406.4   440.9
            14.0    14.0    14.0    14.0    14.0
PEDO      2447.2   713.1   450.4   408.6   387.9
            13.0    13.0    13.0    13.0    13.0
#+end_example

#+Latex: \clearpage

*** Goodness of fit
**** POL                                     :noheading:

     We report below the code used to compute the goodness-of-fit
     measures for model ( 0 ) reported in Table 1 (p.22):
     Pseudo-R$^2$, Akaike information criteria (AIC), and percent of
     good predictions.

#+begin_src R :wrap example
psR2 <- function(x) 1- (logLik(x)/ logLik(update(x, . ~ + 1)))
round(c(psR2= psR2(polm1), AIC= AIC(polm1)/ 1000,
        Pcgp= sum(diag(table(predict(polm1),
                             Reg.Ras$AOC)))/nrow(Reg.Ras)), 2)
#+end_src

#+RESULTS:
#+begin_example
  psR2    AIC   Pcgp 
  0.37 104.15   0.64
#+end_example

**** OGAM                                    :noheading:

     And the same goodness of fit measures for OGAMs.

#+begin_src R :wrap example
library(mgcv)
pcgp <- function(x){
    sum(diag(table(cut(x$line, c(-Inf, x$family$getTheta(TRUE), Inf)),
                   x$model[, 1])))/ nrow(x$model)* 100
}
rbind(psR2= sapply(gamod[ 1: 5* 2], psR2), 
      AIC=  sapply(gamod[ 1: 5* 2], AIC)/ 1000,
      Pcgp= sapply(gamod[ 1: 5* 2], pcgp))
#+end_src

#+RESULTS:
#+begin_example
Le chargement a nécessité le package : nlme
This is mgcv 1.8-28. For overview type 'help("mgcv-package")'.

      gam100 gam300 gam500  gam700  gam900
psR2  0.5323  0.631  0.684  0.7248  0.7565
AIC  77.2170 61.397 53.088 46.7579 41.9259
Pcgp 74.8600 80.387 84.376 87.2566 89.4778
#+end_example

#+Latex: \clearpage

*** Omitted variable bias
**** POL                                     :noheading:

     As indicated in the Working Paper (Appendix A.1), we evaluate the
     potential omitted /terroir/ variables through the joint
     significance of /commune/ fixed effects on the residuals from
     auxiliary regressions without such fixed effects.  Code below
     allows to compute the bootstrapped Fisher statistics with 100
     replications from parametric ordered logistic model.  The absence
     of correlated effects is strongly rejected.  Note that we use the
     =sure= package to compute the surrogate residuals from this
     parametric model.

#+begin_src R :wrap example
library(lmtest) ; library(sandwich) ; library(sure)
wal1 <- rep(NA, times= nsim <- 100)
for (i in 1: nsim){
    tmp <- surrogate(polm1a)- polm1a$lp
    wal1[ i] <- waldtest(lm(tmp~ Reg.Ras$LIBCOM), .~ 1, vcov= vcovHC)$F[ 2]
}
quantile(wal1, c(.05, .5, .95))
#+end_src

#+RESULTS:
#+begin_example
   5%   50%   95% 
151.3 155.9 160.6
#+end_example

    Note that the values obtained are not exactly equal to those
    reported in the Working Paper because of the bootstrap procedure.

**** OGAM                                    :noheading:

     The =sure= package does not allow to compute surrogate residuals
     for =gam= models from the =mgcv= package.  Because this framework
     is also consistent for OGAMs, we write the function =sureOGAM=
     presented and tested in Appendix [[#Sec:rOGAM]] to adapt the
     framework.  This function is also available in the file of custom
     function =./myFcts.R= that is sourced in the following code.
     Hence, we compute the bootstrapped F-statistics for the full set
     of OGAM belows.  The estimation of auxiliary models is presented
     above, they can be directly downloaded from [[https://doi.org/10.15454/ZZWQMN][https://data.inra.fr]].

#+begin_src R :wrap example
load("Inter/gammod.Rda") ; library(ggplot2) ; source("myFcts.R")
omitVar <- function(mod, var, nsim= 100){
    usq <- rep(NA, nsim)
    for(i in 1: nsim) {
        RES <- sureOGAM(mod) 
        tmp <- lm(I(RES- mod$linear.pred)~ factor(var)) 
        usq[ i] <- waldtest(tmp, . ~ 1, vcov= vcovHC)$F[ 2]
    }
    usq
}
wal2 <- sapply(gammod, function(x) omitVar(x, Reg.Ras$LIBCOM, nsim= 100))
apply(wal2[, -1], 2, function(x) quantile(x, c(.05, .5, .95)))
#+end_src

#+RESULTS:
#+begin_example
    gam100 gam200 gam300 gam400 gam500 gam600 gam700 gam800 gam900
5%   15.22  5.724  4.983  4.033  3.522  2.787  2.032  1.699  1.361
50%  16.86  6.504  5.658  4.690  4.056  3.373  2.439  2.132  1.722
95%  18.35  7.429  6.536  5.487  4.916  4.024  3.195  2.827  2.203
#+end_example

     Again, the values are not exactly the same.  Note that the
     critical value at 0.01% for the F-distribution in this case is
     2.3, as can be assessed from =qf(.9999, 31, Inf)=.

#+Latex: \clearpage

**** Plot                                    :noheading:

     The following plot resumes the specification diagnostics and
     shows the relevance of OGAMs to control for omitted spatial
     effects.  It corresponds to Figure 7 (p.42) in the Working Paper.

#+begin_src R :results graphics :height 7 :width 10 :file "./Figures/SignifPlot.pdf"
library(lattice)
pltdat <- stack(data.frame(logit= wal1, wal2))
Fstat <- round(qf(.9999, 31, Inf), 2)
bwplot(log(values)~ ind, data= pltdat, type=c("l","g"), horizontal= FALSE,
       xlab= 'Model of GI designation',
       ylab= 'Bootstraped F-statistics (log scale)',
       par.settings = list(box.rectangle=list(col='black'),
                           plot.symbol  = list(pch='.', cex = 0.1)),
       scales=list(y= list(at= log((1: 15)^2), lab= (1: 15)^2)),
       panel = function(..., box.ratio) {
           panel.grid(h= 0, v = -11)
           panel.abline(h= log((1: 15)^2), col= "grey80")
           panel.violin(..., col = "lightblue",
                        varwidth = FALSE, box.ratio = box.ratio)
           panel.bwplot(..., col='black',
                        cex=0.8, pch='|', fill='gray', box.ratio = .1)
           panel.abline(h= log(Fstat), col= "red", lty= 2, cex= 1.5)
           panel.text(2, log(Fstat)+ .1,
                      paste0("F= ", Fstat, " : critical value at .01%"))})
#+end_src

#+Caption: *F-statistics for the diagnostic of correlated residual effects*
#+ATTR_LATEX: :options scale= .5
#+RESULTS:
[[file:./Figures/SignifPlot.pdf]]

#+Latex: \clearpage

*** Specification

     The estimation of surrogate residuals from the full models can be
     used to test the specification of the effects of explanatory
     variables.  The Figures from the code below are not reported in
     this document are they are too detailed.

#+begin_src R :exports code :results graphics :height 7 :width 12 :file "./Figures/Surrogate.pdf"
library(sure) ; library(gridExtra)
var <- c("DEM", "SLOPE", "RAYAT", "EXPO", "LIBCOM", "X", "Y")
plots <- lapply(var, function(.x)
    autoplot(polm1, what= "covariate", x= Reg.Ras@data[, .x], xlab= .x))
do.call(grid.arrange, c(list(autoplot(polm1, what= "qq")), plots))
restmp <- sureOGAM(gamod$gam900)- gamod$gam900$line 
plot(qlogis(1: nrow(Reg.Ras)/ nrow(Reg.Ras), scale= 1), sort(restmp))
abline(0, 1)
pltSURE <- function(resid, xvar, lab){
    plot(xvar, resid, xlab= lab, main= paste("Surrogate Analysis", lab))
    abline(h= 0, col= "red", lty= 3, lwd= 2)
    lines(smooth.spline(resid ~ xvar), lwd= 3, col= "blue")
}
par(mfrow= c(3, 3)) ; for (i in var) pltSURE(restmp, Reg.Ras@data[, i], i)
#+end_src

#+CAPTION: Surrogate for the OGAMs on Current GIs
#+ATTR_LATEX: :options scale= .4
#+RESULTS:
[[file:./Figures/Surrogate.pdf]]

#+Latex: \clearpage

** Marginal effects
*** Parametric ordered logit

    The marginal effects from parametric model =polm1= can be directly
    plotted with the package =effect=.  The following plots
    corresponds to the dotted lines in Figure 5 (p.40) in the Appendix
    of the Working Paper.

#+begin_src R :results graphics :height 7 :width 12 :file "./Figures/Effects1.pdf"
library(effects)
plot(predictorEffects(polm1, ~ DEM+ SLOPE+ RAYAT+ EXPO, latent= TRUE,
                      xlevels=list(DEM= 200: 500,
                                   SLOPE= 0: 400/ 10, RAYAT= -60: 30/ 10)))
#+end_src

#+CAPTION: *Marginal effects of topographic variables from ordered logit*
#+ATTR_LATEX: :options scale= .5
#+RESULTS:
[[file:./Figures/Effects1.pdf]]

#+Latex: \clearpage

*** Ordered generalized additive

    The same effect plots can be drawn for the OGAMs models.  We
    report below the effects from the OGAM =gam900= which corresponds
    to a maximum effective degrees of freedom of 900.  For all models
    of =gamod=, we obtain the gray curves of Figure 5 (p.40) in the
    Appendix of the Working Paper.

#+begin_src R :results graphics :height 9 :width 15 :file "./Figures/Effects2.pdf"
plot(gamod[[ 10]], pages= 1, scale= 0)
#+end_src

#+CAPTION: *Marginal effects of topographic variables from OGAM with edf= 900*
#+ATTR_LATEX: :options scale= .4
#+RESULTS:
[[file:./Figures/Effects2.pdf]]

#+Latex: \clearpage

*** Ordinal superiority figure

    From the equation (4) of the Working Paper (p.14), we can compute
    ordinal superiority measures for each /communes/ relatively to the
    average.  The code below reproduces the Figure 2 (p. 23) of the
    Working Paper.  Note that we drop the isolated Northern /communes/
    of /Chenôve/, /Marsannay-la-Côte/ and /Couchey/ which do not have
    comparable neighbors.  The effect of the proximity to Dijon is too
    high for these /communes/ and they present high ordinal
    superiority measures without high rated vineyards.

#+begin_src R :results graphics :height 6 :width 9 :file "./Figures/ComEff.pdf"
library(latticeExtra)
plogi <- function(x) exp(x/ sqrt(2))/ (1+ exp(x/ sqrt(2)))
xx <- data.frame(sapply(gamod, function(x)
    2* plogi(I(x$coeff[ 4: 31]- mean(x$coeff[ 4: 31])))- 1))
foo_key <- list(x = .35, y = .95, corner = c(1, 1),
            text = list(c("Côte de Beaune", "Côte de Nuits")),
            rectangle = list(col = c("chartreuse", "tomato")))
ww <- data.frame(xx,
                 LIBCOM= substr(names(gamod[[1]]$coef[ 4: 31]), 7, 30),
                 REGION= c(rep("tomato", 12), rep("chartreuse", 16)),
                 MIN= apply(xx[ 8: 10], 1, min),
                 MAX= apply(xx[ 8: 10], 1, max),
                 MEAN= apply(xx[ 8: 10], 1, mean))
segplot(reorder(factor(LIBCOM), MEAN)~ MIN+ MAX, length= 5, draw.bands= T,
        data= ww[order(ww$MEAN), ], center= MEAN, type= "o",
        key= foo_key, col= as.character(ww$REGION[order(ww$MEAN)]),
        unit = "mm", axis = axis.grid, col.symbol= "black", cex= 1, 
        xlab= "Min, Mean and Max of Ordinal Superiorty Measures")
#+end_src

#+CAPTION: *Ordinal superiorty measures for the /communes/ of the region*
#+ATTR_LATEX: :options scale= .6
#+RESULTS:
[[file:./Figures/ComEff.pdf]]

#+Latex: \clearpage

*** Correlation between /Communes/

    Below the code to produce the Figure 8 in Appendix p.42 of the
    Working Paper.  It shows the correlation between the average
    vertical GI score and the mean ordinal superiority measures
    estimated from OGAMs with high effective degrees of freedom.

#+begin_src R :results graphics :height 6 :width 9 :file "./Figures/ComCor.pdf"
library(plyr) ; library(ggrepel)
yy <- ddply(Reg.Ras@data, .(LIBCOM),
            function(x) weighted.mean(x$AOC, x$AREA))
zz <- merge(ww, yy, by= "LIBCOM")
m <- lm(V1~ MEAN, data= zz)
a <- signif(coef(m)[1], digits = 2)
b <- signif(coef(m)[2], digits = 2)
c <- signif(summary(m)$r.sq, digits = 2)
textlab <- paste("y = ", a, " + ", b, " x ", ", R2 = ", c, sep= "")
ggplot(zz, aes(MEAN, V1, label= LIBCOM)) +
    geom_smooth(method= lm, aes(MEAN, V1))+
    geom_text_repel(point.padding = NA) +
    annotate("text", x= -.75, y= 4, label= textlab, size= 4, parse= F)+
    xlab("Ordinal superiority measure") +
    ylab("Average GI grade (between 0 and 5)")
#+end_src

#+CAPTION: *Correlation between ranking and ordinal superiority*
#+ATTR_LATEX: :options scale= .6
#+RESULTS:
[[file:./Figures/ComCor.pdf]]

#+Latex: \clearpage

** Informational content
*** Decomposition tables

    We proceed now to the decomposition of variance of the latent
    quality index from the GI designations.  The mathematical formula
    and codes used in the decomposition are presented and tested in
    Appendix [[#Sec:rDCMP]].  These functions are also available in the
    file of custom function =./myFcts.R= that can be directly sourced.
    The following codes perform the decomposition for the subset of
    models reported in Table 2 (p.25) of the Working Paper.  The
    predictions of the latent quality index in the first rows need
    some time to run, the decomposition that follow are computed
    rapidly.

#+begin_src R :wrap example
ddtt <- data.frame(AOC= Reg.Ras$AOC, LIBCOM= Reg.Ras$LIBCOM,
                   sapply(gamod[ 1: 5* 2], function(x)
                       rowSums(predict(x, type= 'terms')[, -1])))
dcmp <- sapply(names(ddtt[, 3: 7]), function(x)
    c("Total Signal"= var(ddtt[, x]), "Total Noise"= pi^2/ 3,
      jointSignal(ddtt, x),                      jointNoise(ddtt, x),
      vertiSignal(ddtt, x), vertiResid(ddtt, x), vertiNoise(ddtt, x),
      horizSignal(ddtt, x), horizResid(ddtt, x), horizNoise(ddtt, x)))
round(t(apply(dcmp, 1, function(x) x/ (pi^2/ 3+ dcmp[1, ])* 100)), 1)
#+end_src

#+RESULTS:
#+begin_example
                    gam100 gam300 gam500 gam700 gam900
Total Signal          85.3   94.5   96.0   97.3   97.5
Total Noise           14.7    5.5    4.0    2.7    2.5
Joint Signal          69.7   70.1   76.7   75.2   78.6
Joint Noise           15.6   24.3   19.3   22.2   18.9
Vertical Signal       54.1   48.8   51.7   56.2   65.2
Vertical Residual     15.7   21.4   25.0   18.9   13.4
Vertical Noise        31.3   45.7   44.4   41.1   32.3
Horizontal Signal     18.3   16.6   25.6   22.6   23.8
Horizontal Residual   51.4   53.6   51.1   52.6   54.8
Horizontal Noise      67.0   77.9   70.5   74.7   73.7
#+end_example

#+Latex: \clearpage

*** Olds Codes                               :noexport:

#+begin_src R
decomp(por1, RegRank)

## GENERAL NOISE
(noise1 <- 1/ (var(por1$lp)+ 1))

## RANKING NOISE FULL
dn1 <- var(por1$lp[RegRank$AOCc== 1])* mean(RegRank$AOCc== 1)+
    var(por1$lp[RegRank$AOCc== 2])*    mean(RegRank$AOCc== 2)+
    var(por1$lp[RegRank$AOCc== 3])*    mean(RegRank$AOCc== 3)+
    var(por1$lp[RegRank$AOCc== 4])*    mean(RegRank$AOCc== 4)+
    var(por1$lp[RegRank$AOCc== 5])*    mean(RegRank$AOCc== 5)
(discr1 <- dn1/ (var(por1$lp)+ 1))
## RANKING SIGNAL
1- noise1- discr1
siglvl1 <- var(ifelse(RegRank$AOCc== 1, mean(por1$lp[RegRank$AOCc== 1]),
               ifelse(RegRank$AOCc== 2, mean(por1$lp[RegRank$AOCc== 2]),
               ifelse(RegRank$AOCc== 3, mean(por1$lp[RegRank$AOCc== 3]),
               ifelse(RegRank$AOCc== 4, mean(por1$lp[RegRank$AOCc== 4]),
                      mean(por1$lp[RegRank$AOCc== 5]))))))/(var(por1$lp)+1)
siglvl1

(rr= summary(rrr <- lm(por1$lp~ factor(RegRank$AOCc)))$r.sq)* (1- noise1)
(1- rr)* (1- noise1)

## RANKING RESIDUALS
discret <- 0
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        tmp <- por1$lp[RegRank$AOCc== i & RegRank$LIBCOM== j]
        if (length(tmp)> 0)
        discret <- discret+
            var(tmp)* mean(RegRank$AOCc== i & RegRank$LIBCOM== j)
    }
}
(discr2 <- discret/ (var(por1$lp)+ 1))
## RANKING NOISE II
1- noise1-discr2-siglvl1
sig <- rep(0, nrow(RegRank))
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        sig[RegRank$AOCc== i & RegRank$LIBCOM== j] <-
            mean(por1$lp[RegRank$AOCc== i & RegRank$LIBCOM== j])
    }
}
sigg <- 0
for (j in levels(RegRank$LIBCOM)){
    sigg <- sigg+ var(sig[RegRank$LIBCOM== j])* mean(RegRank$LIBCOM== j)
}
(siglvl3 <- sigg/ (var(por1$lp)+ 1))



RR= summary(lm(rrr$resid~ 0+ factor(RegRank$LIBCOM)))$r.sq
RR* (1- noise1)



jj= summary(lm(linp~ factor(dat$AOCc)+ dat$LIBCOM))$r.sq

    cc= summary(ccc <- lm(linp~ factor(dat$LIBCOM)))$r.sq
    CC= summary(lm(ccc$resid~ factor(dat$AOCc)))$r.sq
    c(G.Signal= sgn, G.Noise= 1- sgn, J.Signal= jj, J.Noise= 1- jj,
      R.Signal= rr, R.Residual= RR, R.Noise= 1- rr- RR,
      C.Signal= cc, C.Residual= CC, C.Noise= 1- cc- CC)* 100

##
## POUR GAM1
##
decomp(gam1, RegRank)

gam3lp <- gam1$linear.predictors
## NOISE
(noise3 <- (pi^2/ 3)/ (var(gam3lp)+ (pi^2/ 3)))



## RANK NOISE FULL
dn3 <- var(gam3lp[RegRank$AOCc== 1])* mean(RegRank$AOCc== 1)+
    var(gam3lp[RegRank$AOCc== 2])*    mean(RegRank$AOCc== 2)+
    var(gam3lp[RegRank$AOCc== 3])*    mean(RegRank$AOCc== 3)+
    var(gam3lp[RegRank$AOCc== 4])*    mean(RegRank$AOCc== 4)+
    var(gam3lp[RegRank$AOCc== 5])*    mean(RegRank$AOCc== 5)
(discr3 <- dn3/ (var(gam3lp)+ (pi^2/ 3)))


## RANKING SIGNAL
1- noise3- discr3
siglvl3 <- var(ifelse(RegRank$AOCc== 1, mean(gam3lp[RegRank$AOCc== 1]),
               ifelse(RegRank$AOCc== 2, mean(gam3lp[RegRank$AOCc== 2]),
               ifelse(RegRank$AOCc== 3, mean(gam3lp[RegRank$AOCc== 3]),
               ifelse(RegRank$AOCc== 4, mean(gam3lp[RegRank$AOCc== 4]),
                      mean(gam3lp[RegRank$AOCc== 5]))))))/
    (var(gam3lp)+ (pi^2/ 3))
siglvl3

## RANKING RESIDUALS
discret <- 0
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        tmp <- gam3lp[RegRank$AOCc== i & RegRank$LIBCOM== j]
        if (length(tmp)> 0)
        discret <- discret+
            var(tmp)* mean(RegRank$AOCc== i & RegRank$LIBCOM== j)
    }
}
(discr4 <- discret/ (var(gam3lp)+ (pi^2/ 3)))
RR= summary(lm(rrr$resid~ 0+ factor(RegRank$LIBCOM)))$r.sq
RR
0.2607* (1- noise3)


## SIGNAL LEVEL
siglvl4 <- var(ifelse(RegRank$AOCc== 1, mean(gam3lp[RegRank$AOCc== 1]),
               ifelse(RegRank$AOCc== 2, mean(gam3lp[RegRank$AOCc== 2]),
               ifelse(RegRank$AOCc== 3, mean(gam3lp[RegRank$AOCc== 3]),
               ifelse(RegRank$AOCc== 4, mean(gam3lp[RegRank$AOCc== 4]),
                      mean(gam3lp[RegRank$AOCc== 5]))))))/
    (var(gam3lp)+ (pi^2/ 3))
siglvl4

sig <- rep(0, nrow(RegRank))
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        sig[RegRank$AOCc== i & RegRank$LIBCOM== j] <-
            mean(gam3lp[RegRank$AOCc== i & RegRank$LIBCOM== j])
    }
}
sigg <- 0
for (j in levels(RegRank$LIBCOM)){
    sigg <- sigg+ var(sig[RegRank$LIBCOM== j])* mean(RegRank$LIBCOM== j)
}
(siglvl5 <- sigg/ (var(gam3lp)+ (pi^2/ 3)))

## SIGNAL COMMUNE
siggg <- (var(sig[RegRank$AOCc== 1])* mean(RegRank$AOCc== 1)+
          var(sig[RegRank$AOCc== 2])* mean(RegRank$AOCc== 2)+
          var(sig[RegRank$AOCc== 3])* mean(RegRank$AOCc== 3)+
          var(sig[RegRank$AOCc== 4])* mean(RegRank$AOCc== 4)+
          var(sig[RegRank$AOCc== 5])* mean(RegRank$AOCc== 5))
(sigcom4 <- siggg/ (var(gam3lp)+ (pi^2/ 3)))

sigggg <- rep(0, nrow(RegRank))
for (j in levels(RegRank$LIBCOM)){
    sigggg[ RegRank$LIBCOM== j] <- mean(gam3lp[RegRank$LIBCOM== j])
}
(sigcom5 <- var(sigggg)/ (var(gam3lp)+ (pi^2/ 3)))


sigcom4+ noise4+ discr4+ siglvl4
sigcom4 ; noise4 ; discr4 ; siglvl4

sigcom5+ noise4+ discr4+ siglvl5
sigcom5 ; noise4 ; discr4 ; siglvl5




discret <- 0
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        tmp <- gam4lp[RegRank$AOCc== i & RegRank$LIBCOM== j]
        if (length(tmp)> 0)
        discret <- discret+
            var(tmp)* mean(RegRank$AOCc== i & RegRank$LIBCOM== j)
    }
}
(discr4 <- discret/ (var(gam4lp)+ 1))

## SIGNAL LEVEL
siglvl4 <- var(ifelse(RegRank$AOCc== 1, mean(gam4lp[RegRank$AOCc== 1]),
               ifelse(RegRank$AOCc== 2, mean(gam4lp[RegRank$AOCc== 2]),
               ifelse(RegRank$AOCc== 3, mean(gam4lp[RegRank$AOCc== 3]),
               ifelse(RegRank$AOCc== 4, mean(gam4lp[RegRank$AOCc== 4]),
                      mean(gam4lp[RegRank$AOCc== 5]))))))/(var(gam4lp)+1)
siglvl4

sig <- rep(0, nrow(RegRank))
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        sig[RegRank$AOCc== i & RegRank$LIBCOM== j] <-
            mean(gam4lp[RegRank$AOCc== i & RegRank$LIBCOM== j])
    }
}
sigg <- 0
for (j in levels(RegRank$LIBCOM)){
    sigg <- sigg+ var(sig[RegRank$LIBCOM== j])* mean(RegRank$LIBCOM== j)
}
(siglvl5 <- sigg/ (var(gam4lp)+ 1))

## SIGNAL COMMUNE
siggg <- (var(sig[RegRank$AOCc== 1])* mean(RegRank$AOCc== 1)+
          var(sig[RegRank$AOCc== 2])* mean(RegRank$AOCc== 2)+
          var(sig[RegRank$AOCc== 3])* mean(RegRank$AOCc== 3)+
          var(sig[RegRank$AOCc== 4])* mean(RegRank$AOCc== 4)+
          var(sig[RegRank$AOCc== 5])* mean(RegRank$AOCc== 5))
(sigcom4 <- siggg/ (var(gam4lp)+ 1))

sigggg <- rep(0, nrow(RegRank))
for (j in levels(RegRank$LIBCOM)){
    sigggg[ RegRank$LIBCOM== j] <- mean(gam4lp[RegRank$LIBCOM== j])
}
(sigcom5 <- var(sigggg)/ (var(gam4lp)+ 1))


sigcom4+ noise4+ discr4+ siglvl4
sigcom4 ; noise4 ; discr4 ; siglvl4

sigcom5+ noise4+ discr4+ siglvl5
sigcom5 ; noise4 ; discr4 ; siglvl5














discret <- 0
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        tmp <- por2$lp[RegRank$AOCc== i & RegRank$LIBCOM== j]
        if (length(tmp)> 0)
        discret <- discret+
            var(tmp)* mean(RegRank$AOCc== i & RegRank$LIBCOM== j)
    }
}
(discr2 <- discret/ (var(por2$lp)+ 1))


sig <- rep(0, nrow(RegRank))
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        sig[RegRank$AOCc== i & RegRank$LIBCOM== j] <-
            mean(por1$lp[RegRank$AOCc== i & RegRank$LIBCOM== j])
    }
}
sigg <- 0
for (j in levels(RegRank$LIBCOM)){
    sigg <- sigg+ var(sig[RegRank$LIBCOM== j])* mean(RegRank$LIBCOM== j)
}
(siglvl3 <- sigg/ (var(por2$lp)+ 1))


## SIGNAL LEVELS
siglvl2 <- var(ifelse(RegRank$AOCc== 1, mean(por2$lp[RegRank$AOCc== 1]),
               ifelse(RegRank$AOCc== 2, mean(por2$lp[RegRank$AOCc== 2]),
               ifelse(RegRank$AOCc== 3, mean(por2$lp[RegRank$AOCc== 3]),
               ifelse(RegRank$AOCc== 4, mean(por2$lp[RegRank$AOCc== 4]),
                      mean(por2$lp[RegRank$AOCc== 5]))))))/(var(por2$lp)+1)
siglvl2

sig <- rep(0, nrow(RegRank))
for (i in 1: 5){
    for (j in levels(RegRank$LIBCOM)){
        sig[RegRank$AOCc== i & RegRank$LIBCOM== j] <-
            mean(por2$lp[RegRank$AOCc== i & RegRank$LIBCOM== j])
    }
}
sigg <- 0
for (j in levels(RegRank$LIBCOM)){
    sigg <- sigg+ var(sig[RegRank$LIBCOM== j])* mean(RegRank$LIBCOM== j)
}
(siglvl3 <- sigg/ (var(por2$lp)+ 1))

## SIGNAL COMMUNE
siggg <- (var(sig[RegRank$AOCc== 1])* mean(RegRank$AOCc== 1)+
          var(sig[RegRank$AOCc== 2])* mean(RegRank$AOCc== 2)+
          var(sig[RegRank$AOCc== 3])* mean(RegRank$AOCc== 3)+
          var(sig[RegRank$AOCc== 4])* mean(RegRank$AOCc== 4)+
          var(sig[RegRank$AOCc== 5])* mean(RegRank$AOCc== 5))
(sigcom2 <- siggg/ (var(por2$lp)+ 1))

sigggg <- rep(0, nrow(RegRank))
for (j in levels(RegRank$LIBCOM)){
    sigggg[ RegRank$LIBCOM== j] <- mean(por2$lp[RegRank$LIBCOM== j])
}
(sigcom3 <- var(sigggg)/ (var(por2$lp)+ 1))



sigcom2+ noise2+ discr2+ siglvl2
sigcom2 ; noise2 ; discr2 ; siglvl2

sigcom3+ noise2+ discr2+ siglvl3
sigcom3 ; noise2 ; discr2 ; siglvl3




library(mgcv)



gam3lp <- gam1$linear.predictors
gam4lp <- gam2$linear.predictors


#+end_src

** Models for GIs of 1936
*** Descriptive statistics

    We turn now to the detail of the analysis with past 1936 GIs.  We
    make the same analysis than for actual GIs, first with some
    descriptive statistics.

#+begin_src R :wrap example
Reg.Old <- subset(Reg.Ras, !Reg.Ras$LIBCOM %in%
                           c("CHENOVE", "MARSANNAY-LA-COTE", "COUCHEY",
                             "COMBLANCHIEN","CORGOLOIN", "SAINT-ROMAIN"))
Reg.Old$LIBCOM <- factor(Reg.Old$LIBCOM)
Reg.Old$AOCo <- as.numeric(ifelse(Reg.Old$AOC36lvl== "0", 1,
                           ifelse(Reg.Old$AOC36lvl== "3", 2, 3)))
table(Reg.Old$AOCo, Reg.Old$AOC)
#+end_src

#+RESULTS:
#+begin_example   
        1     2     3     4     5
  1  7124 11452  5111   575    39
  2     5   536 15175  8101   261
  3     0     1    13     3  1604
#+end_example

#+Latex: \clearpage

*** Estimation

    We estimate both the parametric and generalized additive models we
    the following codes.  Because of the long computation times, the
    reader would prefer to fit the models individually.

#+begin_src R :wrap example
library(MASS)
polm2 <- polr(factor(AOCo)~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO
              + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
              + poly(X, 3)* poly(Y, 3), data= Reg.Old, Hess= T)
polm2a <- polr(factor(AOCo)~ 0+ EXPO+ GEOL+ PEDO
               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
               + poly(X, 3)* poly(Y, 3), data= Reg.Old, Hess= T)
polm2b <- polr(factor(AOCo)~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO
               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
             , data= Reg.Old, Hess= T)

library(mgcv)
listk <- c(25, 50, 75, 100, 125, 150, 200, 250)
gamold <- vector("list", length(listk))
system.time(
    for (i in 1: length(listk)){
        gamold[[ i]] <- gam(AOCo~ 0+ LIBCOM+ EXPO+ GEOL+ PEDO
                            + s(DEM)+ s(SLOPE)+ s(RAYAT)
                            + s(X, Y, k= listk[ i])
                          , data= Reg.Old, family= ocat(R= 3))
    }
)
names(gamold) <- paste0("gam", listk)
save(gamold, file= "Inter/gamold.Rda")

gammold <- vector("list", length(listk))
system.time(
for (i in 1: length(listk)){
    gammold[[ i]] <- gam(AOCo~ 0+ EXPO+ GEOL+ PEDO
                         + s(DEM)+ s(SLOPE)+ s(RAYAT)
                         + s(X, Y, k= listk[ i])
                       , data= Reg.Old, family= ocat(R= 3))
})
names(gammold) <- paste0("gam", listk)
save(gammold, file= "Inter/gammold.Rda")
#+end_src

#+begin_example
utilisateur     système      écoulé 
    20454.2       309.5     20766.0
utilisateur     système      écoulé 
    28307.5       462.8     28772.0 
#+end_example

#+Latex: \clearpage

*** Significance

    We first assess the joint significance of variables in all OGAMs
    of GIs designation.  The following results are reported in Table 5
    in Appendix p.43 of the Working Paper.

#+begin_src R :wrap example
load("Inter/gamold.Rda")
res2a <- anova(polm2, polm2b)
res2 <- Anova(polm2)
sapply(gamold[ 1: 7], resume)
#+end_src

#+RESULTS:
#+begin_example
          gam25  gam50  gam100  gam125  gam150  gam200  gam250
s(DEM)   1503.8 1196.2   197.7   219.6   144.8   265.0   253.0
            8.6    8.8     7.6     8.4     8.2     8.7     7.4
s(SLOPE)  534.2  478.1   466.5   332.8   297.1   190.4   169.1
            8.7    8.8     8.7     8.8     8.7     8.8     7.5
s(RAYAT)  339.4  208.8   139.4   150.2    99.2    87.7   142.8
            8.3    8.0     1.1     8.0     8.1     7.4     7.4
s(X,Y)   4789.1 6760.0 14558.9 15981.2 17285.3 18979.3 20905.7
           23.9   48.7    98.0   122.4   147.1   194.3   235.3
LIBCOM   5828.9 3720.9  2639.2  2378.3  2177.2  1831.7  1264.7
           25.0   25.0    25.0    25.0    25.0    25.0    25.0
EXPO      258.0  177.5   131.9   101.2    58.5    43.0    64.0
            7.0    7.0     7.0     7.0     7.0     7.0     7.0
GEOL     1018.5 1047.0   692.1   772.8   710.2   585.8   509.3
           14.0   14.0    14.0    14.0    14.0    14.0    14.0
PEDO     3335.3 2820.6   898.8   660.3   599.4   537.0   539.3
           12.0   12.0    12.0    12.0    12.0    12.0    12.0
#+end_example

*** Goodness of fit

    Goodness of fit measures from the same Table 5 in Appendix p.43 of
    the Working Paper.

#+begin_src R :wrap example
round(c(McFaddenR2= psR2(polm2), AIC= AIC(polm2)/ 1000,
        Pcgp= sum(diag(table(predict(polm2), Reg.Old$AOCo)))/ nrow(Reg.Old)), 2)
rbind(Pcgp= sapply(gamold[1: 7 ], pcgp),
      AIC=  sapply(gamold[1: 7 ], AIC)/ 1000,
      psR2= sapply(gamold[1: 7 ], psR2))
#+end_src

#+RESULTS:
#+begin_example
McFaddenR2        AIC       Pcgp 
      0.45      45.22       0.82
       gam25   gam50  gam100 gam125  gam150  gam200  gam250
Pcgp 82.8820 83.7580 87.8840 88.606 89.8400 91.3480 92.2060
AIC  43.9251 41.2140 31.8196 30.039 28.0878 25.1203 23.1212
psR2  0.4629  0.4968  0.6132  0.636  0.6606  0.6982  0.7236
#+end_example

#+Latex: \clearpage

*** Omitted variable
**** Bootstrap                               :noheading:

     Bootstrapped statistics for omitted variables, reported in Table
     5 in Appendix p.43 of the Working Paper.

#+begin_src R :wrap example
library(lmtest) ; library(sandwich) ; library(sure) ; library(ggplot2)
wal3 <- rep(NA, nsim <- 100)
for (i in 1: nsim){
    tmp <- surrogate(polm2a)- polm2a$lp
    wal3[ i] <- waldtest(lm(tmp~ Reg.Old$LIBCOM), . ~ 1, vcov= vcovHC)$F[ 2]
}
load("Inter/gammold.Rda") ; library(ggplot2) ; source("myFcts.R")
wal4 <- sapply(gammold, function(x) omitVar(x, Reg.Old$LIBCOM, nsim))
wold <- data.frame(logit= wal3, wal4)
apply(wold, 2, function(x) quantile(x, c(.05, .5, .95)))
#+end_src

#+RESULTS:
#+begin_example
    logit gam25  gam50 gam100 gam125 gam150 gam200 gam250
5%  88.18 24.15  8.776  3.903  3.577  2.025  1.700  1.207
50% 92.78 26.62 10.171  4.802  4.372  2.740  2.308  1.748
95% 97.08 28.57 11.472  5.594  5.647  3.638  3.452  2.583
#+end_example

#+Latex: \clearpage

**** Plot                                    :noheading:

     Now the same violon plot as for current GIs, not reported the
     Working Paper but mentioned at p.24.

#+begin_src R :results graphics :height 7 :width 10 :file "./Figures/SignifPold.pdf"
library(lattice)
poldat <- stack(wold)
Fstat <- round(qf(.9999, 31, Inf), 2)
bwplot(log(values)~ ind, data= poldat, type=c("l","g"), horizontal= FALSE,
       xlab= 'Model of GI designation',
       ylab= 'Bootstraped F-statistics (log scale)',
       par.settings = list(box.rectangle=list(col='black'),
                           plot.symbol  = list(pch='.', cex = 0.1)),
       scales=list(y= list(at= log((1: 15)^2), lab= (1: 15)^2)),
       panel = function(..., box.ratio) {
           panel.grid(h= 0, v = -11)
           panel.abline(h= log((1: 15)^2), col= "grey80")
           panel.violin(..., col = "lightblue",
                        varwidth = FALSE, box.ratio = box.ratio)
           panel.bwplot(..., col='black',
                        cex=0.8, pch='|', fill='gray', box.ratio = .1)
           panel.abline(h= log(Fstat), col= "red", lty= 2, cex= 1.5)
           panel.text(2, log(Fstat)+ .1,
                      paste0("F= ", Fstat, " : critical value at .01%"))})
#+end_src

#+Caption: *F-statistics for the omitted /terroir/ effects in 1936 GIs*
#+ATTR_LATEX: :options scale= .5
#+RESULTS:
[[file:./Figures/SignifPold.pdf]]

#+Latex: \clearpage

*** Specification

    The use of surrogate residuals to test the specification process
    for models of 1936 GI designations.  As before, the results are
    not reported because the resulting file is too big.

#+begin_src R :exports code :results graphics :height 7 :width 12 :file "./Figures/Surroldgate.pdf"
library(sure) ; library(ggplot2) ; library(gridExtra)
var <- c("DEM", "SLOPE", "RAYAT", "EXPO", "LIBCOM", "X", "Y")
plots <- lapply(var, function(.x)
    autoplot(polm2, what= "covariate", x= Reg.Old@data[, .x], xlab= .x))
do.call(grid.arrange, c(list(autoplot(polm2, what= "qq")), plots))

restmp <- sureOGAM(gamold$gam150)- gamold$gam150$line 
plot(qlogis(1: nrow(Reg.Old)/ nrow(Reg.Old), scale= 1), sort(restmp))
abline(0, 1)
var <- c("DEM", "SLOPE", "RAYAT", "EXPO", "LIBCOM", "X", "Y")
par(mfrow= c(3, 3)) ; for (i in var) pltSURE(restmp, Reg.Old@data[, i], i)
#+end_src

#+ATTR_LATEX: :options scale= .5
#+RESULTS:
[[file:./Figures/Surroldgate.pdf]]

*** Marginal effects

    Marginal effect can be assessed as for current GIs, the code
    belows can be used on the models from the =gamold= object to
    produce Figure 9 in the Appendix p.44 in the Working Paper.

#+begin_src R :results graphics :height 7 :width 12 :file "./Figures/Effectsold.pdf"
library(effects)
plot(predictorEffects(polm2, ~ DEM+ SLOPE+ RAYAT+ EXPO+ GEOL+ PEDO,
                      latent= TRUE,
                      xlevels=list(DEM= 200: 500,
                                   SLOPE= 0: 400/ 10, RAYAT= -60: 30/ 10)))
# plot(gamold$gam125, pages= 1, scale= 0)
#+end_src

#+ATTR_LATEX: :options scale= .4
#+RESULTS:
[[file:./Figures/Effectsold.pdf]]

#+Latex: \clearpage

*** Ordinal superiority measures
    
    Ordinal superiority for the GIs of 1936, that corresponds to
    Figure 11 in the Appendix p. 46 of the Working Paper.

#+begin_src R :results graphics :height 6 :width 9 :file "./Figures/ComEffOld.pdf"
plogi <- function(x) exp(x/ sqrt(2))/ (1+ exp(x/ sqrt(2)))
load("Inter/gamold.Rda")
xxx <- data.frame(sapply(gamold, function(x)
    2* plogi(I(x$coef[ 1: 25]- mean(x$coef[ 1: 25])))- 1))
www <- data.frame(xxx,
                  LIBCOM= substr(names(gamold[[ 1]]$coef[ 1: 25]), 7, 30),
                  REGION= c(rep("tomato", 10), rep("chartreuse", 15)),
                  MIN= apply(xxx[ 11: 12], 1, min),
                  MAX= apply(xxx[ 11: 12], 1, max),
                  MEAN= apply(xxx[ 11: 12], 1, mean))
segplot(reorder(factor(LIBCOM), MEAN)~ MIN+ MAX, length= 5, draw.bands= T,
        data= www[order(www$MEAN), ], center= MEAN, type= "o",
        key= foo_key, col= as.character(www$REGION[order(www$MEAN)]),
        unit = "mm", axis = axis.grid, col.symbol= "black", cex= 1, 
        xlab= "Min, Mean and Max of Ordinal Superiorty Measures")
#+end_src

#+CAPTION: *Ordinal superiorty measures for the 1936 GIs*
#+ATTR_LATEX: :options scale= .6
#+RESULTS:
[[file:./Figures/ComEffOld.pdf]]

#+Latex: \clearpage

*** Temporal variations

    An additional Figure 3 (p.26) of the Working Paper.

#+begin_src R :results graphics :height 6 :width 11 :file "./Figures/ComDyn.pdf"
zzz <- merge(ww, www, by= "LIBCOM")
segplot(reorder(factor(LIBCOM), MEAN.x)~ MEAN.y+ MEAN.x, data= zzz,
        segments.fun = panel.arrows, length = 5, unit = "mm",
        key= foo_key, col= as.character(zzz$REGION.x),
        draw.bands= F, axis = axis.grid, lwd= 3,
        xlab= "Variation of ordinal superiority measure from 1936 to now")
#+end_src

#+CAPTION: *Evolution of superiority measures between 1936 and now*
#+ATTR_LATEX: :options scale= .6
#+RESULTS:
[[file:./Figures/ComDyn.pdf]]

#+Latex: \clearpage

*** Decomposition table

    The code below compute the decomposition table for GIs of 1936,
    unreported.

#+begin_src R :wrap example
ddoo <- data.frame(AOCo= Reg.Old$AOCo, LIBCOM= Reg.Old$LIBCOM,
                   sapply(gamold[ 1: 7], function(x)
                       rowSums(predict(x, type= 'terms')[, -1])))
dcop <- sapply(names(ddoo[, 3: 9]), function(x)
    c("Total Signal"= var(ddoo[, x]), "Total Noise"= pi^2/ 3,
      jointSignal(ddoo, x, "AOCo"), jointNoise(ddoo, x, "AOCo"),
      vertiSignal(ddoo, x, "AOCo"), vertiResid(ddoo, x, "AOCo"),
      vertiNoise(ddoo,  x, "AOCo"), 
      horizSignal(ddoo, x, "AOCo"), horizResid(ddoo, x, "AOCo"),
      horizNoise(ddoo, x,  "AOCo")))
round(t(apply(dcop, 1, function(x) x/ (pi^2/ 3+ dcop[1, ])* 100)), 1)
#+end_src

#+RESULTS:
#+begin_example
                    gam25 gam50 gam100 gam125 gam150 gam200 gam250
Total Signal         95.9  98.3   97.2   97.4  100.0   99.1   99.6
Total Noise           4.1   1.7    2.8    2.6    0.0    0.9    0.4
Joint Signal         90.8  95.0   72.2   56.1   98.5   59.2   84.4
Joint Noise           5.1   3.4   25.0   41.4    1.5   39.9   15.2
Vertical Signal       2.4   1.3   19.7   16.8    3.1   20.3   13.0
Vertical Residual    88.4  93.7   52.6   39.2   95.4   38.9   71.4
Vertical Noise       93.5  97.1   77.5   80.6   96.9   78.8   86.6
Horizontal Signal    86.0  92.0   54.5   31.7   97.8   39.7   74.8
Horizontal Residual   4.8   3.0   17.7   24.4    0.7   19.5    9.6
Horizontal Noise      9.9   6.4   42.7   65.8    2.1   59.4   24.8
#+end_example

#+Latex: \clearpage

** Alternative GI designations
*** Change latent vineyard quality

    We conclude this work with the simulations of alternative GIs
    designations schemes. Below are scenarios S0 to S3 where the
    counterfactual GI designations are computed according to (we note
    $\hat{q}_i^{gam}= B(X_i)^\top \hat{\beta}^{gam}$):
\begin{align*}
y_i^{S\!0}= &\; \sum\nolimits_{j=0}^{5} j\cdot
           \mathbbm{1}[\hat{\alpha}_{j_i-1}+ \hat{\mu}_{c_i}\geqslant \hat{q}_i^{gam}+\hat{\xi}_i^{sur} \geqslant \hat{\alpha}_{j_i}+ \hat{\mu}_{c_i}]\\
y_i^{S\!1}= &\; \sum\nolimits_{j=0}^{5} j\cdot
           \mathbbm{1}[\hat{\alpha}_{j_i-1}+ \hat{\mu}_{c_i}\geqslant \hat{q}_i^{gam} \geqslant \hat{\alpha}_{j_i}+ \hat{\mu}_{c_i}]\\
y_i^{S\!2}= &\; \sum\nolimits_{j=0}^{5} j\cdot
           \mathbbm{1}[\hat{\alpha}_{j_i-1}\geqslant \hat{q}_i^{gam}+\hat{\xi}_i^{sur} \geqslant \hat{\alpha}_{j_i}]\\
y_i^{S\!3}= &\; \sum\nolimits_{j=0}^{5} j\cdot
           \mathbbm{1}[\hat{\alpha}_{j_i-1}\geqslant \hat{q}_i^{gam} \geqslant \hat{\alpha}_{j_i}]
\end{align*}  

#+LATEX: \clearpage

#+begin_src R :wrap example
prdd <- predict(gamod$gam900, type= 'terms')
thsld <- c(-Inf, gamod$gam900$family$getTheta(TRUE), Inf)
ltt0 <- rowSums(prdd)- (sureOGAM(gamod$gam900)- gamod$gam900$line)
ltt1 <- rowSums(prdd)
ltt2 <- mean(prdd[, 1])+ rowSums(prdd[, -1])-
    (sureOGAM(gamod$gam900)- gamod$gam900$line)
ltt3 <- mean(prdd[, 1])+ rowSums(prdd[, -1])
Simu <- data.frame(Reg.Ras, ltt= rowSums(prdd[, -1]),
                   OLD= Reg.Ras$AOC36lvl, S0= cut(ltt0, thsld),
                   SI= cut(ltt1, thsld), SII= cut(ltt2, thsld),
                   SIII= cut(ltt3, thsld))
table(Simu$AOC, Simu$S0) ; table(Simu$AOC, Simu$SI)
table(Simu$AOC, Simu$SII) ; table(Simu$AOC, Simu$SIII)
#+end_src

#+RESULTS:
#+begin_example
   
    (-Inf,-1] (-1,5.34] (5.34,14] (14,21] (21, Inf]
  1      7847      1510       269      40         9
  2      1688      9476      2126     158        98
  3       146      2360     20652    2005       146
  4        25       117      2160    5956       421
  5         0         1        84     455      1364
   
    (-Inf,-1] (-1,5.34] (5.34,14] (14,21] (21, Inf]
  1      8592      1021        62       0         0
  2       562     11787      1147      50         0
  3         7       929     23528     834        11
  4         0         9      1089    7446       135
  5         0         0         1     363      1540
   
    (-Inf,-1] (-1,5.34] (5.34,14] (14,21] (21, Inf]
  1      7580      1770       280      34        11
  2      2150      7655      3482     150       109
  3       409      5038     16162    3521       179
  4        28       127      2039    5389      1096
  5         0         8       185     611      1100
   
    (-Inf,-1] (-1,5.34] (5.34,14] (14,21] (21, Inf]
  1      8197      1403        73       2         0
  2      1624      8961      2875      85         1
  3       111      4655     17666    2873         4
  4         0        24      1631    6229       795
  5         0         0        83     636      1185
#+end_example

#+LATEX: \clearpage

*** Add a vertical level in GIs

    Here we simulate counterfactual GIs designations from scenarios
    S4, S5, and S6.  In each case, we use the GIs from S0 and add a
    vertical level by computing the mean of the thresholds.

#+begin_src R :wrap example
thrldBOUR <- mean(ltt0[Reg.Ras$AOC== 2])
thrldVILL <- mean(ltt0[Reg.Ras$AOC== 3])
thrldPCRU <- mean(ltt0[Reg.Ras$AOC== 4])
Simv <- data.frame(Simu,
       SIV= ifelse(Reg.Ras$AOC< 2, Reg.Ras$AOC,
            ifelse(Reg.Ras$AOC== 2 & ltt0< thrldBOUR, 2,
            ifelse(Reg.Ras$AOC== 2 & ltt0>= thrldBOUR, 3, Reg.Ras$AOC+1))),
       SV = ifelse(Reg.Ras$AOC< 3, Reg.Ras$AOC,
            ifelse(Reg.Ras$AOC== 3 & ltt0< thrldVILL, 3,
            ifelse(Reg.Ras$AOC== 3 & ltt0>= thrldVILL, 4, Reg.Ras$AOC+1))),
       SVI= ifelse(Reg.Ras$AOC< 4, Reg.Ras$AOC,
            ifelse(Reg.Ras$AOC== 4 & ltt0< thrldPCRU, 4,
            ifelse(Reg.Ras$AOC== 4 & ltt0>= thrldPCRU, 5, Reg.Ras$AOC+1))))
table(Simv$AOC, Simv$SIV) ; table(Simv$AOC, Simv$SV) ; table(Simv$AOC, Simv$SVI)
#+end_src

#+RESULTS:
#+begin_example
   
        1     2     3     4     5     6
  1  9675     0     0     0     0     0
  2     0  7400  6146     0     0     0
  3     0     0     0 25309     0     0
  4     0     0     0     0  8679     0
  5     0     0     0     0     0  1904
   
        1     2     3     4     5     6
  1  9675     0     0     0     0     0
  2     0 13546     0     0     0     0
  3     0     0 12792 12517     0     0
  4     0     0     0     0  8679     0
  5     0     0     0     0     0  1904
   
        1     2     3     4     5     6
  1  9675     0     0     0     0     0
  2     0 13546     0     0     0     0
  3     0     0 25309     0     0     0
  4     0     0     0  4072  4607     0
  5     0     0     0     0     0  1904
#+end_example

#+LATEX: \clearpage

*** Decomposition table

    And we conclude with the decomposition that are reported Table 3
    (p.27) of the Working Paper.

#+begin_src R :wrap example
decf <- sapply(names(Simv[, 76: 83]), function(x)
    c("Total Signal"= var(Simv[, "ltt"]), "Total Noise"= pi^2/ 3,
      jointSignal(Simv, "ltt", vt= x), jointNoise(Simv, "ltt", vt= x),
      vertiSignal(Simv, "ltt", vt= x), vertiResid(Simv, "ltt", vt= x),
      vertiNoise(Simv,  "ltt", vt= x),
      horizSignal(Simv, "ltt", vt= x), horizResid(Simv, "ltt", vt= x),
      horizNoise(Simv,  "ltt", vt= x)))
round(t(apply(decf, 1, function(x) x/ (pi^2/ 3+ decf[1, ])* 100)), 1)
#+end_src

#+RESULTS:
#+begin_example
                     OLD   S0   SI  SII SIII  SIV   SV  SVI
Total Signal        97.5 97.5 97.5 97.5 97.5 97.5 97.5 97.5
Total Noise          2.5  2.5  2.5  2.5  2.5  2.5  2.5  2.5
Joint Signal        48.0 78.2 81.0 79.5 81.5 79.0 79.5 78.9
Joint Noise         49.5 19.3 16.5 18.1 16.0 18.5 18.0 18.6
Vertical Signal     34.4 64.6 68.2 69.7 72.6 65.6 66.1 65.5
Vertical Residual   13.6 13.6 12.8  9.7  8.9 13.4 13.4 13.4
Vertical Noise      63.1 32.9 29.3 27.8 24.9 31.9 31.4 32.0
Horizontal Signal   23.8 23.8 23.8 23.8 23.8 23.8 23.8 23.8
Horizontal Residual 24.2 54.4 57.2 55.7 57.7 55.2 55.7 55.1
Horizontal Noise    73.7 73.7 73.7 73.7 73.7 73.7 73.7 73.7
#+end_example

#+LATEX: \clearpage

** Robustness Checks                         :noexport:
*** Parallel assumption
**** By binary models

#+begin_src R
fit.glm1 <- glm(BOUR~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
                 + EXPO+ Cg5+ Cp10+ poly(XREG, 2)* poly(YREG, 2)
                 , data= RegRank, family= binomial(link= "logit"))
fit.glm2 <- glm(VILL~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
                + EXPO+ Cg5+ Cp10+ poly(XREG, 2)* poly(YREG, 2)
              , data= RegRank, family= binomial(link= "logit"))
fit.glm3 <- glm(PCRU~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
                + EXPO+ Cg5+ Cp10+ poly(XREG, 2)* poly(YREG, 2)
              , data= RegRank, family= binomial(link= "logit"))
fit.glm4 <- glm(GCRU~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
                + EXPO+ Cg5+ Cp10+ poly(XREG, 2)* poly(YREG, 2)
              , data= RegRank, family= binomial(link= "logit"))

gg <- surrogate(fit.glm1)

library(effects) ; library(latticeExtra)
a <- plot(Effect("DEM", fit.glm1))
b <- plot(Effect("DEM", fit.glm2))
d <- plot(Effect("DEM", fit.glm3))
e <- plot(Effect("DEM", fit.glm4))
c(a, b, d, e, y.same= T)

a <- plot(Effect("SLOPE", fit.glm1))
b <- plot(Effect("SLOPE", fit.glm2))
d <- plot(Effect("SLOPE", fit.glm3))
e <- plot(Effect("SLOPE", fit.glm4))
c(a, b, d, e, y.same= T)

a <- plot(Effect("RAYAT", fit.glm1))
b <- plot(Effect("RAYAT", fit.glm2))
d <- plot(Effect("RAYAT", fit.glm3))
e <- plot(Effect("RAYAT", fit.glm4))
c(a, b, d, e, y.same= T)

a <- plot(Effect("EXPO", fit.glm1))
b <- plot(Effect("EXPO", fit.glm2))
d <- plot(Effect("EXPO", fit.glm3))
e <- plot(Effect("EXPO", fit.glm4))
c(a, b, d, e, y.same= T)


surlGLM <- function(mod, newd= NULL){
    if (mod$family$link!= "logit") stop("Logit required")
    if (is.null(newd)){
        g1 <- as.integer(mod$y)
        g6 <- mod$linear.predictors
    } else {
        g1 <- as.integer(newd[, "AOCc"])
        g6 <- predict(mod, newdata= newd, type= "link")
    }
    nn <- length(g1)
    ifelse(g1== 0,
           rtrunc(nn, spec= "logis", a= -Inf, b= 0, location= g6,
                  scale= 1),
           rtrunc(nn, spec= "logis", a= 0, b= Inf, location= g6,
                  scale= 1))
}
sur1 <- surlGLM(fit.glm1)
ff1 <- sur1- mean(sur1)
sur2 <- surlGLM(fit.glm2)
ff2 <- sur2- mean(sur2)


sur3 <- surlGLM(fit.glm3)
ff3 <- sur3- mean(sur3)
sur4 <- surlGLM(fit.glm4)
ff4 <- sur4- mean(sur4)
plot(density(sur4))
xyplot(sur1 ~ RegRank$DEM, 
       type = c("p", "smooth"), col.line= "black")

xyplot(ff1- ff2 ~ RegRank$DEM, 
       type = c("p", "smooth"), col.line= "black")
xyplot(ff2- ff3 ~ RegRank$SLOPE, 
       type = c("p", "smooth"), col.line= "black")
xyplot(ff3- ff4 ~ RegRank$SLOPE, 
       type = c("p", "smooth"), col.line= "black")
xyplot(ff2- sur4 ~ RegRank$DEM, 
       type = c("p", "smooth"), col.line= "black")

#+end_src

**** By constrains on coefficients

#+begin_src R
table(RegRank$LIBCOM, RegRank$AOCc)
table(RegRank$LIBCOM, RegRank$AOChst)

yop <- resids(fit.polr)

yap <- surlOLR(fit.polr)
plot(yap- mean(yap), yop)

library(VGAM)
fit.vglm <- vglm(AOCo~ bs(DEM, 4)+ bs(SLOPE, 5)+ bs(ASPECT, 5)
                 + bs(RAYAT, 5)+ bs(PERMEABILITY, 4)
                 + bs(DISTCHF, 4)
                 + bs(XREG, 4)* bs(YREG, 4)
               , propodds, data= RegRank)
##                link= "Aranda-Ordaz",
##                control= list(method= "optim", iter.max= 1000,
##                              maxIter= 1000))
summary(fit.vglm)
autoplot(fit.vglm, what= "qq")

clist <- list("(Intercept)"= diag(4),
              "bs(DEM, 3)"= nctr, "SLOPE"= nctr,
              "poly(ASPECT, 2)"= nctr, "poly(RAYAT, 2)"= nctr,
              "poly(PERMEABILITY, 2)"= nctr,
              "poly(XREG, 2)"= nctr, "poly(YREG, 2)"= nctr,
              "poly(XREG, 2):poly(YREG, 2)"= nctr,
              "LIBCOM"= nctr2)
fit.vglm1 <- vglm(AOCo~ bs(DEM, 3)+ SLOPE+ poly(ASPECT, 2)
                  + poly(RAYAT, 2)+ poly(PERMEABILITY, 2)
                  + poly(XREG, 2)* poly(YREG, 2)
                  + LIBCOM
                , family= cumulative(reverse= T,
                                     parallel= FALSE~ 1+LIBCOM)
                , constraints= clist
                , data= RegRank)
(ctest <- constraints(fit.vglm1))

fit.vglm2 <- vglm(AOCo~ bs(DEM, 3)+ SLOPE+ poly(ASPECT, 2)
                  + poly(RAYAT, 2)+ poly(PERMEABILITY, 2)
                  + poly(XREG, 2)* poly(YREG, 2)
                  + LIBCOM
                , family= cumulative(reverse= T)
                , constraints= clist
                , data= RegRank)
constraints(fit.vglm2)
yap <- data.frame(predict(fit.vglm, type= "response"))
yup <- factor(names(yap)[apply(yap, 1, which.max)],
              ordered= T, levels= c("BGOR", "BOUR",
                                    "VILL", "PCRU", "GCRU"))
sum(diag(table(Y, yup)))/ nrow(RegRank)

coefficients(fit.rs, matrix= TRUE)
par(mfrow= c(1, 5))
plot(as(fit.rs, "vgam"), se = TRUE, scol = "blue", which.term= 2)
gg <- predict(fit.ss)
summary(gg)


autoplot(fit.vglm2, what= "qq")
autoplot(fit.vglm2, what= "covariate", x= RegRank$LIBCOM)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
coefficients(fit.vglm2, matrix= TRUE)
plot(gof(fit.vglm, nsim= 100, test= "ks"))

fit.clmr1 <- clm(AOCo~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(ASPECT, 2)
                + poly(RAYAT, 2)+ poly(PERMEABILITY, 2)
                + poly(DISTCHF, 2)
                + poly(XREG, 2)* poly(YREG, 2)
              , nominal= ~ DEM,
              , scale= ~ DEM+ SLOPE+ ASPECT+ RAYAT+ DISTCHF
              , data= RegRank
              , control= list(method= "Newton", maxIter= 1000L, 
                              maxLineIter= 1000L))
nominal_test(fit.clmr1)
summary(fit.clmr1)
anova(fit.clmr1, fit.clmr)

fit.molr4 <- vglm(AOCo~ poly(DEM, 2)+ SLOPE,
                  family= cumulative(link= probit, reverse= TRUE),
                  data= RankReg)
anova(fit.molr3, fit.molr4, type= "I")
1- pchisq(deviance(fit.molr3)- deviance(fit.molr4),
          df= df.residual(fit.molr3)- df.residual(fit.molr4))
hdeff(fit.molr)


#+end_src

**** By surrogate

#+begin_src R
prldat1 <- RegRank
table(prldat1$AOCc <- ifelse(prldat1$AOCc> 3, 3, prldat1$AOCc))
por1a <- polr(factor(AOCc)~ bs(DEM, 3)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
              + EXPO+ Cg5+ Cp10+ poly(XREG, 2)* poly(YREG, 2)
            , data= prldat1, Hess= TRUE)

prldat2 <- RegRank
table(prldat2$AOCc <- ifelse(prldat1$AOCc< 3, 3, prldat2$AOCc))
por1b <- polr(factor(AOCc)~ bs(DEM, 3)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
              + EXPO+ Cg5+ Cp10+ poly(XREG, 2)* poly(YREG, 2)
            , data= prldat2, Hess= TRUE)


s1 <- surrogate(por1a)
s2 <- surrogate(por1b)
library(ggplot2)
ggplot(data.frame(D = s1 - s2- mean(s1 - s2),
                  x = RegRank$DEM) , aes(x = x, y = D)) +
geom_point(color = "#444444", shape = 19, size = 2) +
geom_smooth(se = FALSE, size = 1.2, color = "red")

summary(por1a)
summary(por1b)
gg1 <- surlOLR(por1)
, newd= prldat1)
gg2 <- surlOLR(por2)
, newd= prldat2)

plot(RegRank$DEM, gg1- gg2)
#+end_src

*** Specification

    attention geologie/ pedologie

#+begin_src R
library(ordinalNet)

library(splines)
eq1 <- factor(AOCc)~  CODEp+ CODEg+ bs(XREG, 10)* bs(YREG, 10)+
    (poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2))* EXPO+ LIBCOM

fit.onet <- ordinalNet(model.matrix(eq1, data= RegRank),
                       factor(RegRank$AOCc),
                       family= "cumulative", reverse= T, link= "logit")
fit.onet
ss <- predict(fit.onet, type= "class")
sum(diag(table(RegRank$AOCc, ss)))/ nrow(RegRank)

rr <- predict(fit.onet, type ="link")
summary(rr[, 1]- rr[, 2])
coefficients(fit.onet)[ 2]- coefficients(fit.onet)[ 1]

summary(fit.onet)
coef(fit.onet, matrix= TRUE)

pts <- data.frame(RegRank[, c("XL93", "YL93")])
km <-  kmeans(pts, 300, nstart= 10, iter.max= 100)
ctr <- data.frame(X1= km$center[, 1], X2= km$center[, 2])
coordinates(ctr) <- ~ X1+ X2
voronoipolygons = function(layer) {
    require(deldir)
    crds = layer@coords
    z = deldir(crds[,1], crds[,2])
    w = tile.list(z)
    polys = vector(mode='list', length=length(w))
    require(sp)
    for (i in seq(along=polys)) {
        pcrds = cbind(w[[i]]$x, w[[i]]$y)
        pcrds = rbind(pcrds, pcrds[1,])
        polys[[i]] = Polygons(list(Polygon(pcrds)), ID=as.character(i))
    }
    SP = SpatialPolygons(polys)
    voronoi = SpatialPolygonsDataFrame(SP, data=data.frame(x=crds[,1], 
        y=crds[,2], row.names=sapply(slot(SP, 'polygons'), 
        function(x) slot(x, 'ID'))))
}
PolyVP <- voronoipolygons(ctr)
proj4string(PolyVP) <- proj4string(AocRank)
RegRank$KCLUST <- factor(km$cluster)

## library(raster)
## polyVPsel <- intersect(Bord.Area, PolyVP)
## polyVPsel$KCLUST <- as.numeric(row.names(polyVPsel))
length(levels(RegRank$KCLUST))
eq2 <- factor(AOCc)~  KCLUST+ LIBCOM

fit.twot <- ordinalNet(x= model.matrix(eq2, data= RegRank),
                       y= factor(RegRank$AOCc),
                       family= "cumulative", reverse= T, link= "logit")
ss <- predict(fit.twot, type= "class")
sum(diag(table(RegRank$AOCc, ss)))/ nrow(RegRank)
fit.twot
coefficients(fit.twot, matrix= T)

fit.pnet <- ordinalNet(X, Y,
                       family= "cumulative", reverse= T, link= "probit",
                       parallelTerms= TRUE, nonparallelTerms= TRUE)
summary(fit.pnet)
coef(fit2, matrix= TRUE)
1- (-60594/ logLik(update(fit.ogam, . ~ + 1)))
pp <- predict(fit.pnet, type= "class")
sum(diag(table(Y, pp)))/ nrow(RegRank)
#+end_src

*** Heteroskedasticity

#+begin_src R
library(ordinal)
fit.clmr <- clm(AOCo~ bs(DEM, 4)+ bs(SLOPE, 5)+ bs(ASPECT, 5)
                + bs(RAYAT, 5)+ bs(PERMEABILITY, 4)
                + bs(DISTCHF, 4)
                + bs(XREG, 4)* bs(YREG, 4)
              , data= RegRank)
##                link= "Aranda-Ordaz",
##                control= list(method= "optim", iter.max= 1000,
##                              maxIter= 1000))
summary(fit.clmr)
autoplot(fit.clmr, what= "qq")
library(ordinal)
fit.clmr <- clm(AOCo~ bs(DEM, 4)+ bs(SLOPE, 5)+ bs(ASPECT, 5)
                + bs(RAYAT, 5)+ bs(PERMEABILITY, 4)
                + bs(DISTCHF, 4)
                + bs(XREG, 4)* bs(YREG, 4)
              , scale= ~ DEM+ SLOPE+ ASPECT+ RAYAT+ DISTCHF
              , data= RegRank
              , control= list(method= "Newton", maxIter= 1000L, 
                              maxLineIter= 1000L))
summary(fit.clmr)
autoplot(fit.clmr, what= "qq")
autoplot(fit.clmr, what= "covariate", x= RegRank$DEM)
autoplot(fit.clmr, what= "covariate", x= RegRank$DISTCHF)
#+end_src

*** Sample choices

    Cote de Beaune / Cote de Nuits, with other land uses.

    Multivariate probit

#+begin_src R
AocRank$AOCo <- factor(ifelse(AocRank$GCRU== 1, "GCRU",
                       ifelse(AocRank$PCRU== 1, "PCRU",
                       ifelse(AocRank$VILL== 1 | AocRank$COMM== 1, "VILL",
                       ifelse(AocRank$BOUR== 1, "BOUR",
                       ifelse(AocRank$BGOR== 1 | AocRank$BPTG== 1, "BGOR",
                              "NONE"))))), ordered= TRUE,
                       levels= c("NONE", "BGOR", "BOUR",
                                 "VILL", "PCRU", "GCRU"))
#+end_src

*** Spatial Autocorrelation                  :noexport:

#+begin_src R
load("Inter/AocRank.Rda")
SpRank <- subset(AocRank, AocRank$PAOC!= 0 &
                          !is.na(AocRank$DEM) & !is.na(AocRank$CODEg))
library(spdep)
DtrYo <- tri2nb(SpRank) ## triangulation pour le moment
BctYo <- nb2listw(DtrYo, style= "W")

DstReg <- dnearneigh(coordinates(SpRank), d1= 0, d2= 500)
dst <- nbdists(DstReg, coordinates(SpRank))
gl2 <- lapply(dst, function(x) 1e6/ (x^2))
BdsReg <- nb2listw(DstReg, glist= gl2, style= "W")

library("Inter/gamod2.Rda")
fff <- surlGAM(gamod2$gam50)- gamod2$gam50$line
moran.test(fff, BctYo)
#moran.test(fff, BdsReg)
moran.plot(as.numeric(fff), BctYo, labels= FALSE)

fff <- surlGAM(gamod2$gam400)- gamod2$gam400$line
moran.test(fff, BctYo)
#moran.test(fff, BdsReg)
moran.plot(as.numeric(fff), BctYo, labels= FALSE)


library("Inter/gamod3.Rda")
fff <- surlGAM(gamod3$gam800)- gamod3$gam800$line
moran.test(fff, BctYo)
#moran.test(fff, BdsReg)
moran.plot(as.numeric(fff), BctYo, labels= FALSE)

fff <- surlGAM(gamod3$gam700)- gamod3$gam700$line
moran.test(fff, BctYo)
moran.plot(as.numeric(fff), BctYo, labels= FALSE)


moran.test(ggam2, BctYo)
moran.test(ggam2, BdsReg)
moran.plot(as.numeric(ggam2), BctYo, labels= FALSE)
moran.plot(as.numeric(ggam2), BdsReg, labels= FALSE)

j1 <- predict(fit.ogam2, type= "response")
j2 <- rowSums(t(apply(j1, 1, function(x) x* 1: 5)))
j3 <- rowSums(t(apply(j1, 1, function(x) x* c(1: 5)^2))- j2^2)
res <- (RegRank$AOCc- j2)/ j3
summary(res)
plot(density(res))
moran.test(res, BctYo)
moran.plot(res, BctYo)

head(tmp)
head(j2)
#+end_src

** Session information

#+begin_src R :wrap example
sessionInfo()

#+end_src

#+RESULTS:
#+begin_example
R version 3.6.0 (2019-04-26)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 18.04.2 LTS
Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.7.1
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.7.1
locale:
 [1] LC_CTYPE=fr_FR.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=fr_FR.UTF-8        LC_COLLATE=fr_FR.UTF-8    
 [5] LC_MONETARY=fr_FR.UTF-8    LC_MESSAGES=fr_FR.UTF-8   
 [7] LC_PAPER=fr_FR.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=fr_FR.UTF-8 LC_IDENTIFICATION=C       
attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods  
[7] base     
other attached packages:
 [1] latticeExtra_0.6-28 effects_4.0-3       gridExtra_2.3      
 [4] ggplot2_3.1.0       sure_0.2.0          sandwich_2.5-0     
 [7] lmtest_0.9-36       zoo_1.8-4           mgcv_1.8-28        
[10] nlme_3.1-140        car_3.0-2           carData_3.0-1      
[13] MASS_7.3-51.1       RColorBrewer_1.1-2  lattice_0.20-38    
[16] sp_1.3-1           
loaded via a namespace (and not attached):
 [1] tidyselect_0.2.5  purrr_0.3.2       splines_3.6.0    
 [4] haven_1.1.2       colorspace_1.3-2  survival_2.43-3  
 [7] rlang_0.3.4       nloptr_1.0.4      pillar_1.3.0     
[10] foreign_0.8-71    glue_1.3.0        withr_2.1.2      
[13] readxl_1.1.0      bindrcpp_0.2.2    plyr_1.8.4       
[16] bindr_0.1.1       munsell_0.5.0     gtable_0.2.0     
[19] cellranger_1.1.0  zip_1.0.0         labeling_0.3     
[22] rio_0.5.10        forcats_0.3.0     curl_3.2         
[25] Rcpp_1.0.0        scales_1.0.0      abind_1.4-5      
[28] lme4_1.1-18-1     hms_0.4.2         openxlsx_4.1.0   
[31] dplyr_0.7.8       survey_3.33-2     grid_3.6.0       
[34] rgdal_1.3-6       tools_3.6.0       magrittr_1.5     
[37] lazyeval_0.2.1    tibble_1.4.2      crayon_1.3.4     
[40] pkgconfig_2.0.2   Matrix_1.2-17     data.table_1.11.4
[43] minqa_1.2.4       assertthat_0.2.1  R6_2.4.0         
[46] nnet_7.3-12       compiler_3.6.0
#+end_example

#+LATEX: \clearpage\appendix

** Custom R functions
*** Translation of geology

#+begin_src R :tangle ./myFcts.R
trans_geol <- data.frame(
    GEOL= Reg.Ras$GEOL[!duplicated(Reg.Ras$GEOL)],
    GEOf= c(
        "Calcaires massifs de \"Comblanchien\" (Bathonien sup.)",
        "Marnes et calcaires divers (Callovien inférieur)",
        "Marnes et calcaires argileux (Oxfordien moyen)",
        "Eboulis ordonnés cryoclastiques et colluvions diverses",
        "Oolithe ferrugineuse (Oxfordien moyen-sup)",
        "Calcaires hydrauliques de Molesmes et Noiron (Oxfordien sup.)",
        "Colluvions diverses",
        "Dépôts argilo-limoneux, sables et graviers du Villafranchien",
        "Calcaires de Tonnerre, Oisellemont et calcaires à Astartes",
        "Eboulis et glissements de terrains",
        "Calcaires grenus bicolores (Bathonien terminal)",
        "Terrasse argilo-limoneuse de Saint-Usage",
        "Formation de Saint-Cosme (marnes fluvio-lacustres varvées)",
        "Alluvions anciennes indifférenciées, argilo-limoneuses",
        "Calcaires bioclastiques, graveleux, à oolithes (Bathonien inf.)"
    ),
    GEOe= c(
        "Massive limestones from \"Comblanchien\" (upper Bathonian)",
        "Various marls and limestones (lower Callovian)",
        "Marls and argillaceous limestones (middle Oxfordian)",
        "Ordered cryoclastic scree and various colluviums",
        "Ferruginous Oolite (middle-upper Oxfordian)",
        "Hydraulic limestones of Molesmes and Noiron (upper Oxfordian)",
        "Various colluviums",
        "Clay-silt deposits, sand and gravel from Villafranchien",
        "Limestones of Thunder, Oisellemont and limestones in Astartes",
        "Screes and landslides",
        "Two-tone gray limestones (terminal Bathonian)",
        "Clay-silty terrace of Saint-Usage",
        "Formation of Saint-Cosme (varnished fluvio-lacustrine marls)",
        "Undifferentiated ancient alluvium, clay-silty",
        "Bioclastic limestones, gravelly, with oolites (lower Bathonian)")
)
#+end_src

#+LATEX: \clearpage

*** Translation of pedology

#+begin_src R  :tangle ./myFcts.R
trans_pedo <- data.frame(
    PEDO= Reg.Ras$PEDO[!duplicated(Reg.Ras$PEDO)],
    PEDf= c(
        "Vignoble de la Côte de de Beaune",
        "Cônes de déjection du pied de Côte",
        "Côteaux viticoles des Hautes Côtes de Nuits",
        "Courtes pentes marneuses des plateaux plio-pléistocène",
        "Piedmont de la côte viticole",
        "Versants pentus des Hautes Côtes de Beaune",
        "Sommets des collines des Hautes Côtes de Beaune",
        "Alluvions récentes calcaires des vallées (Ouche, Tille, Meuzin)",
        "Pentes liasiques du Haut-Auxois",
        "Basses terrasses gravelo-caillouteuses des plaines alluviales",
        "Basses terrasses argileuses des plaines alluviales",
        "Terrasse argilo-limoneuse de Saint-Usage",
        "Vignoble de la Côte de Nuits",
        "Rebord oriental des plateaux calcaires dominant la Côte viticole"
    ),
    PEDe= c(
        "Vineyard of the Côte de Beaune",
        "Coot footing cones",
        "Wine hills of Hautes Côtes de Nuits",
        "Oxfordian limestone-marly trays of the Hautes Côtes",
        "Short marly slopes of Plio-Pleistocene plateaus",
        "Piedmont of the vineyard of the Côte",
        "Sloping slopes of the Hautes Côtes de Beaune",
        "Summits of the hills of the Hautes Côtes de Beaune",
        "Recent alluvial limestone valleys (Ouche, Tille, Meuzin)",
        "Liastic slopes of Haut-Auxois",
        "Gravelo-stony low terraces of alluvial plains",
        "Low clay terraces of alluvial plains",
        "Vineyard of the Côte de Nuits",
        "Eastern edge of the limestone plateaus overlooking the Côte"
    )
)
#+end_src

#+LATEX: \clearpage

*** Surrogate Residuals
  :PROPERTIES:
  :CUSTOM_ID: Sec:rOGAM
  :END:
**** Ordered Logit                           :noheading:

    The R package =sure= allows to simulate the surrogate residuals
    from a large panel of ordered parametric models
    https://koalaverse.github.io/sure/index.html.  Actually, it is not
    possible to compute the residuals for semiparametric ordered
    generalized additive model fitted with the package =mgcv=.  Here,
    we first define the =truncLogis= function for the simulation of
    random draws from a truncated logistic distribution with a vector
    of inputs (locations and thresholds) as the package =truncdist= is
    only designed for a given value of location and thresholds.  Then,
    we code the function =surePOLR= inspired from the =sure= package
    which simulate surrogate residuals from =polr= models from the
    =MASS= package.  This will be used to check the validity of used
    functions.

#+begin_src R :tangle ./myFcts.R
truncLogis <- function(n, spec, a = -Inf, b = Inf, ...) {
    require(truncdist)
    p <- runif(n, min = 0, max = 1)
    G <- get(paste("p", spec, sep = ""), mode = "function")
    Gin <- get(paste("q", spec, sep = ""), mode = "function")
    G.a <- G(a, ...)
    G.b <- G(b, ...)
    pmin(pmax(a, Gin(G(a, ...) + p * (G(b, ...) - G(a, ...)), ...)), b)
}

surePOLR <- function(mod, newd= NULL){
    if (mod$method!= "logistic") stop("Logistic required")
    gg <- as.numeric(mod$zeta)
    if (is.null(newd)){
        g1 <- as.integer(model.response(model.frame(mod)))
        g6 <- mod$lp
    } else {
        g1 <- as.integer(newd[, "AOCc"])
        g6 <- gg[ 1]-qlogis(predict(mod, newdata= newd, type= 'probs')[, 1])
    }
    nn <- length(g1)
    suls <- sapply(g1, switch,
                   "1"= c(-Inf  , gg[ 1]), "2"= c(gg[ 1], gg[ 2]),
                   "3"= c(gg[ 2], gg[ 3]), "4"= c(gg[ 3], gg[ 4]),
                   "5"= c(gg[ 4], Inf   ))
    sls <- data.frame(unlist(t(suls)))
    truncLogis(nn, spec= "logis", a= sls[, 1], b= sls[, 2],
               location= g6, scale= 1)
}
#+end_src

#+begin_src R
sure1 <- surrogate(polm1)+ polm1$zeta[ 1]
sure2 <- resids(polm1)
polr1 <- surePOLR(polm1) ; polr2 <- surePOLR(polm1)- polm1$lp
#+end_src

     The custom function =surePOLR= allows to compute the same
     surrogate value and surrogate residuals than the functions
     =surrogate= and =resids= from the =sure= package.
    
**** Ordered Additive                        :noheading:

     Now we use the same structure to simulate the surrogate residuals
     for the OGAM through the function =sureOGAM=.  Again, the
     function is tested for a random OGAM.

#+begin_src R :tangle ./myFcts.R
sureOGAM <- function(mod, newd= NULL){
    if (is.null(newd)){
        g1 <- as.integer(mod$y)
        g6 <- mod$linear.predictors
    } else {
        g1 <- as.integer(newd[, names(mod$model[ 1])])
        g6 <- predict(mod, newdata= newd)
    }
    nn <- length(g1)
    gt <- data.frame(rep(NA, nn), rep(NA, nn))
    gg <- c(mod$family$getTheta(TRUE), Inf)
    kk <- c(- Inf, gg[ 1])
    for (j in 2: length(unique(g1))) kk <- rbind(kk, c(gg[ j- 1], gg[ j]))
    gt <- data.frame(t(sapply(g1, function(x) kk[x, ])))
    truncLogis(nn, spec= "logis", a= gt[, 1], b= gt[, 2], location= g6)
}
#+end_src

#+begin_src R
library(mgcv)
fit.ogam <- gam(AOC~ poly(DEM, 2)+ poly(SLOPE, 2)
                + poly(RAYAT, 2)+ poly(ASPECT, 2)+ poly(PERMEA, 2)
              , family= ocat(R= 5), data= Reg.Ras)
ogam1 <- sureOGAM(fit.ogam)
ogam2 <- sureOGAM(fit.ogam)- fit.ogam$linear.pred

par(mfrow= c(3, 2))
plot(sure1, polr1)
abline(h= fit.polr$zeta, v= fit.polr$zeta, lty= 2, col= "blue")
abline(0, 1, col= "orange")
plot(sure2, polr2)
abline(0, 1, col= "orange")

plot(polr1, ogam1- mean(ogam1))
abline(h= fit.ogam$family$getTheta(TRUE)- mean(ogam1),
       v= fit.polr$zeta, lty= 2, col= "blue")
abline(0, 1, col= "orange")
plot(polr2, ogam2)
abline(0, 1, col= "orange")

plot(sure1, ogam1- mean(ogam1))
abline(h= fit.ogam$family$getTheta(TRUE)- mean(ogam1),
       v= fit.polr$zeta, lty= 2, col= "blue")
abline(0, 1, col= "orange")
plot(sure2, ogam2)
abline(0, 1, col= "orange")

#+end_src

#+Latex: \newpage

**** Current package                         :noexport:

       Pour les glm, la fonction getBounds.glm devrait se baser sur 1
       ou 2 plutôt que 0 ou 1. En plus, plutôt que de garder du 1 ou 2
       (issu de
       as.integer(as.factor(model.response(model.frame(fit.glm1))))),
       il serait plus logique d'utilise la partie y de l'objet, ce que
       je fais dans mes fonctions.

       Pourquoi on fait 2 colonnes pour les proba prédites, le cas
       particulier pour les glm dans les fonctions workhorse ne me
       semble pas nécessaire. C'est de là que viendrait l'erreur que
       l'on trouve avec le package.

       Pour avoir du newdata, il suffirait de remplacer (comme je le
       fais) les fitted.values et linear predictors par la fonction
       predict. (ça risque d'être plus long)

       Il y a une partie du code (les trois fonctions ci-dessous que
       je ne capte pas bien)

#+begin_src R
library(sure)
bad <- surrogate(fit.glm1) ## MARCHE PAS POUR GLM
better <- surrogate(fit.polr)
mean(better) ; mean(fit.polr$lp) ## but not in the scale
mean(fit.polr$lp- fit.polr$zeta[ 1]) ## good

.rtrunc <- function (n, spec, a = -Inf, b = Inf, ...) {
  .qtrunc(runif(n, min = 0, max = 1), spec, a = a, b = b, ...)
}

.qtrunc <- function (p, spec, a = -Inf, b = Inf, ...) {
  tt <- p
  G <- get(paste("p", spec, sep = ""), mode = "function")
  Gin <- get(paste("q", spec, sep = ""), mode = "function")
  G.a <- G(a, ...)
  G.b <- G(b, ...)
  pmin(pmax(a, Gin(G(a, ...) + p * (G(b, ...) - G(a, ...)), ...)), b)
}

sim_trunc <- function(n, distribution, a, b, location = 0, scale = 1) {
  if (distribution == "norm") {
    .rtrunc(n, spec = distribution, a = a, b = b,
            mean = location, sd = scale)
  } else {
    .rtrunc(n, spec = distribution, a = a, b = b,
            location = location, scale = scale)
  }
}
#+end_src

**** Old functions                           :noexport:
***** Logit

#+begin_src R
surlGLM <- function(mod, newd= NULL){
    if (mod$family$link!= "logit") stop("Logit required")
    if (is.null(newd)){
        g1 <- as.integer(mod$y)
        g6 <- mod$linear.predictors
    } else {
        g1 <- as.integer(newd[, "AOCc"])
        g6 <- predict(mod, newdata= newd, type= "link")
    }
    nn <- length(g1)
    ifelse(g1== 0,
           rtrunc(nn, spec= "logis", a= -Inf, b= 0, location= g6,
                  scale= 1),
           rtrunc(nn, spec= "logis", a= 0, b=  Inf, location= g6,
                  scale= 1))
}
#+end_src

***** Probit

#+begin_src R :tangle ./myFcts.R
surpGLM <- function(mod, newd= NULL){
    if (mod$family$link!= "probit") stop("Probit required")
    if (is.null(newd)){
        g1 <- as.integer(mod$y)
        g6 <- mod$linear.predictors
    } else {
        g1 <- as.integer(newd[, "AOCc"])
        g6 <- predict(mod, newdata= newd, type= "link")
    }
    nn <- length(g1)
    ifelse(g1== 0, rtrunc(nn, spec= "norm", a= -Inf, b= 0, mean= g6),
           rtrunc(nn, spec= "norm", a= 0, b=  Inf, mean= g6))
}
#+end_src

*** Decomposition terms
  :PROPERTIES:
  :CUSTOM_ID: Sec:rDCMP
  :END:

    For each terms of the decomposition presented in the main text, we
    code a different function as reported below.  First note the
    vector of predicted latent quality index $\hat{q}_i= B(X_i)^\top
    \hat{\beta}$.  With $N_{y}$, $N_{c}$ and $N_{y, c}$ the numbers of
    vineyard plots respectively in rank $y$, in /commune/ $c$ and both
    in rank $y$ and /commune/ $c$, we define:
\begin{align*}
\overline{q}_{y_i}    =&\; \frac{1}{N_{y_i}} \sum\nolimits_{\ell=1}^{N} \mathbbm{1}[y_\ell= y_i]\cdot \hat{q}_{\ell} \\
\overline{q}_{c_i}    =&\; \frac{1}{N_{c_i}} \sum\nolimits_{\ell=1}^{N} \mathbbm{1}[c_\ell= c_i]\cdot \hat{q}_{\ell} \\
\overline{q}_{y_i,c_i}=&\; \frac{1}{N_{y_i, c_i}} \sum\nolimits_{\ell=1}^{N} \mathbbm{1}[(y_\ell, c_\ell)= (y_i, c_i)]\cdot \hat{q}_{\ell}
\end{align*}

**** Joint Signal                            :noheading:

     The *joint signal* terms is the variance of the expected quality
     conditionally on vertical and horizontal dummies:
\begin{equation}
\mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y, c]\,\big\}= 
\frac{1}{N}\sum\nolimits_{i=1}^{N} \big[\overline{q}_{y_i, c_i}- \overline{q}\big]^2 
\end{equation}

#+begin_src R :tangle ./myFcts.R
jointSignal <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    jS <- rep(0, nrow(dat))
    for (i in unique(dat[, vt])){
        for (j in unique(dat[, hz])){
            tmp <- dat[, vt]== i & dat[, hz]== j
            jS[ tmp] <- mean(dat[tmp, lt])
        }
    }
    c("Joint Signal"= var(jS))
}
#+end_src

#+Latex: \vspace{1cm}

**** Joint Noise                             :noheading:

     The *joint noise* terms is the expectation of the variance
     quality conditionally on vertical and horizontal dummies:
\begin{equation}
\mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y, c]\,\big\}= 
\sum\nolimits_{y=1}^J\sum\nolimits_{c=1}^C \left[\tfrac{N_{y, c}}{N} 
\sum\nolimits_{i= 1}^N \mathbbm{1}[(y_i, c_i)= (y, c)]\cdot (\hat{q}_{i}- \overline{q}_{y_i,c_i})^2\right] 
\end{equation}

#+begin_src R :tangle ./myFcts.R
jointNoise <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    jN <- 0
    for (i in unique(dat[, vt])){
        for (j in unique(dat[, hz])){
            tmp <- dat[, vt]== i & dat[, hz]== j
            if (sum(tmp)> 1) jN <- jN+ var(dat[ tmp, lt])* mean(tmp)
        }
    }
    c("Joint Noise"= jN)
}
#+end_src

#+Latex: \vspace{1cm}

**** Vertical Signal                         :noheading:

     The *vertical signal* terms is the variance of the expectation
     quality conditionally on vertical GI dummies:
\begin{equation}
\mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y]\,\big\}= 
\frac{1}{N}\sum\nolimits_{i=1}^{N} \big[\overline{q}_{y_i}- \overline{q}\big]^2 
\end{equation}

#+begin_src R :tangle ./myFcts.R
vertiSignal <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    vS <- rep(0, nrow(dat))
    for (i in unique(dat[, vt])){
        vS[ dat[, vt]== i] <- mean(dat[dat[, vt]== i, lt])
    }
    c("Vertical Signal"= var(vS))
}
#+end_src

#+Latex: \vspace{1cm}

**** Vertical Residual                       :noheading:

     The *vertical residual* terms is the expectation of the
     conditional on horizontal variance of the expectation quality
     conditionally on vertical GI dummies:
\begin{equation}
\mathbb{E}\big\{\,\mathbb{V}[\mathbb{E}(q(X^*)\mid y, c)\mid c]\,\big\}= 
\sum\nolimits_{y=1}^{J}\left[ \tfrac{N_y}{N}\sum_{i=1}^N (\overline{q}_{y_i}-\overline{q})^2 \right] 
\end{equation}

#+begin_src R :tangle ./myFcts.R
vertiResid <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    sig <- rep(0, nrow(dat)) ; vR <- 0
    for (i in unique(dat[, vt])){
        for (j in unique(dat[, hz])){
            tmp <- dat[, vt]== i & dat[, hz]== j 
            sig[ tmp] <- mean(dat[ tmp, lt])
        }
    }
    for (i in unique(dat[, vt])){
        vR <- vR+ var(sig[dat[, vt]== i])* mean(dat[, vt]== i)
    }
    c("Vertical Residual"= vR)
}
#+end_src

#+Latex: \vspace{1cm}

**** Vertical Noise                          :noheading:

     The *vertical Noise* terms is the expectation of the variance of
     the quality conditionally on vertical GI dummies:
\begin{equation}
\mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y]\,\big\}= 
\sum\nolimits_{y=1}^J \left[\tfrac{N_{y}}{N} 
\sum\nolimits_{i= 1}^N \mathbbm{1}[y_i= y]\cdot (\hat{q}_{i}- \overline{q}_{y_i})^2\right] 
\end{equation}

#+begin_src R :tangle ./myFcts.R
vertiNoise <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    vN <- 0
    for (i in unique(dat[, vt])){
        vN <- vN+ var(dat[dat[, vt]== i, lt])* mean(dat[, vt]== i)
    }
    c("Vertical Noise"= vN)
}
#+end_src

#+Latex: \vspace{1cm}

**** Horizontal Signal                       :noheading:

     The *horizontal signal* terms is the variance of the expectation
     quality conditionally on horizontal GI dummies:
\begin{equation}
\mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid c]\,\big\}= 
\frac{1}{N}\sum\nolimits_{i=1}^{N} \big[\overline{q}_{c_i}- \overline{q}\big]^2 
\end{equation}

#+begin_src R :tangle ./myFcts.R
horizSignal <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    hS <- rep(0, nrow(dat))
    for (j in unique(dat[, hz])){
        hS[ dat[, hz]== j] <- mean(dat[dat[, hz]== j, lt])
    }
    c("Horizontal Signal"= var(hS))
}
#+end_src

#+Latex: \vspace{1cm}

**** Horizontal Residual                     :noheading:

     The *horizontal residual* terms is the expectation of the
     conditional on vertical variance of the expectation quality
     conditionally on horizontal GI dummies:
\begin{equation}
\mathbb{E}\big\{\,\mathbb{V}[\mathbb{E}(q(X^*)\mid y, c)\mid y]\,\big\}= 
\sum\nolimits_{c=1}^{C}\left[ \tfrac{N_c}{N}\sum_{i=1}^N (\overline{q}_{c_i}-\overline{q})^2 \right] 
\end{equation}

#+begin_src R :tangle ./myFcts.R
horizResid <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    sig <- rep(0, nrow(dat)) ; hR <- 0
    for (i in unique(dat[, vt])){
        for (j in unique(dat[, hz])){
            tmp <- dat[, vt]== i & dat[, hz]== j 
            sig[ tmp] <- mean(dat[ tmp, lt])
        }
    }
    for (j in unique(dat[, hz])){
        hR <- hR+ var(sig[dat[, hz]== j])* mean(dat[, hz]== j)
    }
    c("Horizontal Residual"= hR)
}
#+end_src

#+Latex: \vspace{1cm}

**** Horizontal Noise                        :noheading:

     The *horizontal Noise* terms is the expectation of the variance
     of the quality conditionally on horizontal GI dummies:
\begin{equation}
\mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid c]\,\big\}= 
\sum\nolimits_{c=1}^C \left[\tfrac{N_{c}}{N} 
\sum\nolimits_{i= 1}^N \mathbbm{1}[c_i= c]\cdot (\hat{q}_{i}- \overline{q}_{c_i})^2\right] 
\end{equation}

#+begin_src R :tangle ./myFcts.R
horizNoise <- function(dat, lt, vt= "AOC", hz= "LIBCOM"){
    hN <- 0
    for (j in unique(dat[, hz])){
        hN <- hN+ (var(dat[dat[, hz]== j, lt])* mean(dat[, hz]== j)) 
    }
    c("Horizontal Noise"= hN)
}
#+end_src

#+Latex: \vspace{1cm}

** Test of R packages                        :noexport:
*** Old GIS

#+begin_src R
gamold$Gam100$coef[ 1] <- - gamold$Gam100$coef[ 1]
gamold$Gam125$coef[ 1] <- - gamold$Gam125$coef[ 1]
gamold$Gam100$coef[ 2] <- - gamold$Gam100$coef[ 2]
gamold$Gam125$coef[ 2] <- - gamold$Gam125$coef[ 2]
gamold$Gam100$coef[ 7] <- - 3- gamold$Gam125$coef[ 7]
gamold$Gam125$coef[ 7] <- - 4- gamold$Gam125$coef[ 7]
gamold$Gam125$coef[ 12] <- - gamold$Gam125$coef[ 12]
gamold$Gam125$coef[ 13] <- - gamold$Gam125$coef[ 13]
save(gamold, file= "Inter/gamold.Rda")
#+end_src

*** Multinomial model

    Hors sujet

#+begin_src R
library(nnet)
RegRank <- subset(AocRank@data, !is.na(AocRank$DEM))
fit.mnl <- multinom(AOCo ~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(ASPECT, 2)
                    + poly(SOLAR, 2)+ poly(PERMEABILITY, 2)
                    + poly(XL93, 3)* poly(YL93, 3),
                    data= RegRank, maxit= 300)
1- (logLik(fit.mnl)/ logLik(update(fit.mnl, . ~ + 1)))
sum(diag(table(RegRank$AOCo, predict(fit.mnl))))/ nrow(RegRank)
table(RegRank$AOCo, predict(fit.mnl))


library(effects)
plot(predictorEffects(fit.mnl, ~ DEM+ SLOPE),
     axes=list(grid=TRUE, x=list(rug=FALSE)),
     lattice=list(key.args=list(columns=1)),
     lines=list(multiline=TRUE, col=c("blue", "red", "orange")))
plot(predictorEffects(fit.mnl, ~ DEM+ SLOPE),
     axes=list(grid=TRUE, x=list(rug=FALSE), y= list(style= "stacked")),
     lattice=list(key.args=list(columns=1)),
     lines=list(multiline=TRUE))

yop1 <- predict(fit.mnl, type= "probs")
plot(data.frame(yop1))

gg <- t(apply(yop1, 1, cumsum))
ff <- gg[order(gg[, 1]), ]
plot(ff[, 1], type= "l")
par(new= T)
plot(ff[, 2], col= "blue")

ff$D1 <- ff[, 2]- ff[, 1]

summary(ff$D1)
#+end_src

*** SURE for residuals

#+begin_src R
## On utilise le probit uniquement sur AOC
autoplot(fit.golr, what= "covariate", x= RankReg$DEM,
         method= "jitter", jitter.scale= "response")

summary(prs)


plot(prs, prq$R)
library(ggplot2) # for plotting
p1 <- ggplot(data.frame(x = RankReg$DEM, y = prq$R), aes(x, y)) +
    geom_point(color = "#444444", shape = 19, size = 2, alpha = 0.5) +
    geom_smooth(color = "red", se = FALSE) +
    ylab("Probability-scale residual")
p2 <- ggplot(data.frame(y = prq$R), aes(sample = y)) +
    stat_qq(distribution = qunif, dparams = list(min = -1, max = 1), alpha = 0.5) +
    xlab("Sample quantile") +
    ylab("Theoretical quantile")
grid.arrange(p1, p2, ncol = 2) # Figure 1

sres <- resids(fit.polr)
plot(prs, sres)
p1 <- autoplot(sres, what= "covariate", x= RankReg$SLOPE)
p2 <- autoplot(sres, what= "qq", distribution= qnorm)
grid.arrange(p1, p2, ncol = 2) # Figure 2

sprd <- surrogate(fit.polr)
var(sprd)


fit.polr2 <- update(fit.polr, .~ DEM)
sprd2 <- surrogate(fit.polr2)
var(sprd2)

autoplot(fit.polr2, what= "covariate", x= df1$x)

prq <- NormRes(predict(fit.polr2, type= "probs"), df1$y)
p1 <- ggplot(data.frame(x = df1$x, y = prq$R), aes(x, y)) +
    geom_point(color = "#444444", shape = 19, size = 2, alpha = 0.5) +
    geom_smooth(color = "red", se = FALSE) +
    ylab("Probability-scale residual")
p2 <- ggplot(data.frame(y = prq$R), aes(sample = y)) +
    stat_qq(distribution = qnorm, alpha = 0.5) +
    xlab("Sample quantile") +
    ylab("Theoretical quantile")
grid.arrange(p1, p2, ncol = 2)

prq <- NormRes(predict(fit.orm, type= "fitted.ind"), df2$y)
p2 <- ggplot(data.frame(x = df1$x, y = prq$R), aes(x, y)) +
    geom_point(color = "#444444", shape = 19, size = 2, alpha = 0.5) +
    geom_smooth(color = "red", se = FALSE) +
    ylab("Probability-scale residual")
grid.arrange(p1, p2, ncol = 2)

resids # residuals
surrogate # surrogate response values
autoplot # diagnostic plots
gof # goodness of fit

#+end_src

*** OrdinalNet

#+begin_src R
load("Inter/AocRank.Rda")
AocRank$AOCo <- factor(ifelse(AocRank$GCRU== 1, "GCRU",
                       ifelse(AocRank$PCRU== 1, "PCRU",
                       ifelse(AocRank$VILL== 1 | AocRank$COMM== 1, "VILL",
                       ifelse(AocRank$BOUR== 1, "BOUR",
                       ifelse(AocRank$BGOR== 1 | AocRank$BPTG== 1, "BGOR",
                              "NONE"))))), ordered= TRUE,
                       levels= c("NONE", "BGOR", "BOUR",
                                 "VILL", "PCRU", "GCRU"))
spl <- round(seq(1, nrow(AocRank), length.out= 10000))
RegSpl <- subset(AocRank@data[spl, ],
                 !is.na(AocRank$DEM[spl])& !is.na(AocRank$CODEg[spl]))
RegSpl$LIBCOM <- factor(RegSpl$LIBCOM)
library(MASS)
fit.polr <- polr(AOCo~ poly(DEM, 2)+ poly(SLOPE, 2)+ poly(ASPECT, 2)
                 + poly(SOLAR, 2)+ PERMEABILITY,#+ LIBCOM,
                 data= RegSpl, method= "probit")
1- (logLik(fit.polr)/ logLik(update(fit.polr, . ~ + 1)))
head(rr)
ss <- predict(fit.polr, type= "class")
table(rr, ss)
summary(fit1)
coef(fit1, matrix= TRUE)

fit2 <- ordinalNet(X, Y, family= "cumulative", reverse= T, link= "logit",
                   parallelTerms= TRUE, nonparallelTerms= TRUE)
summary(fit2)
coef(fit2, matrix= TRUE)

head(tt)
## A APPLIQUER SUR UNE SOUS-ECHANTILLON DE MA BASE
library(ordinalgmifs)
data(hccframe) ; dim(hccframe)
X <- model.matrix(~ ., data= hccframe[, -1])
Y <- factor(hccframe[, 1])
fit1 <- ordinalNet(X, Y, family= "cumulative", link= "logit")
summary(fit1)
head(coef(fit1, matrix= TRUE))

fit2 <- ordinalNet(X, Y, family= "cumulative", link= "logit",
                   parallelTerms= TRUE, nonparallelTerms= TRUE, warn= F)
summary(fit2)
coef(fit2, matrix= TRUE)

fit3 <- ordinalNet(X, Y, family= "cumulative", link= "logit",
                   parallelTerms= FALSE, nonparallelTerms= TRUE, warn= F)
summary(fit3)
head(coef(fit2, matrix= TRUE))

fit2_tune <- ordinalNetTune(X, Y, family= "cumulative", link= "logit",
                            parallelTerms= TRUE, nonparallelTerms= TRUE,
                            warn= FALSE, printProgress= FALSE)
head(fit2_tune$loglik)
bastLambda <- which.max(rowMeans(fit2_tune$loglik))
coef(fit2_tune$fit, matrix= TRUE, whichLambda= bastLambda)
#+end_src

*** Multinomial Shrink (from Raja, Julie)
**** Estimations

# see also https://rdrr.io/cran/mgcv/man/multinom.html

#+begin_src R :results output exemple
library(glmnet)
Ter.Reg <- subset(Ter.Fin, !is.na(Ter.Fin$POP99))
MX <- model.matrix(U03~ 0+ Uinit+ scale(RTFO03)+ scale(PXGL03)
                      + scale(PXLB03)+ scale(POP99)+ scale(TMOY03)
                      + scale(PCUM03)+ scale(BdAlti)+ scale(BdPente)
                      + scale(rumoy1km)+ scale(promoy1km), data= Ter.Reg)
Las0 <- glmnet(MX, Ter.Reg$U03, family= "multinomial", alpha= 1)
Rid0 <- glmnet(MX, Ter.Reg$U03, family= "multinomial", alpha= 0)
Net0 <- glmnet(MX, Ter.Reg$U03, family= "multinomial", alpha= .5)
Srk0 <- list("Las0"= Las0, "Rid0"= Rid0, "Net0"= Net0)
#+end_src

**** LASSO

#+Name: Lst:LMNL0
#+Header: :width 7 :height 9
#+begin_src R :results graphics :exports code :file "Figures/LassoMNL0.pdf"
load("./Res/Srk0.Rda") ; bL0 <- coef(Srk0$Las0)
par(mfrow= c(4, 2), mar= c(2, 2, 2, 1))
for (i in names(bL0)){
    ## FOR THE GENERAL PLOT
    cf1 <- bL0[[ i]][-1, ] ; yop <- (1/ 5): (dim(cf1)[ 2]/ 5)* 5
    matplot(yop, t(cf1)[yop ,], type= "o", lty= 1, pch= 19, col= "blue",
            xlim= c(0, max(yop)+ 12),
            xlab= "Step", ylab= "Coefficients", main= paste(i, "GENERAL"))
    text(max(yop)+ 8, cf1[1: 4, max(yop)],
         substr(rownames(cf1[1: 4, ]), 6, 20), cew= .75)
    ## FOR THE ZOOM PLOT
    cf2 <- bL0[[ i]][-c(1: 5), ]
    deb <- min(I(1: max(yop))[colMeans(cf2)!= 0])- 1
    yop <- (deb/ 5): (dim(cf2)[ 2]/ 5)* 5
    matplot(yop, t(cf2)[yop ,], type= "o", lty= 1, pch= 19, col= "blue",
            xlim= c(deb, max(yop+ 10)),
            xlab= "Step", ylab= "Coefficients", main= paste(i , "ZOOM"))
    text(max(yop)+ 5, cf2[, max(yop)],
         substr(rownames(cf2), 6, 20), cex= .75)
}
#+end_src

 #+Name: Fig:LMNL0
 #+ATTR_LaTeX: :options scale= .8
 #+Caption: Coefficients of variables from Lasso models on the specification 0
 #+RESULTS: Lst:LMNL0
 [[file:Figures/LassoMNL0.pdf]]

     Figure in the appendix.

**** RIDGE

#+Name: Lst:RMNL0
#+Header: :width 7 :height 9
#+begin_src R :results graphics :exports code :file "Figures/RidgeMNL0.pdf"
load("./Res/Srk0.Rda") ; bR0 <- coef(Srk0$Rid0)
par(mfrow= c(4, 2), mar= c(2, 2, 2, 1))
for (i in names(bR0)){    
    ## FOR THE GENERAL PLOT
    cf1 <- bR0[[ i]][-1, ]; yop <- round(seq(1, dim(cf1)[ 2], lengt= 10))
    matplot(yop, t(cf1)[yop ,], type= "o", lty= 1, pch= 19, col= "blue",
            xlim= c(0, max(yop)+ 12),
            xlab= "Step", ylab= "Coefficients", main= paste(i, "GENERAL"))
    text(max(yop)+ 8, cf1[1: 4, max(yop)],
         substr(rownames(cf1[1: 4, ]), 6, 20), cew= .75)
    ## FOR THE ZOOM PLOT
    cf2 <- bR0[[ i]][-c(1: 5), ] ; deb= 1
    yop <- (deb/ 5): (dim(cf2)[ 2]/ 5)* 5
    matplot(yop, t(cf2)[yop ,], type= "o", lty= 1, pch= 19, col= "blue",
            xlim= c(deb, max(yop+ 10)),
            xlab= "Step", ylab= "Coefficients", main= paste(i , "ZOOM"))
    text(max(yop)+ 5, cf2[, max(yop)],
         substr(rownames(cf2), 6, 20), cex= .75)
}
#+end_src

#+Name: Fig:RMNL0
#+ATTR_LaTeX: :options scale= .8
#+Caption: Coefficients of variables from Ridge models on the specification 0
#+RESULTS: Lst:RMNL0
[[file:Figures/RidgeMNL0.pdf]]

     Figure in the appendix.

**** ELASTIC NET \alpha= .5

#+Name: Lst:NMNL0
#+Header: :width 7 :height 9
#+begin_src R :results graphics :exports code :file "Figures/NetMNL0.pdf"
load("./Res/Srk0.Rda") ; bN0 <- coef(Srk0$Net0)
par(mfrow= c(4, 2), mar= c(2, 2, 2, 1))
for (i in names(bN0)){
    ## FOR THE GENERAL PLOT
    cf1 <- bN0[[ i]][-1, ]; yop <- round(seq(1, dim(cf1)[ 2], lengt= 10))
    matplot(yop, t(cf1)[yop ,], type= "o", lty= 1, pch= 19, col= "blue",
            xlim= c(0, max(yop)+ 12),
            xlab= "Step", ylab= "Coefficients", main= paste(i, "GENERAL"))
    text(max(yop)+ 8, cf1[1: 4, max(yop)],
         substr(rownames(cf1[1: 4, ]), 6, 20), cew= .75)
    ## FOR THE ZOOM PLOT
    cf2 <- bN0[[ i]][-c(1: 5), ]
    deb <- min(I(1: max(yop))[colMeans(cf2)!= 0])- 1
    yop <- (deb/ 5): (dim(cf2)[ 2]/ 5)* 5
    matplot(yop, t(cf2)[yop ,], type= "o", lty= 1, pch= 19, col= "blue",
            xlim= c(deb, max(yop+ 10)),
            xlab= "Step", ylab= "Coefficients", main= paste(i , "ZOOM"))
    text(max(yop)+ 5, cf2[, max(yop)],
         substr(rownames(cf2), 6, 20), cex= .75)
}
#+end_src

#+Name: Fig:NMNL0
#+ATTR_LaTeX: :options scale= .8 :placement [!h]
#+Caption: Coefficients of variables from Elastic Net models on the specification 0
#+RESULTS: Lst:NMNL0
[[file:Figures/NetMNL0.pdf]]

     Figure in the appendix.

*** mvord

#+begin_src R
load("Inter/AocRank.Rda")
library(ordinal)
AocRank$AOCo <- factor(ifelse(AocRank$GCRU== 1, "GCRU",
                       ifelse(AocRank$PCRU== 1, "PCRU",
                       ifelse(AocRank$VILL== 1 | AocRank$COMM== 1, "VILL",
                       ifelse(AocRank$BOUR== 1, "BOUR",
                       ifelse(AocRank$BGOR== 1 | AocRank$BPTG== 1, "BGOR",
                              "NONE"))))), ordered= TRUE,
                       levels= c("NONE", "BGOR", "BOUR",
                                 "VILL", "PCRU", "GCRU"))
names(AocRank)
RegRank <- subset(AocRank@data, !is.na(AocRank$DEM)& !is.na(AocRank$CODEg))


library(mvord)
data(data_mvord_toy)
## CONVERT TO LONG FORMAT NECESSAIRE SI ON VEUT DES RELATIONS D'EXCLUSION
res <- mvord(MMO2(Y1, Y2)~ 0+ X1+ X2, data= data_mvord_toy)
summary(res)

names_constraints(Y~ 0+ X1+ X2+ f2, data= data_mvord_toy)

ff <- predict(res)
length(ff)
table(data_mvord_toy$Y1)

data(data_cr)
res_cor_probit_simple <- mvord(MMO2(rater1, rater2, rater3, rater4)~
                                   0+ LR+ LEV+ PR+ RSIZE+ BETA,
                               data= data_cr)
summary(res_cor_probit_simple, call= FALSE)
#+end_src

* Working Paper
  :PROPERTIES:
  :EXPORT_FILE_NAME:    WorkingPaper.pdf
  :EXPORT_LATEX_CLASS:  WorkinPap
  :EXPORT_LANGUAGE:     en
  :EXPORT_OPTIONS:      TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:3
  :EXPORT_TITLE:        @@latex: \vspace{-1cm} The informational content of geographical indications@@
  :EXPORT_AUTHOR:       @@latex:  Jean-Sauveur AY\thanks{\protect\singlespacing \vspace{-.8cm}\hspace{.4cm}Contact: \url{jsay@inra.fr}, UMR CESAER, AgroSup Dijon, INRA, Université de Bourgogne Franche-Comté.  Adress: 25 boulevard Docteur Petitjean, 21000 Dijon (France).  Data and R code are available in the Replication Material (RM) from the repository \href{http://github.com/jsay/geoInd/blob/master/ReproPaper.pdf}{http://github.com/jsay/geoInd/} under copyright licence GNU GPL V3.  I acknowledge Mohamed Hilal, Jean-Marc Brayer, Pierre Curmi, and Florian Humbert for their help with the data, and Julie Le Gallo, Stéphan Marette, Emmanuel Paroissien for their comments on previous versions of the article.} \\ INRA UMR CESAER @@
  :EXPORT_DATE:         Working Paper Version 1.2 : \today
  :EXPORT_LATEX_HEADER: \usepackage[T1]{fontenc} \usepackage[doublespacing]{setspace} \usepackage{tabularx, rotating, booktabs, pdflscape, amssymb, amsmath, amsthm, bbm, eurosym, pdflscape, txfonts, rotfloat, caption}\usepackage[para,online,flushleft]{threeparttable} 
  :END:
** Abstract                                  :noheading:
#+BEGIN_abstract
Geographical indications (GIs) convey information about the place of
production as a proxy for the quality of agricultural products.  We
define the informational content of the GI proxy as its ability to
describe the tangible characteristics of a production site, instead of
intangible factors from the political bargaining on the designation
process.  We estimate econometrically this informational content of
wine-related GIs for the /Côte d'Or/ region of Burgundy, France.  Due
to their hierarchical and nested structure, GIs have high
informational content while we found some persistent lobbying effects.
We apply the same signal decomposition to alternative wine
classifications from history and counterfactual simulations to show
significant gains of efficiency in the last century and provide
guidelines for better designated GIs in the future.\\

\textbf{Keywords}: Food certification, wine economics, strategic
quality disclosure, variance decomposition, ordered semi-parametric
model.

\textbf{J.E.L. Codes:} C24, L15, Q13.\\
#+END_abstract
** Introduction
*** Importance of information                :noheading:

    Using the place of production to signal the quality of
    agricultural products is not consensual in market relations
    citep:Josl06,USTR17, but distinguishing good quality products from
    those of bad quality is recognized as being fundamental for
    consumers and producers when the quality cannot be assessed before
    deciding to buy or sell citep:Aker70,Nels70.  Thus, one major
    point in the debate is the extent to which geographical
    indications (GIs) provide information about product quality
    citep:WMCl05,YBMZ17.  We studied this informational content of GIs
    through the econometric relationship between the natural and human
    characteristics of the vineyards and wine-related GIs of the /Côte
    d'Or/ region (Burgundy, France).

*** Our contribution                         :noheading:

    The main objective of this article was to identify the
    informational content of current, past, and simulated GI
    designation schemes for an exhaustive data set of $60\,000$
    vineyard plots.  We defined the informational content as the
    ability to describe the tangible characteristics of production
    sites, and estimate it by the variance of a latent quality index
    according to the principle that more informative signals lead to
    greater variability citep:GPen10.  We propose disentangling
    tangible information from intangible information through ordered
    logit models explaining the GI hierarchy by the natural and
    administrative attributes of vineyard plots.  The first set of
    variables relates to the tangible attributes of vineyard plots
    that are known to impact wine quality: topography (elevation,
    slope, aspect), geology (subsoil material, soil depth, soil
    humidity), and climate (solar radiation, longitude, latitude).
    The second set of variables relates to the political bargaining
    that have historically impacted the GI designation process,
    modeled with municipality-specific thresholds.  Through the
    reputation of landowners, their influence with decision-makers or
    their collective actions, some administrative units have had
    privileged treatment that made their vineyard plots higher in the
    GI hierarchy than similar plots from another administrative units.
    We formally show that significant threshold variations bias the
    signal, and decrease the efficiency of GI designation schemes.
    Moreover, using historical data, we found this bias was decreasing
    on the last century, and we drawn GI simulations to show how to
    improve the informational content of GIs in the future.

*** Empirical strategy                       :noheading:

    Knowing the geographic co-variations between tangible and
    intangible characteristics, and the difficulty controlling for all
    tangible variables that impact vineyard quality (i.e., /terroir/
    variables), the major empirical challenge at hand is to
    disentangle these two sources of variations in the GI signal.  In
    effect, wine quality strongly depends on the natural conditions
    prevailing at production sites citep:JLom93,BTRM14,KKFG15,VLRR18.
    Even with fine-scale data as we used here, all the /terroir/
    variables are not (and probably never will be) actually observable
    for econometric or statistical analysis.  One can think of the
    need to control for local climate patterns citep:LPBR19, soil
    microbes citep:BTRM14,GLZa14, or any other form of spatial
    heterogeneity citep:PCad95 that could confound the lobbying effect
    associated to the administrative location of a given vineyard
    plot.  We estimate semiparametric ordered generalized additive
    models (OGAMs) that exploits the precise location of vineyard
    plots to control for the unobserved spatial heterogeneity through
    fine-scale smooth functions of geographic coordinates
    citep:WPSa16.  This identification strategy is based on the
    structural difference between the assumed spatial continuity of
    /terroir/ and the discontinuity of administrative borders
    according to the axiom that nature does not make jumps (as in any
    regression discontinuity design).  This original estimation method
    is shown to significantly outperform more classical approaches
    that use polynomial functions of geographic coordinates both in
    terms of goodness-of-fit and of causal inference validity.

*** Why wine in Burgundy?                    :noheading:

    Wine is an experience good well-suited to studying the
    transmission of quality information between producers and
    consumers citep:CLVi97,ANau07,Ashe08,Stor12.  In Burgundy, the
    ranking of vineyards according to their quality for wine
    production has a long history dating back to the Middle Ages, with
    numerous modifications to the actual scheme
    citep:Jull16,More31,Lava55,Dang92,Garc11,WJac18.  Thus, the GIs
    that we study are based on the fine-scale location of the vineyard
    plots, with both a vertical and horizontal dimension of
    differentiation.  The vertical dimension is a quality ranking with
    five levels: /Côteaux Bourguignons/ < /Bourgogne Régional/ <
    /Bourgogne Village/ < /Premier Cru/ < /Grand Cru/.  The horizontal
    dimension is 1 of the 31 /communes/ (i.e., administrative
    municipalities) without an explicit hierarchy between them, such
    as /Beaune/, /Gevrey-Chambertin/, /Pommard/, or /Fixin/.  Such a
    hierarchical and nested structure is common for wine-related GIs
    in France (Bordeaux, Rhône Valley, see citealp:GLRW17) and other
    wine-producing countries (Germany, United States and Italy, see
    citealp:Stor05,CMCG10,CSCa19).  The horizontal dimension also
    corresponds to the spatial scale at which the lobbying was made
    for GI designations citep:Jacq09.  This conjunction between GI and
    administrative scales is not particular to Burgundy, as similar
    patterns are found for Bordeaux citep:Four12.  Indeed, GIs could
    be viewed as cartels with quality signaling and quantity control
    determined at the same scale citep:MCSc99,MCre03,DSwi14.

*** Literature reputation                    :noheading:
    
    This article is an empirical contribution to the literature about
    quality disclosure and strategic certification (see
    citealp:Bagw01,DJin10 for reviews).  The vineyard quality
    index@@latex:\footnote{ We use the concept of vineyard quality
    index in reference to the hierarchical structure of GIs that is
    modeled from a continuous latent variable crossing ordered
    thresholds.  This quality is revealed from the GI designation
    scheme.}@@ that we study is based exclusively on natural vineyard
    characteristics, in contrast to typical frameworks in which
    quality is strategically determined by producers
    citep:Shap82,BDWh87,ALiz01,JLes03,DMDi14.  The resulting
    exogeneity makes identification of the informational content of
    the quality signal easier and allows more transparent analysis of
    the role of lobbying in the information conveyed by actual GIs put
    on the labels of wine bottles.  We argue that the long history of
    GI designations allows us to neglect the role of actual wine
    producers and their undoubtedly tangible impact on wine quality.
    In effect, as generations of producers succeed each other with
    numerous vineyards bought and sold, the informational content of
    GIs is a predetermined collective reputation citep:Tiro96 that is
    reasonably independent from the actual individual practices or
    skills of producers.  In addition, the vineyard quality index
    relies exclusively on the unchangeable location of production
    sites, which precludes spurious correlations from the assortative
    matching between quality and name as in cite:Tade99.  Because a GI
    name cannot be separated from its associated vineyard quality
    based on tangible characteristics, the GI information put on the
    label by producers is not related to their own characteristics,
    which is another source of tangible information not studied here.
    
*** Literature quality disclosure            :noheading:

    A large body of literature about wine quality disclosure is
    concerned with expert reviews and the use of this information by
    consumers.  Such ratings have been shown to have mainly short-term
    effects, both on the demand for citep:FGro12 and the price of
    wines citep:ALVi08,DNau10.  The major problems with their
    aggregation citep:AQua99,CPar15 and consistency
    citep:CSto10,Bodi17 create some doubts about their own interest to
    consumers citep:AJon13.  Ratings by experts, judges, or websites
    have also been shown to be significantly divergent from historical
    GIs for Bordeaux wines citep:TMut11, probably because of their
    fundamental differences.  Ratings are exogenous year-to-year
    sources of information and not directly comparable to more stable
    public GIs voluntarily put on wine labels by producers.  This
    observation introduces the tedious question of the endogenous
    adoption of quality disclosure for GIs, which is not a concern for
    expert review citep:HMDO99.  This could have unintended economic
    consequences, such as counter-signaling, in situations in which
    the certification is not adopted to signal the high quality of
    products citep:BZJL18.  This is probably not the case for GIs in
    Burgundy, because their economic citep:CLVi00,CFlo10,SNCS13 and
    historical citep:MSwi18 importance is such that, to the best of
    our knowledge, wine producers and sellers in the region comply
    with the GI requirements such as the compulsory indication of GIs
    as the main informational message on wine labels.

*** Literature certification                 :noheading:

    We finally decompose the informational content of GI designation
    from an original framework based on the law of total variance
    citep:BSwa12.  This allows to estimate the part of the vineyard
    quality index that is described by the vertical dimension of GIs,
    the part that is described by the horizontal part of GIs, and a
    noised part that is not described by GIs.  The application of this
    framework to our empirical results shows high informational
    content of both dimensions of actual GIs, with 4-times higher
    signal variance than noise variance (corresponding to an R$^2$ of
    $\sim$ 80%).  The vertical part of the GIs is found to be more
    informative than the horizontal part, even if we control for lobby
    effects.  In addition, applying the same signal decomposition on
    historical GIs from 1936 shows that the informational content of
    the vertical dimension has slightly increased in the last century,
    through continuous evolution of GI designation schemes by the
    French national institute in charge of geographical indications
    (INAO).  This historical increase of the informational content of
    GIs illustrates the theory developed by cite:BLar92 regarding
    strategic information transmission.  We found that some producers
    or landowners could have profited from private information on
    vineyard quality manipulating the GI signal and extracted rents
    through undeserved high rating for vineyards in their
    administrative units.  However, the hierarchical GI certification
    appears increasingly less biased on the long run, or more
    efficient in the sense of cite:DNab91; the probability that two
    identical vineyard plots in different /communes/ have the same
    classification is increasing.  We also found that a monopolistic
    certifying party discloses useful information in the form of rank
    orderings, as predicted by cite:Guer01.  This contrasts with
    models in the literature that found weak, if any, welfare gains
    associated with the information conveyed by a monopolistic
    certifying party citep:Shap86,Lizz99.  These two results suggest
    that the high informational content of GIs and their current
    economic importance in Burgundy come from their long history and
    independent management by INAO.

    # This administrative unit in France corresponds to the scale at
    # which collective actions and lobbying have been performed
    # historically, particularly the scale at which the syndicates
    # (groups of wine producers) were structured citep:Jacq09.

*** Outline                                  :noexport:

    The following Section [[#Sec:1]] presents in greater details the
    historical and regional contexts of the work, jointly with the
    data used.  Section [[#Sec:2]] presents the data generating process
    under consideration (also called the population structural model),
    the signal decomposition framework and the econometric strategy.
    Section [[#Sec:3]] presents the results and simulations for
    alternative GI designation schemes. Section [[#Sec:4]] concludes.

** Context and data
  :PROPERTIES:
  :CUSTOM_ID: Sec:1
  :END:

  First, we present the vineyards from the /Côte d'Or/ region under
  study.  Next, we present the historical evolution of GIs in this
  region, followed by a precise description of current GIs.  Finally,
  we provide some summary statistics on the data used here.

*** The /Côte d'Or/ region
   :PROPERTIES:
   :CUSTOM_ID: Sec:11
   :END:
**** Natural characteristics                 :noheading:

     The /Côte d'Or/ (literally, slope of gold) is a northeastern
     French administrative unit (/département/) included in the larger
     wine-producing region of Burgundy (\autoref{Fig:1}).  We studied
     a subset of the most famous vineyards in this region (named
     /Climats/ locally), which was granted World Heritage Status by
     UNESCO in 2015 (https://whc.unesco.org/fr/list/1425).  The area
     under consideration is a strip of approximately 65\nbsp{}km from
     the north to south and at most 5 km from east to west located
     between latitudes 46.9 and 47.3 and longitudes 4.7 and 5 (World
     Geodetic System 1984).  The main tangible attributes of vineyards
     in the area are illustrated by the distribution of elevation in
     the left panel of \autoref{Fig:1}.  The presence of /combes/ (dry
     valley) results in some rounded patterns with fine-scale
     variations in the typical topographical variables (elevation,
     slope and exposition) that are known to have some direct and
     indirect impacts on wine quality.  Firstly, elevation is expected
     to determine wine quality principally through its indirect
     correlation with temperatures and atmospheric outcomes.
     Temperatures during the growing season and harvest are major
     determinants of the grape maturity cycle, sugar content, and the
     structure of aromas. The latitude position of vineyards is also
     indirectly correlated with temperature along the north-south
     gradient.  Secondly, slope is expected to have both a direct
     effect through the drainage capacity of vineyard plots and an
     indirect effect through the correlated soil characteristics
     (steeper soils are generally older and thinner).  The longitude
     position of vineyards indirectly correlates with precipitation on
     the area, as a hill at the west provides a protective barrier
     that limits rains and, consequently, soil moisture.  Thirdly, the
     exposition is expected to have a direct effect through sunshine
     cycles and an indirect effect through its correlation with the
     wind, which is known to have strong importance for dry grapes and
     to concentrate aromas.  Note that we do not use climate data due
     to their typical coarse scale availability, which makes them
     unsuitable to the narrowness of our study area and the tiny size
     of vineyard plots.  For example, historical climate data from
     /Météo-France/ are usually available at 8 km resolution where the
     vineyard strip depicted in \autoref{Fig:1} is at most 5 km large.
     Moreover, topography (available at a 5 m resolution in our data)
     is regularly used to interpolate climate observations that
     artificially increase the resolution of climate variables.  Using
     such interpolations to control for climate variables are
     unappropriated to our econometric analysis as they produce a
     strong redundancy with raw topographic variables.
     
# Local particularity in terms of (i) temperature hail and frost. the
# region less precipitation than its neighbors (less than 700mm/ year,
# up to 1000mm/year). Although this northern position compared to
# other French vineyards such as Bordeaux and Rhône Valley high solar
# with about 1300 and 1400 hours of sun between April and September.

**** Map                                     :noheading:

# Peut-être faire apparaître si les communes contiennent une AOC communale.
#+begin_export latex
\vspace{.5cm}
\begin{figure}[!h]
  \caption{\textbf{Topography and geographical indications (GIs) of the vineyards of the \emph{Côte d'Or}}\\[.1cm]
    \footnotesize Notes: The elevation on the left side map is
    decretized in 8 classes of 50 m intervals.  From the east to the
    west, the elevation is first convex then concave, which means that
    the highest slopes are for average elevations.  GIs on the right
    side map are located on these highest slopes.  The spatial
    precision of the vertical dimension of GIs is such that best
    vineyards, classified as \emph{Grands Crus}, are not visually
    well-separated from just below \emph{Premiers Crus}.  The right
    panel also reports the names of the 31 \emph{communes} of the
    area, considered as the horizontal dimension of GIs.\vspace*{-.6cm}}\label{Fig:1}
  \centering\hspace{-2.5cm}
\begin{minipage}{.5\textwidth}
  \centering
 \includegraphics[scale= .4]{./Figures/MapCom1}
\end{minipage}%
\begin{minipage}{.5\textwidth}
  \centering
 \includegraphics[scale= .4]{./Figures/MapCom2}
\end{minipage}
\end{figure}
#+end_export

*** Historical context
**** Until Lavalle                           :noheading:

    Some archaeological evidence located the first vineyards in the
    region in antiquity citep:Garc14.  The first written evidence
    dated from the 7th century, with abbey archives describing the
    donation of vineyards between groups of Benedictine monks whose
    names are still used in actual GI classifications (e.g., /Abbayes
    de Bèze/ or /de Saint-Vivant/).  The origin of Burgundy's vineyard
    classification can be found in the work of the Cistercian monks
    who delineated plots of land that produced wine of distinct
    character (12th century according to citealp:Lava55).  However,
    the first exhaustive spatial delineation of the region was an
    administrative separation of /communes/ following the decree of
    1789 after the French revolution.  The delineation of /communes/
    was based on the spatial distribution of churches (usually built
    between the 9th and the 12th centuries), without the goal of
    signaling wine quality.  The first exhaustive vertical
    classification scheme of vineyard quality was created by
    cite:Lava55, a Professor of Natural and Medical History at Dijon
    University, inspired by the writings of other scientists,
    particularly cite:Jull16 and cite:More31.  He providesd a ranking
    of vineyards on four levels, from the best /Tête de Cuvée/ to
    /Première/, /Deuxième/ and /Troisième Cuvées/.  The interaction
    between the horizontal and vertical dimensions is of particular
    importance in his work: "I have studied the wines of each of the
    /communes/ of the /Côte/ as if the other /communes/ had not
    existed and the classification that I give is true only for each
    /commune/ taken in isolation" (p.162, translation from the
    author).

**** After Lavalle                           :noheading:

     These two spatial delineations were merged in an 1860 map by the
     /Comité d'Agriculture et de Viticulture de l'Arrondissement de
     Beaune/, the local organization of wine producers.  This map
     contains small modifications from the initial 1789 and 1855
     classifications citep:WJac18 and was used extensively as a legal
     basis to regulate wine trade in the region.  It paved the way for
     court trials, collective actions, and lobbying for the right to
     use the names of both dimensions that are not yet called GIs.
     The capacity of producers and owners to negotiate or influence
     judgments and delineations is determined by the reputation of the
     /commune/ to which they belong citep:Jacq09.  The author showed
     that there was unequal treatment between /communes/ in terms of
     the vertical differentiation of vineyards, whereas the separation
     between advantaged and disadvantaged /communes/ was not well
     established: "the reputation of the wine-growing /communes/ of
     Burgundy is not an objectively measurable phenomenon"
     (citealp:Jacq09, p.189; translation by the author).  In 1936, a
     French national institute, INAO, was created to legally manage
     what became the GIs of all wine regions of the country on a
     common legal basis.  In Burgundy, the first official GIs came
     from the map of 1860 and the jurisprudence occurring thereafter.
     Some modifications were then implemented during the 20th century
     with the creation of /Premiers Crus/ in 1943 and the fine-scale
     digitization of plot-level delineation in a Geographical
     Information System after 2000.  The GIs have been called
     /Appellation d'Origine Contrôlée/ in France since 1936,
     corresponding to Protected Designation of Origin for the European
     Union (https://ec.europa.eu/agriculture/quality/schemes_en).

*** Current GI designations
**** Description                             :noheading:

    Current GIs are a nest between a vertical quality ranking of five
    levels and a horizontal differentiation scheme through 31
    administrative municipalities (/communes/, \autoref{Fig:1}, right
    panel).  The highest quality vineyards are labeled /Grands Crus/,
    each of which has its own independent appellation name (e.g.,
    "/Clos de la Roche/" or "/Chevalier-Montrachet/").  There are 32
    /Grands Crus/ in the area, 8 in the /Côte de Beaune/ (southern
    part) and 24 in the /Côte de Nuits/ (northern part), with a total
    area of 472.6 ha (4.2% of acreage with GIs).  In the hierarchy, it
    follows 404 /Premiers Crus/ in the area that have to be associated
    with their /commune/ names on wine labels (e.g., "/Les Chaumes/"
    from /Vosne-Romanée/ or "/La Chapelle/" from /Auxey-Duresse/).
    There are $1619$ ha of /Premiers Crus/ in the /Côte de Beaune/,
    accounting for 20.5% of the sub-region and 433 ha in the /Côte de
    Nuits/ (12.75%).  The third vertical level corresponds to
    /Bourgogne Village/ with or without a name (e.g., /Pommard
    Village/ with name and /Côte de Nuits Village/ without),
    accounting for $2500$ ha (31.75%) in the /Côte de Beaune/ and
    $1563$ ha (46%) in the /Côte de Nuits/.  The vertical
    differentiation of GIs ends with /Bourgogne Régional/ ($2788$ ha,
    24.73% of the GI area) and /Coteaux Bourguignons/ ($1899$ ha,
    16.85%), which are sometimes grouped in the same /Régional/ level.
    
    # The difference between these last two GIs was justified
    # initially in terms of grape varieties (/Pinot noir/ or
    # /Chardonnay/ for /Bourgogne Régional/ and /Gamay noir/ or
    # /Aligoté/ for /Côteaux Bourguignons/), but this distinction is
    # less and less relevant as /Pinot noir/ and /Chardonnay/ become
    # the main varieties.

**** Confusion                               :noheading:

    The picture of current GIs in the area is not complete without
    mentioning of the complexities that exist between the vertical and
    horizontal dimensions, which could lead to difficulties for
    consumers distinguishing their respective informational content.
    Note that the terms /commune/ and /village/ are often used
    synonymously for the administrative delineations in rural areas of
    France, whereas the first is related to the horizontal dimension
    and the second to the vertical dimension.  In addition, the same
    name as a vertical levels from /Grand Cru/, /Premier Cru/ or even
    /Villages/ can be found in two different /communes/: the /Grand
    Cru/ /Bonnes Mares/ is shared between the /communes/ of
    /Chambolle-Musigny/ and /Morey-Saint-Denis/, the /Fixin Premier
    Cru/ /Clos de la Perrière/ is shared between the /communes/ of
    /Brochon/ and /Fixin/, and the /Vosnes-Romanée/ /Village/ is
    shared between the /communes/ of /Vosnes-Romanée/ and
    /Flagey-Echézeaux/.  Furthermore, at the beginning of the 20th
    century, 10 /communes/ added the name of their most famous /Grand
    Cru/ to their administrative name, such as /Aloxe-Corton/ or
    /Gevrey-Chambertin/.  Consequently, the name of a /Grand Cru/ is
    labeled in the horizontal information for wines that are not
    /Grand Cru/.  This complexity reaches its maximum in the two
    /communes/ of /Chassagne-Montrachet/ and /Puligny-Montrachet/,
    which share /Grand Cru/ /Montrachet/ and have chosen to add it to
    their administrative names.  However, the legal obligation to
    mention the vertical level /Grand Cru/, /Premier Cru/, /Village/,
    /Régional/ or /Coteaux Bourguignons/ as the main information on
    wine bottle labels suggests that this information is clearly
    identifiable by consumers.

*** Summary Statistics
**** Particularities                         :noheading:

     The precision of econometric estimations for disentangling the
     sources of variation in GIs depends on a balanced distribution of
     tangible variables and vertical levels between and within the
     horizontal /commune/ items.  The left panel of \autoref{Fig:1}
     shows that each /commune/ approximately contains the whole range
     of elevation, slope, and exposition of the area, whereas the
     right panel shows that administrative delineations of /communes/
     articulate with each other on the north-south gradient, which
     ensures sharp climatic differences between them.
     \autoref{Fig:A0} in the Appendix presents the acreages and shares
     of each vertical level for each horizontal /commune/.  Every
     /commune/ has at least two of the five possible vertical levels.
     The majority of /communes/ count three different vertical levels,
     with an average number of 3.87 levels per /commune/.  Vineyards
     ranked as /Village/, /Premier Cru/ and /Grand Cru/ are present in
     28, 24, and 11 /communes/ accounting for 90%, 77.4%, and 35.5% of
     all of them, respectively.

**** Variable description                    :noheading:

     \autoref{Tab:SD} in the Appendix presents the summary
     statistics about the exhaustive plot-level data that we use on
     the 31 /communes/ of the region.  For approximately $60\,000$
     vineyard plots of a tiny average size of 0.2 ha ($\sim$ 0.5
     acres), the elevation is distributed between 200 and 500 m, with
     an average of 286 m.  Slopes are an average 5.73 degrees wit high
     standard deviation (the coefficient of variation is $\sim$ 100%).
     The solar radiation is distributed from 0.58 to 1.23 million
     Joules, with an average of 1.05 million J.  To add flexibility to
     the econometric estimations, the exposition variable is
     discretized in eight dummy variables for different
     semi-quadrants, which shows that more than 50% of vineyard plots
     have a south-eastern exposition, between 90 and 180 degrees.
     \autoref{Tab:SD} also shows the current distribution of the
     vertical dimensions of GIs and the distribution in 1936 when the
     INAO was created.  We also use additional geological and
     pedological variables as fixed effects to control for sub-soil
     and soil characteristics.  Because such variables are not central
     in the empirical strategy that we propose, we do not report them
     here.  Interested readers can access these variables through the
     Replication Material (RM) from the link on the title page of this
     article.

** Model of GI designation
   :PROPERTIES:
   :CUSTOM_ID: Sec:2
   :END:

   First, we present the structural model of GI designation that is
   assumed to be the data-generating process.  Next, we discuss the
   empirical challenge of separating the /terroir/ effects from the
   intangible influences and the specification procedure that we
   propose.  Finally, we describe the decomposition of the vineyard
   quality signal from the GI information available to consumers.

*** Structure of GIs
**** Latent structure of quality             :noheading:

    The fine-scale variation of natural characteristics (i.e.,
    /terroir/) between vineyard plots is the basis of the GI
    classification scheme.  The vineyard quality index is assumed to
    be an unknown function $q:\mathbb{R}^{K^*}\mapsto\mathbb{R}$ of
    the $K^*$ natural characteristics $X^*$ of each vineyard plot.
    From this scalar quality, GIs are designated through a continuous
    latent variable $y^*$ defined as the sum between the quality index
    and idiosyncratic random designation noise noted $\xi$ such that:
#+begin_export latex
\begin{equation}
y^*= q(X^*)+ \xi.
\end{equation}
#+end_export
    The mapping between tangible /terroir/ characteristics $X^*$ and
    the vineyard quality index represents the cumulative knowledge
    from informed people that have contributed to the vineyard
    classification throughout history.  At this stage, we consider the
    latent variable as an unbiased, though imperfect because of
    designation noise, signal of the quality of vineyards with
    $\mathbb{E}(\xi\mid X^*)=0$.  The designation noise could be
    attributed to imperfect knowledge or anecdotal facts that cause
    random deviations around the quality signal.  The presence of
    designation noise is more generally due to the absence of a
    deterministic rule between vineyard characteristics and GIs; thus,
    the orthogonality between the designation noise and $X^*$ is more
    a definition than an assumption.  Determining the correlation
    between this quality signal and consumer preferences about wines
    and the related question of the value of GI information would
    require economic data about wine prices or consumer' surveys that
    we did not have here.  Instead, we evaluated the relevance of the
    GI information according to this long-term quality signal which is
    different than evaluating the relevance of the quality signal
    itself.  The ordered structure of the vertical dimension of GIs
    explains our reference to vineyard quality.

**** Dimensions of GIs                       :noheading:

     The hierarchical structure of GIs is modeled through the
     multi-valued scalar $y \in \{ 1, \dots, 5\}$ that represents the
     vertical differentiation of GIs: /Côteaux Bourguignons/ <
     /Bourgogne Régional/ < /Bourgogne Village/ < /Premier Cru/ <
     /Grand Cru/.  The GI of a given vineyard plot is a crude
     measurement of the underlying latent variable through a
     threshold-crossing relationship:
#+begin_export latex
\begin{equation}
y= j \;\;\;\mbox{ $\Leftrightarrow$ }\;\;\; \alpha^{c}_{j-1}< y^*< \alpha^{c}_{j},\;\;\;\mbox{ for }\;\;\; j= 1, \dots, 5,\label{Eq:STR}
\end{equation}
#+end_export
     where $\alpha_0^c= -\infty < \alpha_1^c< \cdots < \alpha_5^c=
     +\infty$ for all /commune/ $c\in\{1, \dots, 31\}$ by
     construction.  The exponent $c$ on the thresholds marks the
     /commune/ in which the vineyard is located among the 31
     /communes/ of the area under consideration, and represents the
     horizontal dimension of GIs by municipality-specific thresholds.
     The variation in the thresholds between /communes/ corresponds to
     the differential treatments that have been documented by
     historians and presented above.  For example, a /commune/ $c_1$
     receives preferential treatment in terms of /Premier Cru/ ($j=4$)
     if its corresponding thresholds are smaller than those of another
     given /commune/ $c_2$: $\alpha^{c_1}_{3}< \alpha^{c_2}_{3}$ and
     $\alpha^{c_1}_{4}< \alpha^{c_2}_{4}$.  This means that the
     quality requirements for /Premier Cru/ of the /commune/ $c_1$ are
     less stringent and, consequently, the average quality is smaller:
     $\mathbb{E}(y^*\mid y= 4, c= c_1)< \mathbb{E}(y^*\mid y= 4, c=
     c_2)$.@@latex:\footnote{The link with average quality from this
     last inequality requires the addtional assumption that
     $\mathbb{E}(\xi\mid X^*, C)= 0$, i.e., that the random part of
     the latent variable is unrelated between \emph{communes}.  We
     make this assumption in the rest of the article, which has the
     same rationale as the orthogonality of designation noise in
     regard to \emph{terroir} variables presented above and even
     implies it by the law of iterated expectations:
     $\mathbb{E}(\xi\mid X^*)= \mathbb{E}[\mathbb{E}(\xi\mid X^*,
     C)\mid X^*]=0$.}@@

**** Efficient case                          :noheading:

     Within a given /commune/, the ordered structure of GIs provides
     an efficient certification process as defined by cite:DNab91; the
     probability that a vineyard is classified into at least its own
     quality category is higher than the probability that another
     vineyard with lower quality will be classified into at least that
     category.  For two vineyard plots, $1$ and $2$, with
     differentiated tangible characteristics such that $q(X_1^*)>
     q(X_2^*)$ and located within the same /commune/ $c_0$, one can
     show that $\mbox{Prob}(y_{1}\geqslant j)>
     \mbox{Prob}(y_{2}\geqslant j)$ for all $j$ because:
#+begin_export latex
\begin{equation}
\mbox{Prob}(y_{i}\geqslant j)= F\left[q(X_i^*)- \alpha_{j-1}^{c_0}\right],
           \;\;\;\mbox{ for }\;\;\; i= 1, 2.\label{eq:SM}
\end{equation}
#+end_export
     where $F$ is the strictly increasing cumulative distribution
     function of $-\xi$.  The efficiency of the GI designation scheme
     is also verified in the absence of threshold variations between
     /communes/ (i.e., if $\alpha_j^c$ is constant among $c$ for each
     $j$), which is equivalent to lack of bias in the GI signal.

**** Ordinal superiority                     :noheading:

     The efficiency property and absence of bias are no longer true
     for vineyard plots located in different /communes/, say $c_1$ and
     $c_2$ to continue with the same example.  The lesser quality
     vineyard plot $2$ has a higher probability of being classified at
     least $j_1$ (the GI quality level of vineyard $1$) if
     $\alpha_{j_1}^{c_2}- \alpha_{j_1}^{c_1}> q(X_1^*)- q(X_2^*)$.  In
     this case, the preferential treatment given to /commune/ $c_2$ is
     a source of bias in the GI classification that contradicts the
     efficiency of the vertical GI differentiation
     ($\alpha_{j_1}^{c_2}> \alpha_{j_1}^{c_1}$ is a necessary
     condition to have a higher probability for the vineyard plot $2$
     compared to $1$).  In particular, the probability that another
     given plot from another /commune/ (e.g., plot 3 from /commune/
     $c_3$) of the same quality as plot 1 but higher in the GI
     classification scheme is equal to the ordinal superiority measure
     defined by cite:AKat17:
#+begin_export latex
\begin{equation}
\gamma^{j_1}_{3\mid 1}\equiv \mbox{Prob}(y_{3}> y_{1}\mid X^*_1)\approx F\left(\frac{\alpha_{j_1}^{c_3}- \alpha_{j_1}^{c_1}}{\sqrt{2}}\right).\label{Eq:OS}
\end{equation}
#+end_export
     We use the approximation that the cdf of the normalized
     difference between designation noises is equal to the marginal
     cdf; this approximation is exact in the case of a Gaussian
     distribution.  This measure of ordinal superiority determines the
     bias in the GI designation independently of the conditioning
     tangible characteristics $X^*_1$ of vineyard plots.  This allows
     a direct comparison between the horizontal dimension $c$ of GIs
     for each vertical level $j$.  For a given /commune/ of reference
     (e.g., $c_1$ in \autoref{Eq:OS}), this implies $30 \times 5= 150$
     measures of ordinal superiority.  Therefore, we assume an
     additive separability between the horizontal and vertical
     intercepts to simplify the comparison, $\alpha^c_{j}= \alpha_{j}-
     \mu_c$.  The ordinal superiority measure between two identical
     plots located in given /communes/ A and B becomes $\gamma_{A\mid
     B}= F\left[(\mu_{c_B}- \mu_{c_A})/ \sqrt{2}\right]$ regardless of
     $j$, which allows the number of ordinal superiority measures to
     be divided by 5.  The resulting 30 statistics provide objective
     measures of the differential treatments that have been applied
     between /communes/ according to the GI vertical classification of
     their vineyards.  The presence of significant ordinal superiority
     measures indicates some significant bias in the GI signal, and
     the ordinal superiority measures estimate the size.

*** Ordered Generalized Additive Model
**** General                                 :noheading:

     The estimation of the unknown function $q(\cdot)$ that relates
     tangible attributes of vineyards to the vineyard quality index is
     subject to two empirical challenges that we consider jointly: the
     specification of the functional form for the effect of a given
     tangible variable $x_k$ and the presence of unobserved /terroir/
     variables that impact vineyard quality.  These unobserved effects
     for the econometrician are taken into account in GI designations
     by observations in the field because they are known by people
     involved in GI designations.  This is a serious econometric
     concern due to the potential confounding effect that such
     variables could have through their spurious correlations with
     /commune/ delineations that group together adjacent vineyard
     plots.  Identifying the information conveyed by GIs about
     tangible variables requires that all of these /terroir/ variables
     be observable, which is unfortunately not the case, and probably
     never will be.  Instead, we propose estimating an Ordered
     Generalized Additive Model (OGAM, citealp:WPSa16,Wood17;
     citealp:KWan03,LVEP15 for econometric applications) that allows a
     semiparametric specification of the effect of each observed
     tangible variable and to control for omitted /terroir/ variables
     through bivariate smoothing of geographic coordinates.  This
     identification strategy is based on the definition of /terroir/
     as the full set of natural variables that impact vineyard quality
     index.  As they originate from natural processes citep:PCad95, we
     consider them as spatially continuous according to the axiom that
     nature makes no jumps, in contrast to the discontinuities
     introduced by administrative delineations of /communes/ related
     to intangible human determinants of GIs.

**** Reduced form                            :noheading:

     Consider that we only observe the realizations of a subset $X_i
     \subset X_i^*$ of all /terroir/ variables that are taken into
     account in the GI designation scheme for a given vineyard plot
     $i= 1, \dots, N$.  These observed tangible variables are
     elevation, slope, exposition, solar radiation, geology, pedology
     and geographic coordinates.  By noting $C_i$ the row vector of
     dimension 31, with the typical element $c_{ih}$ equal to 1 if
     vineyard $i$ is located in /commune/ $h$ and zero otherwise, the
     specification of a logistic distribution for the reduced-form
     errors leads to a classical parametric ordered logit model that
     can be estimated by maximum likelihood:
#+begin_export latex
\begin{equation}
\mbox{Prob}(y_{i}> j\mid X_i, C_i)= \Lambda\big[ B(X_i)^\top\beta+ C_i^\top\mu- \alpha_{j}\big],\label{Eq:Mod}
\end{equation}
#+end_export
     where $\Lambda$ is the logistic cdf.  The intangible determinants
     that impact GIs through varying designation thresholds, noted
     $\mu_c$ previously, are taken into account by the dummy variables
     $C_i$ which work as /commune/ fixed effects.  In the absence of
     theoretical priors for the effects of all observed tangible
     variables $X_i$, we specify them through a series of functional
     transformations noted as $B(\cdot)$ with an associated vector of
     coefficients $\beta$.  From an initial set of $K$ observed
     tangible variables (with $K<K^*$), the series and vector of
     coefficients are of dimension $\widetilde{K}= \sum\nolimits_k
     L_k$, where $L_k$ is the number of transformations used to
     specify the effect of each variable $x_k$.  For example, a
     second-order polynomial specification for all observed tangible
     variables is noted $B(X_i)= [x_{1i}\; x_{1i}^2\; x_{2i} \;
     x_{2i}^2 \; \cdots \; x_{Ki} \; x_{Ki}^2]$ with a set of
     $\widetilde{K}= 2\times K$ coefficients to estimate.

**** Method of estimation                    :noheading:

     The results presented below will show that polynomial
     specifications have limited performance in accounting for the
     complex interactions between natural characteristics of vineyards
     and the continuous quality index used in GI designations.  Thus,
     we turned to semiparametric thin plate regression splines that
     have optimal smooth approximation properties citep:Wood17.  The
     matrix $B(X)$ is specified through additive low rank isotropic
     smoothers of the individual tangible variables $x_k$.  The cost
     of this additional flexibility is the need to estimate jointly a
     smoothing parameter that controls the penalization of the
     overfit.  Accordingly, the complexity of the spline
     transformations is determined endogenously for a given maximum
     basis reduction for each variable through a quadratic penalty.
     The penalized deviance is minimized by penalized iterated
     weighted least squares and the smoothing parameter is estimated
     using a separate criterion from the restricted maximum likelihood
     framework.  The computational details are given in cite:WPSa16.
     The complexity of the effect of a given variable or of the whole
     model can be assessed by the effective degrees of freedom that
     account for the endogenous penalization of any given dimension
     reduction (citealp:Wood17, p.273).  The most sensible point is
     the estimation of the smoothing parameter which is a source of
     additional uncertainty, whereas cite:WPSa16 provide some
     corrections for inference and traditional goodness of fit
     measures, such as Akaike Information Criteria (AIC).
     Unfortunately, goodness of fit measures give little guidance
     about the causal inference of /communes/ effects that measure the
     intangible effects that bias the GI signal.  We propose to
     determine the sufficient level of spatial smoothing with an
     heuristic procedure based on auxiliary regressions and surrogate
     residuals recently defined by cite:LZha18, Appendix A.1 presents
     the procedure in more details.

     # In practice then, choice of basis dimension has to remain a part
     # of model specification. But it is important to note that all the
     # choice is doing is to set an upper limit on the flexibility of a
     # term: the actual flexibility is controlled by the smoothing
     # parameters. Hence, provided that we do not make the basis
     # dimension too restrictively small, its exact value should have
     # only a small effect on the fitted model. However, there is one
     # subtle caveat: a function space with basis dimension 20 will
     # contain a larger space of functions with EDF 5 than will a
     # function space of dimension 10 (the numbers being arbitrary), so
     # that model fit tends to retain some sensitivity to basis
     # dimension, even if the appropriate EDF for a term is well below
     # its basis dimension? To choose basis dimension, test of residuals
     # as we propose here.

*** Informational content
**** General decomposition                   :noheading:

     The formal analysis that we develop about the informational
     content of GIs is based on the framework of cite:GPen10 for
     information signal ordering, in addition to the variance
     decomposition formulas provided by cite:BSwa12.  We consider GIs
     as an information structure, i.e., a joint distribution between
     the states of the world (vineyard quality index) and the GIs.  We
     propose evaluating the extend to which the observation of $y$ and
     $c$ allows consumers to recover vineyard quality, assuming that a
     more informative signal leads to a more dispersed distribution of
     conditional expectations.  Contrary to cite:GPen10, we measure
     the dispersion through conditional variance of the signals, this
     leads to four nested variance decomposition:
#+begin_export latex
\begin{align}
\mbox{\emph{Total decomposition :} }& \mathbb{V}(y^*)= \mathbb{V}[q(X^*)]+ \mathbb{V}[\xi]  \label{eq:dec1}\\
\mbox{\emph{Joint decomposition :} }& \mathbb{V}[q(X^*)]= \mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y, c]\,\big\}
                                                          + \mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y, c]\,\big\} \label{eq:dec2}\\
\mbox{\emph{Vertical decomposition :} }& \mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y, c]\,\big\}=
                                                          \mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y]\,\big\}
			                                + \mathbb{E}\big\{\,\mathbb{V}[\mathbb{E}(q(X^*)\mid y, c)\mid y]\,\big\} \label{eq:dec3}\\
\mbox{\emph{Horizontal decomposition :} }& \mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y, c]\,\big\}=
                                                          \mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid c]\,\big\}
                                                        + \mathbb{E}\big\{\,\mathbb{V}[\mathbb{E}(q(X^*)\mid y, c)\mid c]\,\big\} \label{eq:dec4}
\end{align}
#+end_export

     The /total decomposition/ in \autoref{eq:dec1} comes from the law
     of total variance, the law of iterated expectations, and the
     definition of designation errors by $\mathbb{E}(\xi\mid X^*)=0$.
     It presents the variance of the latent variable as the sum of a
     /signal variance/ and a /noise variance/ defined from the
     data-generating process.  The signal to noise ratio
     $\mathbb{V}[q(X^*)]/\mathbb{V}[\xi]$ gives the proportion of
     relevant information conveyed by the continuous quality grade
     $q(X^*)$ in terms of the irrelevant information from noise $\xi$.
     This decomposition represents the maximum informational content
     that any GI signal can achieve for the data-generating process
     under consideration.  This corresponds to the case in which the
     continuous quality grade is conveyed to consumers as a continuous
     score on wine labels.

**** Joint decomposition                     :noheading:

     The /joint decomposition/ in \autoref{eq:dec2} comes from the law
     of total variance applied to the continuous quality grade
     citep:BSwa12.  It disentangles the part of the signal that is
     conveyed jointly by the vertical and horizontal dimensions of GIs
     (the /joint signal/, which is the variance of the expectation)
     and the part that is lost due to the discretization of the
     continuous quality information (the /joint noise/, which is the
     expectation of the variance).  If the continuous quality grade
     $q(X^*)$ was observable, the share of the /joint signal/ in the
     /total signal/ would be the R$^2$ of the regression of $q(X^*)$
     on the full set of dummy variables from $y$ and $c$.  

     # According to the nested structure of the /total/ and /joint/
     # decomposition, we define the /joint informational content/ of
     # horizontal and vertical dimensions of GIs as
     # $\mathbb{V}\big\{\,\mathbb{E}[q(X^*)\mid y, c]\,\big\}/
     # \big(\mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y, c]\,\big\}+
     # \mathbb{V}[\xi]\big)$.  This statistic measures the share of the
     # quality information that is conveyed to consumers through both
     # dimensions of GIs.

**** Vertical decomposition                  :noheading:

     The /vertical decomposition/ in \autoref{eq:dec3} separates the
     /joint signal/ into the part that is conveyed through the
     vertical dimension of GIs (the /vertical signal/, the variance of
     the expectation) and the residual part that remains for the
     horizontal dimension (the /vertical residual/).  The first term
     represents the variance of the quality information that can be
     assessed by consumers only through the vertical dimension $y$ of
     GIs.  Consumers may choose to favor this dimension by choice
     based on their experience or they can have a limited cognitive
     ability in understanding the full complexities of GIs.  An
     important point is that, in the absence of preferential treatment
     between /communes/ in the GI designation scheme, the residual
     part of this decomposition would be zero.  In such a case, the
     vertical dimension would be unbiased and provide all of the
     relevant information about quality available to consumers.  The
     only loss in information would be due to the discretization of
     the continuous quality index and the /joint signal/ would be
     equal to the /vertical signal/.

#      We also propose defining /vertical noise/ as the sum of
#      the /vertical residual/ and the /joint noise/.  This corresponds
#      to the information loss of using only the vertical dimension:
# #+begin_export latex
# \begin{align}
# \mbox{\emph{Vertical noise :} }& \mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y]\,\big\}=
# \mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y, c]\,\big\}+\mathbb{E}\big\{\,\mathbb{V}[\mathbb{E}(q(X^*)\mid y, c)\mid y]\big\}
# \end{align}
# #+end_export

**** Horizontal decomposition                :noheading:

     The /horizontal decomposition/ in \autoref{eq:dec4} is symmetric
     to vertical decomposition, as it defines a /horizontal signal/
     and a /horizontal residual/.  This means that decomposition of
     the /joint signal/ between a /vertical/ and /horizontal/ part is
     non-unique, depending on the GI dimension that is privileged.
     The first /horizontal signal/ measures the dispersion of the
     expectation of vineyard quality conditionally on the /commune/ of
     the vineyards.  This informational content is due both to the
     incidental spatial correlation between vineyard quality and
     /commune/ delineations, and to the historical factors that have
     made GI thresholds dependent on the /communes/.  In the absence
     of any preferential treatment of certain /communes/, this signal
     is reliable, as it indicates that some /communes/ have better
     tangible conditions to make wines of better quality.  Thus, the
     residual part of the decomposition is the marginal gain of using
     the vertical dimension of GIs for consumers that rely only on the
     horizontal dimension.  

#      Finally, we also define the /horizontal
#      noise/ as the sum of the /joint noise/ and the /horizontal
#      residual/, and it corresponds to the loss in GI signal when using
#      only the horizontal dimension of GIs:
# #+begin_export latex
# \begin{align}
# \mbox{\emph{Horizontal noise :} }& \mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid c]\,\big\}=
#      \mathbb{E}\big\{\,\mathbb{V}[\mathbb{E}(q(X^*)\mid y, c)\mid c]+
#      \mathbb{E}\big\{\,\mathbb{V}[q(X^*)\mid y, c]\,\big\}
# \end{align}
# #+end_export

** Results
   :PROPERTIES:
   :CUSTOM_ID: Sec:3
   :END:
*** Models of GI designation
**** Text 1                                  :noheading:

    The first column ( 0 ) of \autoref{Tab:1} reports the joint
    significance statistics from a standard ordered logit model with
    quadratic effects for the three topographic variables, third-order
    polynomials with full interactions for spatial coordinates, and
    pedology, geology, exposition and /commune/ fixed effects.  The
    reported $\chi^2$ statistics are equivalent to F-statistics for
    models with discrete outcomes.  The tests indicate that all
    variables are significant at the 1% level, for an overall
    pseudo-R$^2$ of 36.7%.  The most significant series of variables
    is the set of 31 /commune/ dummies that represent the intangible
    determinants of lobbying effects on GI designations.  This set is
    closely followed by the pedology fixed effects and the polynomial
    transformation of spatial coordinates that controls for the
    effects of the longitude and latitude positions of vineyards.
    Elevation, solar radiation, geology, exposition and slope
    variables follow in decreasing order of joint significance, for an
    overall significance that is slightly higher for tangible
    variables than intangible variables.  The non-linear effects of
    the three topographical variables on the latent quality index are
    reported in \autoref{Fig:A1} of the Appendix.  Elevation and slope
    variables have inverted-U effects, with the highest vineyard
    quality at about 290 meters and 10 degrees.  The effect of solar
    radiation linearly increases and southern exposition provides the
    highest marginal probability of a high GI classification (see the
    Replication Material, RM p.14, from the link on the title page of
    this article).  The top-left panel of \autoref{Fig:A2} in the
    Appendix shows the marginal effects of spatial coordinates on the
    latent index.  The third-order parametric specification with full
    interactions produces some smooth ellipsoidal patterns with two
    central kernels that describe a core-periphery structure.  The
    coefficients estimated from /communes/ fixed effects are
    interpreted in the next subsection in terms of ordinal
    superiority.

**** Table                                   :noheading:

#+begin_export latex
\begin{table}[!htb]
\caption{\textbf{Joint Variable Significance for Ordered Logit Models of Current GI Designations}}\singlespacing
\newcolumntype{Y}{>{\centering\arraybackslash}X}\label{Tab:1}  \vspace{-.5cm}
\begin{threeparttable}
\input{Tables/VarSign1.tex}
\begin{tablenotes}\footnotesize
\item Notes: $^{**} p< 0.001$ for joint significance tests from the
  reported chi-square statistics, effective degrees of freedom are in
  brackets.  Column ( 0 ) corresponds to an ordered logit model with
  quadratic effects for elevation, slope and solar radiation (df$= 2$)
  with a full interaction between third-orders polynomials for
  longitude and latitude (df$= 3+3+3\times 3= 15$) and with 13, 14, 7
  and 31 dummy variables for pedology, geology, exposition, and
  \emph{communes} fixed effects, respectively.  Models ( I ) to ( V )
  are OGAMs with elevation, slope and solar radiation additively
  specified with a maximum of 9 edf, shrinked endogenously by a
  quadratic penalization.  Spatial coordinates are specified in
  increasing order of complexity with the maximum edf of 100, 300,
  500, 700 and 900.  The last row reports the bootstraped F-statistics
  for the joint nullity of \emph{commune} effects on residuals from
  auxiliary regressions without \emph{commune} dummies.
\end{tablenotes}
\end{threeparttable}
\end{table}
#+end_export

**** Text 2                                  :noheading:

     Columns ( I ) to ( V ) in \autoref{Tab:1} report the same
     significance statistics from OGAMs with increasing complexity in
     the spatial smoothing terms from left to right, as it appears
     from the effective degrees of freedom for spatial coordinates.
     The semiparametric structure of these models keeps the same
     degrees of freedom for pedology, geology, exposition and
     /commune/ fixed effects with 13, 14, 7 and 31 degrees,
     respectively.  Increasing the complexity of the spline series of
     spatial coordinates increases the pseudo-R$^2$ to 75% and the
     percent of good predictions to 90% in the most complex OGAM
     reported in the last column ( V ).  Simultaneously, the joint
     significance of spatial coordinates increases and the
     significance of all other explanatory variables decreases, except
     slope and exposition variables, for which the decrease of
     significance is not monotone.  As expected, the spatial patterns
     of GI designations are increasingly grasped by spatial
     coordinates at the expense of other explanatory variables.
     \autoref{Fig:A1} in the Appendix shows the comparative advantage
     of OGAMs over parametric model ( 0 ) in estimating the marginal
     effects of each explanatory variable.  Panel A of
     \autoref{Fig:A1} shows that the strong effect of elevation in the
     0-300 m range is not found in the parametric model, Panel B shows
     the same result for slope on the 0-5 degrees range.  These
     results are particularly stringent as these ranges concentrate
     the majority of vineyard plots.  In terms of spatial smooth
     effects reported in \autoref{Fig:A2} of Appendix, OGAMs produce
     more detailed spatial variations than the broad ellipsoid pattern
     from the parametric model ( 0 ).  This suggests some fine-scale
     spatial variations in the latent quality index according to GI
     designation scheme.  The significance of /commune/ fixed effects
     decreases sharply by increasing the complexity of spatial
     smoothing, whereas it remains the second most important set of
     variable in the model ( V ).

*** Ordinal superiority of /communes/
**** Text 1                                  :noheading:

     The last row of \autoref{Tab:1} reports the bootstrapped
     F-statistics for the joint significance of /commune/ dummies on
     surrogate residuals from auxiliary models that do not account for
     such fixed effects (see Appendix A.1).  \autoref{Fig:A2a} in the
     Appendix shows the relevance of smoothing spatial coordinates to
     control for unobserved /terroir/ variables and improve the causal
     inference about /commune/ effects.  Initially, it appears that
     OGAMs allow to decreasing significantly the correlation between
     auxiliary residuals and /commune/ effects, compared to the
     parametric ordered logistic model ( 0 ).  A maximum effective
     degrees of freedom of approximately 700, which corresponds to
     model ( IV ) in \autoref{Tab:1}, is a sufficient complexity level
     to rule out potentially correlated omitted /terroir/ effects, as
     the insignificance of /commune/ dummies on the surrogate
     residuals from the auxiliary regressions cannot be rejected
     according to the median of the bootstrapped F-statistics.  The
     fact that /commune/ effects remain significant in model ( IV )
     and ( V ) of \autoref{Tab:1} indicates persistent effects of
     intangible lobbying effects from political bargaining about the
     GI designation scheme, even for precisely controlled /terroir/
     effects.  Similar vineyard plots from one side or another of
     administrative borders have significantly different probabilities
     of being in different vertical levels of GIs.

**** Figure                                  :noheading:

#+begin_export latex
\vspace{.5cm}
\begin{figure}[h]
  \caption{\textbf{Ordinal Superiorty Measures for the Current GI
      Designation Scheme} \\[.1cm]
    \footnotesize Notes: For a given \emph{commune} on the y-axis,
    ordinal superiority measures are computed as the difference
    between the estimated fixed effect $\mu_c$ and the average fixed
    effect $\overline{\mu}$ of all \emph{commune} according to:
    $\Delta_{c}= 2\times \Lambda[(\mu_{c}-\overline{\mu})/
    \sqrt{2}]-1$.  The horizontal bars represent the range of measures
    according to the OGAMs with 700, 800 and 900 maximum edf for the
    effects of spatial coordinates.  Black dots represent the average
    of these measures.  Relatively privilegied \emph{communes} appear
    at the top of the y-axis, whereas relatively disadvantged
    \emph{communes} appear at the bottom.}\label{Fig:2}
  \centering\vspace*{-.75cm}\hspace*{-.5cm} \includegraphics[scale=
  .75]{./Figures/ComEff.pdf}
\end{figure}
#+end_export

**** Text 2                                  :noheading:

     Ordinal superiority measures computed from OGAMs with 700, 800
     and 900 maximum edf are reported in \autoref{Fig:2}.  A positive
     measure indicates that the /commune/ is advantaged relatively to
     the average /commune/ citep:AKat17.  We see that only vineyard
     plots from four /communes/ are not differently designated from
     the average /commune/ of the area.  /Communes/ from the /Côte de
     Nuits/ in the north of the region are, on average, more
     advantaged than those of the /Côte de Beaune/ in the south, as
     eight /communes/ from this part of the region are among the 12
     most advantaged.  The proximity to Dijon, where trials of the use
     of vineyard names occurred between 1860 and 1936, is one
     potential explanation for this result, as well as the fact that
     it was usual that influential people living in Dijon own some
     vineyards in the /Côte de Nuits/, closer to Dijon than /Côte de
     Beaune/ (citealp:WJac18, see \autoref{Fig:1} for the location of
     Dijon).  The /communes/ that have a syndicate engaged in
     collective action appear to be privileged, but the separation is
     not clear-cut.@@latex:\footnote{\citealt{Jacq09} (p.189, 211)
     reports that the \emph{communes} of \emph{Vougeot},
     \emph{Aloxe-Corton}, \emph{Ladoix-Serrigny},
     \emph{Gevrey-Chambertin}, \emph{Vosne-Romanée} and
     \emph{Santenay} had the first syndicates, with some internal
     conflicts for \emph{Santenay}.}@@ This hierarchy of advantaged
     and disadvantaged /communes/ from current GI designation scheme
     is not significantly correlated with the average vertical level
     of the vineyards, as some advantaged /communes/ do not have
     vineyards of high level on average (/Ladoix-Serrigny/ and
     /Chorey-les-Beaune/), and some /communes/ with high level
     vineyards are disadvantaged by the designation scheme
     (/Flagey-Echezeaux/ and /Pommard/).  We found that the ordinal
     superiority measures only weakly positively correlated with
     average levels of current GIs ($R^2= 0.06$, $t= 1.27$, see
     \autoref{Fig:A2b} in the Appendix).

*** Informational content of current GIs
**** Text 1                                  :noheading:
    
     \autoref{Tab:2} reports the decomposition computed from equations
     (\ref{eq:dec1}) to (\ref{eq:dec4}) with $q(X_i^*)$ predicted from
     the five OGAMs ( I ) to ( V ) reported in \autoref{Tab:1}.  The
     empirical formulas used to compute the different terms are
     reported in RM p.37, jointly with the R code used.  As expected,
     the total signal shares reported in the first row of
     \autoref{Tab:2} increases from left to right and the total noise
     decreases.@@latex:\footnote{As the variance of errors is
     normalized to identify ordered models and the variance of $y^*$
     from the data-generating process is constant between models, the
     increase in the total signal and the decrease in total noise are
     two sides of the same coin, as they come from the increase in the
     variance of the latent quality index predicted by tangible
     variables.}@@ In contrast to this monotonic relationship between
     the total signal and the complexity of the spatial smoothing
     terms, the results from joint, vertical, and horizontal
     decomposition are more stable between specifications.  For all
     models, the vertical and horizontal dimensions of GIs have high
     joint information content.  From the last column of
     \autoref{Tab:2}, the joint signal of approximately 78% is 4-times
     higher than the joint noise of 19%.  The vertical dimension has
     higher informational content than the horizontal dimension, with
     a signal to noise ratio of 2 ($65/32$) compared to 0.33
     ($24/73$).  The horizontal residual, which represents the
     marginal informational content of the vertical dimension after
     the horizontal dimension is fully taken into account, is higher
     than the horizontal signal when only using the horizontal
     dimension.  This result reinforces the superiority of the
     vertical dimension to convey quality information, though the
     dimension of the signal is lower (5 levels instead of 31 items).
     From the vertical residual terms (i.e., sixth row), we see that
     the vertical dimension of GIs has approximately 20% ($13/65$)
     bias in conveying information about vineyard quality, and this
     bias due to preferential treatment between /communes/ can be
     assessed by well informed consumers through the horizontal
     dimension.

**** Table                                   :noheading:

#+begin_export latex
\begin{table}[!htb]
\caption{\textbf{Signal Decompositions of the Informational Content of
    GIs from OGAMs}}
\singlespacing\label{Tab:2} \vspace{-.5cm}
\begin{threeparttable}
\input{Tables/Decomp.tex}
\begin{tablenotes}\footnotesize
\item Notes: The effective degrees of freedom for spatial smoothing
  terms in parentheses show that the columns correspond to model ( I )
  to ( V ) from \autoref{Tab:1}.  Decomposition terms are expressed in
  percent of variance of the latent variable $y^{*}$ according to
  equations (\ref{eq:dec1}) to (\ref{eq:dec4}) in the text.  For each
  column, the sum of \emph{vertical signal} and \emph{vertical
    residual} equals the \emph{joint signal}, as does the sum of
  \emph{horizontal signal} and \emph{horizontal residual}.  The
  \emph{vertical noise} equals the sum of the \emph{vertical residual}
  and the \emph{joint noise}, and the \emph{horizontal noise} equals
  the sum of \emph{horizontal residual} and \emph{joint noise}.
\end{tablenotes}
\end{threeparttable}
\end{table}
#+end_export

*** Models of the 1936 GIs
**** Text 1                                  :noheading:

     We estimate the same set of ordered models with the vertical GIs
     of 1936 as the outcome variable.  At this point of history, the
     vertical dimension of GIs counted only three levels, as reported
     in the summary statistics in \autoref{Tab:SD} in the Appendix:
     /Régional/ < /Village/ < /Grand Cru/ with respectively 57%, 41%,
     and 3% of current vineyard plots.@@latex:\footnote{We drop the
     \emph{communes} of \emph{Chenôve}, \emph{Marsannay-la-Côte},
     \emph{Couchey}, \emph{Comblanchien}, \emph{Corgoloin} and
     \emph{Saint-Romain} because they contained only one vertical
     level in 1936, so their fixed effects are not identified (see RM,
     p.5).}@@ The joint significance, and the marginal effects of
     tangible variables are reported in \autoref{Tab:A3}, and
     \autoref{Fig:A4}, respectively, in the Appendix.  The hierarchy
     of the joint significance of explanatory variables is very close
     to what is obtained for current GIs.  The /commune/, pedology
     fixed effects, and geographic coordinates have the highest
     significance, followed by elevation, geology, solar radiation,
     slope, and exposition.  The marginal effects of elevation and
     slope also have an inverted-U pattern with close maximum values,
     and the spatial smoothed patterns are also very close to what is
     found for current GIs.  For the 1936 GI designation scheme, the
     control for omitted /terroir/ variables is reached for smaller
     maximum edf of spatial coordinates (bootstrapped F-statistics are
     reported in the bottom of \autoref{Tab:A3} in Appendix, the
     violin plot is reported in the RM, p.23).  In contrast,
     \autoref{Fig:A6} in the Appendix show the ordinal superiority
     measures were more marked between /communes/ in 1936.  The
     /communes/ from the /Côte de Nuits/ already appeared as
     relatively advantaged (seven /communes/ among the 11 most
     advantaged) and the effect of the syndicates of producers appear
     more clearly (see footnote 3).  \autoref{Fig:3} shows that the
     /commune/ where a vineyard is located was a more important
     determinant of GIs designations in the middle of the 20th century
     than it is currently.  For 18 /communes/ among 25 (72%) the
     ordinal superiority measure decreases in absolute values in the
     last decades.  This indicates that the GI designation scheme is
     increasingly efficient in the sens of cite:DNab91.  Some
     /communes/ such as /Santenay/ and /Vosnes-Romanée/ are moving
     from advantaged to disadvantaged since the creation of INAO,
     while the majority of /communes/ stays in the same category.

**** Figure                                  :noheading:

#+begin_export latex
\vspace{.5cm}
\begin{figure}[h]
  \caption{\textbf{Variations of Ordinal Superiorty Measures 
      between 1936 GIs and Current GIs}\\[.1cm]
    \footnotesize Notes: For a given \emph{commune} on the y-axis,
    ordinal superiority measures are computed as the difference
    between the estimated fixed effect $\mu_c$ and the average fixed
    effect $\overline{\mu}$ of all \emph{commune} according to:
    $\Delta_{c}= 2\times \Lambda[(\mu_{c}-\overline{\mu})/
    \sqrt{2}]-1$.  The arrows represent the change in the measures
    between the creation of INAO in 1936 and current
    GIs.}\label{Fig:3}
  \centering\vspace*{-.75cm}\hspace*{-.5cm} \includegraphics[scale=
  .62]{./Figures/ComDyn.pdf}
\end{figure}
#+end_export

**** Text 2                                  :noheading:

     The first column of \autoref{Tab:3} reports the decomposition of
     the latent quality index according to the 1936 GIs.  The GIs of
     1936 have lower joint informational content than actual GIs with
     a joint signal to noise ratio close to 1 ($48/49.5$), which
     confirms the result of increasing efficiency of GIs on the last
     century.  The bias from the vertical dimension double to become
     equals to 40% ($14/35$). The informational content of the
     vertical and horizontal dimensions are more balanced, whereas the
     vertical dimension stays more informative.  The vertical
     dimension of 1936 GIs has a signal to noise ratio of 0.54
     ($34.4/63.1$) compared to 0.32 ($23.8/73.7$) for the other
     dimension.  Because the /commune/ delineations have not changed
     since 1936, the informational content of the horizontal dimension
     does not change.  Note that the lower informational level of the
     vertical dimension of the 1936 GIs is not due exclusively to the
     higher bias in GI delineation from intangible determinants.  A
     part of the loss could be attributable to the lower number of
     vertical items (3 instead of 5 in current GIs).  These results
     indicate significant improvements in the informational content of
     GIs in the last century in combination with the decreased bias
     from intangible determinants.

**** Table                                   :noheading:

#+begin_export latex
\vspace{.5cm}
\begin{table}[!htb]
\caption{\textbf{Signal Decompositions from Alternative GI Designation Schemes}}
\singlespacing\label{Tab:3} \vspace{-.5cm}
\begin{threeparttable}
\input{Tables/Decoldmp.tex}
\begin{tablenotes}\footnotesize
\item Notes: Latent quality index used to simulate GI designation
  schemes is predicted from model ( V ) of \autoref{Tab:1}, which
  provides the best fit of current GIs. The first column reports the
  informational content of the GIs of 1936.  Scheme S.0 is a benchmark
  simulation that adds surrogate residuals to the latent quality index
  in order to mimic current GIs.  S.I drops the random idiosynchratic
  terms, S.II drops the intangible determinants through averaging
  \emph{commune} effects, and S.III drops both random terms and
  intangible determinants of GIs.  Schemes S.IV, S.V, and S.VI add a
  vertical level on actual GIs for \emph{Bourgogne}, \emph{Village},
  and \emph{Premier Cru}, respectively, by an additional threshold
  fixed at the mean.
\end{tablenotes}
\end{threeparttable}
\end{table}
#+end_export

*** Informational content of simulated GIs
**** Text 1                                  :noheading:

     In order to provide guidelines for better designated GIs in the
     future, we performed different simulations of counter-factual GI
     designation schemes as reported in columns S.I to S.VI in
     \autoref{Tab:3}.  This consists in changing the GI designation
     schemes and evaluates the consequences on their informational
     content.  The six vertical designation schemes under
     consideration were simulated by changing the predictions of the
     latent quality index that is mapped to GIs by thresholds (in
     columns S.I, S.II, and S.III), and by changing the number of
     vertical levels from five to six (in S.IV, S.V and S.VI).  The
     detailed formula and R codes used to simulate them are reported
     in RM (p.28).  We did not consider changing the horizontal
     dimension of GIs, because changing the administrative boundaries
     of /communes/ in order to improve wine quality signaling is not
     policy-relevant.  Scheme S.0 is a benchmark scheme that tries to
     reproduce actual GI designations by adding simulated designation
     noises from surrogate residuals to the predictions of the latent
     quality index.  This noised index is mapped to the vertical
     dimension of the simulated GIs with estimated thresholds and
     /commune/ fixed effects.  The second column, S.0, in
     \autoref{Tab:3} shows that the decomposition terms are very close
     to those obtained in the last column of \autoref{Tab:2} from
     actual GIs.  Next, we drop the designation errors from surrogate
     residuals in S.I, we drop the intangible /commune/ effects in
     S.II, and we drop both designation errors and /commune/ effects
     in S.III.  In the last simulated designation schemes S.IV, S.V
     and S.VI, /Bourgogne/, /Village/ and /Premier Cru/ levels are
     respectively divided into two different levels by adding a
     threshold, fixed at the mean of the estimated thresholds used for
     S.0.  Each of these schemes corresponds to the creation of an
     additional level (like, e.g., /Bourgogne supérieur/, /Village
     supérieur/ ou /Premier Cru supérieur/) that allows consumer to
     distinguish them.

**** Text 2                                  :noheading:

     The decomposition reported in \autoref{Tab:3} show that dropping
     the intangible effects associated with /commune/ effects is the
     most important policy to increase the informational content of
     the vertical dimension of GIs.  Conversely, reducing the
     designation noise is more important for increasing the joint
     signal, which corresponds with the assumption that consumers use
     the information of both GI dimensions.  These two policy changes
     for GIs seem to be additively cumulative for increasing the
     informational content of both the vertical and joint signals.  In
     particular, the marginal gain of dropping the /commune/ effects
     is about the same with and without designation noise.
     \autoref{Tab:3} also shows that dropping the /commune/ effect in
     the designation scheme increases the joint signal more than
     adding a sixth vertical level as in S.III, S.IV or S.V.  Among
     these latter alternative schemes, we found that splitting the
     intermediate level /Village/ is more efficient, but the
     differences are small.  Note that the measure of the
     informational content that we propose is not directly related to
     the value of the GI information, as it treats symmetrically high
     and low levels of GIs.  More research is needed to convert these
     results in terms of the efficient amount of information to give
     consumers, as information about high levels of GIs would be more
     valuable.  In all cases, these potential improvements from the
     vertical dimension of GIs have no impact on the informational
     content of the horizontal dimension, which maintains the same
     order of magnitude among simulations.

** Conclusion
   :PROPERTIES:
   :CUSTOM_ID: Sec:4
   :END:
*** Resume of the paper                      :noheading:

    We present a framework for modeling the geographical indications
    (GIs) and disentangle their informational content, i.e., their
    ability to describe the tangible characteristics of production
    sites.  Applied to the wine-producing region of /Côte d'Or/
    (Burgundy, France), we found simultaneously a high informational
    content of the vertical levels of GIs, and some persistent
    differential treatments between administrative boundaries that
    bias the GI signal.  This two-dimensional segmentation inspired
    many GIs among the wine-producing regions of the "old world" (in
    France, Germany, and Italy for example) but also in the "new
    world" (in the United States in particular).  Similar empirical
    analysis have to be conducted to evaluate the external validity of
    our results, and identify the various determinants of the
    informational content of GIs between these regions.  We also
    showed that the long history of GIs in Burgundy and their
    independent management by INAO has decreased the bias of the GI
    signal in the last decades.  This results is of particular
    importance to explain the differential performance on wine markets
    between the "old world" and the "new world".

*** Theory reputation                        :noheading:

    The economic success of wines from this part of burgundy is not
    only attributable to the informational content of their GIs.  Our
    results are nevertheless related to the general dynamic theory of
    strategic transmission information developed by cite:BLar92.  The
    authors show that, when information is not fully reliable (here,
    because of the lobbying effects on the GI designation process),
    the possibility of honest mistakes (here, because of designation
    noise) produces some confusion for consumers.  Consequently,
    market incentives keep the consumers' learning process incomplete
    and allow market manipulation by producers.  Accordingly, this
    negative economic outcome "is limited only in the long run by the
    public's constant reassessment of their credibility"
    (citealp:BLar92, p.947).  This analysis is particularly relevant
    for signaling wine quality, knowing the difficulties defining and
    observing the notion of /terroir/ and agreeing about the quality
    of wines, which worsens the problem of consumer verification of
    the relevance of the informational content of GIs.

*** More interpretations                     :noheading:

   These benefits of the long-term history of the informational
   content of GIs would require some second thoughts about GI
   flexibility, which is sometimes wished to follow changing
   consumers' preferences, and changing determinants of wine quality
   (particularly in the face of climate change, citealp:WWJo09).  As a
   human institution, which requires political bargaining and the
   involvement of producers with private information, the unbiased
   nature of the GI signal would probably not be reached
   spontaneously.  Moreover, the regular modifications that would be
   required to follow the changing preferences or changing environment
   would increase the confusing correlation between tangible and
   intangible characteristics and, consequently, decrease the
   informational content of GIs for consumers.  The stability of GIs
   and their third-party management probably account for a great
   portion of their value that is currently observed in the wine
   markets.

*** Discussion of the identification         :noheading:

    Our empirical strategy was based on the difference between the
    assumed spatial continuity of /terroir/ and the discontinuity of
    administrative borders, from which we disentangle the tangible and
    intangible determinants of GIs.  Due to the small size of vineyard
    plots in the region, the smooth functions of geographic
    coordinates (longitude and latitude) allow to control for the
    fine-scale variations of unobserved heterogeneity from the
    /terroir/.  The estimated spatial patterns of the latent quality
    index grasped by these functions are not exclusively related /a
    priori/ to tangible characteristics that matter for wine quality.
    In particular, they can grasp some spatial interactions of
    reputation or influence between vineyard plots on both sides of a
    /commune/ border.  Nevertheless, we found that the main
    decomposition results for the informational content of GIs, and
    the general result of a signal-to-noise ratio of 4 are robust in
    regards to the degree of spatial smoothing used in regressions.
    Taking into account fine-scale variations in /terroir/ is
    important to estimate the ordinal superiority measures, but not
    determinant of the informational content of GIs.

#+Latex: \clearpage

** Bibliography                              :noheading:
   
#+LATEX: \singlespacing

   bibliographystyle:../Softwares/latex/erae
   bibliography:Biblio.bib

#+LATEX: \clearpage\appendix

** Appendices
*** About causal inference

    We consider that the causal /commune/ effects are identified once
    the spatial heterogeneity correlated between /commune/ is
    controlled by the smoothing functions of geographical coordinates.
    This sufficient level of spatial smoothing is expected to be
    reached once the residuals from auxiliary regressions that do not
    include /commune/ effects are not correlated between /communes/.
    Using residuals for specification purposes has a long history in
    econometrics, complemented by generalized residuals for non-linear
    outcomes citep:PHal83,GMRT87,CIri87.  We use here the surrogate
    residuals recently defined by cite:LZha18.

    Define a surrogate variable $S\mid X, y \sim
    \lambda\,\big[\,B(X)^\top\beta- \alpha_{y}\mid y\,\big]$ that
    follows a truncated logistic distribution conditionally on $y$.
    The principle of using the observed values of $y$ to estimate the
    residuals is shared by generalized residuals, the originality of
    the surrogate approach is to randomly draw the residuals rather
    than computing them analytically.  This allows the estimation of
    their full distribution instead of only their first 2 moments,
    which sensibly extends their potential applications in regression
    diagnostics citep:LZha18.  We estimated the residuals of auxiliary
    models from $N$ random draws of the surrogate variable $S_i$ with:
#+begin_export latex
\begin{equation}
R_i= S_i-\mathbb{E}(S_i)= S_i+ \alpha_{y_i}- B(X_i)^\top\beta,
\end{equation}
#+end_export
     and we regress them on /commune/ dummies.  By increasing the
     complexity of $B(X_i)$ through increasing spline base dimensions
     of the smooth functions of geographical coordinates, the joint
     significance of /commune/ dummies decreases as the unobserved
     spatial patterns are increasingly accounted for.  Failing to
     reject the null hypothesis of a classical Fisher test of joint
     significance is expected to indicate that the sufficient
     complexity is attained by the auxiliary model.  Hence, we
     estimate a full OGAM of GI designation with the sufficient level
     of spatial smoothing.  In the absence of residual effects
     correlated between /commune/, the estimated ordinal superiority
     measures are expected to be causal.  The F-statistics are
     bootstrapped to take into account the additional uncertainty
     attributable to the random draws used in the computation of
     surrogate residuals.

*** Table of summary statistics              :noheading:
    :PROPERTIES:
    :CUSTOM_ID: App:A
    :END:

#+begin_export latex
\begin{table}[h]
\caption{\textbf{Descriptive Statistics for the Variables used in the Econometric Analysis}}\singlespacing
\vspace{-.25cm}\centering\label{Tab:SD}
\begin{threeparttable}
\input{Tables/StatDes.tex}
\begin{tablenotes}\footnotesize
\item Notes: Topographic variables were computed by a Geographical
  Information System from a Digital Elevation Model with 5 m
  resolution.  Longitude and latitude variables correspond to the
  center of each vineyard plot.  Current GI are modeled as dummy
  variables that account for the vertical dimension in january 2018,
  and 1936 GI comes from MSH data (see RM).  Exposition is discretized
  in the Aspect variable according to the degree ranges reported within
  brakets.
\end{tablenotes}
\end{threeparttable}
\end{table}\clearpage
#+end_export

*** Figure of GIs interaction                :noheading:

#+begin_export latex
\begin{landscape}
\begin{figure}[b]
  \caption{\textbf{The Distribution of GI Levels within each
      \emph{Communes}} \\[.1cm]
    \footnotesize Notes: For each \emph{commune} on the y-axis (i.e.,
    the horizontal dimension of GIs), the bar represents the vineyard
    area designated in each vertical level of GIs.  The number
    reported within the bar is the percentage that each vertical item
    represent in the total vineyard area of each \emph{commune}.}
  \centering\label{Fig:A0} \rotatebox[origin=c]{-90}{
    \includegraphics[scale=.65,angle=90]{Figures/CrossGIs.pdf} }
 \end{figure}
\end{landscape}
#+end_export

*** Marginal effects in GI models            :noheading:

#+begin_export latex
\begin{figure}[!t]
  \caption{\textbf{Nonlinear Effects of Topographic Variables on Current GI Designations}\\[.1cm]
    \footnotesize Notes: Dotted lines represent the quadratic effects
    from model ( 0 ) in \autoref{Tab:1}, centered at zero with all
    other explanatory variables at their sample means.  Continuous
    lines represent the centered effects from 10 OGAMs with increasing
    darkening for increasing effective degrees of freedom for spatial
    smoothing terms.  Models ( I ) to ( V ) in \autoref{Tab:1} are a
    subset of these OGAMs with maximum effective degrees of freedom
    uniformly distributed between 100 and 1000.  The histograms at the
    bottom of each plot represent the marginal distributions of the
    explanatory variables.}\label{Fig:A1}
  \centering
\includegraphics[scale= .85]{Figures/PltEff.pdf}
\end{figure}\clearpage
#+end_export

*** Spatial smooth surfaces                  :noheading:

#+begin_export latex
\begin{landscape}
\begin{figure}[b]
  \caption{\textbf{Smoothed Functions of Geographic Coordinates from Current GI Designations}\\[.1cm]
    \footnotesize Notes: The smooth surfaces are predicted only from
    spatial coordinates, other explanatory variables are fixed to
    their sample means.  Predictions of the latent vineyard quality
    index are uniformly normalized to be inside the unit interval.
    Each Panel corresponds to a model reported in \autoref{Tab:1},
    from model ( 0 ) at the top-left to model ( V ) at the
    bottom-right.  The effective degrees of freedom for the smooth
    functions are reported at the top of each plot.}
  \centering\label{Fig:A2} \rotatebox[origin=c]{-90}{
    \includegraphics[scale=.7,angle=90]{Figures/SmoothMap.pdf} }
 \end{figure}
\end{landscape}
#+end_export

*** Omitted variable test                    :noheading:

# Changer bootstrap on the y-axis
#+begin_export latex
\begin{figure}[!t]
  \caption{\textbf{Joint Significance of \emph{commune} dummies on
      surrogate residuals}\\[.1cm]
    \footnotesize Notes: For each model on the x-axis (with increasing
    level of spatial smoothing), the Figure reports the distribution
    of the bootstrapped F-statistics about the joint significance of
    \emph{commune} dummies on surrogate residuals (log
    scale).}\label{Fig:A2a}
  \centering \includegraphics[scale= .65]{Figures/SignifPlot.pdf}
\end{figure}\clearpage
#+end_export

*** Correlation between /communes/           :noheading:

#+begin_export latex
\begin{figure}[!t]
  \caption{\textbf{Relation between Average GI Level and Ordinal
      Superiority Measures} \\[.1cm]
    \footnotesize Notes: The ordinal superiority measures on the
    x-axis are those of \autoref{Fig:2} in the main text.  The average
    GI level for each \emph{commune} is the area-weighted average of
    GIs coded from 1 to 5 from the worst \emph{Coteaux bourguignons}
    to the best \emph{Grands Crus}.  The nullity of the slope cannot
    be rejected at 1\% ($t=1.27$).}\label{Fig:A2b}
  \centering \includegraphics[scale= .65]{Figures/ComCor.pdf}
\end{figure}\clearpage
#+end_export

*** Significance for old GIs                 :noheading:

#+begin_export latex
\begin{table}[!htp]
\caption{\textbf{Joint Variable Significance for Ordered Logit Models
    of 1936 GI Designations}} \singlespacing
\newcolumntype{Y}{>{\centering\arraybackslash}X}
\label{Tab:A3}\vspace{-.5cm}
\begin{threeparttable}
\input{Tables/VarSign2.tex}
\begin{tablenotes}\footnotesize
\item Notes: $^{**} p< 0.001$ for joint significance tests from the
  reported chi-square statistics, effective degrees of freedom are in
  brackets.  Column ( 0 ) corresponds to an ordered logit model with
  quadratic effects for elevation, slope and solar radiation (df$= 2$)
  with a full interaction between third-orders polynomials for
  longitude and latitude (df$= 3+3+3\times 3= 15$) and with 13, 14, 7
  and 25 dummy variables for pedology, geology, exposition, and
  \emph{communes} fixed effects, respectively.  Models ( I ) to ( V )
  are OGAMs with elevation, slope and solar radiation additively
  specified with a maximum of 9 edf, shrinked endogenously by a
  quadratic penalization.  Spatial coordinates are specified in
  increasing order of complexity with the maximum edf of 50, 100, 150,
  200, and 250.  The last row reports the bootstraped F-statistics for
  the joint nullity of \emph{commune} effects on residuals from
  auxiliary regressions without \emph{commune} dummies.
\end{tablenotes}
\end{threeparttable}
\end{table}\clearpage
#+end_export

*** Marginal effects in old GI models        :noheading:

#+begin_export latex
\begin{figure}[!t]
  \caption{\textbf{Nonlinear Effects of Topographic Variables on
      1936 GI Designations} \\[.1cm]
    \footnotesize Notes: Dotted lines represent the quadratic effects
    from model ( 0 ) in \autoref{Tab:A3}, centered at zero with all
    other explanatory variables at their sample means.  Continuous
    lines represent the centered effects from 10 OGAMs with increasing
    darkening for increasing effective degrees of freedom for spatial
    smoothing terms.  Models ( I ) to ( V ) in \autoref{Tab:A3} are a
    subset of these OGAMs with maximum effective degrees of freedom
    uniformly distributed between 50 and 350.  The histograms at the
    bottom of each plot represent the marginal distributions of the
    explanatory variables.} \label{Fig:A4} \centering
  \includegraphics[scale= .85]{Figures/PltEffOld.pdf}
\end{figure}\clearpage
#+end_export

*** Ordinal superiority for old GI models    :noheading:

#+begin_export latex
\begin{figure}[!t]
  \caption{\textbf{Ordinal Superiority Measures for 1936 GI
      designation scheme}\\[.1cm]
    \footnotesize Notes: For a given \emph{commune} on the y-axis,
    ordinal superiority measures are computed as the difference
    between the estimated fixed effect $\mu_c$ and the average fixed
    effect $\overline{\mu}$ of all \emph{commune} according to:
    $\Delta_{c}= 2\times \Lambda[(\mu_{c}-\overline{\mu})/
    \sqrt{2}]-1$.  The horizontal bars represent the range of measures
    according to the OGAMs with 150, 200 and 250 maximum edf for the
    effects of spatial coordinates.  Black dots represent the average
    of these measures.  Relatively privilegied \emph{communes} appear
    at the top of the y-axis, whereas relatively disadvantged
    \emph{communes} appear at the bottom.}\label{Fig:A6}
  \centering\vspace*{-.75cm}\hspace*{-.5cm} \includegraphics[scale=
  .75]{./Figures/ComEffOld.pdf}
\end{figure}\clearpage
#+end_export
    
*** Analytic bias from /terroir/ variables   :noexport:
    :PROPERTIES:
    :CUSTOM_ID: App:X
    :END:
**** Main text

     We propose to deal with this problem of unobserved spatial
     heterogeneity (met frequently in hedonic studies) by an original
     specification diagnostic and procedure based on the proxy
     variable approach of cite:Wool10 (p.67-72) and the computation of
     residuals in non-linear models citep:PHal83,GMRT87,CIri87,LZha18.
     The effect of unobserved /terroir/ variable is studied throught
     the definition of the linear projection of the unobserved quality
     grade on the observed tangible characteristics :
#+begin_export latex
\begin{equation}
q(X_i^*)= B(X_i)^\top\beta_{LP}+ \eta_i\label{Eq:LP1}
\end{equation}
#+end_export
    with the covariances between each columns of $B(X)$ and the
    residuals from the linear projection equal to zero by definition :
    $\mathbb{C}[b_\ell(x_{ki}), \eta_i]= 0$, $\forall \ell, k$
    citep:Wool10.  The concept of linear projection is of particular
    interest in regard to the indirect effects that are caught by
    tangible variables and the potential for geographical coordinates
    to control for unobserved /terroir/ variables.  On the first
    point, section 2.3 provides some intuitions about the indirect
    effects that tangible variables can have.  The residuals from
    linear projection $\eta$ represent the part of the climate that
    are not taken into account by topographic variables.  This is also
    true for the case of spatial coordinates of the center of the
    vineyard plots that constitutes a very precise information of the
    location (\autoref{Tab:SD}).  If we consider /terroir/ as a
    ecological process spatially smooth, it can allow to control
    through OGAM specification of the joint effect of longitude and
    latitude.

    The Appendix [[#App:A]] shows that the percent of bias on the
    /commune/ effects $\theta= (\hat{\mu}- \mu)/ \mu$ from the
    estimation of \autoref{Eq:Mod} relatively to the structural model
    is :
#+begin_export latex
\begin{equation}
\theta= \frac{\rho}{1- R^2}-1
\end{equation}
#+end_export
    where $\rho$... The intuition behind is as follows The first
    equality is the result of Wooldridge about proxy variable.  What
    is the $R^2$, variance, what is not observable.  The second add
    the term $\rho$ which is the correlation between a reduced from of
    $y^*_i$ on $b(X_i)$.  Increasing the dimension, particularly in
    the spatial coordinates allows to modify the $\theta$, allow th
    assess the potential bias.  Approximation for the variances.
    Specification (including link function) and Omitted long history
    of diagnostics based on residuals

**** Appendix

    Consider the additional linear projection for $i= 1,\dots,N$ of
    the quality grades $q(X^*_i)$ on the terms $B(X_i)^\top\beta_{LP}$
    and $C_i^\top\mu$ to define the scalars $\delta$, $\theta$ and the
    residuals $\epsilon_i$ such that :
#+begin_export latex
\begin{equation}
q(X_i^*)= \delta [B(X_i)^\top\beta_{LP}]+ \theta [C_i^\top\mu]+ \epsilon_i\label{Eq:LP2}
\end{equation}
#+end_export

    Substituting this linear projection in the structural model
    \autoref{Eq:STR} of the main text with the assumption of additive
    thresholds, we obtain :
#+begin_export latex
\begin{equation}
\mbox{Prob}(y_i=j\mid X_i, C_i)=
\mbox{Prob}\big\{\alpha_{j-1}< \delta [B(X_i)^\top\beta_{LP}]+ (1+ \theta) [C_i^\top\mu]+ \epsilon_i+ \xi_i^*<\alpha_j\big\}.\label{Eq:LT}
\end{equation}
#+end_export
    This equation indicates that the estimation of the reduced form
    (\ref{Eq:Mod}) of the main text will produce biased estimates with
    probability limits of $\widehat{\beta}= \beta_{LP}\delta$ and
    $\widehat{\mu}= \mu(1+\theta)$.  The reason is that controlling by
    $B(X_i)$ is not equivalent to controlling for $q(X_i^*)$ and some
    unobserved parts of the true long run quality are caught by the
    /commune/ dummies (unless $\theta=0$).

    By definition of the coefficients of a bivariate linear projection
    applied to (\ref{Eq:LP2}), we have :
#+begin_export latex
\begin{align}
\theta= &\,\frac{\mathbb{C}[q(X_i^*), C_i^\top\mu]\;\mathbb{V}[B(X_i)^\top\beta_{LP}]- 
                 \mathbb{C}[q(X_i^*), B(X_i)^\top\beta_{LP}]\;\mathbb{C}[C_i^\top\mu, B(X_i)^\top\beta_{LP}]}{
              \mathbb{V}[C_i^\top\mu]\;\mathbb{V}[B(X_i)^\top\beta_{LP}]- \mathbb{C}[C_i^\top\mu, B(X_i)^\top\beta_{LP}]^2}\label{Comp:1}\\
        =&\,\frac{\mathbb{V}[B(X_i)^\top\beta_{LP}]\big\{\mathbb{C}[B(X_i)^\top\beta_{LP}, C_i^\top\mu]+ \mathbb{C}[\eta_i, C_i^\top\mu]\big\}- 
                 \mathbb{V}[B(X_i)^\top\beta_{LP}]\;\mathbb{C}[C_i^\top\mu, B(X_i)^\top\beta_{LP}]}{
              \mathbb{V}[C_i^\top\mu]\;\mathbb{V}[B(X_i)^\top\beta_{LP}]- \mathbb{C}[C_i^\top\mu, B(X_i)^\top\beta_{LP}]^2}\label{Comp:2}\\
      = &\, \frac{\mathbb{C}(\eta_i, C_i^\top\mu)}{\mathbb{V}[C_i^\top\mu]\times(1-R^2)}\label{Comp:3}
\end{align}
#+end_export
    \autoref{Comp:2} is obtained by substituting $q(X^*)$ by the
    linear projection of \autoref{Eq:LP1} of the main text and
    \autoref{Comp:3} comes from the definition of the R$^2$ from the
    regression of $C_i^\top\mu$ on $B(X_i)^\top\beta_{LP}$, that is :
    $R^2=\mathbb{C}[C_i^\top\mu, B(X_i)^\top\beta_{LP}]^2/
    \big\{\mathbb{V}[C_i^\top\mu]\mathbb{V}[B(X_i)^\top\beta_{LP}]\big\}$.
    We use the fact that $\mathbb{C}[\xi_i^*, b_\ell(x_k)]= 0$ for all
    $k,\ell$ from the structural assumption that $\mathbb{E}(\xi^*\mid
    X^*, C_i)= 0$ with $X\subset X^*$ (law of iterated expectations).
    The last expression is the standard formula for the omitted
    variable bias when using $B(X_i)$ as a proxy for $q(X_i^*)$. It
    shows in particular the necessary condition for an absence of bias
    is that the proxy is closely enough related to the omitted
    variable so that once included, $C_i^\top\mu$ is not partially
    correlated with $q(X^*_i)$ (citealp:Wool10, p.68).  This reads as
    $\mathbb{C}(\eta_i, C_i^\top\mu)= 0$ $\Rightarrow$ $\theta=0$.  We
    found another result from the literature about the importance of
    reporting the R$^2$, Oster XX.  As regression XX and XX are
    hypothetical, the last \autoref{Comp:3} does not have any testable
    implications.
 
    Hence consider the auxiliary regression of the latent variable
    from \autoref{eq:LT} on only the tangible variable $B(X_i)$,
    voluntary omitting the /commune/ fixed effects. This would
    provide :
#+begin_export latex
\begin{equation}
\widetilde{y}_i^*= \tau B(X_i)^\top\beta_{LP}+ \varepsilon_i \;\;\mbox{ with }\;\; 
\tau=\mathbb{C}[B(X_i)^\top\beta_{LP}, \widetilde{y}_i^*]/\mathbb{V}[B(X_i)^\top\beta_{LP}]
\end{equation} 
#+end_export
     Assume that this regression could be run with observations of
     $\widetilde{y}_i^*$, we are interested by the estimated residuals
     and their correlation with $C_i^\top\mu$. In effect, intuition. We
     substitute to obtain :
#+begin_export latex
\begin{align}
\mathbb{C}(\widehat{\varepsilon}_i, C_i^\top\mu)=& \, \mathbb{C}(\widetilde{y}_i^*,C_i^\top\mu)-\frac{\mathbb{C}[\widetilde{y}_i^*, b(X_i)^\top\beta_{LP}]}{\mathbb{V}[b(X_i)^\top\beta_{LP}]}\mathbb{C}[b(X_i)^\top\beta_{LP}, C_i^\top\mu]\\ 
=& \, \mathbb{C}[q(X^*),C_i^\top\mu]+\mathbb{V}(C_i^\top\mu)-\frac{\mathbb{C}[b(X_i)^\top\beta_{LP}, C_i^\top\mu]}{\mathbb{V}[b(X_i)^\top\beta_{LP}]}\Big\{\mathbb{C}[q(X^*), b(X_i)^\top\beta_{LP}]+ \mathbb{C}[C_i^\top\mu, b(X_i)^\top\beta_{LP}]\Big\}\nonumber\\
=& \, \mathbb{C}[b(X_i)^\top\beta_{LP},C_i^\top\mu]+ \mathbb{C}[\eta_i,C_i^\top\mu] +\mathbb{V}(C_i^\top\mu)-\frac{\mathbb{C}[b(X_i)^\top\beta_{LP}, C_i^\top\mu]}{\mathbb{V}[b(X_i)^\top\beta_{LP}]}\Big\{\mathbb{V}[b(X_i)\beta_{LP}]+ \mathbb{C}[C_i^\top\mu, B(X_i)^\top\beta_{LP}]\Big\}\nonumber\\
=& \, \mathbb{C}[\eta_i,C_i^\top\mu] +\mathbb{V}(C_i^\top\mu)-\frac{\mathbb{C}[b(X_i)^\top\beta_{LP}, C_i^\top\mu]^2}{\mathbb{V}[b(X_i)^\top\beta_{LP}]}\\
=& \, \mathbb{C}[\eta_i,C_i^\top\mu]+ \mathbb{V}(C_i^\top\mu)\times (1-R^2)
\end{align}
#+end_export

     The last term could be substituted in the \autoref{Comp:3} to
     obtain the formula reported in the main text by noting $\rho$
     (for a variance of $\widehat{\varepsilon}_i$ normalized to one,
     which is standard in ordered models) :
#+begin_export latex
\begin{equation}
\theta= \frac{\mathbb{C}(\widehat{\varepsilon}_i, C_i^\top\mu)-\mathbb{V}(C_i^\top\mu)\times (1-R^2)}{\mathbb{V}(C_i^\top\mu)(1- R^2)}= \frac{\rho}{1- R^2}-1
\end{equation}
#+end_export

*** Spatial smooth surfaces for old GIs      :noexport:

#+begin_export latex
\begin{landscape}
\begin{figure}[b]
  \caption{\textbf{Smoothed Functions of Geographic Coordinates from 1936 GI Designations}\\[.1cm]
    \footnotesize Notes: The smooth surfaces are predicted only from
    spatial coordinates, other explanatory variables are fixed to
    their sample means.  Predictions of the latent vineyard quality
    index are uniformly normalized to be inside the unit interval.
    Each Panel corresponds to a model reported in \autoref{Tab:A3},
    from model ( 0 ) at the top-left to model ( V ) at the
    bottom-right.  The effective degrees of freedom for the smooth
    functions are reported at the top of each plot.}
  \centering\label{Fig:A5} \rotatebox[origin=c]{-90}{
    \includegraphics[scale=.7,angle=90]{Figures/SmoothMapOld.pdf} }
 \end{figure}
\end{landscape}
#+end_export

** Research perspectives                    :noexport:

    A next step would be to study consumer reaction to quality
    signaling (welfare implication) but difficult on GIs because of
    their stability.  Another difficulty would be the endogenous
    quality from viticultural practices in reaction to good
    classification and associated high prices. But also: Consumers may
    migrate toward higher quality (vertical sorting) of to wine whose
    product characteristics best meet their idiosynchratic needs
    (horizontal). Both can increase welfare. Numerous paper about
    vertical welfare imroving (DZJi10 p.952 for a review) Reputation
    should thus be relevant if prospective buyers believe that it
    predicts current quality in markets in which current quality is
    imperfectly observable (Shapiro, 1982, Landon and Smith 1998). The
    second is about the value of GIs.

* Title Page
  :PROPERTIES:
  :EXPORT_FILE_NAME:    TitlePage.pdf
  :EXPORT_LATEX_CLASS:  WorkinPap
  :EXPORT_LANGUAGE:     en
  :EXPORT_OPTIONS:      TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:3
  :EXPORT_TITLE:        @@latex: Title: The informational content of geographical indications@@
  :EXPORT_AUTHOR:       @@latex: Author name: Jean-Sauveur Ay \\ Contact person: Jean-Sauveur Ay \\ Address: 25 boulevard Docteur Petitjean, 21000 Dijon (France).\\ Phone number: 00.333.80.77.23.19 @@
  :EXPORT_LATEX_HEADER: \usepackage[T1]{fontenc} \usepackage[doublespacing]{setspace} \usepackage{tabularx, rotating, booktabs, pdflscape, amssymb, amsmath, amsthm, bbm, eurosym, pdflscape, txfonts, rotfloat, caption}\makeatletter\renewcommand{\maketitle}{\bgroup\setlength{\parindent}{0pt}\@title \begin{flushleft} \@author\end{flushleft}\egroup}\makeatother
  :END:

* Presentation
  :PROPERTIES:
  :EXPORT_FILE_NAME:     Presentation
  :EXPORT_LATEX_CLASS:   PresSemin
  :EXPORT_LATEX_HEADER:  \renewcommand{\texttt}{\textcolor{beamer@blendedblue}} \renewcommand{\footnotesize}{\scriptsize} \addbibresource{Perso.bib} \renewcommand*{\bibfont}{\scriptsize}
  :EXPORT_BEAMER_HEADER: \usepackage{libertine}\setbeamerfont{frametitle}{family=\sffamily}\setbeamerfont{framesubtitle}{family=\sffamily}\setbeamerfont{title}{family=\sffamily}\setbeamerfont{date}{family=\sffamily}\usepackage{bm, adjustbox, amsmath, dcolumn, import, rotfloat} \newcommand{\indep}{\rotatebox[origin=c]{90}{$\models$}}
  :EXPORT_OPTIONS:       TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:2 author:t
  :EXPORT_TITLE:         @@latex: The Informational Content of\\ Geographical Indications @@
  :EXPORT_AUTHOR:        @@latex: Jean-sauveur Ay \\ Groupe de Travail Interne  @@  
  :EXPORT_DATE:          =Vendredi 10 mai 2019=
  :END:
** 1 -- Introduction
*** The signal of quality

# Vous avez l'étiquette d'un des vins les plus chers du monde, où on
# voit bien ce qui est mis en avant pour signaler la qualité du vin.

# Romanée Conti est une parcelle d'un peu plus de 1 ha et demi, située
# à une trenteine de km d'ici, je reviendrais là-dessus.

#+BEGIN_CENTER
\vspace{-.5cm}
\includegraphics[trim=0cm 0cm 0cm 0cm, clip=true, scale= .9]{./Figures/labelDRC}
#+END_CENTER

*** Quality of the signal

# Par contre, signaler le lieu de production ne suffit pour signaler
# la qualité et se pose donc la question de la qualité du signal qui
# transite par la référence au lieu

# je ne connaîs pas le bois joli dans l'hérault mais je sais qu'il y a
# un rapport de un à plus de mille pour 75 cl de jus de raisin
# fermenté

#+BEGIN_CENTER
\vspace{-.5cm}
\includegraphics[trim= 2.5cm 1.5cm 2.5cm 2cm, clip=true, scale= .55]{./Figures/labelVDP}
#+END_CENTER

*** Relevant signal ?

# Au delà de l'annecdote se joue la question de la pertinence de la
# référence au lieu par rapport au modèle dominant de la marque, qui
# est encore source de conflit dans les négociations commerciales.

# je ne rentre pas dans les détails mais la littérature anglo-saxone
# est très critique des AOC qui limite l'offre et hausse les prix,
# avec des préférences pour des stratégies marketing plus subtiles.

#+BEGIN_CENTER
\vspace{-.5cm}
\includegraphics[trim=0cm 0cm 0cm 0cm, clip=true, scale= .35]{./Figures/labelFAT}
#+END_CENTER

** 2 -- Context
*** Côte d'Or, Bourgogne, France

# je vais travailler sur le vignoble de la Côte

# qui est une sorte de talu avec la plaine à l'est et les hautes côtes
# à l'ouest, moins de 100 km de long entre 180 et 600 mètres
# d'altitude

# les vignes et les appellations sont une bande de 1 à 2 km sur les
# coteaux à pentes maximales, sur 31 communes séprarées en Côte de
# Nuits et Côte de Beaune

# Au sein des chaque commune il y a une classification verticale en 5
# catégories en ordre croissant dans la hiérarchie

**** Image 2                                 :BMCOL:
    :PROPERTIES:
    :BEAMER_col: 0.5
    :END:
     
#+BEGIN_CENTER
\vspace*{-1cm}
\includegraphics[scale= .3]{./Figures/MapCom1}
#+END_CENTER     

**** Image 1                                 :BMCOL:
    :PROPERTIES:
    :BEAMER_col: 0.6
    :END:

#+BEGIN_CENTER
\vspace*{-1cm}
\includegraphics[scale= .3]{./Figures/MapCom2}
#+END_CENTER     

*** Information available to consumers

# Parmi les informations typiquement disponible d'une étiquette, je
# vais m'intéresser au niveau de l'appellation, village et la
# dénomination

#+BEGIN_CENTER
\vspace{-.5cm}
\includegraphics[trim=0cm 0cm 0cm 0cm, clip=true, scale= .55]{./Figures/labelPCRU}
#+END_CENTER

*** History

    - IIth century: Archaeological evidences of vineyards
    - VIIth century: Written evidences of vineyards (Benedictines)
    - XIIth century: First classification of vineyards (Cistercians)
    - 1789: First administrative delineation of /communes/
    - 1810: First delineations at the vineyard plot scale
    - 1855: First hierarchical delineations of vineyards
    - 1935: Creation of the National Institute for GIs (INAO)
    - Continuous modifications of vineyard delineations 

*** Interaction between GIs and /communes/

#+begin_quote 

<< I have studied the wines of each of the /communes/ as if the other
/communes/ had not existed and the classification that I give is true
only for each /commune/ taken in isolation. >>

#+end_quote

#+Latex: {\small
    Jules Lavalle 1855 (p.78)

 Histoire et statistique de la vigne et des grands vins de la Côte
 d'Or.
#+Latex:}

*** Interaction between GIs and /communes/

#+begin_quote

    << More the GI is aligned with the /syndicat/ that defend it, more
    the probability that the /commune/ have well rated vineyards on
    the hierarchy is high. >>

#+end_quote

#+Latex: {\small
    Olivier Jacquet 2009 (p.193)

    Un siècle de construction du vignoble bourguignon.
#+Latex: }

** 3 -- Model
*** Latent structure

#+begin_export latex
\begin{flalign*}
y^*= q\left(X^*\right)+ \xi \;\;\mbox{ with }\;\; \mathbb{E}(\xi \mid X^*)= 0&&\nonumber
\end{flalign*}\pause
#+end_export

# Composante non observée, note de qualité SELON LE DESIGNATEUR Il ne
# s'agit pas de savoir si c'est pertinent pour le consommateur

# Il s'agit de décomposer entre ce qui est tangible X de ce qui est
# idiosyncratique (hypothèse les deux sont indépendants)

#+begin_export latex
\vspace{-1.5cm}
\begin{flalign*}
 y= j &\;\;\mbox{ if }\;\; \alpha_{j-1}^c< y^* \leqslant \alpha_{j}^c & \nonumber\\
&\mbox{ for }\;\; j \in \big\{\mbox{\small Côteaux b., Bourgogne, Village, Premier Cru, Grand Cru}\big\}&\nonumber
\end{flalign*}\pause
#+end_export

# Cette simplification hiérarchisée de l'information permet de réduire
# en 5 niveaux une information continue.

# La structure ordinale (verticale) s'éloigne d'une mesure cardinal
# (un score de 40 c'est 2 fois mieux qu'un score de 20), ça permet de
# s'afranchir d'une échelle qui est souvent problématique sur les
# notes (école des fans, Parker). Et ça permet une certaine
# horizontalité, ça laisse une place aux goûts

#+begin_export latex
\vspace{-1.5cm}
\begin{flalign*}
 \alpha_{j}^c =&\; \alpha_j- \mu_c  \;\;\mbox{ with }\;\; \mu_c \;\;\mbox{ an ordinal superiority measure }&\nonumber\\
& \mbox{ for }\;\; c \in \big\{\mbox{\small Gevrey-Chambertin, Pommard, Meursault, Vougeot, \dots}\big\}&\nonumber
\end{flalign*}
#+end_export

# La structure horizontale est également présente dans l'information
# transmise aux consommateurs à travers la commune
# d'appartenance. L'information communale est un découpage
# administratif qui préexiste aux appellations d'origine. 1789 en
# fonction des paroisses, localisation des églises (IXe-XIIe
# siècles). Le but n'était de signaler la qualité des vignes

# Par contre, les communes ont joué un rôle important, à travers les
# regroupements de producteurs dans la mise en oeuvre des AOC, ils ont
# fait preuve d'influence et leur réputation a joué: Olivier Jacquet,
# Gilles. On a donc un double effet des communes qui sont unité
# spatialement contigu mais dont l'histoire est une source
# additionnelle de brouillage de l'information qualité contenu dans les
# AOC.

# quand aux vignerons d'aujourd'hui ont peu dire qu'ils n'ont peu
# d'effet à moins de supposer des déterminismes génétiques sur 2
# siècles.

# Ordinal superiority as an objective mesure of reputation

*** Empirical Challenge

    =Note= we only observe $X\subset X^*$ of the whole /terroir/
#+LATEX: \vspace{.5cm}

    $\Rightarrow$ omitted /terroir/ variable correlated within /communes/
#+LATEX: \vspace{.5cm}

    =But= under the assumption of spatial smoothness of /terroir/
#+LATEX: \vspace{.5cm}

    $\Rightarrow$ Geographical coordinates allow to control for /terroir/
#+LATEX: \vspace{.5cm}

     =So= we fit an Ordered GeoAdditive Model (penalized semiparametric)

*** Informational content
#+LATEX: \small

#+begin_export latex
\begin{flalign*}
\mathbb{V}(y^*)= \underbrace{\mathbb{V}\left[\widehat{q}\left(X\right)\right]}_{\mbox{signal}}+ \underbrace{\mathbb{V}\left[\;\xi\;\right]}_{\mbox{noise}}&& [D1]\nonumber
\end{flalign*}\pause
#+end_export

# Avec des informations sur X et un modèle ordonné, du type probit ou
# logit on peut obtenir cette décomposition qui ressemble au R2 si on
# normalise par la variance de y^* (bien qu'il soit inobservable,
# c'est magique!) Mais on ne sait pas comment ça agit sur le
# consommateur car lui à part tout connaître (100000 parcelles) il ne
# connaît pas y

# On va donc décomposer le signal selon l'accesibilité qu'il a pour le
# consommateur: loi de la variance totale

#+begin_export latex
\vspace{-1cm}
\begin{flalign*}
  \mathbb{V}\left[\widehat{q}\left(X\right)\right]=
    \underbrace{\mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid y, c\right]\right\}}_{\mbox{joint signal}}+
    \underbrace{\mathbb{E}\left\{\mathbb{V}\left[\widehat{q}\left(X\right)\mid y, c\right]\right\}}_{\mbox{joint residual}}&& [D2]
\end{flalign*}\pause
#+end_export

#+begin_export latex
\vspace{-1cm}
\begin{flalign*}
  \mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid y, c\right]\right\}=
    \underbrace{\mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid y\right]\right\}}_{\mbox{vertical signal}}+
    \underbrace{\mathbb{E}\mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid y, c \right]\mid y\right\}}_{\mbox{vertical residual}}&& [D3]
\end{flalign*}\pause
#+end_export

#+begin_export latex
\vspace{-1cm}
\begin{flalign*}
  \mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid y, c\right]\right\}=
    \underbrace{\mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid c\right]\right\}}_{\mbox{horizontal signal}}+
    \underbrace{\mathbb{E}\mathbb{V}\left\{\mathbb{E}\left[\widehat{q}\left(X\right)\mid y, c \right]\mid c\right\}}_{\mbox{horizontal residual}}&& [D4]
\end{flalign*}
#+end_export

# Intuitions derrière les termes de la décomposition, c'est également
# un R^2

# Certaine redondance entre les niveaux et les communes

** 4 -- Data
*** \null

# Pour cela nous avons compiler les cractéristiques...

#+LATEX: \vspace*{-1cm}\small \input{Tables/StatDesP1.tex}

*** Geology
**** Image                                   :BMCOL:
    :PROPERTIES:
    :BEAMER_col: 0.5
    :END:
     
#+BEGIN_CENTER
\vspace*{-1cm}
\includegraphics[scale= .3, page= 1]{./Figures/MapGeol}
#+END_CENTER     

**** Legend                                  :BMCOL:
    :PROPERTIES:
    :BEAMER_col: 0.6
    :END:

#+BEGIN_CENTER
\vspace*{-1.8cm}
\includegraphics[scale= .4, page= 2]{./Figures/MapGeol}
#+END_CENTER     

*** Pedology
**** Image                                   :BMCOL:
    :PROPERTIES:
    :BEAMER_col: 0.5
    :END:
     
#+BEGIN_CENTER
\vspace*{-1cm}
\includegraphics[scale= .3, page= 1]{./Figures/MapPedo}
#+END_CENTER     

**** Legend                                  :BMCOL:
    :PROPERTIES:
    :BEAMER_col: 0.6
    :END:

#+BEGIN_CENTER
\vspace*{-1.6cm}
\includegraphics[scale= .38, page= 2]{./Figures/MapPedo}
#+END_CENTER     

*** Geographical Indications

#+LATEX: \input{Tables/StatDesP2.tex}

*** \null                                    :noexport:
     
#+BEGIN_CENTER
\vspace*{-1.35cm}\hspace*{-1cm}
\includegraphics[scale= .39]{./Figures/CrossGIs}
#+END_CENTER     

** 5 -- Results
*** Ordered models of GI designations

#+LATEX: \footnotesize\input{Tables/VarSignPres.tex}

*** Omitted /terroir/ effects

#+LATEX: \includegraphics[scale= .4]{Figures/SignifPlot.pdf}

*** Marginal effect of elevation

#+LATEX: \vspace*{.2cm}\hspace*{-1cm}\includegraphics[scale= 1.05]{Figures/PltEff.pdf}

*** Marginal effect of slope

#+LATEX: \vspace*{.2cm}\hspace*{-1cm}\includegraphics[trim=0cm 0cm 0cm 6.75cm, clip=true, scale= 1.05]{Figures/PltEff.pdf}

*** Marginal effects of solar radiation

#+LATEX: \vspace*{.2cm}\hspace*{-1cm}\includegraphics[trim=0cm 0cm 0cm 13.65cm, clip=true, scale= 1.05]{Figures/PltEff.pdf}

*** Ordinal superiority

#+LATEX: \includegraphics[scale= .5]{./Figures/ComEff.pdf}

*** \null

#+LATEX: \vspace{-.5cm}\small \input{Tables/DecompPres.tex}

*** \null

#+LATEX: \vspace{-.5cm}\small \input{Tables/DecoldmpPres.tex}

** 6 -- Conclusion
*** Summary

    =High informational content= of GIs
    - Vertical dimension counts for about 55%
    - Horizontal dimension counts for about 25%

#+LATEX: \vspace{.25cm}

    =Importance of history=
    - the informational content increases
    - the /commune/ fixed effects decrease

#+LATEX: \vspace{.25cm}

    =Increasing the quality of the signal=
    - Equal treatment between /communes/ more important
    - ... than increasing the number of items

*** Perspectives

    =We've studied the informational content= of GIs
    - in terms of characteristics of production sites
    - but not the =value of the GI information=

#+LATEX: \vspace{.5cm}
    
    This would require some data about the =price of wines or
    vineyards=: are they concordents? Does consumers, producers trust
    GIs?

*** \null
#+LaTeX: \Large

    Open data, R codes and Shiny app : @@latex:
    {\fontfamily{pcr}\selectfont https://github.com/jsay/geoInd/}@@

*** \null

#+LATEX: \vspace{-.75cm}\includegraphics[scale=.425]{Figures/SmoothMap.pdf}

* Figures
** Commune descriptive map
*** Elevation file

    Pas besoin de tourner à chaque fois

#+begin_src R
library(data.table) ; library(raster)
Dat.Dem <- fread("Data/VITI_JSA_MH/vitidem.csv")
r <- rasterFromXYZ(Dat.Dem[, c('XL93', 'YL93', 'DEM')])
proj4string(r) <- proj4string(MapCom)
ss <- aggregate(r, fact= 10, mean)
bks <- seq(180, 580, length.out= 9)
library(SpatialPosition)
Grid.Dem <- rasterToContourPoly(ss, breaks= bks, mask= Bord.Area)
GDem <- spTransform(Grid.Dem, CRS("+proj=longlat +ellps=WGS84"))
class(GDem)
save(GDem, file= "Inter/GDem.Rda")
#+end_src

*** Map 1

#+begin_src R
library(rgdal)
MapCom <- readOGR("Carto/", "MapCom")
library(maptools) ; library(sp) ; library(sf)
Bord.Area <- unionSpatialPolygons(MapCom, rep(1, nrow(MapCom)))
MCom <- spTransform(MapCom, CRS("+proj=longlat +ellps=WGS84"))
BArea <- spTransform(Bord.Area, CRS("+proj=longlat +ellps=WGS84"))
ff <- readOGR("Carto/", "COML93")
gg <- subset(ff, !CODE_DEPT %in% c("2A", "2B"))
Fr.Area <- unionSpatialPolygons(gg, rep(1, nrow(gg)))
hh <- subset(ff, CODE_DEPT== "21")
Cd.Area <- unionSpatialPolygons(hh, rep(1, nrow(hh)))
FArea <- spTransform(Fr.Area, CRS("+proj=longlat +ellps=WGS84"))
CArea <- spTransform(Cd.Area, CRS("+proj=longlat +ellps=WGS84"))

pdf("Figures/MapCom1.pdf", width= 7, height= 9)
par(mar = c(0, 0, 0, 0))
plot(as(BArea, "Spatial"), expandBB= c(0, 0, 0, 0))
plot(gl <- gridlines(BArea, easts= c(4.7, 4.8, 4.9, 5),
                     norths= c(47.0, 47.1, 47.2, 47.3)),
     add= TRUE, col = grey(.8), lty= 2)
text(labels(gl), col = grey(.5))
load("Inter/GDem.Rda") ; k <- st_as_sf(GDem)
k <- k[order(k$center),]
library(RColorBrewer)
cols <- brewer.pal(n = 9, name = "Greys")

for (i in 1: nrow(k)){
    p <- st_geometry(k[i,])
    plot(p+ c(-.001, .001), add= T, border= "#ffffff90", col= "#ffffff90")
    plot(p+ c(.001, -.001), add=T, col= "#00000090", border= "#00000090")
    plot(p, col = cols[ i], border = "NA", add= T)  
}
library(cartography)
bks <- seq(180, 580, length.out= 9)
legendChoro(pos = "right", breaks = bks, col = cols, nodata = F,
            title.txt = "Elevation\n (meters)", horiz= FALSE,
            cex= 1, values.cex= 1, title.cex= 1)
library(TeachingDemos) ; library(prettymapr)
addscalebar(plotepsg= "4326", lwd= 1.2, padin= c(1, 0.5),
            widthhint= .1, style= "ticks", pos= "bottomright")
addnortharrow(pos= "bottomright", padin= c(1, 1), scale= .8)
plot(MCom, add= TRUE, lty= 4)
text(coordinates(MCom[MCom$REGION== "Ouche Dij" ,]), "DIJON")
plot(BArea, add= TRUE)
par(fig = c(c(.15, .5), c(.65, .9)), mar = c(0,0,0,0), new = TRUE)
plot(as(FArea, "Spatial"), expandBB= c(.1, .25, 0, .05),
     bg= "white", col= "white")
plot(gridlines(FArea), add= TRUE, col = grey(.8), lty= 2)
text(labels(gridlines(FArea)), col = grey(.5), cex= .75)
box(col = "grey20", lwd = 2, bg= "white")
plot(FArea, add= TRUE)
plot(BArea, add= TRUE, col= "black")
plot(CArea, add= TRUE)
##text(coordinates(CArea)- c(3.8, 0), "Côte d'Or")
points(rbind(c(2.217999, 48.512381), c(4.508372, 45.4550555)),
       pch= 10, cex= .5)
text(2.21, 48.51+ .5, "Paris", cex= .75)
text(4.508372, 45.4550555- .5, "Lyon", cex= .75)
dev.off()
#+end_src

*** Map 2

#+begin_src R
load("Inter/GeoRas.Rda")
Geo.Ras$AOCc <- ifelse(Geo.Ras$GCRU== 1, 5,
                ifelse(Geo.Ras$PCRU== 1, 4,
                ifelse(Geo.Ras$VILL== 1 | Geo.Ras$COMM== 1, 3,
                ifelse(Geo.Ras$BOUR== 1, 2, 1))))
library(rgeos)
tmp_geo <- gBuffer(Geo.Ras, byid= TRUE, width= 0)
Poly.Ras <- unionSpatialPolygons(tmp_geo, Geo.Ras$AOCc)
Poly.ras <- spTransform(Poly.Ras, CRS("+proj=longlat +ellps=WGS84"))
Poly.ras$AOC <- as.character(row.names(Poly.ras))

pdf("Figures/MapCom2.pdf", width= 9, height= 9)

par(mar = c(0, 0, 0, 0))
plot(as(BArea, "Spatial"), expandBB= c(0, 0, 0, 0))
plot(gl <- gridlines(BArea, easts= c(4.7, 4.8, 4.9, 5),
                     norths= c(47.0, 47.1, 47.2, 47.3)),
     add= TRUE, col = grey(.8), lty= 2)
text(labels(gl), col = grey(.5))
my.palette <- brewer.pal(n = 5, name = "BuPu")
Poly.ras$COLOR <- ifelse(Poly.ras$AOC== 1, my.palette[ 1],
                  ifelse(Poly.ras$AOC== 2, my.palette[ 2],
                  ifelse(Poly.ras$AOC== 3, my.palette[ 3],
                  ifelse(Poly.ras$AOC== 4, my.palette[ 4],
                         my.palette[ 5]))))
plot(Poly.ras, col= Poly.ras$COLOR, border= NA, add= TRUE)

CDN <- subset(MCom, REGION== "CDN")
text(4.85, 47.305, bquote(~ underline("CÔTE DE NUITS")), adj= 1)
text(4.85, 47.305- 1: nrow(CDN)/ 85,
     paste(CDN$NOM_COMM[order(CDN$Y_CENTROID, decreasing= TRUE)],
           "-", 1: nrow(CDN)), adj= 1)
## FUNCTION AT THE BOTTOM
shadowtext(coordinates(CDN)[order(CDN$Y_CENTROID, decreasing= TRUE), ],
           labels=  1: nrow(CDN), bg= "white", r=.1, col="black", cex= 1)
plot(CDN, add= TRUE, lty= 2)
CDB <- subset(MCom, REGION== "CDB")
text(5, 47.1, bquote(~underline("CÔTE DE BEAUNE")), adj= 0)
text(5, 47.1- 1: nrow(CDB)/ 85 , paste(nrow(CDN)+ 1: nrow(CDB), "-",
     CDB$NOM_COMM[order(CDB$Y_CENTROID, decreasing= TRUE)]), adj= 0)
shadowtext(coordinates(CDB)[order(CDB$Y_CENTROID, decreasing= TRUE), ],
           labels= nrow(CDN)+ 1: nrow(CDB), bg= "white", r= .1,
           col= "black", cex= 1)
plot(CDB, add= TRUE, lty= 2)
plot(BArea, add= TRUE, col= NA, lwd= 2)
text(coordinates(MCom[MCom$REGION== "Ouche Dij" ,]), "DIJON")
legend(5.04, 47.28, c("Côteaux Bourguignons", "Bourgogne Régional",
                    "Village","Premier Cru","Grand Cru"), cex= 1.2,
       fill= my.palette, title= "GI: vertical dimension", bty= "n")
dev.off()
## segments(rep(4.855, nrow(CDN)), 47.305- 1: nrow(CDN)/ 85,
##          coordinates(CDN)[order(CDN$Y_CENTROID, decreasing= TRUE), 1],
##          coordinates(CDN)[order(CDN$Y_CENTROID, decreasing= TRUE), 2])
## segments(rep(4.995, nrow(CDB)), 47.1- 1: nrow(CDB)/ 85,
##          coordinates(CDB)[order(CDB$Y_CENTROID, decreasing= TRUE), 1],
##          coordinates(CDB)[order(CDB$Y_CENTROID, decreasing= TRUE), 2])
##plot(ARank[ARank$AOC!= "NONE", ], add= TRUE, col= "blue", pch= 15, cex= .1)
## library(viridis)
## plot(ss, col= inferno(256, alpha= 1))
## slope = terrain(ss, opt='slope')
## aspect = terrain(ss, opt='aspect')
## hill = hillShade(slope, aspect, 40, 270)
## plot(hill, col=grey(0:100/100), legend=FALSE, main='Switzerland')
## shadowtext <- function(x, y=NULL, labels, col='white', bg='black',
##                     theta= seq(pi/4, 2*pi, length.out=8), r=0.1, ... ) {
##    xy <- xy.coords(x,y)
##    xo <- r*strwidth('x')
##    yo <- r*strheight('x')
 
##    for (i in theta) {
##      text( xy$x + cos(i)*xo, xy$y + sin(i)*yo, labels, col=bg, ... )
##    }
##    text(xy$x, xy$y, labels, col=col, ... )
##  }
#+end_src

#+RESULTS:
: X11cairo 
:        2

** Geology descriptive map

#+begin_src R
library(rgdal) ; library(maptools) ; library(sp) ; library(sf)
MapCom <- readOGR("Carto/", "MapCom")
Bord.Area <- unionSpatialPolygons(MapCom, rep(1, nrow(MapCom)))
Geol.Map <- readOGR("./Carto/", "GeolMap")


library(RColorBrewer)
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors,
                           rownames(qual_col_pals)))

library(raster)
pi <- intersect(Bord.Area, Geol.Map)
mycol <- sample(col_vector, length(unique(pi$DESCR)))

pdf("Figures/MapGeol.pdf", width= 7, height= 9)
par(mar = c(0, 0, 0, 0))
plot(pi, col= mycol)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottom", cex= 1.3, legend= substr(unique(pi$DESCR), 1, 60), fill= mycol)
dev.off()
#+end_src

** Pedology descriptive map

#+begin_src R
library(rgdal) ; library(maptools) ; library(sp) ; library(sf)
MapCom <- readOGR("Carto/", "MapCom")
Bord.Area <- unionSpatialPolygons(MapCom, rep(1, nrow(MapCom)))
Pedo.Map <- readOGR("./Carto", "PedoMap")

library(raster)
pi <- intersect(Bord.Area, Pedo.Map)
mycol <- sample(col_vector, length(unique(pi$DESCRp)))

library(RColorBrewer)
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors,
                           rownames(qual_col_pals)))

pdf("Figures/MapPedo.pdf", width= 7, height= 9)
par(mar = c(0, 0, 0, 0))
plot(pi, col= mycol)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottom", cex= 1.3, legend= substr(unique(pi$DESCRp), 1, 60), fill= mycol)
dev.off()
#+end_src

** Multi gam effects New AOCs

   New polr model with intercept, without that we cannot predict.

#+begin_src R 
load("Inter/gamod.Rda") ; library(Hmisc)
polm1c <- polr(factor(AOC)~ LIBCOM+ EXPO+ GEOL+ PEDO
               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
               + poly(X, 3)* poly(Y, 3), data= Reg.Ras, Hess= T)

prdTerms <- lapply(gamod, function(x) predict(x, type= "terms", se= TRUE))
grcol <- rev(gray.colors(length(gamod)))

pdf("Figures/PltEff.pdf", width= 6, height= 8)
par(mfrow= c(3, 1), mar= c(2, 4, 2, 2))
plot(0, type= "n", xlim= c(219, 450), ylim= c(-15, 6.5), xlab= "",
     main= "", ylab= "Marginal Effect (centered)")
legend("topleft", "A - Elevation (meter)", cex= 1.2, bty= "n")
dem.for <- order(Reg.Ras$DEM)
for (i in 1: length(prdTerms)){
    lines(Reg.Ras$DEM[dem.for ], prdTerms[[ i]]$fit[dem.for, "s(DEM)"],
          col= grcol[ i], lwd= 1.2)
}
prdDem <- data.frame(DEM= Reg.Ras$DEM, SLOPE= mean(Reg.Ras$SLOPE),
                     RAYAT= 0, EXPO= "(-2,45]", LIBCOM= "FIXIN",
                     GEOL= "0AREF", PEDO= "0AREF",
                     X= mean(Reg.Ras$X), Y= mean(Reg.Ras$Y))
gg <- -qlogis(predict(polm1c, newdata= prdDem, type= 'probs')[, 1])
lines(Reg.Ras$DEM[dem.for ], gg[dem.for ]- mean(gg),
      col= "#1F78B4", lwd= 1.2, lty= 2)
histSpike(Reg.Ras$DEM, add= TRUE, frac= .2, lwd = 4, nint= 120)

plot(0, type= "n", xlim= c(0, 35), ylim= c(-2.5, 2.5), xlab= "", 
     main= "", ylab= "Marginal Effect (centered)")
legend("topleft", "B - Slope (degree)", cex= 1.2, bty= "n")
slp.for <- order(Reg.Ras$SLOPE)
for (i in 1: length(prdTerms)){
    lines(Reg.Ras$SLOPE[slp.for ], prdTerms[[ i]]$fit[slp.for, "s(SLOPE)"],
          col= grcol[ i], lwd= 1.2)
}
prdSlp <- data.frame(DEM= mean(Reg.Ras$DEM), SLOPE= Reg.Ras$SLOPE,
                     RAYAT= 0, EXPO= "(-2,45]", LIBCOM= "FIXIN",
                     GEOL= "0AREF", PEDO= "0AREF",
                     X= mean(Reg.Ras$X), Y= mean(Reg.Ras$Y))
gg <- -qlogis(predict(polm1c, newdata= prdSlp, type= 'probs')[, 1])
lines(Reg.Ras$SLOPE[slp.for ], gg[slp.for ]- mean(gg),
      col= "#1F78B4", lwd= 1.2, lty= 2)
histSpike(Reg.Ras$SLOPE, add= TRUE, frac= .2, lwd = 4, nint= 110) 

plot(0, type= "n", xlim= c(-4, 3.25), ylim= c(-3.5, 1.5), xlab= "",
     main= "",ylab="Marginal effect (centered)")
legend("topleft", "C- Solar Radiation (scaled)", cex= 1.2, bty= "n")
ray.for <- order(Reg.Ras$RAYAT)
for (i in 1: length(prdTerms)){
    lines(Reg.Ras$RAYAT[ray.for ], prdTerms[[ i]]$fit[ray.for, "s(RAYAT)"],
          col= grcol[ i], lwd= 1.2)
}
prdRay <- data.frame(DEM= mean(Reg.Ras$DEM), SLOPE= mean(Reg.Ras$SLOPE),
                     RAYAT= Reg.Ras$RAYAT, EXPO= "(-2,45]",LIBCOM= "FIXIN",
                     GEOL= "0AREF", PEDO= "0AREF",
                     X= mean(Reg.Ras$X), Y= mean(Reg.Ras$Y))
gg <- -qlogis(predict(polm1c, newdata= prdRay, type= 'probs')[, 1])
lines(Reg.Ras$RAYAT[ray.for ], gg[ray.for ]- mean(gg),
      col= "#1F78B4", lwd= 1.2, lty= 2)
histSpike(Reg.Ras$RAYAT, add= TRUE, frac= .2, lwd = 4, nint= 175) 
dev.off()
## lcl <- fit - 1.96 * se
## ucl <- fit + 1.96 * se
## x.polygon <- c(RRank$DEM[i.for ], RRank$DEM[i.back ])
## y.polygon <- c(ucl[i.for ], lcl[i.back ] )
## polygon(x.polygon, y.polygon, col= "#A6CEE3", border= NA)
#+end_src

#+RESULTS:
: X11cairo 
:        2

** Multi gam effects Old AOCs

#+begin_src R 
## load("Inter/gamold.Rda") ; library(Hmisc)
## por2c <- polr(factor(AOCavt)~ LIBCOM+ EXPO
##               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
##               + poly(X, 3)* poly(Y, 3)
##             , data= SRank, Hess= T)
## prdTerms <- lapply(gamold, function(x) predict(x, type= "terms", se= TRUE))
## grcol <- rev(gray.colors(length(gamold)))

pdf("Figures/PltEffOld.pdf", width= 6, height= 8)
par(mfrow= c(3, 1), mar= c(2, 4, 2, 2))
plot(0, type= "n", xlim= c(219, 450), ylim= c(-15, 6.5), xlab= "",
     main= "", ylab= "Marginal Effect (centered)")
legend("topleft", "A - Elevation (meter)", cex= 1.2, bty= "n")
dem.for <- order(SRank$DEM)
for (i in 1: length(prdTerms)){
    lines(SRank$DEM[dem.for ], prdTerms[[ i]]$fit[dem.for, "s(DEM)"],
          col= grcol[ i], lwd= 1.2)
}
prdDem <- data.frame(DEM= SRank$DEM, SLOPE= mean(SRank$SLOPE),
                     RAYAT= 0, EXPO= "45-90", LIBCOM= "VOUGEOT",
                     X= mean(SRank$X), Y= mean(SRank$Y))
gg <- -qlogis(predict(por2c, newdata= prdDem, type= 'probs')[, 1])
lines(SRank$DEM[dem.for ], gg[dem.for ]- mean(gg),
      col= "#1F78B4", lwd= 1.2, lty= 2)
histSpike(SRank$DEM, add=TRUE, frac= .2, lwd = 4, nint= 120)

plot(0, type= "n", xlim= c(0, 35), ylim= c(-2.5, 2.5), xlab= "", 
     main= "", ylab= "Marginal Effect (centered)")
legend("topleft", "B - Slope (degree)", cex= 1.2, bty= "n")
slp.for <- order(SRank$SLOPE)
for (i in 1: length(prdTerms)){
    lines(SRank$SLOPE[slp.for ], prdTerms[[ i]]$fit[slp.for, "s(SLOPE)"],
          col= grcol[ i], lwd= 1.2)
}
prdSlp <- data.frame(DEM= mean(SRank$DEM), SLOPE= SRank$SLOPE,
                     RAYAT= 0, EXPO= "0-45", LIBCOM= "FIXIN",
                     X= mean(SRank$X), Y= mean(SRank$Y))
gg <- -qlogis(predict(por2c, newdata= prdSlp, type= 'probs')[, 1])
lines(SRank$SLOPE[slp.for ], gg[slp.for ]- mean(gg),
      col= "#1F78B4", lwd= 1.2, lty= 2)
histSpike(RRank$SLOPE, add=TRUE, frac= .2, lwd = 4, nint= 110) 

plot(0, type= "n", xlim= c(-4, 3.25), ylim= c(-3.5, 1.5), xlab= "",
     main= "",ylab="Marginal effect (centered)")
legend("topleft", "C- Solar Radiation (scaled)", cex= 1.2, bty= "n")
ray.for <- order(SRank$RAYAT)
for (i in 1: length(prdTerms)){
    lines(SRank$RAYAT[ray.for ], prdTerms[[ i]]$fit[ray.for, "s(RAYAT)"],
          col= grcol[ i], lwd= 1.2)
}
prdRay <- data.frame(DEM= mean(SRank$DEM), SLOPE= mean(SRank$SLOPE),
                     RAYAT= SRank$RAYAT, EXPO= "0-45", LIBCOM= "FIXIN",
                     X= mean(SRank$X), Y= mean(SRank$Y))
gg <- -qlogis(predict(por2c, newdata= prdRay, type= 'probs')[, 1])
lines(SRank$RAYAT[ray.for ], gg[ray.for ]- mean(gg),
      col= "#1F78B4", lwd= 1.2, lty= 2)
histSpike(SRank$RAYAT, add=TRUE, frac= .2, lwd = 4, nint= 175) 
dev.off()
## lcl <- fit - 1.96 * se
## ucl <- fit + 1.96 * se
## x.polygon <- c(RRank$DEM[i.for ], RRank$DEM[i.back ])
## y.polygon <- c(ucl[i.for ], lcl[i.back ] )
## polygon(x.polygon, y.polygon, col= "#A6CEE3", border= NA)
#+end_src

#+RESULTS:
: X11cairo 
:        2

** Smoothed gam surface New AOCs

#+begin_src R
library(rgdal) ; library(maptools) ; library(sp)
MapCom <- readOGR("Carto/", "MapCom")
Bord.Area <- unionSpatialPolygons(MapCom[MapCom$NOM_COMM!= "DIJON", ],
                                  rep(1, nrow(MapCom)- 1))
MCom <- spTransform(MapCom, CRS("+proj=longlat +ellps=WGS84"))
BArea <- spTransform(Bord.Area, CRS("+proj=longlat +ellps=WGS84"))
i= .1
GG <- data.frame(expand.grid(X= seq(min(Reg.Ras$X)- i,
                                    max(Reg.Ras$X)+ i, length.out= 100),
                             Y= seq(min(Reg.Ras$Y)- i,
                                    max(Reg.Ras$Y)+ i, length.out= 100)),
                 "VOUGEOT", mean(Reg.Ras$DEM), "0AREF", "0AREF",
                 mean(Reg.Ras$SLOPE), 0, "(90,135]")
names(GG)[ 3: 9] <- c("LIBCOM", "DEM",
                      "GEOL", "PEDO", "SLOPE", "RAYAT", "EXPO")
library(MASS)
polm1c <- polr(factor(AOC)~ LIBCOM+ EXPO+ GEOL+ PEDO
               + poly(DEM, 2)+ poly(SLOPE, 2)+ poly(RAYAT, 2)
               + poly(X, 3)* poly(Y, 3) 
             , data= Reg.Ras, Hess= TRUE)
tmp <- qlogis(predict(polm1c, newdata= GG, type= "probs")[, 3]+ 1e-5)
GG$por1 <- (tmp- min(tmp))/ (max(tmp)- min(tmp))
GG$por1 <- 0.5+ GG$por1/ 2
load("Inter/gamod.Rda")
fctPrd <- function(mod){
    tmp <- predict(mod, newdata= GG)
    (tmp- min(tmp))/ (max(tmp)- min(tmp))
}
HH <- cbind(GG, sapply(gamod[ 1: 5* 2], fctPrd))
hh <- SpatialPixelsDataFrame(HH[, c("X", "Y")], HH,
                             proj4string=CRS("+proj=longlat +ellps=WGS84"))
library(viridis)
ttl <- paste0("Model ( ", c("0", "I", "II", "III", "IV", "V"), " ) - ")
names(ttl) <- names(hh)[ 10: 15]

pdf("Figures/SmoothMap.pdf", width= 12, height= 8)
par(mar= c(0, 0, 0, 0))
layout(rbind(c(1, 2, 3, 7),
             c(4, 5, 6, 7)), widths = c(4,4,4,1))

for (i in names(hh)[ 10: 15]){
    plot(hh[!is.na(over(hh, BArea)), i],
         xlim= c(4.65, 5.1), what= "image", axes= TRUE, zlim= c(.5, 1),
         ylim= c(46.9, 47.31), col= inferno(256, alpha= 1))
    contour(hh[!is.na(over(hh, BArea)), i], add= TRUE, col= "white")
    plot(BArea, add= TRUE, lwd= 2) ; box()
    if (i== "por1") { title(paste0(ttl[ i], " Quadratic parametric"))
    } else {
            title(paste0(ttl[ i], "Effective degree of freedom : ",
                         round(summary(gamod[[ i]])$edf[ 4], 2)))}
}
plot(hh[, "gam100"],
     what= "scale", scale.size = lcm(1.4), zlim= c(.5, 1),
     ylim= c(46.9, 47.31), col= inferno(256, alpha= 1))
dev.off()
#+end_src

** Smoothed gam surface Old AOCs

   plus uptodate

#+begin_src R
library(rgdal) ; library(maptools) ; library(sp)
MapCom <- readOGR("Carto/", "MapCom")
Bord.Area <- unionSpatialPolygons(MapCom[MapCom$NOM_COMM!= "DIJON", ],
                                  rep(1, nrow(MapCom)- 1))
MCom <- spTransform(MapCom, CRS("+proj=longlat +ellps=WGS84"))
BArea <- spTransform(Bord.Area, CRS("+proj=longlat +ellps=WGS84"))
i= .1
GG <- data.frame(expand.grid(X= seq(min(SRank$X)- i,
                                    max(SRank$X)+ i, length.out= 100),
                             Y= seq(min(SRank$Y)- i,
                                    max(SRank$Y)+ i, length.out= 100)),
                 "VOUGEOT",mean(SRank$DEM), mean(SRank$SLOPE), 0, "90-135")
names(GG)[ 3: 7] <- c("LIBCOM", "DEM", "SLOPE", "RAYAT", "EXPO")

tmp <- -qlogis(predict(por2c, newdata= GG, type= "probs")[, 2]+1e-10)
GG$por2 <- (tmp- min(tmp))/ (max(tmp)- min(tmp))
GG$por2 <- 0.5+ GG$por2/ 2

load("Inter/gamold.Rda")
fctPrd <- function(mod){
    tmp <- predict(mod, newdata= GG)
    (tmp- min(tmp))/ (max(tmp)- min(tmp))
}
HH <- cbind(GG, sapply(gamold[ 3: 7], fctPrd))
hh <- SpatialPixelsDataFrame(HH[, c("X", "Y")], HH,
                             proj4string=CRS("+proj=longlat +ellps=WGS84"))

library(viridis)
pdf("Figures/SmoothMapOld.pdf", width= 12, height= 8)
par(mar= c(0, 0, 0, 0))
layout(rbind(c(1, 2, 3, 7), c(4, 5, 6, 7)), widths = c(4,4,4,1))
for (i in names(hh)[ 8: 13]){
    plot(hh[!is.na(over(hh, BArea)), i],
         xlim= c(4.65, 5.1), what= "image", axes= TRUE, zlim= c(.5, 1.01),
         ylim= c(46.9, 47.31), col= inferno(256, alpha= 1))
    contour(hh[!is.na(over(hh, BArea)), i], add= TRUE, col= "white")
    plot(BArea, add= TRUE, lwd= 2) ; box()
    if (i== "por2") { title("Quadratic parametric")
    } else {
            title(paste0("Effective degree of freedom : ",
                         round(summary(gamold[[ i]])$edf[ 4], 2)))}
}
plot(hh[, "gam100"],
     what= "scale", scale.size = lcm(0.4), zlim= c(.5, 1),
     ylim= c(46.9, 47.31), col= inferno(256, alpha= 1))
dev.off()
#+end_src

*** OLD smoothed gam surfaces
**** New GIs

#+begin_src R
library(rgdal)
MapCom <- readOGR("Carto/", "MapCom")
library(maptools) ; library(sp)
Bord.Area <- unionSpatialPolygons(MapCom[MapCom$NOM_COMM!= "DIJON", ],
                                  rep(1, nrow(MapCom)- 1))
MCom <- spTransform(MapCom, CRS("+proj=longlat +ellps=WGS84"))
BArea <- spTransform(Bord.Area, CRS("+proj=longlat +ellps=WGS84"))
gl = gridlines(BArea, easts= c(4.7, 4.8, 4.9, 5),
               norths= c(47.0, 47.1, 47.2, 47.3))
gll = labels(gl)

load("Inter/AocRank.Rda")
RegRank <- subset(AocRank, AocRank$PAOC!= 0 &
                  !is.na(AocRank$DEM) & !is.na(AocRank$CODEg))
RegRank$AOCc <- ifelse(RegRank$GCRU== 1, 5,
                ifelse(RegRank$PCRU== 1, 4,
                ifelse(RegRank$VILL== 1 | RegRank$COMM== 1, 3,
                ifelse(RegRank$BOUR== 1, 2, 1))))
RegRank$RAYAT <- with(RegRank@data, (SOLAR- mean(SOLAR))/ sd(SOLAR))

RegRank$EXPO <- factor(ifelse(RegRank$ASPECT< 45, "0-45",
                       ifelse(RegRank$ASPECT< 90, "45-90",
                       ifelse(RegRank$ASPECT<135, "90-135",
                       ifelse(RegRank$ASPECT<180, "135-180",
                       ifelse(RegRank$ASPECT<225, "180-225",
                       ifelse(RegRank$ASPECT<270, "225-270",
                       ifelse(RegRank$ASPECT<315, "270-315", "315-360"))))))),
                       levels= c("0-45", "45-90", "90-135", "135-180",
                                 "180-225","225-270","270-315","315-360"))
RRank <- spTransform(RegRank, CRS("+proj=longlat +ellps=WGS84"))
SSank <- as(RRank, "data.frame")
RRank$X= SSank$coords.x1
RRank$Y= SSank$coords.x2

load("Inter/gamod2.Rda")
i= .1
GG <- data.frame(expand.grid(X= seq(min(RRank$X)- i,
                                    max(RRank$X)+ i, length.out= 100),
                             Y= seq(min(RRank$Y)- i,
                                    max(RRank$Y)+ i, length.out= 100)),
                 LIBCOM= "FIXIN", DEM= mean(RRank$DEM),
                 SLOPE= mean(RRank$SLOPE), RAYAT= 0, EXPO= "180-225")
GG$gam50 <- predict(gamod2[[1]], newdata= GG)
GG$gam100 <- predict(gamod2[[2]], newdata= GG)
GG$gam200 <- predict(gamod2[[3]], newdata= GG)
GG$gam300 <- predict(gamod2[[4]], newdata= GG)
GG$gam400 <- predict(gamod2[[5]], newdata= GG)
GG$gam500 <- predict(gamod2[[6]], newdata= GG)
GG$gam600 <- predict(gamod2[[7]], newdata= GG)


GG$gam50N <- (GG$gam50- min(GG$gam50))/ (max(GG$gam50)- min(GG$gam50))
GG$gam100N <- (GG$gam100- min(GG$gam100))/ (max(GG$gam100)- min(GG$gam100))
GG$gam200N <- (GG$gam200- min(GG$gam200))/ (max(GG$gam200)- min(GG$gam200))
GG$gam300N <- (GG$gam300- min(GG$gam300))/ (max(GG$gam300)- min(GG$gam300))
GG$gam400N <- (GG$gam400- min(GG$gam400))/ (max(GG$gam400)- min(GG$gam400))
GG$gam500N <- (GG$gam500- min(GG$gam500))/ (max(GG$gam500)- min(GG$gam500))
GG$gam600N <- (GG$gam600- min(GG$gam600))/ (max(GG$gam600)- min(GG$gam600))


## GRID DATA FRAME
hh <- SpatialPixelsDataFrame(GG[, c("X", "Y")], GG,
                             proj4string=CRS("+proj=longlat +ellps=WGS84"))

BORD <- list(sp.polygons, MCom, lwd= 2, col= "black", cex= 1.2)

par(mar = c(0, 0, 0, 0), mfrow= c(2, 3))
plot(as(BArea, "Spatial"), expandBB= c(.1, 0, 0, 0))
plot(gl, add= TRUE, col = grey(.8), lty= 2)
text(gll, col = grey(.5))
plot(MCom, add= TRUE)
library(viridis)
plot(hh[!is.na(over(hh, BArea)), "gam200N"],
     col= inferno(256, alpha= 1), add= TRUE)
contour(hh[!is.na(over(hh, BArea)), "gam100N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)

pdf("Figures/SmoothMap.pdf")
par(mar= c(0, 0, 0, 0))
plot(hh[!is.na(over(hh, BArea)), "gam100N"], col= inferno(256, alpha= 1))
contour(hh[!is.na(over(hh, BArea)), "gam100N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam200N"], col= inferno(256, alpha= 1))
contour(hh[!is.na(over(hh, BArea)), "gam200N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam300N"], col= inferno(256, alpha= 1))
contour(hh[!is.na(over(hh, BArea)), "gam300N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam400N"], col= inferno(256, alpha= 1))
contour(hh[!is.na(over(hh, BArea)), "gam400N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam500N"], col= inferno(256, alpha= 1))
contour(hh[!is.na(over(hh, BArea)), "gam500N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam600N"], col= inferno(256, alpha= 1))
contour(hh[!is.na(over(hh, BArea)), "gam600N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
dev.off()



library(RColorBrewer)

spplot(hh[!is.na(over(hh, BArea)), ], "gam50N")

spplot(hh[!is.na(over(hh, BArea)), ], "gam600N")

library(dichromat)
library(RColorBrewer)
spplot(hh[!is.na(over(hh, BArea)), ], "gam300N",
       col.regions= rev(brewer.pal(n = 9, name = "BuPu")))

my.palette <- brewer.pal(n = 9, name = "BuPu")

spplot(hh[!is.na(over(hh, BArea)), ], c("gam50N", "gam200N"),
       col.regions = plasma(256),
       panel = function(x,y, ...){ 
           panel.gridplot(x,y, ...) 
           sp.polygons(MCom, col=1,fill=0, lwd= 2)
       }) 

#+end_src

**** Old GIs

#+begin_src R
library(rgdal)
MapCom <- readOGR("Carto/", "MapCom")
library(maptools) ; library(sp)
Bord.Area <- unionSpatialPolygons(MapCom[MapCom$NOM_COMM!= "DIJON", ],
                                  rep(1, nrow(MapCom)- 1))
MCom <- spTransform(MapCom, CRS("+proj=longlat +ellps=WGS84"))
BArea <- spTransform(Bord.Area, CRS("+proj=longlat +ellps=WGS84"))
gl = gridlines(BArea, easts= c(4.7, 4.8, 4.9, 5),
               norths= c(47.0, 47.1, 47.2, 47.3))
gll = labels(gl)


load("Inter/gamod4.Rda")
i= .1
GG <- data.frame(expand.grid(X= seq(min(SRank$X)- i,
                                    max(SRank$X)+ i, length.out= 100),
                             Y= seq(min(SRank$Y)- i,
                                    max(SRank$Y)+ i, length.out= 100)),
                 LIBCOM= "FIXIN", DEM= mean(SRank$DEM),
                 SLOPE= mean(SRank$SLOPE), RAYAT= 0, EXPO= "180-225")
GG$gam50 <- predict(gamod4[[1]], newdata= GG)
GG$gam100 <- predict(gamod4[[2]], newdata= GG)
GG$gam200 <- predict(gamod4[[3]], newdata= GG)
GG$gam300 <- predict(gamod4[[4]], newdata= GG)
GG$gam400 <- predict(gamod4[[5]], newdata= GG)
GG$gam500 <- predict(gamod4[[6]], newdata= GG)
GG$gam600 <- predict(gamod4[[7]], newdata= GG)


GG$gam50N <- (GG$gam50- min(GG$gam50))   / (max(GG$gam50)- min(GG$gam50))
GG$gam100N <- (GG$gam100- min(GG$gam100))/ (max(GG$gam100)- min(GG$gam100))
GG$gam200N <- (GG$gam200- min(GG$gam200))/ (max(GG$gam200)- min(GG$gam200))
GG$gam300N <- (GG$gam300- min(GG$gam300))/ (max(GG$gam300)- min(GG$gam300))
GG$gam400N <- (GG$gam400- min(GG$gam400))/ (max(GG$gam400)- min(GG$gam400))
GG$gam500N <- (GG$gam500- min(GG$gam500))/ (max(GG$gam500)- min(GG$gam500))
GG$gam600N <- (GG$gam600- min(GG$gam600))/ (max(GG$gam600)- min(GG$gam600))


hh <- SpatialPixelsDataFrame(GG[, c("X", "Y")], GG,
                             proj4string=CRS("+proj=longlat +ellps=WGS84"))
class(GG)

BORD <- list(sp.polygons, MCom, lwd= 2, col= "black", cex= 1.2)

par(mar = c(0, 0, 0, 0), mfrow= c(2, 3))
plot(as(BArea, "Spatial"), expandBB= c(.1, 0, 0, 0))
plot(gl, add= TRUE, col = grey(.8), lty= 2)
text(gll, col = grey(.5))
plot(MCom, add= TRUE)
library(viridis)
plot(BArea)
plot(hh[!is.na(over(hh, BArea)), "gam200N"],
     col= inferno(256, alpha= 1), add= TRUE)
contour(hh[!is.na(over(hh, BArea)), "gam100N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)


pdf("Figures/SmoothMapOldGI.pdf")
par(mar= c(0, 0, 0, 0))
layout(rbind(c(1, 2, 3, 7),
             c(4, 5, 6, 7)), widths = c(4,4,4,.5))

plot(hh[!is.na(over(hh, BArea)), "gam100N"], what= "scale", zlim= c(.5,1))


plot(hh[!is.na(over(hh, BArea)), "gam100N"],
     xlim= c(4.65, 5.1), what= "image",
     ylim= c(46.9, 47.35), col= inferno(256, alpha= 1), zlim= c(.5, 1))
contour(hh[!is.na(over(hh, BArea)), "gam100N"], add= TRUE, col= "white")
plot(MCom, add= TRUE) ; title("yopla (normalized)") ; box()

plot(hh[!is.na(over(hh, BArea)), "gam200N"],
     col= inferno(256, alpha= 1), zlim= c(.5, 1))
contour(hh[!is.na(over(hh, BArea)), "gam200N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)

plot(hh[!is.na(over(hh, BArea)), "gam300N"],
     col= inferno(256, alpha= 1), zlim= c(.5, 1))
contour(hh[!is.na(over(hh, BArea)), "gam300N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam400N"],
     col= inferno(256, alpha= 1), zlim= c(.5, 1))
contour(hh[!is.na(over(hh, BArea)), "gam400N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam500N"],
     col= inferno(256, alpha= 1), zlim= c(.5, 1))
contour(hh[!is.na(over(hh, BArea)), "gam500N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
plot(hh[!is.na(over(hh, BArea)), "gam600N"],
     col= inferno(256, alpha= 1), zlim= c(.5, 1))
contour(hh[!is.na(over(hh, BArea)), "gam600N"], add= TRUE, col= "white")
plot(MCom, add= TRUE)
dev.off()

#+end_src

** Violon plot from prediction

   Alternative plots for the application

#+begin_src R
## overlay
p <- ggplot(Geo.Aoc@data, aes(factor(AOC), G900raw))
p <- p + geom_violin(aes(colour= "#1268FF"), alpha= 0.3)
q <- p + geom_violin(aes(y= G900cor, colour= "#3268FF"), alpha= 0.3)
q+ ylim(40, 100)

p <- ggplot(Geo.Aoc@data, aes(factor(AOC), GMONraw))
p <- p + geom_violin(aes(colour= "#1268FF"), alpha = 0.3)
q <- p + geom_violin(aes(y= GMONcor, colour= "#3268FF"), alpha= 0.3)
q+ ylim(40, 100)

## split
library(plyr)
revAOC <- c("1"= "Coteaux b.", "2"= "Bourgogne", "3"= "Village",
            "4"= "Premier cru", "5"= "Grand Cru")
cc <- rbind(
    data.frame(AOC= revalue(factor(Geo.Aoc$AOC), revAOC),
               Score= Geo.Aoc$G900raw,
               Pr= "Uncorrected: without communes fixed effects"),
    data.frame(AOC= revalue(factor(Geo.Aoc$AOC), revAOC),
               Score= Geo.Aoc$G900cor,
               Pr= "Corrected: with communes fixed effects"))

ggplot(cc, aes(factor(AOC), Score, fill= Pr))+
    geom_split_violin()+
    ylab("100-Point Vineyard Quality Score")+
    ylim(40, 100)+ theme_minimal()+ xlab("")+
    geom_split_violin(draw_quantiles = c(0.25, 0.5, 0.75))+
    theme(legend.justification=c(0, 1), legend.position=c(0, 1),
          legend.title = element_blank())
#ggsave("Figures/MainPlot.png")
#+end_src

* Tables
** Descriptive statistics

#+begin_src R :results value :exports code :file "Tables/StatDes.tex"
Reg.Ras$bgor <- ifelse(Reg.Ras$AOC== 1, 1, 0) 
Reg.Ras$bour <- ifelse(Reg.Ras$AOC== 2, 1, 0) 
Reg.Ras$vill <- ifelse(Reg.Ras$AOC== 3, 1, 0)
Reg.Ras$pcru <- ifelse(Reg.Ras$AOC== 4, 1, 0)
Reg.Ras$gcru <- ifelse(Reg.Ras$AOC== 5, 1, 0)
Reg.Ras$X0t45    <- ifelse(Reg.Ras$EXPO== "(-2,45]"   , 1, 0)
Reg.Ras$X45t90   <- ifelse(Reg.Ras$EXPO== "(45,90]"  , 1, 0)
Reg.Ras$X90t135  <- ifelse(Reg.Ras$EXPO== "(90,135]" , 1, 0)
Reg.Ras$X135t180 <- ifelse(Reg.Ras$EXPO== "(135,180]", 1, 0)
Reg.Ras$X180t225 <- ifelse(Reg.Ras$EXPO== "(180,225]", 1, 0)
Reg.Ras$X225t270 <- ifelse(Reg.Ras$EXPO== "(225,270]", 1, 0)
Reg.Ras$X270t315 <- ifelse(Reg.Ras$EXPO== "(270,315]", 1, 0)
Reg.Ras$X315t360 <- ifelse(Reg.Ras$EXPO== "(315,360]", 1, 0)
Reg.Ras$REGavt <- ifelse(Reg.Ras$AOC36lvl== "0", 1, 0)
Reg.Ras$VILavt <- ifelse(Reg.Ras$AOC36lvl== "3", 1, 0)
Reg.Ras$GCRavt <- ifelse(Reg.Ras$AOC36lvl== "5", 1, 0)
Reg.Ras$AREA <- Reg.Ras$AREA/ 1000
Reg.Ras$Altitude <- Reg.Ras$DEM/ 1000
Reg.Ras$Solar <- Reg.Ras$SOLAR/ 1000000

lab1 <- c("Acreage [1000 m$^2$]", "Elevation [1000 m]", "Slope [degree]",
          "Solar radiation [millions J]",
          "Longitude [degree]", "Latitude [degree]",
          "Actual GI [\\emph{Coteaux}]",
          "Actual GI [\\emph{Régional}]", "Actual GI [\\emph{Village}]",
          "Actual GI [\\emph{Premier Cru}]",
          "Actual GI [\\emph{Grand Cru}]",
          "1936 GI [\\emph{Régional}]", "1936 GI [\\emph{Village}]",
          "1936 GI [\\emph{Grand Cru}]",
          "Aspect [$0-45$]", "Aspect [$45-90$]", "Aspect [$90-135$]",
          "Aspect [$135-180$]", "Aspect [$180-225$]", "Aspect [$225-270$]",
          "Aspect [$270-315$]", "Aspect [$315-360$]") 
library(stargazer)          
stargazer(Reg.Ras@data[, c("AREA", "Altitude", "SLOPE", "Solar", "X", "Y",
                         "bgor", "bour", "vill", "pcru", "gcru",
                         "REGavt", "VILavt", "GCRavt",
                         "X0t45", "X45t90", "X90t135", "X135t180",
                         "X180t225", "X225t270", "X270t315", "X315t360")],
          covariate.labels= lab1, column.sep.width= "0pt", float= F,
	  digit.separate= c(0, 3))
#+end_src

#+RESULTS:
[[file:Tables/StatDes.tex]]

** Descriptive Presentation
*** Topographic

#+begin_src R :results value :exports code :file "Tables/StatDesP1.tex"
load("Inter/GeoRas.Rda") ; library(sp)
GR84 <- spTransform(Geo.Ras, CRS("+proj=longlat +ellps=WGS84"))
dd <- coordinates(GR84)
Geo.Ras$X= dd[, 1] ; Geo.Ras$Y= dd[, 2]
Reg.Ras <- subset(Geo.Ras, !is.na(AOClb) & !is.na(DEM) & !is.na(DESCR)
                  & !is.na(RUD) & !is.na(AOC36lab) & !is.na(REGION))
Reg.Ras$EXPO <- factor(ifelse(Reg.Ras$ASPECT< 45, "0-45",
                       ifelse(Reg.Ras$ASPECT< 90, "45-90",
                       ifelse(Reg.Ras$ASPECT<135, "90-135",
                       ifelse(Reg.Ras$ASPECT<180, "135-180",
                       ifelse(Reg.Ras$ASPECT<225, "180-225",
                       ifelse(Reg.Ras$ASPECT<270, "225-270",
                       ifelse(Reg.Ras$ASPECT<315, "270-315", "315-360"))))))),
                       levels= c("0-45", "45-90", "90-135", "135-180",
                                 "180-225","225-270","270-315","315-360"))

Reg.Ras$X0t45    <- ifelse(Reg.Ras$EXPO== "0-45"   , 1, 0)
Reg.Ras$X45t90   <- ifelse(Reg.Ras$EXPO== "45-90"  , 1, 0)
Reg.Ras$X90t135  <- ifelse(Reg.Ras$EXPO== "90-135" , 1, 0)
Reg.Ras$X135t180 <- ifelse(Reg.Ras$EXPO== "135-180", 1, 0)
Reg.Ras$X180t225 <- ifelse(Reg.Ras$EXPO== "180-225", 1, 0)
Reg.Ras$X225t270 <- ifelse(Reg.Ras$EXPO== "225-270", 1, 0)
Reg.Ras$X270t315 <- ifelse(Reg.Ras$EXPO== "270-315", 1, 0)
Reg.Ras$X315t360 <- ifelse(Reg.Ras$EXPO== "315-360", 1, 0)
Reg.Ras$Area <- Reg.Ras$AREA/ 10000
Reg.Ras$Altitude <- Reg.Ras$DEM/ 1000
Reg.Ras$Solar <- Reg.Ras$SOLAR/ 1000000

lab1 <- c("Acreage [hectare]", "Elevation [1000 m]", "Slope [degree]",
          "Solar radiation [MJ]", "Longitude [degree]","Latitude [degree]",
          "Aspect [$0-45$]", "Aspect [$45-90$]", "Aspect [$90-135$]",
          "Aspect [$135-180$]", "Aspect [$180-225$]", "Aspect [$225-270$]",
          "Aspect [$270-315$]", "Aspect [$315-360$]") 
library(stargazer)          
stargazer(Reg.Ras@data[, c("Area", "Altitude", "SLOPE", "Solar", "X", "Y",
                         "X0t45", "X45t90", "X90t135", "X135t180",
                         "X180t225", "X225t270", "X270t315", "X315t360")],
          covariate.labels= lab1, column.sep.width= "0pt", float= F,
	  digit.separate= c(0, 3))
#+end_src

#+RESULTS:
[[file:Tables/StatDesP1.tex]]

*** GIs

#+begin_src R :results value :exports code :file "Tables/StatDesP2.tex"
library(plyr) ; library(xtable)
AOCtab <- revalue(factor(Reg.Ras$AOC),
                  c("1"= "Coteaux b.", "2"= "Bourgogne",
                    "3"= "Village", "4"= "Premier Cru",
                    "5"= "Grand Cru"))
print(xtable(rbind(round(table(AOCtab)),
                   round(table(AOCtab)/ length(AOCtab)* 100, 1))),
      include.rownames= F)
#+end_src

#+RESULTS:
[[file:Tables/StatDesP2.tex]]

** Variable significance New AOCs

#+begin_src R :results value :exports code :file "Tables/VarSign1.tex"
load("Inter/gamod.Rda") ; load("Inter/gammod.Rda")
sign <- function(x) paste0(format(x,digits=5,big.mark=" "), "$^{**}$")
eedf <- function(x) paste0("[ ", format(x,digits=4), " ]")
ligne1 <- c(res1[5: 7, "LR Chisq"], res1a[2, 6],
            res1[ 4: 1, "LR Chisq"], nrow(Reg.Ras),
            1-(logLik(polm1)/ logLik(update(polm1, . ~ + 1))),
            sum(diag(table(predict(polm1), Reg.Ras$AOC)))/nrow(Reg.Ras),
            AIC(polm1), mean(wal1))
lig1 <- c(res1[5: 7, "Df"], res1a[2, "   Df"], res1[ 4: 1, "Df"])

ligneGAM <- function(numMod){
    res= anova(gamod[[ numMod]])
    prd= predict(gamod[[ numMod]], type= "response")
    mpb= factor(c(1: 5)[apply(prd, 1, which.max)], levels= 1:5, ordered= T)
    pp <- c(sign(res$chi.sq[ 1]), eedf(res$edf[ 1]),
            sign(res$chi.sq[ 2]), eedf(res$edf[ 2]),
            sign(res$chi.sq[ 3]), eedf(res$edf[ 3]),
            sign(res$chi.sq[ 4]), eedf(res$edf[ 4]),
            sign(res$pTerms.chi.sq[ 4]), eedf(res$pTerms.df[ 4]),
            sign(res$pTerms.chi.sq[ 3]), eedf(res$pTerms.df[ 3]),
            sign(res$pTerms.chi.sq[ 2]), eedf(res$pTerms.df[ 2]),
            sign(res$pTerms.chi.sq[ 1]), eedf(res$pTerms.df[ 1]),
            format(round(nrow(Reg.Ras), 0), big.mark=" "),
            round((1-logLik(gamod[[ numMod]])/
                   logLik(update(gamod[[ numMod]],.~ + 1)))* 100, 2),
            round(sum(diag(table(Reg.Ras$AOC, mpb)))/
                  nrow(Reg.Ras)* 100, 2),
            round(AIC(gamod[[ numMod]])/ 1000, 2),
            round(wal2[2, names(gamod[ numMod])], 2))
    return(pp)
}

## library(mgcv)
## Tabb <- data.frame(c("Elevation" , "", "Slope", "", "Solar Radiation", "",
##                      "Spatial Coords", "", "Pedology", "", "Geology", "",
##                      "Exposition", "", "Commune", "",
##                      "Nb Observ.", "McFadden R$^2$", "Pc good pred.",
##                      "Akaike IC", "Surrogate F"),
##                    c(sign(ligne1[ 1]), eedf(lig1[ 1]),
##                      sign(ligne1[ 2]), eedf(lig1[ 2]),
##                      sign(ligne1[ 3]), eedf(lig1[ 3]),
##                      sign(ligne1[ 4]), eedf(lig1[ 4]),
##                      sign(ligne1[ 5]), eedf(lig1[ 5]),
##                      sign(ligne1[ 6]), eedf(lig1[ 6]),
##                      sign(ligne1[ 7]), eedf(lig1[ 7]),
##                      sign(ligne1[ 8]), eedf(lig1[ 8]),
##                      format(round(ligne1[ 9], 0), big.mark=" "),
##                             round(ligne1[ 10]* 100, 2),
##                      round(ligne1[ 11]* 100, 2), round(ligne1[ 12]/1000),
##                      round(ligne1[ 13], 2)), lapply(1: 5* 2, ligneGAM))

names(Tabb) <- c("Variable", "( 0 )", "( I )", "( II )",
                 "( III )", "( IV )", " ( V )")
library(xtable)
print(xtable(Tabb, alig= "llYYYYYY"), hline.after = NULL,
      include.rownames= F,
      add.to.row = list(pos = list(-1, 0, 16, nrow(Tabb)),
          command = c("\\hline\\hline\\toprule\n", rep("\\midrule\n", 2),
                      "\\bottomrule\\hline\n")),
      tabular.environment = "tabularx", width="\\textwidth",
      sanitize.text.function = identity, floating= F)
#+end_src

#+RESULTS:
[[file:Tables/VarSign1.tex]]

** Variable significance Old AOCs

#+begin_src R :results value :exports code :file "Tables/VarSign2.tex"
load("Inter/gamold.Rda") ; load("Inter/gammold.Rda")
ligne2 <- c(res2[5: 7, "LR Chisq"], res2a[2, 6], res2[ 4: 1, "LR Chisq"],
            nrow(Reg.Old), 1-(logLik(polm2)/logLik(update(polm2,. ~ + 1))),
            sum(diag(table(predict(polm2), Reg.Old$AOCo)))/ nrow(Reg.Old),
            AIC(polm2), mean(wal3))
lig2 <- c(res2[5: 7, "Df"], res2a[2, "   Df"], res2[ 4: 1, "Df"])

oldigneGAM <- function(numMod){
    res= anova(gamold[[ numMod]])
    prd= predict(gamold[[ numMod]], type= "response")
    mpb= factor(c(1: 3)[apply(prd, 1, which.max)], levels= 1:3, ordered= T)
    pp <- c(sign(res$chi.sq[ 1]), eedf(res$edf[ 1]),
            sign(res$chi.sq[ 2]), eedf(res$edf[ 2]),
            sign(res$chi.sq[ 3]), eedf(res$edf[ 3]),
            sign(res$chi.sq[ 4]), eedf(res$edf[ 4]),
            sign(res$pTerms.chi.sq[ 4]), eedf(res$pTerms.df[ 4]),
            sign(res$pTerms.chi.sq[ 3]), eedf(res$pTerms.df[ 3]),
            sign(res$pTerms.chi.sq[ 2]), eedf(res$pTerms.df[ 2]),
            sign(res$pTerms.chi.sq[ 1]), eedf(res$pTerms.df[ 1]),
            format(round(nrow(Reg.Old), 0), big.mark=" "),
            round((1-logLik(gamold[[ numMod]])/
                   logLik(update(gamold[[ numMod]],.~ + 1)))* 100, 2),
            round(sum(diag(table(Reg.Old$AOCo, mpb)))/nrow(Reg.Old)*100,2),
            round(AIC(gamold[[ numMod]])/ 1000, 2),
            round(wal4[2, names(gamold[ numMod])], 2))
    return(pp)
}

## Tabo <- data.frame(c("Elevation" , "", "Slope", "", "Solar Radiation", "",
##                      "Spatial Coords", "", "Pedology", "", "Geology", "",
##                      "Exposition", "", "Commune", "",
##                      "Nb Observ.", "McFadden R$^2$", "Pc good pred.",
##                      "Akaike IC", "Surrogate F"),
##                    c(sign(ligne2[ 1]), eedf(lig2[ 1]),
##                      sign(ligne2[ 2]), eedf(lig2[ 2]),
##                      sign(ligne2[ 3]), eedf(lig2[ 3]),
##                      sign(ligne2[ 4]), eedf(lig2[ 4]),
##                      sign(ligne2[ 5]), eedf(lig2[ 5]),
##                      sign(ligne2[ 6]), eedf(lig2[ 6]),
##                      sign(ligne2[ 7]), eedf(lig2[ 7]),
##                      sign(ligne2[ 8]), eedf(lig2[ 8]),
##                      format(round(ligne2[ 9], 0), big.mark=" "),
##                             round(ligne2[ 10]* 100, 2),
##                      round(ligne2[ 11]* 100, 2), round(ligne2[ 12]/1000),
##                      round(ligne2[ 13], 2)),
##                    lapply(c(2, 3, 5, 6, 7), oldigneGAM))

names(Tabo) <- c("Variable", "( 0 )", "( I )", "( II )",
                 "( III )", "( IV )", " ( V )")
library(xtable)
print(xtable(Tabo, alig= "llYYYYYY"), hline.after = NULL,
      include.rownames= F,
      add.to.row = list(pos = list(-1, 0, 16, nrow(Tabo)),
          command = c("\\hline\\hline\\toprule\n", rep("\\midrule\n", 2),
                      "\\bottomrule\\hline\n")),
      tabular.environment = "tabularx", width="\\textwidth",
      sanitize.text.function = identity, floating= F)

#+end_src

#+RESULTS:
[[file:Tables/VarSign2.tex]]

** Decomposition New AOC

#+begin_src R :results value :exports code :file "Tables/Decomp.tex"
load("Inter/gamod.Rda") ; source("myFcts.R") ; library(xtable)
## ddtt <- data.frame(AOC= Reg.Ras$AOC, LIBCOM= Reg.Ras$LIBCOM,
##                    sapply(gamod[ 1: 5* 2], function(x)
##                        rowSums(predict(x, type= 'terms')[, -1])))
decomp <- sapply(names(ddtt[, 3: 7]), function(x)
    c(Signal= var(ddtt[, x]), Noise= pi^2/ 3,
      jointSignal(ddtt, x), jointNoise(ddtt, x),
      vertiSignal(ddtt, x), vertiResid(ddtt, x), vertiNoise(ddtt, x),
      horizSignal(ddtt, x), horizResid(ddtt, x), horizNoise(ddtt, x)))
yop <- data.frame(Decomp.= c("Total", "", "Joint", "",
                             "Vertical", "", "", "Horizontal", "", ""),
                  Term= c(rep(c("Signal", "Noise"), 2),
                       rep(c("Signal", "Residual", "Noise"), 2)),
                  t(t(decomp)/ (pi^2/ 3+ decomp[1, ]))* 100)
names(yop)[ 3: 7] <- paste0("(", sapply(gamod[ 1: 5* 2], function(x)
    round(summary(x)$edf[ 4])), ")")
ctmp <- "\\hline\\hline\\toprule\n&& \\multicolumn{5}{c}{\\emph{Effective degrees of freedom for spatial smoothing}}\\\\[.25cm]\n"
print(xtable(yop, align= c("@{\\extracolsep{\\fill}} l", rep("X", 7))),
      add.to.row= list(pos= list(-1, 0, 2, 4, 7, 10),
                       command= c(ctmp, rep("\\midrule\n", 4),
                                  "\\bottomrule\\hline\n")),
      tabular.environment= "tabularx", width= "\\textwidth",
      include.rownames= FALSE, hline.after = NULL, floating= FALSE)
#+end_src

#+RESULTS:
[[file:Tables/Decomp.tex]]

** Decomposition Counterfactual AOC

#+begin_src R :results value :exports code :file "Tables/Decoldmp.tex"
library(xtable)
yap <- data.frame(Decomp.= c("Total", "", "Joint", "",
                             "Vertical", "", "", "Horizontal", "", ""),
                  Term= c(rep(c("Signal", "Noise"), 2),
                          rep(c("Signal", "Residual", "Noise"), 2)),
                  t(apply(decf, 1, function(x)x/(pi^2/3+ decf[1,])* 100)))
names(yap)[ 3: 10] <- c("1936", "S.0", "S.I", "S.II", "S.III",
                        "S.IV", "S.V", "S.VI")
ctmp <- "\\hline\\hline\\toprule\n&& \\multicolumn{7}{c}{\\emph{Alternative scenarios of GI designations}}\\\\[.25cm]\n"
print(xtable(yap, align= c("@{\\extracolsep{\\fill}} l", "l", "l", rep("X", 8))),
      add.to.row= list(pos= list(-1, 0, 2, 4, 7, 10),
                       command= c(ctmp, rep("\\midrule\n", 4),
                                  "\\bottomrule\\hline\n")),
      tabular.environment= "tabularx", width= "\\textwidth",
      include.rownames= FALSE, hline.after = NULL, floating= FALSE)
#+end_src

#+RESULTS:
[[file:Tables/Decoldmp.tex]]

* Bibliography
  :PROPERTIES:
  :EXPORT_FILE_NAME:    Biblio.pdf
  :EXPORT_LATEX_CLASS:  ManueBibt
  :EXPORT_OPTIONS:      TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc toc:nil H:2
  :EXPORT_LATEX_HEADER: \usepackage{hyperref, xcolor} \hypersetup{colorlinks=true, linkcolor=red, urlcolor=blue, citecolor=gray} \usepackage[utf8]{inputenc} \usepackage[T1]{fontenc} 
  :EXPORT_AUTHOR:       \textsc{Bibliography}
  :END:
** Bourgogne specific
*** cite:Jull16 [[file:Biblio/Trie/Jull16.pdf][Book: Jullien 1816]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{Jull16,
  TITLE = {Topographie de tous les vignobles connus},
  SUBTITLE = {Contenant leur position géographique, l'indication du
                  genre et de la qualité des produits de chaque cru,
                  les lieux ou se font les chargement et le principal
                  commerce des vins, le nom et la capacité des
                  tonneaux et des mesures en usage, les moyens de
                  transaport ordinairement employés, les tarifs des
                  douanes de France et des pays étrangers, etc.},
  AUTHOR = {Jullien, André},
  YEAR = {1816},
  PUBLISHER = {Colas, Paris},
}
#+end_src

- Partie Bourguignone [[pdfview:/home/jsay/geoIndic/Biblio/Trie/Jull16.pdf::133][ici]], distingue les départements.
- Rien sur Gigondas, se comprend avec la date.

*** cite:More31 [[file:Biblio/Trie/More31.pdf][Book: Morelot 1831]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{More31,
  TITLE = {Statistique de la vigne dans le département de la Côte
                  d'Or},
  AUTHOR = {Morelot, Denis},
  YEAR = {1831},
  PUBLISHER = {Lagier, Dijon},
}
#+end_src

- Une autre proposition de désignation
- Des statistiques sur les surfaces et les productions communales et
  les revenus imposables

*** cite:Dion52 [[file:Biblio/Trie/Dion52.pdf][Annales: Dion qualité]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Dion52,
  title={Querelle des anciens et des modernes sur les facteurs de la qualit{\'e} du vin},
  author={Dion, Roger},
  journal={Annales de g{\'e}ographie},
  volume={61},
  number={328},
  pages={417--431},
  year={1952}
}
#+end_src

*** cite:Lava55 [[file:Biblio/Trie/Lava55.pdf][Book: Lavalle 1855]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{Lava55,
  TITLE = {Histoire et statistique de la vigne et des grands vins de
                  la Côte d'Or},
  AUTHOR = {Lavalle, Jules},
  YEAR = {1855},
  PUBLISHER = {Daumier, Dijon},
}
#+end_src

    Il y a les dates de vendange sur longue période au début.

    Le Dr Jules Lavalle a rédigé ‘Histoire de la Statistique de la
    Vigne et des Grands Vins de la Côte d’Or’ en 1855. L’ouvrage est
    une référence majeure car il contient le premier essai de
    classement complet des climats de la Côte d’Or. Ce classement est
    réalisé par finage. Pour chacun, les climats sont catégorisés
    selon leur mérite en vertu d’un système comportant jusqu’à cinq
    classes: Tête de Cuvée (parfois ‘Hors Ligne’ selon le contexte,
    comme pour le Clos de Vougeot), Première/Seconde/Troisième/ et
    Quatrième Cuvée. Sur un aspect délicat de son classement, celui de
    l’éventuelle comparaison des classes identiques entre les communes
    par le lecteur, Jules Lavalle écrit "Je n’ai étudié les vins de
    chacune des communes de la Côte comme si les autres communes
    n’eussent pas existé et la classification que j’ai donnée n’est
    vrai que pour chacune d’elles prises isolément." (p.162) Le
    monumental travail de Jules Lavalle contient aussi le premier
    exercice, rigoureux, de cartographie de La Côte.  Il fut
    professeur à l’école de médecine de Dijon, directeur du Jardin
    botanique de cette ville, secrétaire de la Société d’Horticulture
    de la Côte d’Or et membre de la Société géologique de France.

*** cite:Dang92 [[file:Biblio/Trie/Dang92.pdf][Book: Danguy 1892]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{Dang92,
  TITLE = {Les grands vins de Bourgogne (la Côte d'Or)},
  SUBTITLE = {Étude et classement par ordre de mérite},
  AUTHOR = {Danguy, René and Aubertin, Charles},
  YEAR = {1892},
  PUBLISHER = {Librairie H. Armand, Dijon},
}
#+end_src

- Quelques photos sur les bâtiments 
- Partie sur Marsannay [[pdfview:/home/jsay/geoIndic/Biblio/Trie/Dang92.pdf::677][ici]]
- Déjà l'idée d'une catégorisation mais semble moins central que dans
  les autres livres de l'époque. Ce sont surtout les noms des
  propriétaires qui sont importants.

*** cite:Capu47 [[file:Biblio/Trie/Capu47.pdf][Book: Capus 1947]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Capu47,
  title={L'{\'E}volution de la l{\'e}gislation sur les appellations
                  d'origine. Gen{\`e}se des appellations
                  contr{\^o}l{\'e}es},
  author={Capus, Joseph},
  year={1947},
  publisher={L. Larmat}
}
#+end_src

- yop

*** cite:Chre00 [[file:Biblio/Trie/Chre00.pdf][Référentiel Pédo]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Chre00,
  title={R{\'e}f{\'e}rentiel p{\'e}dologique de Bourgogne {\`a}
                  1/250000(r{\'e}gions naturelles, p{\'e}dopaysages et
                  sols de la C{\^o}te-d'Or)},
  author={Chr{\'e}tien, Jean},
  year={2000},
  publisher={Institut national de la recherche agronomique, Centre de
                  recherche d'Orl{\'e}ans}
}
#+end_src

- Référentiel pédologique de Bourgogne
- Pas de pdf

*** cite:JLaf06 [[file:Biblio/Trie/JLaf06.pdf][AHSS: Équivalences au XIXe]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{JLaf06,
  title={Le contr{\^o}le r{\'e}publicain du march{\'e}: vignerons et
                  n{\'e}gociants sous la Troisi{\`e}me R{\'e}publique},
  author={Jacquet, Olivier and Lafert{\'e}, Gilles},
  journal={Annales. Histoire, sciences sociales},
  volume={61},
  number={5},
  pages={1147-1170},
  year={2006},
  publisher={Cambridge University Press}
}
#+end_src

- La liste des "communes porte drapeau" en note de bas de page mais
  assez "molle" selon Gilles

*** cite:Coat08 [[file:Biblio/Trie/Coat08.pdf][Book: Wines of Burgundy]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Coat08,
  title={The wines of Burgundy},
  author={Coates, Clive},
  year={2008},
  publisher={Univ of California Press}
}
#+end_src

- Bouquin précis sur les Grand crus Bourguignons.
- Pas de pdf

*** cite:Jacq09 [[file:Biblio/Trie/Jacq09.pdf][Book: Construction vignoble]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Jacq09,
  title={Un si{\`e}cle de construction du vignoble bourguignon. Les
                  organisations vitivinicoles de 1884 aux AOC},
  author={Jacquet, Olivier},
  year={2009},
  publisher={Editions Universitaires de Dijon}
}
#+end_src

- Le rôle des organisations syndicales, citation importante pour les
  biais communaux dans les désignations

*** cite:Norm10 [[file:Biblio/Trie/Norm10.pdf][Book: Grand crus]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Norm10,
  title={Grand Cru: The Great Wines of Burgundy Through the
                  Perspective of Its Finest Vineyards},
  author={Remington Norman},
  year={2010},
  publisher={Kyle Cathie},
  pages={p. 240}
}
#+end_src

- Bouquin précis sur les Grand crus Bourguignons.
- Pas de pdf

*** cite:Morr10 [[file:Biblio/Trie/Morr10.pdf][Book: Inside burgundy]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Morr10,
  title={Inside Burgundy: The Vineyards, the Wine \& the People},
  author={Morris, Jasper},
  year={2010},
  publisher={Berry Bros. \& Rudd Press}
}
#+end_src

- Bouquin précis sur les Grand crus Bourguignons.
- Pas de pdf

*** cite:WJac11 [[file:Biblio/Trie/Papier.pdf][Book: Wolikow et Jacquet]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{WJac11,
  TITLE = {Territoires et terroirs du vin du XVIIIe au XXIe siècles},
  SUBTITLE = {Approche internationale d'une construction historique},
  AUTHOR = {Wolikow, Serge and Jacquet, Olivier},
  YEAR = {2011},
  PUBLISHER = {Éditions Universitaires de Dijon},
}
#+end_src

  Les chapitres qui concernent la Bourgogne et peuvent m'intéresser:

- Jules Guyot... de Christophe Lucand. Il situe l'apparition des AOC
  liée au commerce (XIXe) pour identifier des type de goût (il y a
  même preuve de retours de bouteilles si ça ne correspond pas). Il
  parle de passage du territoire commercial au terroir. Ce n'est que
  suite au Phylloxéra que la protection contre la fraude apparaît,
  arrive alors la réglementation.  
- La justification des usages... d'Olivier Jacquet. Il analyse le
  jugement de 1930, avec en particulier les apports du syndicat des
  producteurs qui ont a priori été écoutés. Les 3 auteurs les plus
  cités reviennent, et il y a en plus des données sur les prix, il
  faudrait que je parle avec Olivier de l'exploitation de ces données.
- Quand le cadastre... de Charlotte Fromont. Liste de bonne manière
  les principales utilisations qui pourraient être faites du cadastre
  Napoléonien et des matrices cadastrales sur les propriétaires en
  particulier. Seulement à partir de petites études de cas, il
  faudrait prendre des nouvelles sur la généralisation potentielle.
- De l'intérêt de spatialiser... Garcia et al. Le moulinage de données
  au travers d'un MNT quelques idées/ intuitions mais un travail qui
  n'est pas allé plus loin que la thèse il me semble. Voir les travaux
  qui suivent de Garcia.
- Délimitations AOC entre usage et milieu... Vincent et al. Un peu la
  position de l'INAO sur les délimitations, intéressant pour le
  discours officiel.

*** cite:LLPi14 [[file:Biblio/Trie/WJac11.pdf][Book: Climats et lieux-dits]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{LLPi14,
  TITLE = {Climats et lieux-dits des grands vignobles de {B}ourgogne},
  SUBTITLE = {Atlas et histoire des noms de lieux},
  AUTHOR = {{Landrieu-Lussigny}, Marie-Hélène and Pitiot, Sylvain},
  YEAR = {2014},
  PUBLISHER = {Éditions de Monza et du Meurger},
}
#+end_src

*** cite:Bazi15 [[file:Biblio/Trie/Bazi15.pdf][Book: Vin de Bourgogne]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Bazi15,
  title={Le vin de Bourgogne},
  author={Bazin, Jean-Fran{\c{c}}ois},
  year={2015},
  publisher={Dunod Editions}
}
#+end_src

- Livre de référence sur les vins en Francais
- pas de pdf

*** cite:Garc10 [[file:Biblio/Trie/Garc10.pdf][lien avec Dion]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Garc10,
  title={Données nouvelles pour l’histoire de la construction des
                  terroirs viticoles de Bourgogne, cinquante ans après
                  l’oeuvre de Roger Dion},
  author={Garcia, Jean-Pierre},
  year={2010},
  publisher={Le bon vin entre terroir, savoir-faire et savoir-boire :
                  actualité de la pensée de Roger Dion, Paris : CNRS
                  Editions, p. 287-303}
}
#+end_src

    Données nouvelles pour l’histoire de la construction des terroirs
    viticoles de Bourgogne, cinquante ans après l’oeuvre de Roger Dion
    
    Discussion entre déterminants naturels, histoire de pentes et de
    déplacement du vignoble. Même graphique qu'Olivier sur les
    organisations vini-viticoles en meilleure résolution.

*** cite:Humb11 [[file:Biblio/Trie/Humb11.pdf][Thèse Florian]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@phdthesis{Humb11,
  title={L'INAO, de ses origines {\`a} la fin des ann{\'e}es 1960:
                  gen{\`e}se et {\'e}volutions du syst{\`e}me des vins
                  d'AOC},
  author={Humbert, Florian},
  year={2011},
  school={Universit{\'e} de Bourgogne}
}
#+end_src


    La construction des climats viticoles en Bourgogne, la relation du
    vin au lieu au Moyen Âge
    
    Publication un peu plus sérieuse que les autres.

*** cite:Ay11   [[file:Biblio/Trie/Ay11.pdf][Thèse jsay]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@phdthesis{Ay11,
  TITLE = {Hétérogénéité de la terre et rareté économique},
  AUTHOR = {Ay, Jean-Sauveur},
  URL = {https://tel.archives-ouvertes.fr/tel-00629142},
  SCHOOL = {{Universit{\'e} de Bourgogne}},
  YEAR = {2011},
  MONTH = Jul,
  TYPE = {Theses},
  PDF = {https://tel.archives-ouvertes.fr/tel-00629142/file/THESE.pdf},
  HAL_ID = {tel-00629142},
  HAL_VERSION = {v1},
}
#+end_src

*** cite:Garc11 [[file:Biblio/Trie/Garc11.pdf][Book: Patrimoine mondial]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Garc11,
  title={Les \emph{climats} du vignoble de {B}ourgogne comme
                  patrimoine mondial de l'humanit{\'e}},
  author={Garcia, Jean-Pierre},
  year={2011},
  publisher={Ed. Universitaires de Dijon}
}
#+end_src

    Les mêmes figures que précédemment. Diapos pour le dossier de
    classement: [[file:Biblio/Trie/diapo1.pdf][Diapo 1]] ; [[file:Biblio/Trie/diapo2.pdf][Diapo 2]] ; [[file:Biblio/Trie/diapo3.pdf][Diapo 3]] ; [[file:Biblio/Trie/diapo4.pdf][Diapo 4]].

*** cite:Garc14 [[file:Biblio/Trie/Garc14.pdf][ACRH: Climats moyen âge]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Garc14,
  title={La construction des climats viticoles en {B}ourgogne, la
                  relation du vin au lieu au {M}oyen {Â}ge},
  author={Jean-Pierre Garcia},
  journal={Atelier du Centre de Recherches Historiques},
  volume={12},
  pages={22 p},
  year={2014},
  publisher={http://journals.openedition.org/acrh/5979}
}
#+end_src


    La construction des climats viticoles en Bourgogne, la relation du
    vin au lieu au Moyen Âge
    
    Publication un peu plus sérieuse que les autres.

*** cite:DChe15 [[file:Biblio/Trie/DChe15.pdf][Cyber : Dion vivant]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{DChe15,
  title={Roger Dion, toujours vivant!},
  author={Delay, Etienne and Chevallier, Marius},
  journal={Cybergeo: European Journal of Geography},
  year={2015},
  publisher={CNRS-UMR G{\'e}ographie-cit{\'e}s 8504}
}
#+end_src

*** Garcia 2018, [[file:Biblio/Trie/Garc18.pdf][InBook: Construction noms]] 

    La pérennisation par la remotivation des lieux, des mots et des
    choses de la Bourgogne viticole, in : Bourgogne(s) viticole(s) –
    Enjeux et perspectives historiques d’un territoire (S. Wolikow et
    O. Jacquet, dir.), Dijon, EUD, 2018, p. 145-152.

    Le concept de climat au cours du temps. Proche de la publi GLGr17
    ci-dessous.

*** Garcia et Labbé 2017 [[file:Biblio/Trie/GLGr17.pdf][Concept de Climat]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GGLa17,
  title={Terroirs, climats ... ou le vin et le lieu en Bourgogne},
  author={Jean-Pierre Garcia, Guillaume Grillon, Thomas Labbé},
  journal={HAL},
  volume={01574896},
  year={2017}
}
#+end_src

    proche de ce qui suit Garc16

*** cite:WJac18 [[file:Biblio/Trie/Papier.pdf][Book: Wolikow et Jacquet 2018]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{WJac18,
  title={Bourgogne(s) viticole(s) : Enjeux et perspectives historiques
                  d'un territoire},
  author={Wolikow, Serge and Jacquet, Olivier},
  year={2018},
  publisher={{\'E}ditions Universitaires de Dijon}
}
#+end_src

*** cite:LPBR19 [[file:Biblio/Trie/LPBR19.pdf][CPD: Longues séries climat]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@Article{LPBR19,
AUTHOR = {Labb\'e, T. and Pfister, C. and Br\"onnimann, S. and
                  Rousseau, D. and Franke, J. and Bois, B.},
TITLE = {The longest homogeneous series of grape harvest dates, Beaune
                  1354--2018, and its significance for the
                  understanding of past and present climate},
JOURNAL = {Climate of the Past Discussions},
VOLUME = {2019},
YEAR = {2019},
PAGES = {1--33},
URL = {https://www.clim-past-discuss.net/cp-2018-179/},
DOI = {10.5194/cp-2018-179}
}
#+end_src

- yop

*** cite:Ay19 [[file:WorkingPaper.pdf][AAWE: Geographical content]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Ay19,
  title={The informational content of geographical indications},
  author={Ay, Jean-Sauveur},
  journal={AAWE Working Paper n XXX},
  year={2019},
  publisher={http://journals.openedition.org/acrh/5979}
}
#+end_src


    La construction des climats viticoles en Bourgogne, la relation du
    vin au lieu au Moyen Âge
    
    Publication un peu plus sérieuse que les autres.

** Geographical Indications
*** cite:Coes98 [[file:Biblio/Trie/Coes98.pdf][AES: Certification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Coes98,
  title={Asym{\'e}trie de l'information, r{\'e}putation et certification},
  author={Coestier, B{\'e}n{\'e}dicte},
  journal={Annales d'{\'e}conomie et de statistique},
  pages={49--78},
  year={1998},
  publisher={JSTOR}
}
#+end_src

- yop

*** cite:HMDO99 [[file:Biblio/Trie/HMDO99.pdf][AJAE: Choice of grade]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{HMDO99,
  title={Pleasures of cockaigne: Quality gaps, market structure, and
                  the amount of grading},
  author={Hollander, Abraham and Monier-Dilhan, Sylvette and Ossard,
                  Herve},
  journal={American Journal of Agricultural Economics},
  volume={81},
  number={3},
  pages={501--511},
  year={1999},
  publisher={Oxford University Press}
}
#+end_src

- Choix d'adoption des grade

*** cite:MCSc99 [[file:Biblio/Trie/MCSc99.pdf][ERAE: Cartel welfare improving]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MCSc99,
  title={The role of common labelling in a context of asymmetric
                  information},
  author={Marette, Stephan and Crespi, John M and Schiavina,
                  Alessandra},
  journal={European Review of Agricultural Economics},
  volume={26},
  number={2},
  pages={167--178},
  year={1999},
  publisher={Oxford University Press}
}
#+end_src

- Cartel welfare improving

*** cite:CLVi00 [[file:Biblio/Trie/CLVi00.pdf][AE: Hedonic Burgundy]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CLVi00,
  title={Estimation of a hedonic price equation for {B}urgundy wine},
  author={Combris, Pierre and Lecocq, S{\'e}bastien and Visser,
                  Michael},
  journal={Applied Economics},
  volume={32},
  number={8},
  pages={961--967},
  year={2000},
  publisher={Taylor \& Francis}
}
#+end_src

- Modele hedoniques sur le prix des bouteilles en Bourgogne.
- Des effets à la fois des caractéristiques objectives mais aussi des
  AOCs.
- Bonne citation pour localiser le Bourgogne

*** cite:LPer00 [[file:Biblio/Trie/LPer00.pdf][RE: Signe de qualité]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{LPer00,
  title={Une analyse {\'e}conomique des" signes de
                  qualit{\'e}". Labels et certification des produits},
  author={Linnemer, Laurent and Perrot, Anne},
  journal={Revue {\'e}conomique},
  volume={51},
  number={6},
  pages={1397--1418},
  year={2000},
  publisher={Presses de Science Po}
}
#+end_src

- yop

*** cite:CSex02 [[file:Biblio/Trie/CSex02.pdf][AJAE: Grading errors]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CSex02,
  title={Marketing orders, grading errors, and price discrimination},
  author={Chalfant, James A and Sexton, Richard J},
  journal={American Journal of Agricultural Economics},
  volume={84},
  number={1},
  pages={53--66},
  year={2002},
  publisher={Oxford University Press}
}
#+end_src

- Les erreurs de grading peuvent avoir les même conséquence que la
  régulation par les quantités.
- La qualité est endogène ici.

*** cite:Barh03 [[file:Biblio/Trie/Barh03.pdf][JRS: Translating terroir]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Barh03,
  title={Translating terroir: The global challenge of {F}rench {AOC}
                  labeling},
  author={Barham, Elizabeth},
  journal={Journal of rural studies},
  volume={19},
  number={1},
  pages={127--138},
  year={2003},
  publisher={Elsevier}
}
#+end_src

- Parle de la place du terroir dans les négociations
  internationales
- Il y a un bouquin écrit par la même auteur

*** cite:MCre03 [[file:Biblio/Trie/MCre03.pdf][RIO: GI cartels]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MCre03,
  title={Can quality certification lead to stable cartels?},
  author={Marette, St{\'e}phan and Crespi, John M},
  journal={Review of industrial organization},
  volume={23},
  number={1},
  pages={43--64},
  year={2003},
  publisher={Springer}
}
#+end_src

- GI cartels that could be welfare improving

*** cite:Mahe04 [[file:Biblio/Trie/Mahe04.pdf][AJAE: Informed buyers]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Mahe04,
  title={Influence of informed buyers in markets susceptible to the
                  lemons problem},
  author={Mahenc, Philippe},
  journal={American Journal of Agricultural Economics},
  volume={86},
  number={3},
  pages={649--659},
  year={2004},
  publisher={Oxford University Press}
}
#+end_src

- Modèle d'économie industrielle où les vins de Bordeaux sont cités en
  exemple d'une théorie plus générale.
- Les individus ne se différentient que sur une seule dimension et
  avec des utilités linéaires, les fonctions de demande sont très
  simples. Il n'y a que deux niveaux de qualité du bien.
- Dans un premier temps apparaît un équilibre /pooled/ où les prix ne
  permettent pas de signaler la qualité. La vrai raison est qu'il est
  trop peu coûteux pour les producteurs de basses qualités de se
  déclarer haut.
- Puis, s'il y a certains individus informés et "pessimistes" sur la
  qualité, on peut signaler la qualité et on sort du problème des
  lemons.

*** cite:Stan04 [[file:Biblio/Trie/Stan04.pdf][EJLE: Law AOC]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Stan04,
  title={Wine reputation and quality controls: The origin of the
                  {AOCs} in 19th century {F}rance},
  author={Stanziani, Alessandro},
  journal={European Journal of Law and Economics},
  volume={18},
  number={2},
  pages={149--167},
  year={2004},
  publisher={Springer}
}
#+end_src

- Papier non économique sur les processus historiques en jeu dans la
  création des AOC en france, et la possibilité d'avoir des rentes.
- Vision juridique

*** cite:Stor05 [[file:Biblio/Trie/Stor05.pdf][JWR: OP wine quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Stor05,
  title={English weather and {R}hine wine quality: An ordered probit
                  model},
  author={Storchmann, Karl},
  journal={Journal of Wine Research},
  volume={16},
  number={2},
  pages={105--120},
  year={2005},
  publisher={Taylor \& Francis}
}
#+end_src

- Exemple de probit ordonné
- Mais ce n'est pas sur les AOC, c'est sur les classement des
  millésimes
- Mais il y a un lien avec le climat

*** cite:WMCl05 [[file:Biblio/Trie/WMCl05.pdf][AJAE: Reputation]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{WMCl05,
  title={Collective reputation and quality},
  author={Winfree, Jason A and McCluskey, Jill J},
  journal={American Journal of Agricultural Economics},
  volume={87},
  number={1},
  pages={206--213},
  year={2005},
  publisher={Oxford University Press}
}
#+end_src

- L'application de Tirole 1996 sur la réputation collective, appliquée
  aux IG.

*** cite:Rame06 [[file:Biblio/Trie/Rame06.pdf][JES: Survey marks]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Rame06,
  title={What's in a sign? Trademark law and economic theory},
  author={Ramello, Giovanni B},
  journal={Journal of Economic Surveys},
  volume={20},
  number={4},
  pages={547--565},
  year={2006},
  publisher={Wiley Online Library}
}
#+end_src

- Survey sur la référencement des produits

*** cite:Josl06 [[file:Biblio/Trie/Josl06.pdf][JAE: War on terroir]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Josl06,
  title={The war on terroir: geographical indications as a
                  transatlantic trade conflict},
  author={Josling, Tim},
  journal={Journal of Agricultural Economics},
  volume={57},
  number={3},
  pages={337--363},
  year={2006},
  publisher={Wiley Online Library}
}
#+end_src

- Une /presidential address/ bien littéraire sur les intérêts et
  les limites des indications géographiques dans un contexte de
  commerce international.
- De nombreuses phrases peuvent être utilisées en citation.
- Peut servir en particulier à appuyer l'antagonisme entre l'Europe et
  les Etats Unis sur ces questions. C'est ce qu'il appelle la guerre
  du /terroir/.
- Globalement, il est pour les AOC.

*** cite:BKir07 [[file:Biblio/Trie/BKir07.pdf][Agrk: Protecting GI]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BKir07,
  title={Exploring the economic rationale for protecting geographical
                  indicators in agriculture},
  author={Bramley, Cerkia and Kirsten, Johann F},
  journal={Agrekon},
  volume={46},
  number={1},
  pages={47--71},
  year={2007},
  publisher={Taylor \& Francis}
}
#+end_src

- Discussion sur l'économie des indications géographiques
- The economic rationale for protecting Geographical Indications
  derives mainly from the fact that place of origin may be used as a
  quality signal, or alternatively, that the resources of the region
  may be captured as quality attributes.

*** cite:MMPi08 [[file:Biblio/Trie/MMPi08.pdf][AJAE: GI to provide quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MMPi08,
  title={Geographical indications and the competitive provision of
                  quality in agricultural markets},
  author={Moschini, GianCarlo and Menapace, Luisa and Pick, Daniel},
  journal={American Journal of Agricultural Economics},
  volume={90},
  number={3},
  pages={794--812},
  year={2008},
  publisher={Oxford University Press}
}
#+end_src

- Positive welfare effects of GIs

*** cite:TBow08 [[file:Biblio/Trie/TBow08.pdf][GeoJourn: Learn from AOC]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{TBow08,
  title={Creating the taste of place in the {U}nited {S}tates: can we
                  learn from the {F}rench?},
  author={Trubek, Amy B and Bowen, Sarah},
  journal={GeoJournal},
  volume={73},
  number={1},
  pages={23--30},
  year={2008},
  publisher={Springer}
}
#+end_src

- Pour illustrer les liens entre la définition du terroir et la
  géographie.

*** cite:Bena10 [[file:Biblio/Trie/Bena10.pdf][WP: GI as a club asset]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@techreport{Bena10,
  title={The Economics of Geographical Indications: GIs modeled as
                  club assets},
  author={Benavente, Daniela},
  year={2010},
  institution={Graduate Institute of International and Development
                  Studies Working Paper}
}
#+end_src

- GIs are not pure public goods, they are club goods with non-rivality
  but partial excluability. They are also presented as intangible.
- The link between GIs and club goods is not well, it is more a
  reputation in this paper than trully geographical.

*** cite:CMCG10 [[file:Biblio/Trie/CMCG10.pdf][AJAE: Nested names]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CMCG10,
  title={The economics of nested names: {N}ame specificity,
                  reputations, and price premia},
  author={Costanigro, Marco and McCluskey, Jill J and Goemans, Christopher},
  journal={American Journal of Agricultural Economics},
  volume={92},
  number={5},
  pages={1339--1350},
  year={2010},
  publisher={Oxford University Press}
}
#+end_src

- Se pose la question de l'échelle à laquelle se déterminent les
  réputations basés sur des noms. Cela est possible car ils
  s'intéressent à un cas oû les noms sont imbriqués: vin californiens
  (également justifié par la disposition d'appréciation de la qualité
  à l'aveugle donc exogènes à la réputation).
- Le point de départ est que les agents basent leurs croyances en
  termes de réputation sur des indicateurs de la performance
  passée. Mais la relation exacte n'est pas connue.
- Modélise la réputation comme des primes sur les prix de vente des
  bouteilles de vin, avec l'approche quartile en plus. Cependant, les
  primes contiennent les coûts de recherche en plus de la WTP.
- Quand le prix du vin augmente, le coût d'avoir faux augmente et donc
  la valeur de l'information: *justification pour le quantile*
- On a également la preuve que la longévité d'un nom compte du point
  de vue de la réputation pour les consommateurs.
- Quelques détails sur la régression quartile sont intéressants
  (bootstrap).

*** cite:CFlo10 [[file:Biblio/Trie/CFlo10.pdf][CJAE: GI Burgundy]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CFlo10,
  title={The importance of geographic wine appellations: Hedonic
                  pricing of {B}urgundy wines in the {B}ritish
                  {C}olumbia wine market},
  author={Carew, Richard and Florkowski, Wojciech J},
  journal={Canadian Journal of Agricultural Economics/Revue canadienne
                  d'agroeconomie},
  volume={58},
  number={1},
  pages={93--108},
  year={2010},
  publisher={Wiley Online Library}
}
#+end_src

- Sur des modeles hédoniques du prix des vins de Bourgogne au Canada
- Les AOC ont des primes positives, sur la base du prix de la
  bouteille.
- Bonne citation pour localiser le Bourgogne

*** cite:MMos12 [[file:Biblio/Trie/MMos12.pdf][ERAE: Quality and GIs]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MMos12,
  title={Quality certification by geographical indications, trademarks
                  and firm reputation},
  author={Menapace, Luisa and Moschini, GianCarlo},
  journal={European Review of Agricultural Economics},
  volume={39},
  number={4},
  pages={539--566},
  year={2012},
  publisher={Oxford Univ Press}
}
#+end_src

- Ils montrent que, malgré la possibilité pour les producteurs de
  faire leur propre trademark, la présence d'une certification
  géographique augmente l'efficacité de la réputation pour signaler la
  qualité.
- La certification permet de diminuer les coûts de l'investissement en
  réputation.
- Ceux pour qui la réputation est basée sur une marque sont alors
  réticents à l'arrivée d'une certification, même si ils peuvent en
  profiter.
- Leur analyse plaide pour la vision européenne dans le débat avec les
  US à l'OMC.

*** cite:MSex12 [[file:Biblio/Trie/MSex12.pdf][ERAE: Excess quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MSex12,
  title={Will geographical indications supply excessive quality?},
  author={M{\'e}rel, Pierre and Sexton, Richard J},
  journal={European Review of Agricultural Economics},
  volume={39},
  number={4},
  pages={567--587},
  year={2012},
  publisher={Oxford Univ Press}
}
#+end_src

- Contre les AOC car il font du pooling equilibrium sur les basses
  qualités et offre trop de différenciations pour les autres.

*** cite:Four12 [[file:Biblio/Trie/Four12.pdf][Socio: Social classification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Four12,
  title={The vile and the noble: On the relation between natural and
                  social classifications in the French wine world},
  author={Fourcade, Marion},
  journal={The Sociological Quarterly},
  volume={53},
  number={4},
  pages={524--545},
  year={2012},
  publisher={Taylor \& Francis}
}
#+end_src

*** cite:BCon14 [[file:Biblio/Trie/BCon14.pdf][AJAE: Survey label]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BCon14,
  title={On the economics of labels: How their introduction affects
                  the functioning of markets and the welfare of all
                  participants},
  author={Bonroy, Olivier and Constantatos, Christos},
  journal={American Journal of Agricultural Economics},
  volume={97},
  number={1},
  pages={239--259},
  year={2014},
  publisher={Oxford University Press}
}
#+end_src

- Survey sur les effets économiques des labels de qualité, GI y
  compris.

*** cite:Brec14 [[file:Biblio/Trie/Brec14.pdf][REE: label profusion]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Brec14,
  title={Consumer confusion over the profusion of eco-labels: Lessons
                  from a double differentiation model},
  author={Br{\'e}card, Doroth{\'e}e},
  journal={Resource and energy economics},
  volume={37},
  pages={64--84},
  year={2014},
  publisher={Elsevier}
}
#+end_src

- Double différenciation des labels car on peut produire de la faible
  qualité sous un certain label.

*** cite:DSwi14 [[file:Biblio/Trie/DSwi14.pdf][AAWE: Political of AOC]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{DSwi14,
  title={The political economy of Geographical Indications},
  author={Deconinck, Koen and Swinnen, Johan},
  journal={AAWE working paper No 174},
  year={2014}
}
#+end_src

- Il y a une idée de centralité de l'AOC et que les consommateurs
  n'ont de signal que sur la qualité.
- Ils se posent la question de l'extension de l'aire d'appellation et
  le process institutionnel qui permet de le déterminer.

*** cite:Malt14 [[file:Biblio/Trie/Malt14.pdf][ASQ: Causality crus]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Malt14,
  title={On the causality and cause of returns to organizational
                  status: Evidence from the grands crus class{\'e}s of
                  the M{\'e}doc},
  author={Malter, Daniel},
  journal={Administrative Science Quarterly},
  volume={59},
  number={2},
  pages={271--300},
  year={2014},
  publisher={SAGE Publications Sage CA: Los Angeles, CA}
}
#+end_src

- Question du Organizational Status, qu'il distingue de la qualité
  mais aussi de la réputation.
- sorted 61 wine producers into five growth classes in 1855, as a
  fixed hierarchical symbol of class status. The classification has
  defied attempts at revision for more than 150 years
- I study a period of time during which the uncertainty about quality
  has arguably declined because the Internet has made wine ratings
  ubiquitously available.
- organizational status as a signal of quality under uncertainty
  (Podolny, 2005)
- Effet des primes Bordeaux, avec exogénéité supposée des primes du
  fait de leur histoire.
- Biased matching because of unobservables: IV

*** cite:USTR17 [[file:Biblio/Trie/USTR17.pdf][Report Intellectual property]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{USTR17,
  title                    = {2017 {S}pecial 301 {R}eport},
  author                   = {USTR},
  year                     = {2017},
  journal                  = {Office of the United States Trade Representative},
  volume                   = {81 p.},
  pages                    = {\url{https://ustr.gov/sites/default/files/301/2017 Special 301 Report FINAL.PDF}}
}
#+end_src

- Contre les indications géographiques en Europe.

*** cite:GLRW17 [[file:Biblio/Trie/GLRW17.pdf][FP: Collective reputation]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GLRW17,
  title={Evaluating the net benefits of collective reputation: The
                  case of {B}ordeaux wine},
  author={Gergaud, Olivier and Livat, Florine and Rickard, Bradley and
                  Warzynski, Frederic},
  journal={Food Policy},
  volume={71},
  pages={8--16},
  year={2017},
  publisher={Elsevier}
}
#+end_src

- Réputation collective à la suite de Tirole 1996. Lien avec Lalonde
  and Smith (1997, 1998). Here, the collective reputation refers to
  the appellation name and individual reputations at the firm level
  are proxied by the average ratings the wines have received from a
  popular wine guide.
- C'est un modèle en système imbriqué, où la réputation agrégée dépend
  des réputations individuelles et les réputations individuelles
  dépendent de la réputation agrégée. Il n'ont pas de bons instruments
  pour les réputations individuelles donc ils ne s'intéressent qu'à
  l'effet de la réputation agrégée sur les individuelles
- Ils se servent de l'imbrication des différentes échelles des
  appellations contre l'endogénéité de la réputation
  collective. L'appréciation de Bordeaux est instrumentée par les
  appréciations des autres régions viticoles à cette échelle. On a
  quelque part une sorte de modèle hiérarchiques à 2 étapes.

*** cite:MCKa17 [[file:Biblio/Trie/MCKa17.pdf][AEPP: Food labeling]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MCKa17,
  title={Labeling food processes: The good, the bad and the ugly},
  author={Messer, Kent D and Costanigro, Marco and Kaiser, Harry M},
  journal={Applied Economic Perspectives and Policy},
  volume={39},
  number={3},
  pages={407--427},
  year={2017},
  publisher={Oxford University Press}
}
#+end_src

- ça parle plutôt de labels vis-à-vis de l'environnement. Ils les
  appelle les "process label". Il sont dans une opposition binaire
  entre ce qui est scientifique et ce qui ne l'est pas, sans parler
  d'incertitude.
- When product quality and safety is uncertain, consumers can search
  for information they deem important. But when information about a
  food product is too costly or difficult to obtain, aligning food
  choices with individual preferences is problematic. Further
  complicating matters is the fact that many important food
  characteristics, such as taste, can be assessed only after consuming
  the food (“experience attributes”; Nelson 1970), and the authen-
  ticity of many claims, such as “extra virgin” olive oil, is known to
  producers but cannot be directly verified by consumers (“credence
  attributes”; Darby and Karni 1973). As pointed out by Caswell and
  Mojduszka (1996), labels can facilitate consumer choice by
  transforming credence and experience attributes into searchable
  characteristics, thereby decreasing the information gap between
  consumers and producers. Thus, a truthful certification of the
  production process should make the outcomes searchable attributes.

*** cite:YBMZ17 [[file:Biblio/Trie/YBMZ17.pdf][AJAE: Quality in nested names]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{YBMZ17,
  title={What is in a Name? {I}nformation, Heterogeneity, and Quality
                  in a Theory of Nested Names},
  author={Yu, Jianyu and Bouamra-Mechemache, Zohra and Zago, Angelo},
  journal={American Journal of Agricultural Economics},
  volume={100},
  number={1},
  pages={286--310},
  year={2017},
  publisher={Oxford University Press}
}
#+end_src

- The economics theory of Nested names
- At Marsannay, we are clearly in such a situation in regard to the
  other wines from burgundy. The authors say: "the Burgundy
  classification system is the most sophisticated, with a very long
  tradition of classifying vineyards to find the best quality climats,
  that is, plots of land. Burgundy’s soil quality is very heteroge-
  neous and this, together with differences in altitude and
  exposition, has always led to wines of “almost unpredictable
  quality” (Johnson and Robinson 2013). However, over time traders
  have learned to distinguish the quality of wines coming from
  different climats, and so the prices of the grapes have reflected
  the quality potential of different plots. The best plots were those
  able to give quality wines consistently across years with different
  weather conditions. In short, nowadays pundits continue to argue for
  the Bungundy classification system, given that “the general validity
  of the hierarchy is well supported by the market” (Lewin 2010)."
- An interesting case is the appellation of Montagny, on the Cote
  Chalonnaise, where producers between 1989 and 1991 voluntarily
  decided to reduce the number of Premiers Crus, that is, the
  second-tier climats. “There were plenty of private and public spats
  over which vineyards kept their status [..] but the fact remains
  that the winemakers had seen over the preceeding decades that
  certain plots in Montagny made unquestionably better wines than
  others,” (Anson 2016).

*** cite:MSwi18 [[file:Biblio/Trie/MSwi18.pdf][FP: First GIs]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MSwi18,
  title={Trade and terroir. The political economy of the world’s first
                  geographical indications},
  author={Meloni, Giulia and Swinnen, Johan},
  journal={Food Policy},
  volume={81},
  pages={1--20},
  year={2018},
  publisher={Elsevier}
}
#+end_src

- 

*** cite:CSCa19 [[file:Biblio/CSCa19.pdf][FP: Vertical differentiation and geographical indications]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CSCa19,
  title={Vertical differentiation via multi-tier geographical
                  indications and the consumer perception of quality:
                  The case of {C}hianti wines},
  author={Costanigro, Marco and Scozzafava, Gabriele and Casini, Leonardo},
  journal={Food Policy},
  year={2019},
  publisher={Elsevier}
}
#+end_src

** Informational structure
*** cite:Aker70 [[file:Biblio/Trie/Aker70.pdf][QJE: Market for lemons]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Aker70,
  title={The market for "lemons": Quality uncertainty and the market
                  mechanism},
  author={Akerlof, George A},
  journal={Quarterly Journal of Economics},
  pages={488--500},
  year={1970},
  publisher={JSTOR}
}
#+end_src

- Papier séminal sur l'absence d'information qui tire la qualité des
  produits vers le bas.

*** cite:Nels70 [[file:Biblio/Trie/Nels70.pdf][JPE: Experience goods]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Nels70,
  title={Information and consumer behavior},
  author={Nelson, Phillip},
  journal={The Journal of Political Economy},
  volume={78},
  number={2},
  pages={311--329},
  year={1970},
  publisher={JSTOR}
}
#+end_src

- Défini ce que sont les biens d'expérience par rapport aux bien de
  recherche dans Stigler 1961. Le point commun est l'information.
- Les biens sont définis sur la manière dont les consommateurs
  obtiennent de l'information sur leur qualité.
- La fréquence d'achat et le prix du bien (qui est le coût
  d'acquisition de l'information en cas d'expérience) sont des
  attributs importants desquels il tire une typologie stylisée.

*** cite:Nels74 [[file:Biblio/Trie/Nels74.pdf][JPE: Advertising information]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Nels74,
  title={Advertising as information},
  author={Nelson, Phillip},
  journal={Journal of political economy},
  volume={82},
  number={4},
  pages={729--754},
  year={1974},
  publisher={The University of Chicago Press}
}
#+end_src

- Seminal paper about advertising and information, mais Nelson 1970
  (sur les biens d'expérience) est beaucoup cité tout au long de
  l'article
- Pour les biens d'expérience (ou plutôt les qualités d'expérience),
  la publicité n'a pas forcément d'intérêt à coller à la réalité
- The major control that consumers have over the market for experience
  qualities is whether they repeat the purchase of a brand or not
  (Nelson 1970).

*** cite:MRos78 [[file:Biblio/Trie/MRos78.pdf][JET: Monopole and quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MRos78,
  title={Monopoly and product quality},
  author={Mussa, Michael and Sherwin Rosen},
  journal={Journal of Economic Theory},
  volume={18},
  number={},
  pages={301--317},
  year={1978}
}
#+end_src

- Monopole et biais dans la provision de qualité
- Papier très théorique

*** cite:Shap82 [[file:Biblio/Trie/Shap82.pdf][BJE: Information and quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Shap82,
  title={Consumer information, product quality, and seller reputation},
  author={Shapiro, Carl},
  journal={The Bell Journal of Economics},
  pages={20--35},
  year={1982},
  publisher={JSTOR}
}
#+end_src

- Viewing reputation as an expectation of quality, this article
  studies the properties of quality expectations that are
  fulfilled. When sellers set quality once and for all, any
  self-fulfilling quality level must lie below the perfect information
  quality level
- Once for all endogenous quality

*** cite:Shap86 [[file:Biblio/Trie/Shap86.pdf][RES: License and certification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Shap86,
  title={Investment, moral hazard, and occupational licensing},
  author={Shapiro, Carl},
  journal={The Review of Economic Studies},
  volume={53},
  number={5},
  pages={843--862},
  year={1986},
  publisher={Wiley-Blackwell}
}
#+end_src

- La présence de licences et de certifications ne sert à rien.

*** cite:BDWh87 [[file:Biblio/Trie/BDWh87.pdf][QJE: Quality distorsion]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BDWh87,
  title={Monopoly and quality distortion: Effects and remedies},
  author={Besanko, David and Donnenfeld, Shabtai and White, Lawrence
                  J},
  journal={Quarterly Journal of Economics},
  volume={102},
  number={4},
  pages={743--767},
  year={1987},
  publisher={Oxford University Press}
}
#+end_src

- Article séminal sur les biais qualitatifs en présence d'absence
  d'information et donc de pouvoir de monopole.
- Minimum quality standard, No distorsion at the top

*** cite:DNab91 [[file:Biblio/Trie/DNab91.pdf][EL: Efficient certification scheme]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{DNab91,
  title={Economic implications of imperfect quality certification},
  author={De, Sankar and Nabar, Prafulla},
  journal={Economics Letters},
  volume={37},
  number={4},
  pages={333--337},
  year={1991},
  publisher={Elsevier}
}
#+end_src

- Efficient certification: better product is more likely to have
  higher quality ratio: Ordered models.

*** cite:BLar92 [[file:Biblio/Trie/BLar92.pdf][QJE: Gurus manipulate markets]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BLar92,
  title={Using privileged information to manipulate markets: Insiders,
                  gurus, and credibility},
  author={Benabou, Roland and Laroque, Guy},
  journal={Quarterly Journal of Economics},
  volume={107},
  number={3},
  pages={921--958},
  year={1992},
  publisher={MIT Press}
}
#+end_src

- Théorie qui semble correpondre à nos résultats, les agents ont pu
  profiter des informations qu'ils avaient pour manipuler la qualité
  de l'information.

*** cite:Ryu93  [[file:Biblio/Trie/Ryu93.pdf][EL: Kullback-Leibler]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Ryu93,
  title={Monotonicity of the Fisher information and the
                  {K}ullback-{L}eibler divergence measure},
  author={Ryu, Keunkwan},
  journal={Economics Letters},
  volume={42},
  number={2-3},
  pages={121--128},
  year={1993},
  publisher={Elsevier}
}
#+end_src

- The information gain of discretizing a continuous signal,
  asymptotically.

*** cite:Tiro96 [[file:Biblio/Trie/Tiro96.pdf][RES: History vs stereotypes]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Tiro96,
  title={A theory of collective reputations (with applications to the
                  persistence of corruption and to firm quality)},
  author={Tirole, Jean},
  journal={Review of Economic Studies},
  volume={63},
  number={1},
  pages={1--22},
  year={1996},
  publisher={Wiley-Blackwell}
}
#+end_src

- The information gain of discretizing a continuous signal,
  asymptotically.

*** cite:Lizz99 [[file:Biblio/Trie/Lizz99.pdf][RJE: Monopoly in certifications]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Lizz99,
  title={Information revelation and certification intermediaries},
  author={Lizzeri, Alessandro},
  journal={The RAND Journal of Economics},
  pages={214--231},
  year={1999},
  publisher={JSTOR}
}
#+end_src

- La question de l'intermédiaire de certification lorsqu'il est en
  monopole.
- Il donne que très peu d'information mais la concurrence entre des
  intermédiaires d'information peut aller vers l'information parfaite.

*** cite:Tade99 [[file:Biblio/Trie/Tade99.pdf][AER: What's in a name]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Tade99,
  title={What's in a Name? {R}eputation as a Tradeable Asset},
  author={Tadelis, Steven},
  journal={American Economic Review},
  volume={89},
  number={3},
  pages={548--563},
  year={1999}
}
#+end_src

- Seminal reference

*** cite:ALiz01 [[file:Biblio/Trie/ALiz01.pdf][IER: Welfare certification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{ALiz01,
  title={Strategic certification and provision of quality},
  author={Albano, Gian Luigi and Lizzeri, Alessandro},
  journal={International Economic Review},
  volume={42},
  number={1},
  pages={267--283},
  year={2001},
  publisher={Wiley Online Library}
}
#+end_src

- Effets de bien être d'un organisme tiers qui prodit de la
  classification.
- Welfare improving mais moins qu'en full information.

*** cite:Bagw01 [[file:Biblio/Trie/Bagw01.pdf][Book: Economics advertising]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@BOOK{Bagw01,
  TITLE = {The Economic Analysis of Advertising},
  AUTHOR = {Bagwell, Kyle},
  YEAR = {2001},
  PUBLISHER = {Edward Elgar Publishing},
}
#+end_src

- Seminal reference

*** cite:Guer01 [[file:Biblio/Trie/Guer01.pdf][WP: Ordered rankings of levels]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Guer01,
  title={Certification Disclosure and Informational Efficiency: A Case
                  for Ordered Ranking of Levels},
  author={Guerra, Gerardo A},
  year={2001},
  journal={University of Oxford, Department of Economics, Discussion
                  Paper 64},
  volume= {ISSN 1471-0498}
}

#+end_src

- have noisy estimates of the quality level of the agent being
  certified (seller), a disclosure in the form of ordered ranking of
  levels is predicted.

*** cite:MShi02 [[file:Biblio/Trie/MShi02.pdf][AER: Public information]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MShi02,
  title={Social value of public information},
  author={Morris, Stephen and Shin, Hyun Song},
  journal={The American Economic Review},
  volume={92},
  number={5},
  pages={1521--1534},
  year={2002},
  publisher={American Economic Association}
}
#+end_src

- Valeur de l'information sociale pas forcément positive quand elle
  cohabite avec de l'information privée.
- Modèle intéressant car très simple et met une équation structurelle
  de l'information disponible aux individus, à la fois de manière
  collective et individuelle.
- L'incertitude est globale, pas propre aux individus, ce qui rend le
  modèle difficilement applicable à l'information sur les AOC.
- Par un écart de l'action des individus avec l'état du monde
  objectif, la fonction de bien-être agrégé est facilement
  proportionnel à la précision de l'information: l'inverse de la
  variance des résidus.
- Je ne comprend pas l'équation 10 donc j'ai arrêté la lecture à ce
  point.

*** cite:JLes03 [[file:Biblio/Trie/JLes03.pdf][QJE: Hygiene quality in restaurants]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{JLes03,
  title={The effect of information on product quality: Evidence from
                  restaurant hygiene grade cards},
  author={Jin, Ginger Zhe and Leslie, Phillip},
  journal={Quarterly Journal of Economics},
  volume={118},
  number={2},
  pages={409--451},
  year={2003},
  publisher={MIT Press}
}
#+end_src

- Un effet très fort de la qualité endogène à l'information

*** cite:JMya06 [[file:Biblio/Trie/JMya06.pdf][AER: simple advertising]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{JMya06,
  title={On the simple economics of advertising, marketing, and
                  product design},
  author={Johnson, Justin P and Myatt, David P},
  journal={American Economic Review},
  volume={96},
  number={3},
  pages={756--784},
  year={2006}
}
#+end_src

- C'est un style de survey sur les rotations de demande, par
  opposition aux shifts étudiés habituellement.
- On distingue l'information selon qu'elle soit hype (demande shift)
  ou real (demande rotation).
- Analytiquement assez loin de ce que je cherche.

*** cite:DJin10 [[file:Biblio/Trie/DJin10.pdf][JEL: Quality certification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{DJin10,
  title={Quality disclosure and certification: Theory and practice},
  author={Dranove, David and Jin, Ginger Zhe},
  journal={Journal of Economic Literature},
  volume={48},
  number={4},
  pages={935--63},
  year={2010}
}
#+end_src

- Revue de littérature sur les certifications de la qualité

*** cite:GPen10 [[file:Biblio/Trie/GPen10.pdf][Econca: Signal ordering]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GPen10,
  title={Signal orderings based on dispersion and the supply of
                  private information in auctions},
  author={Ganuza, Juan-Jos{\'e} and Penalva, Jose S},
  journal={Econometrica},
  volume={78},
  number={3},
  pages={1007--1030},
  year={2010},
  publisher={Wiley Online Library}
}
#+end_src

- Ils n'utilisent pas la variance pour mesurer la précision, on ne
  voit pas trop pourquoi, probablement des raisons analytiques. Il
  faudrait comparer les critères qu'ils proposent à la variance dans
  le cas gaussien ordonné.
- Notice that signals are ordered for a given prior. The prior plays a
  crucial role in the definition, as E[V|X_k] is computed using both
  the prior and the signal. Thus, precision criteria are defined as
  orders over the information structures. Cet information prior est
  pour nous le modèle économétrique, on va donc avoir des résultats
  différents selon le modèle sélectionné.
- A la fin de l'article il y a d'autres critères qui pourraient
  également rentrer dans notre comparaison pour le cas gaussien.

*** cite:WSor11 [[file:Biblio/Trie/WSor11.pdf][OS: Inflencing classifications]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{WSor11,
  title={The ratings game: Asymmetry in classification},
  author={Waguespack, David M and Sorenson, Olav},
  journal={Organization Science},
  volume={22},
  number={3},
  pages={541--553},
  year={2011},
  publisher={INFORMS}
}
#+end_src

- Certains inidivdus arrivent à influencer les classements
- C'est observé sur des film par comparaison entre pays.

*** cite:BSwa12 [[file:Biblio/Trie/BSwa12.pdf][PNAS: Information flows]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BSwa12,
  title={Identifying sources of variation and the flow of information
                  in biochemical networks},
  author={Bowsher, Clive G and Swain, Peter S},
  journal={Proceedings of the National Academy of Sciences},
  volume={109},
  number={20},
  pages={E1320--E1328},
  year={2012},
  publisher={National Acad Sciences}
}
#+end_src

- With supplementary Information [[file:Biblio/Trie/BSwa12a.pdf][here]] for the formula and the
  links with the information theory.
- Multivariate variance decomposition.

*** cite:LSKa15 [[file:Biblio/Trie/LSKa15.pdf][JARE: Noisy information signal]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{LSKa15,
  title={Noisy information signals and endogenous preferences for
                  labeled attributes},
  author={Liaukonyte, Jura and Streletskaya, Nadia A and Kaiser, Harry
                  M},
  journal={Journal of Agricultural and Resource Economics},
  pages={179--202},
  year={2015},
  publisher={JSTOR}
}
#+end_src

- Modèle théorique gaussien qui peut être utilisé pour dériver des
  intuitions sur notre modèle.
- Les calculs sont en annexe et peuvent être pédagogique (Bayes rule)

*** cite:Gola17 [[file:Biblio/Trie/Gola17.pdf][Book: Info-metrics]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Gola17,
  title={Foundations of info-metrics: modeling and inference with
                  imperfect information},
  author={Golan, Amos},
  year={2017},
  publisher={Oxford University Press}
}
#+end_src

- La théorie de l'information appliquée à l'économie

*** cite:BZJL18 [[file:Biblio/Trie/BZJL18.pdf][AEJ: Countersignaling]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BZJL18,
  title={Incomplete disclosure: Evidence of signaling and
                  countersignaling},
  author={Bederson, Benjamin B and Jin, Ginger Zhe and Leslie, Phillip
                  and Quinn, Alexander J and Zou, Ben},
  journal={American Economic Journal: Microeconomics},
  volume={10},
  number={1},
  pages={41--66},
  year={2018}
}
#+end_src

- On regarde si les restaurants communiquent sur une niveau d'hygiène
  qui a été établit volontairement dans un comté Californien.
- Les auteurs trouvent que les restaurants les mieux classés ne sont
  pas ceux qui communiquent le plus car ne pas communiquer montre que
  l'on est au-dessus des autres: c'est le countersignaling.

** Parametric ordered
*** cite:PHal83 [[file:Biblio/Trie/PHal83.pdf][ER: Residuals for diagnostics]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{PHal83,
  title={Diagnostic tests as residual analysis},
  author={Pagan, Adrian Rodney and Hall, Anthony David},
  journal={Econometric Reviews},
  volume={2},
  number={2},
  pages={159--218},
  year={1983},
  publisher={Taylor \& Francis}
}
#+end_src

- Seminal paper about using residuals for model dignostics

*** cite:Smal87 [[file:Biblio/Trie/Smal87.pdf][Econca: ordered alternatives]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Smal87,
  title={A discrete choice model for ordered alternatives},
  author={Small, Kenneth A},
  journal={Econometrica},
  pages={409--424},
  year={1987},
  publisher={JSTOR}
}
#+end_src

- GEV model proven to not work well

*** cite:GMRT87 [[file:Biblio/Trie/GMRT87.pdf][JoE: Generalised residuals]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GMRT87,
  title={Generalised residuals},
  author={Gourieroux, Christian and Monfort, Alain and Renault, Eric
                  and Trognon, Alain},
  journal={Journal of Econometrics},
  volume={34},
  number={1},
  pages={5--32},
  year={1987},
  publisher={Elsevier}
}
#+end_src

- Proposent une définition des résidus généralisés et les manières de
  s'en servir pour faire plein de tests différents sur des modèles non
  linéaires.
- Les modèles concernés doivent avoir pour base une variable latente
  avec une structure de link exponentielle.
- Voir en particulier pour la construction des résidus et les
  écritures à l'ancienne.

*** cite:CIri87 [[file:Biblio/Trie/CIri87.pdf][JoE: Residuals grouped]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CIri87,
  title={Residual analysis in the grouped and censored normal linear
                  model},
  author={Chesher, Andrew and Irish, Margaret},
  journal={Journal of Econometrics},
  volume={34},
  number={1},
  pages={33--61},
  year={1987},
  publisher={Elsevier}
}
#+end_src

- Utile pour la formule des résidus généralisés dans le cadre du
  probit ordonné (qu'ils appellent le modèle grouped data).
- Certaines procédures de test sont présentées mais difficiles à
  comprendre, variable omise, hétéroscédasiticité.
- Une analyse graphique un peu naïve est présentée mais les
  discussions peuvent être intéressantes.

*** cite:Bran90 [[file:Biblio/Trie/Bran90.pdf][Bitrics: Assessing proportionality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Bran90,
  title={Assessing proportionality in the proportional odds model for
                  ordinal logistic regression},
  author={Brant, Rollin},
  journal={Biometrics},
  pages={1171--1178},
  year={1990},
  publisher={JSTOR}
}
#+end_src

- Tester la proportionnalité à partir de modèles binaires séparés
- Il y a quand même certains problèmes associés à ce test

*** cite:CPVe98 [[file:Biblio/Trie/CPVe98.pdf][ER: inference in MNL and ORD]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CPVe98,
  title={Simple inference in multinomial and ordered logit},
  author={Crawford, David L and Pollak, Robert A and Vella, Francis},
  journal={Econometric Reviews},
  volume={17},
  number={3},
  pages={289--299},
  year={1998},
  publisher={Taylor \& Francis}
}
#+end_src

- For the OP and OL with have the single crossing property which works
  on linear in variable model (not quadratic nor interactions)
- They also compare multinomial and ordered models claiming that the
  theory choose between both models.
- They show for the MNL that computing the individual marginal effects
  and averaging is not a good strategy.

*** cite:PShi00 [[file:Biblio/Trie/PShi00.pdf][JAE: Specification tests OP]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{PShi00,
  title={Gender, race, pay and promotion in the British nursing
                  profession: Estimation of a generalized ordered
                  probit model},
  author={Pudney, Stephen and Shields, Michael},
  journal={Journal of Applied Econometrics},
  volume={15},
  number={4},
  pages={367--399},
  year={2000},
  publisher={Wiley Online Library}
}
#+end_src

- specification tests and generalized models which relax two of the
  restrictive features of the ordered probit model: the constancy of
  threshold parameters and exogeneity of explanatory variables.
- In general, if the same variables impact the threshold and the
  latent variables, the two effects cannot be separated. According to
  the author we have to force by dropping one possibility. We use the
  threshold constancy test developed in Section 3.2 to allocate each
  explanatory variable either to the thresholds.
- Terza (1985) seems to be the seminal paper for non-constant
  thresholds.
- The test for non-constant thresholds is close to a parallel
  assumption. It is tested through an extended definition of
  coefficients from the latent variable. Then it is a score test.
- The specification procedure is strange (with non-constant
  thresholds), see p.374.
- Endogeneity is treated exclusively through simultaneity questions,
  tested through the generalized residuals (only possible for a
  discrete endogenous explanatory variable, Pagan and Vella 1989),
  Implemented by simulated likelihood.
- Ancien commentaires:
   - Un modèle ordonné généralisé de plus mais avec les intérêts de
     (i) proposer un test de constance des seuils, (ii) proposer un
     test d'exogénéité de certaines variables explicatives et (iii) de
     proposer l'estimation de variables ordonnées endogènes (elles
     mêmes dans une deuxième étape ordonnée).
   - Ils disent que c'est dur de spécifier des formes fonctionnelles
     flexibles sur les seuils car il y a autant de formes à estimer
     que de seuils et donc font des transformations a priori des
     variables qui expliquent les seuils et qui ont des effets non
     linéaires.
   - Leur modèle a équation simultannées est un peu laborieux:
     inclusion d'effets aléatoires on ne sait pas pourquoi,
     estimation par maximum de vraisemblance simulé.
   - Par contre les deux test présentés pour la constance des seuils
     et l'exogénéité d'une variable ordonnée (marche aussi si la
     deuxième étape est continue) sont d'un intérêt fort.

*** cite:CHNa07 [[file:Biblio/Trie/CHNa07.pdf][IER: Economic content of ordered]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CHNa07,
  title={The identification and economic content of ordered choice
                  models with stochastic thresholds},
  author={Cunha, Flavio and Heckman, James J and Navarro, Salvador},
  journal={International Economic Review},
  volume={48},
  number={4},
  pages={1273--1309},
  year={2007},
  publisher={Wiley Online Library}
}
#+end_src

- They present Prescott and Visscher (1977) which look like ideal
  point for politics.
- The model they present is an optimal stopping, can be used for trees
  in particular.

*** cite:VDJo03 [[file:Biblio/Trie/VDJo03.pdf][JHE: Scoring from ordered]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{VDJo03,
  title={Inequalities in self-reported health: validation of a new approach to measurement},
  author={Van Doorslaer, Eddy and Jones, Andrew M},
  journal={Journal of health economics},
  volume={22},
  number={1},
  pages={61--87},
  year={2003},
  publisher={Elsevier}
}
#+end_src

- Re-scaling the latent variable with (y_i- y_min)/ (y_max- y_min)
  [density uniform distribution]
- Interval regression (with known thresholds) can be artificially
  implemented with the cdf of an auxiliary continuous variable [not
  interesting for us]
- Allowing the thresholds to depend on explanatory variables is
  equivalent to an heteroskedastic specification [and vice versa? an
  heteroskedastic ordered probit present non-constant thresholds?]
- Health concentration index, very close to a Gini index, measure the
  inequality from the relation between the distribution of wealth and
  health.
- We can also decompose the health concentration index on the basis of
  explanatory variables. These two last point justify to scale the
  predictions from OP for inter-group comparisons: "impose cardinality
  on the ordinal responses"
- For the decomposition, the ordered probit work as the interval
  regression.

*** cite:Fiel04 [[file:Biblio/Trie/Fiel04.pdf][QQ: Scaling for residual variance]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Fiel04,
  title={Scaling for residual variance components of ordered category
                  responses in generalised linear mixed multilevel
                  models},
  author={Fielding, Antony},
  journal={Quality and Quantity},
  volume={38},
  number={4},
  pages={425--433},
  year={2004},
  publisher={Springer}
}
#+end_src

- Bien moins clair et intéressant que le papier de 2009 de Baue09.

*** cite:Baue09 [[file:Biblio/Trie/Baue09.pdf][PCM: scaling ordered]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Baue09,
  title={A note on comparing the estimates of models for
                  cluster-correlated or longitudinal data with binary
                  or ordinal outcomes},
  author={Bauer, Daniel J},
  journal={Psychometrika},
  volume={74},
  number={1},
  pages={97},
  year={2009},
  publisher={Springer}
}
#+end_src

- Instead of normalizing by the variance of the residuals, we put the
  variance of the latent to a given value by rescaling
- Extension of Winship and Mare (1984) for random effects
  (clusters). the proof are in the appendix.
- Complementarity with Fielding 2004, same goal.

*** cite:XXXXXX [[file:Biblio/Trie/JackXX.pdf][Cours: Ideal point and reparam]]

- Only the course of Jackman with the theory of ideal point. 
- With two votes known thresholds (Krehbiel and Rivers), We need to
  know the amount for each vote (wage for exemple) the threshold from
  the ordered model is the center between two options the transitivity
  allow to suppress a possibility among 4, so we can make an ordered
  model with 4 modalities. (the outcome of two choices are coded as an
  ordered value).
- Jackman shows how to recover interesting parameters about scale,
  thresholds even with a model estimated with standard thresholds
  normalization.

*** cite:GHen10 [[file:Biblio/Trie/GHen10.pdf][Book: Green ordered]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{GHen10,
  title={Modeling ordered choices: A primer},
  author={Greene, William H and Hensher, David A},
  year={2010},
  publisher={Cambridge University Press}
}
#+end_src

- Tout ce qui faut savoir sur les modèles de choix ordonnés.
- Ils améliorent le probit ordonné en permettant d'avoir des seuils
  qui dépendent de chocs aléatoire et de variables explicatives.
- Ils justifient ce besoin par la prise en compte de l'hétérogénéité
  des préférences des individus, à la fois observée et inobservée.
- "The Brant test frequently rejects the null hypothesis of a common
  slope vector in these discrete choice models. The test is not about
  the choice mechanism per se, but about functional form".
- Le probit ordonné généralisé a la préférence de la littérature par
  rapport au relachement de la parallèle assumption et permet d'avoir
  des effets marginaux différents selon les outcomes.
- On n'a plus la single crossing condition, ni la parallel assumption
  par contre l'interprétation des effets marginaux est plus
  hasardeuse.
- Ils sont très critiques des modèles qui relachent la parallel
  assumption. L'idée de structurer les constantes comme des sommes
  l'une de l'autres en exponentiel est intéressante.
- L'estimation se fait par MV simulée dans la logique de Train et du
  package de Croissant.

*** cite:Wool10 [[file:Biblio/Trie/Wool10.pdf][Book: Wooldridge]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Wool10,
  title={Econometric Analysis of Cross Section and Panel Data},
  author={Wooldridge, Jeffrey M.},
  year={2010},
  publisher={MIT press}
}
#+end_src

- Version 2010 de Wooldridge.

*** cite:PRos13 [[file:Biblio/Trie/PRos13.pdf][JRSS: Vignette suridentification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{PRos13,
  title={The heterogeneous thresholds ordered response model:
                  Identification and inference},
  author={Peracchi, Franco and Rossetti, Claudio},
  journal={Journal of the Royal Statistical Society: Series A
                  (Statistics in Society)},
  volume={176},
  number={3},
  pages={703--722},
  year={2013},
  publisher={Wiley Online Library}
}
#+end_src

- Detailed analysis of the identification of the ordered models with
  vignette for intra-personal comparability
- Present the choice of allocating variable between thresholds and
  latent as exclusion restrictions.

*** cite:NSha15 [[file:Biblio/Trie/NSha15.pdf][AMAR: Equivalence between Generalized Ordered]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{NSha15,
  title={A note on generalized ordered outcome models},
  author={Eluru, Naveen and Yasmin, Shamsunnahar},
  journal={Analytic methods in accident research},
  volume={8},
  pages={1--6},
  year={2015},
  publisher={Elsevier}
}
#+end_src

- Simple mathematical derivation of the equivalence between
  non-constant thresholds and non-parallel effects
- Simple specification Wald tests : [[pdfview:/home/jsay/geoIndic/Biblio/Trie/NSha15.pdf::6][page 6
- Generalization with random parameters (mixed model) both for
  threshold and non-parallel variables.
- For the mixed models, imposing a recursive structure for the
  thresholds allow to impose the non-negativity of the probability for
  a particular level, I think this is the same as the monotone
  condition. To verify.

*** cite:Terz16 [[file:Biblio/Trie/Terz16.pdf][JES: Correction of Green on identification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Terz16,
  title={Threshold Specification And Parameter Identification In The
                  Generalized Ordinal Probit Model},
  author={Terza, Joseph V},
  journal={Journal of Economic Surveys},
  volume={30},
  number={4},
  pages={696--697},
  year={2016},
  publisher={Wiley Online Library}
}
#+end_src

- Contrary to what GHHW14 said, it is possible to estimate ordered
  models with variable thresholds (with heterogeneous coefficients
  between modalities) and many common explanatory variables in the
  latent and thresholds.
- GHHW14 said that we can only identify the effect of common
  explanatory variables for a modality (modality 1 in particular).
- This paper shows that if one threshold is normalized (to 0 in
  particular), the coefficients of the common explanatory variables
  are identified, they are equal to the structural parameters minus
  the structural parameter for the threshold normalized.

** R implementations
*** CORE       :: cite:Core19 CORE team

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@Manual{Core19,
title = {R: A Language and Environment for Statistical Computing},
author = {{R Core Team}},
organization = {R Foundation for Statistical Computing},
address = {Vienna, Austria},
year = {2019},
url = {http://www.R-project.org/},
}
#+end_src

*** Effects    :: cite:FHon09 [[file:Biblio/Trie/FHon09.pdf][JSS: Effect plots]] 

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{FHon09,
  title={Effect displays in R for multinomial and proportional-odds
                  logit models: Extensions to the effects package},
  author={Fox, John and Hong, Jangman},
  journal={Journal of Statistical Software},
  volume={32},
  number={1},
  pages={1--24},
  year={2009}
}
#+end_src

- Papier JSS pour ploter les effets de modèles multinomiaux et de
  modèles ordonnés
- En plus de l'explication des commandes R, il y a le calcul des
  écarts-types pour les modèles multinomiaux.

*** MASS       :: cite:VRip02 [[file:Biblio/Trie/VRip02.pdf][Book: Ordered model with MASS]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@Book{VRip02,
    title = {Modern Applied Statistics with S},
    author = {W. N. Venables and B. D. Ripley},
    publisher = {Springer},
    edition = {Fourth},
    address = {New York},
    year = {2002},
    note = {ISBN 0-387-95457-0},
    url = {http://www.stats.ox.ac.uk/pub/MASS4},
}
#+end_src

- Pour le Package MASS

*** sp, spdep  :: cite:BPGR13 [[file:Biblio/Trie/BPGR13.pdf][Book: Spatial data with R]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{BPGR13,
  title={Applied spatial data: analysis with R},
  author={Bivand, Roger S and Pebesma, Edzer J and Rubio, Virgilio
                  G{\'o}mez},
  year={2008},
  publisher={Springer}
}
#+end_src

- Pour les fonctions spatiales

*** car        :: cite:FWei19 [[file:Biblio/Trie/FWei19.pdf][Book: Companion Applied Regression]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{FWei19,
  title={An R companion to applied regression},
  author={Fox, John and Weisberg, Sanford},
  year={2010},
  publisher={Sage}
}
#+end_src

- Pour les fonctions spatiales

*** VGAM       :: cite:Yee10  [[file:Biblio/Trie/Yee10.pdf][JSS: Vector generalized models]] [[file:Biblio/Trie/Yee15.pdf][Book]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Yee10,
    AUTHOR = {Yee, Thomas W.},
     TITLE = {The \textsf{VGAM} Package for Categorical Data Analysis},
   JOURNAL = {J. Statist. Soft.},
  FJOURNAL = {Journal of Statistical Software},
    VOLUME = {32},
      YEAR = {2010},
    NUMBER = {10},
     PAGES = {1--34},
    URL = {http://www.jstatsoft.org/v32/i10/},
}
@book{Yee15,
    AUTHOR = {Yee, T. W.},
     TITLE = {Vector Generalized Linear and Additive Models:
              With an Implementation in {R}},
      YEAR = {2015},
 Publisher = {Springer},
   Address = {New York, NY, USA},
}
#+end_src

- marginal effect can be computed
- conditional mnl can be estimated, also parallel multinomial!
- Reduced Rank is a kind of PLS
- At the end of the paper, it shows how to force spline to have the
  same knots to be used in the constraints.
- Seemingly Unrelated Regression: [[pdfview:/home/jsay/geoIndic/Biblio/Trie/Yee15.pdf::317][ici, with 3 means to estimate:
  Zellner plug-in (maxit= 1), Zellner interactive (maxit as default
  and SURff(divisor = "sqrt")) and multivariate normal errors.

*** Ordinal    :: cite:CBro13 [[file:Biblio/Trie/CBro13.pdf][JSFS: Paper for ordinal package]]

    with R paper on the functions [[file:Biblio/Trie/clm18.pdf][clm]] and [[file:Biblio/Trie/clmm18.pdf][clmm]] from the package
    [[file:Biblio/Trie/ordi18.pdf][ordinal]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CBro13,
  title={Analysis of sensory ratings data with cumulative link models},
  author={Christensen, Rune Haubo Bojesen and Brockhoff, Per Bruun},
  journal={Journal de la Soci{\'e}t{\'e} Fran{\c{c}}aise de Statistique},
  volume={154},
  number={3},
  pages={58--79},
  year={2013}
}
#+end_src

- The JSFS paper contains simple inference procedure for ordinal
  models
- It is interesting to present the nominal coefficients jointly with
  the thresholds. p.31, many explications about the identification of
  the ordered models but there is not a method to deal with.
- Originality according to the author: scale effect
  (heteroscedasticity), structured thresholds (symetric or
  equidistant), partially proportional (called nominal effects),
  flexible link function (gumbel, log-gamma)
- If nominal effects are based on dummy variables, be careful to the
  reference modality
- Link function that looks like a box-cox transformation: with a
  additional parameter that can be estimated (could be long)
- Look at convergence failure if unordered thresholds
- We can test the parallel assumption for all the variables
  independently.
- We can plot the profile likelihood which can be used as a test for
  "derivative of LL with respect to the parameter" used in another
  paper. GMCB18 (R journal for surrogate) say that Harrel 2001 (book,
  p.334) "suggest to compute each observation contribution to the
  first derivative of the log lilkelihood function with respect to
  beta and averaging them within each of the J categories".
- For random effects, we have only an example with clmm2, another
  function clmm is announced but not already available. clmm2(rating ~
  temp + contact, random=judge, data=wine) Tutz, G. and W. Hennevogl
  (1996). Random effects in ordinal regression models. Computational
  Statistics & Data Analysis 22, 537–557
- Be careful for predictions with mixed models

*** brglm      :: cite:Kosm14 [[file:Biblio/Trie/Kosm14.pdf][JRSS: Bias correction ML ordered]] [[file:Biblio/Trie/Kosm17.pdf][pres]]

    with
    - https://github.com/ikosmidis/brglm2
    - https://cran.r-project.org/web/packages/brglm2/vignettes/iteration.html

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Kosm14,
  title={Improved estimation in cumulative link models},
  author={Kosmidis, Ioannis},
  journal={Journal of the Royal Statistical Society: Series B
                  (Statistical Methodology)},
  volume={76},
  number={1},
  pages={169--196},
  year={2014},
  publisher={Wiley Online Library}
}
#+end_src

*** mgcv       :: cite:WPSa16 [[file:Biblio/Trie/WPSa16.pdf][JASA: General smooth models]]

    with [[file:Biblio/Trie/Knei16.pdf][Kneib]], [[file:Biblio/Trie/Yee16.pdf][Yee]], [[file:Biblio/Trie/GSch16.pdf][Greven and Scheipl]] comments and a [[file:Biblio/Trie/WPSa16a.pdf][Rejoinder]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{WPSa16,
  title={Smoothing parameter and model selection for general smooth models},
  author={Wood, Simon N and Pya, Natalya and S{\"a}fken, Benjamin},
  journal={Journal of the American Statistical Association},
  volume={111},
  number={516},
  pages={1548--1563},
  year={2016},
  publisher={Taylor \& Francis}
}
#+end_src

- We can specify heteroscedasticity with the package (called
  location-scale model)
- They propose a new Information Criterion for model selection
- Additional material at the end of the file
- Section 7 is an example with an ordered outcome, the first threshold
  is normalized to 1 in order to have an intercept in the model.
- Section 8 is a bivariate additive continuous model with correlated
  errors with random effects about car manufacturer
- Kneib et al. call these models structured additive distributional
  regression models in a bayesian framework.
- Yee says that the link= "identity" is confusing as it is a logit
  link, additional links could be provided. The non-parallel
  application could also be difficult.

*** mgcv       :: cite:Wood17 [[file:Biblio/Trie/Wood17.pdf][Book: Wood gam]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Wood17,
  title={Generalized additive models: An introduction with R},
  author={Wood, Simon N},
  year={2017},
  publisher={Chapman and Hall/CRC, second edition}
}
#+end_src

From [[file:Biblio/Trie/WoodSmooth.pdf][slides]] about smoothing choices
- with univariate smooth function, there are several alternatives for
  smooth functions without elements to choose between them. BUT for
  bivariate smooth functions, there is a major choice: ISOTROPIC
  smooth (for same scale: spatial locations) or SCALE INVARIANT (for
  variables measured in different units)
- For the splines, for a given number of basis, the lambda is the
  weight on the penalization. More alpha is high more the function is
  smooth. Two possibilities about basis choice: choose some knots
  (knot based) or choosing the number of basis (eigen based).
- With the inside argument bs= "", we have:
  - "cr" basis is knot based, "cc" is a cyclic version
  - "tp" is an eigen approximation to a thin plate spline
  - "ps" p-splines with flexibility with penalties and basis functions
  - "ad" adaptive smoother in with strength of penalty varies with
    covariate.
  - In general "cr", "tp" and "ps" produce similar results, "ad" is in
    general different.
- In 2 dimensions, thin plate is isotropic. Isotropic smooths assume
  that a unit change in one variable is equivalent to a unit change in
  another variable, in terms of function variability. Tensor product
  smooths have some flexibility in the different
  dimensions. te(x,z,v,bs="ps",k=5) creates a tensor product smooth of
  x, z and v using rank 5 P-spline marginals: the resulting smooth has
  3 penalties and basis dimension 125
  (5x5x5). te(x,z,t,bs=c("tp","cr"),d=c(2,1),k=(20,5)) creates a
  tensor product of an isotropic 2-D TPS with a 1-D smooth in
  time. The result is isotropic in x,z, has 2 penalties and a basis
  dimension of 100. This sort of smooth would be appropriate for a
  location-time interaction.
- You have to choose the number of basis functions to use for each
  smooth, using the k argument of s or te. The default is essentially
  arbitrary. HE PROPOSE AN ANALYSIS BASED ON THE RESIDUALS!

*** ordinalNet :: rien

    [[file:Biblio/Trie/WRHa17.pdf][Vignette]] 

*** sure       :: cite:LZha18 [[file:Biblio/Trie/LZha18.pdf][JASA: Surrogate residuals]] [[file:Biblio/Trie/LZha18a.pdf][Sup Mat]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{LZha18,
  title={Residuals and Diagnostics for Ordinal Regression Models: A
                  Surrogate Approach},
  author={Liu, Dungang and Zhang, Heping},
  journal={Journal of the American Statistical Association},
  pages={1--10},
  year={2018},
  publisher={Taylor \& Francis}
}
@article{GMCB18,
  title={Residuals and Diagnostics for Binary and Ordinal Regression
                  Models: An Introduction to the sure Package},
  author={Greenwell, Brandon M and McCarthy, Andrew J and Boehmke,
                  Bradley C and Liu, Dungang},
  journal={The R Journal},
  year={2018}
}
#+end_src

   Also a R journal article : [[file:Biblio/Trie/GMCB18.pdf][RJ: Surrogate residuals]]
   and a Github repo : https://github.com/koalaverse/sure

- work with polr, clm, vglm, vgam
- used to test specification (variables and link), heteroscedasticity,
  proportionality, missing covariates,
- Proposition of monotonicity (for a same x, if the AOC is greater for
  one observation, the residual is also greater for this
  observation). This is not the case for multinomials. We have to see
  the validity of this proposition along the OP / MNL gradient.
- Proofs in the supplementary material
- An originality could be to used them to test spatial
  auto-correlation.
- In the appendix, a discussion of goodness-of-fit, with
  Kolmogorov-Smirnov distance (to compare different distribution
  functions)

*** mvord      :: cite:HHVa18 [[file:Biblio/Trie/HHVa18.pdf][SMA: Multivariate ordinal regression]]

    Application of Multivariate ordinal =mvord= [[file:Biblio/Trie/HHVa17.pdf][vignette]] and [[file:Biblio/Trie/HHVa18a.pdf][slides]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{HHVa18,
  title={Multivariate ordinal regression models: an analysis of
                  corporate credit ratings},
  author={Hirk, Rainer and Hornik, Kurt and Vana, Laura},
  journal={Statistical Methods \& Applications},
  pages={1--33},
  year={2018},
  publisher={Springer}
}
#+end_src

- Can be used to model old and new GIs with correlation in the
  unobservable (including with binary outcome but not at the right of
  the main equation)
- Can be used to relax parallel assumption, heteroscedasticity and
  constant thresholds. Correlation between errors can also depends on
  covariates.
- Thresholds parameters are constrained to achieve monotonicity.
- Many constrains on the parameters which allow exclusion relations.

*** functions  :: cite:ATar18 [[file:Biblio/Trie/ATar18.pdf][SN: Interpret effects]] [[file:Biblio/Trie/ATar18a.pdf][Sup Mat]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{ATar18,
  title={Simple ways to interpret effects in modeling ordinal
                  categorical data},
  author={Agresti, Alan and Tarantola, Claudia},
  journal={Statistica Neerlandica},
  year={2018},
  publisher={Wiley Online Library}
}
@article{AKat17,
  title={Ordinal probability effect measures for group comparisons in
                  multinomial cumulative link models},
  author={Agresti, Alan and Kateri, Maria},
  journal={Biometrics},
  volume={73},
  number={1},
  pages={214--219},
  year={2017},
  publisher={Wiley Online Library}
}
#+end_src

- Marginal effects presented are not relevant for polynomial effects,
  so not relevant for us.
- The best measure of partial effect is AME: derive for each
  observation and aggregate (or plot, Long and Freese 2014, Sun 2015)
- For predictive evaluation, concordance effects (already present in
  our code) and a particular interpretation of MacFadden pseudoR2.
- The supmat include some R functions to interpret dummy variables and
  compute standard deviations.
- The second paper [[file:Biblio/Trie/AKat17.pdf][AKat17]] provides a measure of the proba of ordinal
  dominance that can be interesting for communes effects once the
  terroir is fully controlled.

*** PRes

    Allow to compute residuals but also quantify the conditional
    association between ordinal variables, can be used to compare old
    and new GIs: [[file:Biblio/Trie/LShe10.pdf][Paper]] and [[file:Biblio/Trie/DHLL18.pdf][Manual]]

*** plot effects

    [[file:Biblio/Trie/FWei18.pdf][Gallery]]

*** [[file:Biblio/Trie/AHNG18.pdf][Mixor]] and [[file:Biblio/Trie/AHZF18.pdf][ordinalgmifs]]

- Mixor is interesting for clusterized approaches, as a substitute for
  random effects
- ordinalgmifs is for shrinkage regressions on ordered outcomes
  
*** Extended Ordered Regression

     [[file:Biblio/Trie/MMWZ14.pdf][Paper]] and [[file:Biblio/Trie/MMWZ18.pdf][vignette]] 

*** multgee

    [[file:Biblio/Trie/Toul16.pdf][Vignette]], [[file:Biblio/Trie/Toul15.pdf][JSS paper]] and [[file:Biblio/Trie/Toul16a.pdf][R journal]] article about simulations

*** Oglmx

    [[file:Biblio/Trie/Caro18.pdf][Vignette]]

    Not interesting, only allow heteroscedasticity.

*** Interval with selection

    [[file:Biblio/Trie/HPHe17.pdf][Vignette]]

    Petersen, Henningsen, Henningsen, non encore publié mais il y a la
    vignette associée au package sampleSelection. Pour l'instant ne
    permet pas d'estimer les seuils, ils doivent être spécifiés
    explicitement. C'est pour cela que l'on va favoriser la
    non-parellel assumption, d'autant plus que l'absence d'AOC
    correspond bien à un niveau plus faible dans la hiérarchie.

*** Monotonicity

    https://github.com/dongwookim1984/Testing_SD

*** Ordered GWR

    see additional material of DNBr18

*** vcrpart

    recursive partitioning [[file:Biblio/Trie/BRit17.pdf][JSS paper]] and [[file:Biblio/Trie/BRit18.pdf][Manual]]

** Spatial econometrics
*** cite:PCad95 [[file:Biblio/Trie/PCad95.pdf][Science: Spatial heterogeneity]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{PCad95,
  title={Landscape ecology: spatial heterogeneity in ecological systems},
  author={Pickett, Steward TA and Cadenasso, Mary L},
  journal={Science},
  volume={269},
  number={5222},
  pages={331--333},
  year={1995},
  publisher={New York, NY:[sn] 1880-}
}
#+end_src

- Un papier qui explique la généralité des pattern spatiaux suite à
  l'hétérogénéité

*** cite:KPru01 [[file:Biblio/Trie/KPru01.pdf][JoE: Moran's I for qualitative responses]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{KPru01,
  title={On the asymptotic distribution of the Moran I test statistic
                  with applications},
  author={Kelejian, Harry H and Prucha, Ingmar R},
  journal={Journal of Econometrics},
  volume={104},
  number={2},
  pages={219--257},
  year={2001},
  publisher={Elsevier}
}
#+end_src

- Formulas and asymptotic theory for the Moran's I on residuals from
  discrete models, ordered in particular. [[pdfview:/home/jsay/geoIndic/Biblio/Trie/KPru01.pdf::19][ici]]

*** cite:KWan03 [[file:Biblio/Trie/KWan03.pdf][JRSS: Geoadditive models]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{KWan03,
  title={Geoadditive models},
  author={Kammann, EE and Wand, Matthew P},
  journal={Journal of the Royal Statistical Society: Series C (Applied
                  Statistics)},
  volume={52},
  number={1},
  pages={1--18},
  year={2003},
  publisher={Wiley Online Library}
}
#+end_src

- Approche statistique sur les modèles additifs qui admettent les
  coordonnées parmi les variables explicatives.

*** cite:MMil03 [[file:Biblio/Trie/MMil03.pdf][IRSR: Moran for misspecification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MMil03,
  title={Spatial autocorrelation or model misspecification?},
  author={McMillen, Daniel P},
  journal={International Regional Science Review},
  volume={26},
  number={2},
  pages={208--217},
  year={2003},
  publisher={Sage Publications}
}
#+end_src

- about Moran's I usage for misspecification
- Un classique de McMillen, avec des simulations mais très peu
  d'analytique.

*** cite:Dell10 [[file:Biblio/Trie/Dell10.pdf][Econca: Spatial coordinates]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Dell10,
  title={The persistent effects of {P}eru's mining \emph{mita}},
  author={Dell, Melissa},
  journal={Econometrica},
  volume={78},
  number={6},
  pages={1863--1903},
  year={2010},
  publisher={Wiley Online Library}
}
#+end_src

- Un papier avec des fonctions de lissage et une discontinuité
  spatiale.
- Illustration des coordonnées pour l'hétérogénéité spatiale

*** cite:MMil10 [[file:Biblio/Trie/MMil10.pdf][JRS: Spatial nonparam]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MMil10,
  title={Issues in spatial data analysis},
  author={McMillen, Daniel P},
  journal={Journal of Regional Science},
  volume={50},
  number={1},
  pages={119--141},
  year={2010},
  publisher={Wiley Online Library}
}
#+end_src

- Papier sur les spécifications non paramétriques pour gagner en
  flexibilité par rapport aux approches spatial paramétriques.

*** cite:MMil12 [[file:Biblio/Trie/MMil12.pdf][JRS: Spatial econometrics]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MMil12,
  title={Perspectives on Spatial Econometrics: Linear Smoothing with
                  Structured Models},
  author={McMillen, Daniel P},
  journal={Journal of Regional Science},
  volume={52},
  number={2},
  pages={192--209},
  year={2012},
  publisher={Wiley Online Library}
}
#+end_src

- Smoothed non parametric functions are better than spatial AR models,
  more parametric

*** cite:LVEP15 [[file:Biblio/Trie/LVEP15.pdf][LE: Geoadditive as fixed effects]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{LVEP15,
  title={An Alternative to the Standard Spatial Econometric Approaches
                  in Hedonic House Price Models},
  author={Lausted Veie, Kathrine and Panduro, Toke Emil},
  journal={Land Economics},
  volume={91},
  number={2},
  pages={386--409},
  year={2015},
  publisher={University of Wisconsin Press}
}
#+end_src

- Enfin un papier qui décrit une fonction GAM des coordonnées
  spatiales comme une alternatives aux effets fixes spatiaux
- Il n'y a pas grand chose d'un point de vue structurel (pas de
  référence à la méthode proxy)
- mais ils comparent par rapport aux méthodes d'économétrie spatiale
  paramétrique et montrent que ça marche mieux

** Terroir importance
*** cite:JLom93 [[file:Biblio/Trie/JLom93.pdf][AJEV: Review wine quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{JLom93,
  title={Environmental and management practices affecting grape
                  composition and wine quality-a review},
  author={Jackson, DI and Lombard, PB},
  journal={American Journal of Enology and Viticulture},
  volume={44},
  number={4},
  pages={409--430},
  year={1993},
  publisher={Am Soc Enol Viticulture}
}
#+end_src

- Revue de littérature sur ce qui fait la qualité d'un vin

*** cite:AALa95 [[file:Biblio/Trie/AALa95.pdf][Chance: Prix, climat, qualité]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{AALa95,
  title={Bordeaux wine vintage quality and the weather},
  author={Ashenfelter, Orley and Ashmore, David and Lalonde, Robert},
  journal={Chance},
  volume={8},
  number={4},
  pages={7--14},
  year={1995},
  publisher={Taylor \& Francis}
}
#+end_src

- Sur la base des prix longue période de quelques Château Bordelais,
  ils montrent que les variables climatiques sont des bons indicateurs
  des prix des vins.
- Ils utilisent des prix actuels (y compris pour les vieux millésimes)
  ce qui permet d'estimer le taux de rendement interne associé à la
  détention de Bordeaux. Ce sont les écart à cette tendance qui sont
  alors utilisées.
- Ils montrent en outre que le marché des primeurs a du mal a révéler
  l'information sur la qualité mais que cela peut se comprendre étant
  donné la fonction "lissage des revenus" qu'à le marché des vins en
  primeur.

*** cite:VLFC04 [[file:Biblio/Trie/VLFC04.pdf][AJEV: Terroir measured]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{VLFC04,
  title={Influence of climate, soil, and cultivar on terroir},
  author={Van Leeuwen, Cornelis and Friant, Philippe and Chone, Xavier
                  and Tregoat, Olivier and Koundouras, Stephanos and
                  Dubourdieu, Denis},
  journal={American Journal of Enology and Viticulture},
  volume={55},
  number={3},
  pages={207--217},
  year={2004},
  publisher={Am Soc Enol Viticulture}
}
#+end_src

- Il montre que le terroir est plus du climat et des sols que des
  modes de culture
- Par contre c'est sur les attributs biophysiques du raisin plutôt que
  sur une histoire économique

*** cite:LVis06 [[file:Biblio/Trie/LVis06.pdf][JWE: Weather and price]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{LVis06,
  title={Spatial variations in weather conditions and wine prices in
                  Bordeaux},
  author={Lecocq, S{\'e}bastien and Visser, Michael},
  journal={Journal of Wine Economics},
  volume={1},
  number={02},
  pages={114--124},
  year={2006},
  publisher={Cambridge Univ Press}
}
#+end_src

- Sur les données climatiques et le prix des bordeaux, en utilisant
  les variations inter-annuelles.

*** cite:Ashe08 [[file:Biblio/Trie/Ashe08.pdf][EJ: Predicting quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Ashe08,
  title={Predicting the quality and prices of Bordeaux wine},
  author={Ashenfelter, Orley},
  journal={Economic Journal},
  volume={118},
  number={529},
  pages={F174--F184},
  year={2008},
  publisher={Wiley Online Library}
}
#+end_src

- I show that a simple statistical analysis predicts the quality of a
  vintage, and hence its price, from the weather during its growing
  season.
- good vintages produce good wines in all vineyards and the best wines
  are produced in the best vineyards in all vintages.
- In fact, a more advanced statistical analysis reveals that
  information on chateau and vintage alone explain over 90% of the
  variation in the prices.
- In fact, as Edmund Penning-Rowsell (1985) points out in his classic
  book The Wines of Bordeaux, the famous 1855 classification of the
  chateaux of Bordeaux into quality grades was based on a similar
  assessment by price alone.
- there are two natural dimensions on which to search for hedonic
  determinants of wine quality: the vintage and the vineyard. In
  climatological terms it is natural to associate the first with
  weather variability from year to year and the second with climate
  variability across vineyards.
- Econometric analyses using data from vineyards in France (Combris et
  al., 1997; Jones and Storchmann, 2001), California (Haeger and
  Storchmann, 2006) and Germany (Ashenfelter and Storchmann, 2006) all
  show that heat retention and drainage (to remove excess water when
  it exists) are key determinants of vineyards prices and wine
  quality.
- He use summer temperature and harvest rain. Finally, the historical
  reputation of the chateau that produced the wine explains much of
  the remaining variability in prices. Not very much here: about 10%.

*** cite:GGin08 [[file:Biblio/Trie/GGin08.pdf][EJ: Natural endowments]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GGin08,
  title={Natural Endowments, Production Technologies and the Quality
                  of Wines in Bordeaux. Does Terroir Matter?},
  author={Gergaud, Olivier and Ginsburgh, Victor},
  journal={Economic Journal},
  volume={118},
  number={529},
  pages={F142--F157},
  year={2008},
  publisher={Wiley Online Library}
}
#+end_src

- Variables instrumentales pour tester l'effet des natural endowments,
  car la technologie est endogène
- Ils ne trouvent pas d'effets significatifs sur les natural
  endowments
     
*** cite:WWJo09 [[file:Biblio/Trie/WWJo09.pdf][NGeo: Land and wine]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{WWJo09,
  title={Land and wine},
  author={White, Michael A and Whalen, Philip and Jones, Gregory V},
  journal={Nature Geoscience},
  volume={2},
  number={2},
  pages={82},
  year={2009},
  publisher={Nature Publishing Group}
}
#+end_src

- Ils ne croient pas en la terre comme source de la qualité des vins
- Ils plaident pour une vision dynamique du terroir en lien avec les
  changements technologiques et les changements climatiques.
- Deux de leurs arguments ne sont pas vérifiés par les
  faits. L'importance forte du climat: quand on regarde les variations
  de prix entre les crus, la dimension spatiale est plus forte. Le
  changement climatique et technologique va déplacer les AOC, un
  classement qui date de 1915 que les bouquins récents et les prix ne
  remettent pas en cause.
- typique pour illustrer les papier anti-terroir, avec bien sûr une
  référence au jugement de Paris.

*** cite:ASto10 [[file:Biblio/Trie/ASto10.pdf][REE: Solar radiation]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{ASto10,
  title={Using hedonic models of solar radiation and weather to assess
                  the economic effect of climate change: the case of
                  Mosel valley vineyards},
  author={Ashenfelter, Orley and Storchmann, Karl},
  journal={The Review of Economics and Statistics},
  volume={92},
  number={2},
  pages={333--349},
  year={2010},
  publisher={MIT Press}
}
#+end_src

- Model sur le prix du vignoble, qui utilise des données biophysiques
  pour estimer l'effet du réchauffement climatique sur les vignes.
- Il ya un modèle de probit ordonné pour les désignations AOC mais
  ils ne testent pas l'endogénéité des désignations.
- Des trucs intéressant sur l'échelle des variables explicatives
  (climat versus attribut de la terre) sur la variable proxy qu'ils
  calculent: solar radiation.
     
*** cite:CPSt11 [[file:Biblio/Trie/CPSt11.pdf][AER: Value of terroir]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CPSt11,
  title={What is the Value of Terroir?},
  author={Cross, Robin and Plantinga, Andrew J and Stavins, Robert N},
  journal={American Economic Review},
  volume={101},
  number={3},
  pages={152},
  year={2011}
}
#+end_src

- Sur l'utilisation de modèles hédoniques appliqués à la terre pour
  estimer la valeur du terroir.

*** cite:BTRM14 [[file:Biblio/Trie/BTRM14.pdf][PNAS: Microbial geography]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{BTRM14,
  title={Microbial biogeography of wine grapes is conditioned by
                  cultivar, vintage, and climate},
  author={Bokulich, Nicholas A and Thorngate, John H and Richardson,
                  Paul M and Mills, David A},
  journal={Proceedings of the National Academy of Sciences},
  volume={111},
  number={1},
  pages={E139--E148},
  year={2014},
  publisher={National Acad Sciences}
}
#+end_src

- Sur le role des microbes dans la composition des vignes
- Peut être utilisé pour justifier le spatial dans l'hétérogénéité non
  observée

*** cite:GLZa14 [[file:Biblio/Trie/GLZa14.pdf][PNAS: Microbial terroir]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GLZa14,
  title={Microbial terroir for wine grapes},
  author={Gilbert, Jack A and van der Lelie, Daniel and Zarraonaindia,
                  Iratxe},
  journal={Proceedings of the National Academy of Sciences},
  volume={111},
  number={1},
  pages={5--6},
  year={2014},
  publisher={National Acad Sciences}
}
#+end_src

- Un commentaire du papier sur le role des microbes dans la
  définion du terroir,
- Peut être cité pour donner du poids à la première

*** cite:RBGS14 [[file:Biblio/Trie/RBGS14.pdf][FC: Terroir effect in wine]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{RBGS14,
  title={A grape and wine chemodiversity comparison of different
                  appellations in {B}urgundy: Vintage vs terroir
                  effects},
  author={Roullier-Gall, Chlo{\'e} and Boutegrabet, Lemia and Gougeon,
                  R{\'e}gis D and Schmitt-Kopplin, Philippe},
  journal={Food chemistry},
  volume={152},
  pages={100--107},
  year={2014},
  publisher={Elsevier}
}
#+end_src

- Therefore, and for a given vintage and a given appellation, terroir
  was treated as the composite of all possible environmental factors,
  which could influence the overall characteristics of
  vineyard-related grapes and subsequent wines
- it can be seen that wines could be rather well separated according
  to vintages but not according to the terroir (without ageing)
- the terroir as a whole – i.e. that considers the
  vine-soil-climate-human ecosystem – definitely impacts the initial
  chemical complexity of a wine, but time – i.e. bottle ageing – might
  be required to fully reveal it through the in-bottle diagenesis of
  complex chemical signatures. (par contre ces effets de terroir sont
  obtenus par l'identification des effets cote de beaune vs cote de
  nuits)

*** cite:KKFG15 [[file:Biblio/Trie/KKFG15.pdf][ScReport: Microbial terroir]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{KKFG15,
  title={Regional microbial signatures positively correlate with
                  differential wine phenotypes: Evidence for a
                  microbial aspect to terroir},
  author={Knight, Sarah and Klaere, Steffen and Fedrizzi, Bruno and
                  Goddard, Matthew R},
  journal={Scientific reports},
  volume={5},
  year={2015},
  publisher={Nature Publishing Group}
}
#+end_src

- Un autre papier qui montre l'exemple du rôle des microbes comme
  effet du terroir

*** cite:Gang16 [[file:Biblio/Trie/Gang16.pdf][Book: Intellectual property]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{Gang16,
  title={Research handbook on intellectual property and geographical
                  indications},
  author={Gangjee, Dev S},
  year={2016},
  publisher={Edward Elgar Publishing}
}
#+end_src

- Le lien pointe sur le chapitre de Bérard
- For better or worse, that principle is steadily gaining global
  acceptance

*** cite:Ashe17 [[file:Biblio/Trie/Ashe17.pdf][JWE: Vineyard site selection]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Ashe17,
  title={The hedonic approach to vineyard site selection: Adaptation
                  to climate change and grape growing in emerging
                  markets},
  author={Ashenfelter, Orley},
  journal={Journal of Wine Economics},
  volume={12},
  number={1},
  pages={3--15},
  year={2017},
  publisher={Cambridge University Press}
}
#+end_src

- optimizing grape type for each location, estimate the quality of
  wines that can be produced in a particular area, and judge whether
  wine grape production is economically viable.
- He does not deal with scale effects.
- The plantation of older vineyard areas may, therefore, require
  adaptation to crops of higher quality in order to maintain their
  economic viability.
- A precursor to much of this work is Gladstone’s (1992) remarkable
  analysis of Australian vineyard sites. Gladstone details the
  characteristics that ameliorate weather in many Australian
  plantation areas and recommends appropriate grape varietals for
  each. His recommendations have been very successful, especially in
  Western Australia. See also Haeger and Storchmann (2006).
- One purpose of this review is to show how subjective measures of
  wine quality may be used to calibrate the role of weather in the
  determination of wine quality.
- Less weather in Burgundy wine price, less anter-annual variations,
  more terroir.

*** cite:VLRR18 [[file:Biblio/Trie/VLRR18.pdf][OENO: Terroir survey]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{VLRR18,
  title={Soil-related \emph{terroir} factors: A review},
  author={van Leeuwen, Cornelis and Roby, Jean-Philippe and de
                  Ress{\'e}guier, Laure},
  journal={OENO One},
  volume={52},
  number={2},
  pages={173--188},
  year={2018}
}
#+end_src

- Un survey sur le lien du terroir à la terre

** Wine quality
*** cite:CLVi97 [[file:Biblio/Trie/CLVi97.pdf][EJ: Hedonic wine]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CLVi97,
  title={Estimation of a hedonic price equation for {B}ordeaux wine:
                  Does quality matter?},
  author={Combris, Pierre and Lecocq, S{\'e}bastien and Visser, Michael},
  journal={Economic Journal},
  volume={107},
  number={441},
  pages={390--402},
  year={1997},
  publisher={Wiley Online Library}
}
#+end_src

- Estimation sur données expérimentales
- Une des premiers papier sur l'hédonisme appliqué au prix du
  vin. Remarquable en particulier par la structure en prime de la
  valeur des différentes réputations (échelles à vérifier).

*** cite:Oczk01 [[file:Biblio/Trie/Oczk01.pdf][ER: Hedonic measurement errors]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Oczk01,
  title={Hedonic wine price functions and measurement error},
  author={Oczkowski, Edward},
  journal={Economic record},
  volume={77},
  number={239},
  pages={374--382},
  year={2001},
  publisher={Wiley Online Library}
}
#+end_src

- Les erreurs de mesures sont en lien avec la qualité des vins et la
  réputation. C'est une modélisation en terme de variables latentes.
- Par rapport à un modèle biophysique, ces variables de qualité sont
  déjà endogènes.
- Intéressant contre la multicolinéarité au même titre que les PLS,
  mais corriger des erreurs de mesure en supprimant des variables est
  étonnant.

*** cite:HLoc02 [[file:Biblio/Trie/HLoc02.pdf][JWR: Prediction of wine quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{HLoc02,
  title={What price quality? An investigation into the prediction of
                  wine-quality ratings},
  author={Horowitz, Ira and Lockshin, Larry},
  journal={Journal of Wine Research},
  volume={13},
  number={1},
  pages={7--22},
  year={2002},
  publisher={Taylor \& Francis}
}
#+end_src

- Question de la redondance de l'information lorsque l'on achète du
  vin. the quality ratings of wines take on the role of the dependent
  variable in a series of regression equations that employ as the
  independent explanatory variables many of the same factors that
  other researchers have included in their explorations.
- Rating between 3 and 5 with .5 increment
- Modèle de régression linéaire avec plein de variables endogènes et
  des R2 de l'ordre de 30%.

*** cite:CMar04 [[file:Biblio/Trie/CMar04.pdf][Book: Éco de la qualité]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@book{CMar04,
  title={Economie de la qualit{\'e}},
  author={Coestier, B{\'e}n{\'e}dicte and Marette, St{\'e}phan},
  year={2004},
  publisher={La d{\'e}couverte}
}
#+end_src

- yop

*** cite:HSto06 [[file:Biblio/Trie/HSto06.pdf][AE: Determinant of Pinot noir price]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{HSto06,
  title={Prices of American Pinot Noir wines: climate, craftsmanship,
                  critics},
  author={Haeger, John W and Storchmann, Karl},
  journal={Agricultural Economics},
  volume={35},
  number={1},
  pages={67--78},
  year={2006},
  publisher={Wiley Online Library}
}
#+end_src

- Les prix des pinots N américains en lien avec le climat, les marques
  et les critiques.
- L'article identifie le climat bourguignon comme le plus adapté au
  pinot noir (mais peut être est-ce l'inverse?)

*** cite:LJHP06 [[file:Biblio/Trie/LJHP06.pdf][FQP: Wine choices]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{LJHP06,
  title={Using simulations from discrete choice experiments to measure
                  consumer sensitivity to brand, region, price, and
                  awards in wine choice},
  author={Lockshin, Larry and Jarvis, Wade and d’Hauteville,
                  Fran{\c{c}}ois and Perrouty, Jean-Philippe},
  journal={Food quality and preference},
  volume={17},
  number={3-4},
  pages={166--178},
  year={2006},
  publisher={Elsevier}
}
#+end_src

- Un modèle de simulation sur les attributs des vins.

*** cite:Prii06 [[file:Biblio/Trie/Prii06.pdf][IJWM: GI masks quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Prii06,
  title={Wine's placebo effect: How the extrinsic cues of visual
                  assessments mask the intrinsic quality of South
                  African red wine},
  author={Priilaid, David A},
  journal={International Journal of Wine Marketing},
  volume={18},
  number={1},
  pages={17--32},
  year={2006},
  publisher={Emerald Group Publishing Limited}
}
#+end_src

- 2 types d'appréciations sont considérées, aveugle ou non aveugle.
- Dans la seconde, le prix de la bouteille est important, tout comme
  la région d'origine.
- Par contre à l'aveugle la région d'origine ne joue pas donc c'est du
  fake.

*** cite:CMCM07 [[file:Biblio/Trie/CMCM07.pdf][JAE: Segmented wine market]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CMCM07,
  title={Segmenting the wine market based on price: hedonic regression
                  when different prices mean different products},
  author={Costanigro, Marco and McCluskey, Jill J and Mittelhammer,
                  Ron C},
  journal={Journal of Agricultural Economics},
  volume={58},
  number={3},
  pages={454--466},
  year={2007},
  publisher={Wiley Online Library}
}
#+end_src

- Ils disent que la consommation de vin est souvent associée à des
  occasions sociales. C'est un argument intéressant pour justifier ou
  discuter de la présence des AOC dans la fonction d'utilité.
- Le risque dans l'achat d'une bouteille de vin est croissant avec le
  prix de la bouteille est décroissant avec l'information
  disponible. Puisque les gens qui achètent des vins chers sont mieux
  informés, la courbe est en U inversé avec un maximum de risque pour
  les vins de milieu de gamme.
- Ils utilisent une /negative square root transformation/ pour la
  variable dépendante.
- En fixant le nombre de segments de marché de manière exogène. Puis
  en testant un ensemble de prix seuils au travers des effets sur les
  RMSE, ils arrivent à déterminer les prix seuils qui distinguent les
  segments: $13, $21, $40. Les prix hédoniques apparaissent
  significativement différents entre les segments de prix.
- Cette méthode de segmentation est clairement moins bien que
  l'utilisation de fonctions quantiles.

*** cite:ANau07 [[file:Biblio/Trie/ANau07.pdf][AJAE: Pricing en primeur]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{ANau07,
  title={The pricing of experience goods: The example of \emph{en
                  primeur} wine},
  author={Ali, H{\'e}la Hadj and Nauges, C{\'e}line},
  journal={American Journal of Agricultural Economics},
  volume={89},
  number={1},
  pages={91--103},
  year={2007},
  publisher={Oxford University Press}
}
#+end_src

- Sur l'effet de la réputation de long terme, des variations annuelles
  dans les prix observés lors des ventes en primeur

*** cite:CPet07 [[file:Biblio/Trie/CPett07.pdf][FQP: Wine quality]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CPet07,
  title={The dimensions of wine quality},
  author={Charters, Steve and Pettigrew, Simone},
  journal={Food Quality and Preference},
  volume={18},
  number={7},
  pages={997--1007},
  year={2007},
  publisher={Elsevier}
}
#+end_src

- Essai de définition de la qualité d'un vin, avec des références
  intrinsèques et extrinsèques.

*** cite:MLSB10 [[file:Biblio/Trie/MLSB10.pdf][FQP: Back label information]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{MLSB10,
  title={Message on a bottle: The relative influence of wine back
                  label information on wine choice},
  author={Mueller, Simone and Lockshin, Larry and Saltman, Yaelle and
                  Blanford, Jason},
  journal={Food Quality and Preference},
  volume={21},
  number={1},
  pages={22--32},
  year={2010},
  publisher={Elsevier}
}
#+end_src

- Marketing sur l'effet des contre-étiquettes, pas d'intérêt en soi

*** cite:SSto10 [[file:Biblio/Trie/SSto10.pdf][JAFIO: Wine price and information]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{SSto10,
  title={Prices as quality signals: Evidence from the wine market},
  author={Schnabel, Hubert and Storchmann, Karl},
  journal={Journal of Agricultural \& Food Industrial Organization},
  volume={8},
  number={1},
  year={2010},
  publisher={De Gruyter}
}
#+end_src

- Effet sur le prix du vin de l'information sur la qualité
- Le rapport du prix en vente directe sur le prix "Vinexpo", le
  dernier servant de référence pour des acheteurs informés.
- Régression du rapport sur la vrai qualité (guide) et sur le degré
  d'information disponible au consommateur, identifié par le prix de
  ventes. Très inspiré de la théorie de cite:BRio91.
- Une partie de la biblio empirique traite du lien entre le niveau
  d'information et la corrélation entre prix et qualité.
- L'effet de ristourne pour les professionels est pris en compte pas
  une constante, ce sont les variations en lien avec la qualité qui
  sont étudiées.
- Le niveau d'information (prix) est instrumenté par des variables
  hédoniques classiques de qualité du vin.
- Au final c'est une méthode économétrique assez indirecte pour tester
  les résultats théoriques de cite:BRio91.
- Avec des données sur les volumes vendus, on pourrait faire un
  meilleur indicateur de l'information disponible aux clients.

*** cite:Stor12 [[file:Biblio/Trie/Stor12.pdf][JWE: Wine economics]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Stor12,
  title={Wine economics},
  author={Storchmann, Karl},
  journal={Journal of Wine Economics},
  volume={7},
  number={1},
  pages={1--33},
  year={2012},
  publisher={Cambridge University Press}
}
#+end_src

- General information about wine economics

*** cite:SNCS13 [[file:Biblio/Trie/SNCS13.pdf][FQP: Facteurs extrinsèques]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{SNCS13,
  title={Perception of wine quality according to extrinsic cues: The
                  case of {B}urgundy wine consumers},
  author={S{\'a}enz-Navajas, Mar{\'\i}a-Pilar and Campo, Eva and
                  Sutan, Angela and Ballester, Jordi and Valentin,
                  Dominique},
  journal={Food Quality and Preference},
  volume={27},
  number={1},
  pages={44--53},
  year={2013},
  publisher={Elsevier}
}
#+end_src

- Eco expé sur les attributs extrinsèques des vins de Bourgogne (i.e.,
  sans dégustation).
- BDM dans un faux magasin. L'origine géographique est le facteur
  principal de qualité (Table 5).

*** cite:GMMo13 [[file:Biblio/Trie/GMMo13.pdf][JWE: Wine price]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{GMMo13,
  title={Red wines of Medoc: what is wine tasting worth?},
  author={Ginsburgh, Victor and Monzak, Muriel and Monzak, Andras},
  journal={Journal of Wine Economics},
  volume={8},
  number={02},
  pages={159--188},
  year={2013},
  publisher={Cambridge Univ Press}
}
#+end_src

- Un papier de plus sur les origines des prix du vin
- We show that technology and weather conditions are able to explain
  two thirds of the riance of prices; when reputation effects (based
  on the wine classification made in 1855) are included, this
  proportion rises to almost 85%.

*** cite:DMDi14 [[file:Biblio/Trie/DMDi14.pdf][ERAE: Endogenous quality choice]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{DMDi14,
  title={Are geographical indications a worthy quality label? A
                  framework with endogenous quality choice},
  author={Desquilbet, Marion and Monier-Dilhan, Sylvette},
  journal={European Review of Agricultural Economics},
  volume={42},
  number={1},
  pages={129--150},
  year={2014},
  publisher={Oxford University Press}
}
#+end_src

- Deux niveaux d'information, qualité et GI, mais le premier est à la
  base une qualité endogène.

** Wine ranking
*** cite:AQua99 [[file:Biblio/Trie/AQua99.pdf][Chance: Jugement de Paris]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{AQua99,
  title={Analyzing a wine tasting statistically},
  author={Ashenfelter, Orley and Quandt, Richard},
  journal={Chance},
  volume={12},
  number={3},
  pages={16--20},
  year={1999},
  publisher={Taylor \& Francis}
}
#+end_src

- how to best to aggregate reported preferences.

*** cite:ALVi08 [[file:Biblio/Trie/ALVi08.pdf][EJ: Parker Gourou]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{ALVi08,
  title={The Impact of Gurus: Parker Grades and En Primeur Wine
                  Prices},
  author={Ali, H{\'e}la Hadj and Lecocq, S{\'e}bastien and Visser,
                  Michael},
  journal={Economic Journal},
  volume={118},
  number={529},
  pages={F158--F173},
  year={2008},
  publisher={Wiley Online Library}
}
#+end_src

- Papier sur l'utilisation de la crise 2002 pour identifier la
  valeur des appréciations Parker dans le prix des vins en primeur.
- Trouve un effet positif.

*** cite:CSto10 [[file:Biblio/Trie/CSto10.pdf][JWE: Judge Performance]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CSto10,
  title={Evaluation of wine judge performance through three
                  characteristics: Bias, discrimination, and
                  variation},
  author={Cao, Jing and Stokes, Lynne},
  journal={Journal of Wine Economics},
  volume={5},
  number={1},
  pages={132--142},
  year={2010},
  publisher={Cambridge University Press}
}
#+end_src

- Evaluation/ décomposition des notes allouées par les juges. Mentione
  les eggshell plot pour voir les juges qui sont discordants, utile
  pour classer différents classements.

*** cite:DNau10 [[file:Biblio/Trie/DNau10.pdf][IJIO: Quality and expert]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{DNau10,
  title={Identifying the effect of unobserved quality and expert
                  reviews in the pricing of experience goods:
                  Empirical application on {B}ordeaux wine},
  author={Dubois, Pierre and Nauges, C{\'e}line},
  journal={International Journal of Industrial Organization},
  volume={28},
  number={3},
  pages={205--212},
  year={2010},
  publisher={Elsevier}
}
#+end_src

- Basé sur la théorie standard d'économie industrielle, une approche à
  la Olley and Pakes sur la qualité inobservable d'un vin et l'absence
  de bonnes variables instrumentales.

*** cite:TMut11 [[file:Biblio/Trie/TMut11.pdf][JWE: Reconsidering classification]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{TMut11,
  title={Reconsidering the 1855 Bordeaux classification of the Medoc
                  and Graves using wine ratings from 1970--2005},
  author={Thompson, Gary M and Mutkoski, Stephen A},
  journal={Journal of Wine Economics},
  volume={6},
  number={1},
  pages={15--36},
  year={2011},
  publisher={Cambridge University Press}
}
#+end_src

- Counterfactual bordeaux classification

*** cite:FGro12 [[file:Biblio/Trie/FGro12.pdf][AEJ: Expert review]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{FGro12,
  title={Do expert reviews affect the demand for wine?},
  author={Friberg, Richard and Gr{\"o}nqvist, Erik},
  journal={American Economic Journal: Applied Economics},
  volume={4},
  number={1},
  pages={193--211},
  year={2012}
}
#+end_src

- One exemple on the effect of information on demand

*** cite:AJon13 [[file:Biblio/Trie/AJon13.pdf][JWE: Demand for expert opinion]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{AJon13,
  title={The demand for expert opinion: Bordeaux wine},
  author={Ashenfelter, Orley and Jones, Gregory V},
  journal={Journal of Wine Economics},
  volume={8},
  number={3},
  pages={285--293},
  year={2013},
  publisher={Cambridge University Press}
}
#+end_src

- This establishes that the expert opinions are not efficient, in the
  sense that they can be easily improved by weather data.
- Ils corrèlent la qualité du millésime annoncée au moment du primeur
  avec la valeur du millésime dans les enchères plus tard.
- We construct the index of a vintage’s average price from a
  regression of the logarithm of the price from several thousand
  auction sales on dummy variables indicating the château and the
  vintages. The regression coefficients for the vintage dummies are
  then used to construct the vintage index. This provides a simple way
  to construct a vintage index in the presence of an unbalanced sample
  design.
- ordered probit of the effects of weather on the ratings. Pour
  vraiment arriver au résultat sur le bais des experts, je dirais
  qu'il faut faire de l'out of sample (ou du
  jacknife). Rétrospectivement, c'est facile.

*** cite:CPar15 [[file:Biblio/Trie/CPar15.pdf][JWE: Standardize expert]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CPar15,
  title={Standardizing expert wine scores: An application for Bordeaux
                  en primeur},
  author={Cardebat, Jean-Marie and Paroissien, Emmanuel},
  journal={Journal of Wine Economics},
  volume={10},
  number={3},
  pages={329--348},
  year={2015},
  publisher={Cambridge University Press}
}
#+end_src

- yop

*** cite:Bodi17 [[file:Biblio/Trie/Bodi17.pdf][JWE: Judge consistency]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{Bodi17,
  title={Disentangling wine judges’ consensus, idiosyncratic, and
                  random expressions of quality or preference},
  author={Bodington, Jeffrey},
  journal={Journal of Wine Economics},
  volume={12},
  number={3},
  pages={267--281},
  year={2017},
  publisher={Cambridge University Press}
}
#+end_src

- p2 a good survey about wine ranking.
- This article show the importance of replicants in wine ratings.
- Par la modélisation conditionelle des note données aux vins, il
  permet d'obtenir un classement cohérent ou le vin répliqué est
  classé de manière cohérente (c'est à dire qu'ils se suivent dans la
  hiérarchie). the reason for the change in order is that
  low-randomness judges (such as Judge #7) have more influence on
  differences between expected values than high-randomness judges
  (such as Judge #4). That effect also applies to the orders implied
  by sums of ranks, Shapley values, Borda counts, and prefer-
  ence-model results.
- Disentangling Consensus, Idiosyncratic, and Random Ratings. Il y a
  la question de la pertinance des modèle multinomiaux pour étudier
  les ratings. Il plaide pour du rank-preference
  model. rank-preference models can be tailored to discrete, ordered,
  and bounded ratings that are assigned with or without replacement.
  The works of Marden (1995) and Alvo and Yu (2014) are widely cited
  texts concerning these models.

*** cite:CSto17 [[file:Biblio/Trie/CSto17.pdf][JWE: Ranking methods]]

#+begin_src bibtex :tangle ./Biblio.bib :exports none
@article{CSto17,
  title={Comparison of different ranking methods in wine tasting},
  author={Cao, Jing and Stokes, Lynne},
  journal={Journal of Wine Economics},
  volume={12},
  number={2},
  pages={203--210},
  year={2017},
  publisher={Cambridge University Press}
}
#+end_src

- Rien de sensationnel, utilisation de la valeur Shapley de manière
  assez ad hoc, sans vraiment montrer son intérêt
- La partie intéressante de l'article est celle relative au modèle
  ordonné avec coefficients hétérogènes mais seuil homogènes avec une
  qualité latente qui rentre multiplicativement. Cela me fait penser
  au modèle théorique que j'avais fait pour le prix des vignes et
  présenté à Besançon. Mais pour le détail de ce modèle, il faut mieux
  renvoyer à leur papier de 2010.

** Bibliography                              :noheading:
   
   bibliographystyle:../Softwares/latex/erae
   bibliography:Biblio.bib

#+LATEX: \clearpage\appendix

* Letter to the editor

  Dear AJAE editors,

  please find enclosed a research paper about "The informational
  content of geographical indications".  It describes an econometric
  analysis of the links between natural characteristics of vineyard
  plots, administrative boundaries, and geographical indications for
  the Côte d'Or region of Bourgogne (France).  Controling for
  fine-scale terroir effects, we find persistent lobbying effects from
  administrative subdivisions on GI designations that bias in the GI
  quality signal.  Nevertheless, these lobbying effects are decreasing
  since 1936, which means that the informational content of GIs has
  increased.

  The analysis presented in this article is fully reproducible.  Data
  and models are available from a server at
  https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/ZZWQMN.
  R codes, tables, and figures are reported in a replication file
  available at
  https://github.com/jsay/geoInd/blob/master/ReproPaper.pdf.  Note
  that providing these links to the referees will break the anonymity.
  
  Thank you for considering this article for publication in the AJAE,
  which I believe to be the most appropriate journal for this
  research.  I have not submitted this article to another journal
  before.

  Best regards, Jean-Sauveur Ay.
